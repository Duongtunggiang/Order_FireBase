<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuÃ¡n TrÃ  Sá»¯a & Äá»“ Ä‚n - Single Page App</title>
    <!-- Tailwind CSS via CDN (for development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* Custom Tailwind config for production */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        position: relative;
        overflow-x: hidden;
    }

    /* TrÃ¢n chÃ¢u (boba pearls) effect */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background-image: 
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 11px, transparent 11px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 5px, transparent 5px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 12px, transparent 12px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px);
        background-size: 
            80px 80px, 60px 60px, 100px 100px, 70px 70px, 90px 90px,
            75px 75px, 110px 110px, 65px 65px, 85px 85px, 55px 55px,
            95px 95px, 78px 78px, 50px 50px, 115px 115px, 88px 88px;
        background-position: 
            10% 85%, 25% 90%, 40% 88%, 60% 92%, 75% 87%,
            15% 78%, 88% 95%, 50% 80%, 30% 93%, 70% 82%,
            5% 75%, 95% 90%, 45% 96%, 82% 85%, 20% 70%;
        background-repeat: no-repeat;
        opacity: 0.8;
        /* Gradient mask Ä‘á»ƒ lÃ m má»ng dáº§n á»Ÿ trÃªn */
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
        mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
    }

    /* Äáº£m báº£o ná»™i dung náº±m trÃªn background */
    body > * {
        position: relative;
        z-index: 1;
    }

    /* Hide scrollbar for webkit browsers */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f5e6d3; }
    ::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }

    /* Custom utilities */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    </style>
    <!-- Lucide Icons for nice, clean icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Cáº¥u hÃ¬nh Firebase vÃ  Khá»Ÿi táº¡o
        setLogLevel('Debug');
        const appId = 'order-app'; // App ID cho quÃ¡n trÃ  sá»¯a

        // Firebase config cho project order-d8a0c
        const firebaseConfig = {
            apiKey: "AIzaSyCGs3xD2uC153yGlV7IpRftllAKx-NHt88",
            authDomain: "order-d8a0c.firebaseapp.com",
            projectId: "order-d8a0c",
            storageBucket: "order-d8a0c.firebasestorage.app",
            messagingSenderId: "559568129038",
            appId: "1:559568129038:web:dd1ebcefb23f7cf03dc05f"
        };
        const __initial_auth_token = null; // For Canvas environment - set to null for direct usage

        let app, db, auth, storage, userId;
          let menuItems = [];
          let cart = {}; // { itemId: { item, quantity } }
          let orders = []; // Danh sÃ¡ch orders cho admin
          let tables = []; // Danh sÃ¡ch bÃ n Äƒn
          let currentView = 'customer'; // 'customer', 'login', 'admin', 'admin-orders', 'admin-stats', 'admin-tables', 'admin-menu', 'admin-trash', 'preview'
          let currentCategory = 'Äá»“ Uá»‘ng'; // 'Äá»“ Uá»‘ng', 'Äá»“ Ä‚n', 'Äá»“ Nháº­u'
          let currentTableNumber = null; // Sá»‘ bÃ n hiá»‡n táº¡i (tá»« QR code)
          let userRole = 'guest'; // 'guest', 'customer', 'admin'
        let isAdmin = false;
        let isPreviewMode = false; // Admin Ä‘ang xem nhÆ° khÃ¡ch hÃ ng
        let categories = ['Äá»“ Uá»‘ng', 'Äá»“ Ä‚n', 'Äá»“ Nháº­u']; // Danh sÃ¡ch categories máº·c Ä‘á»‹nh
        let drinkSizes = ['S', 'M', 'L', 'Big Size']; // Size cho Ä‘á»“ uá»‘ng

        // --- HÃ m há»— trá»£ chung ---
        function renderLucideIcons() {
            lucide.createIcons();
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 16000) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = numSamples * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;

            // RIFF chunk
            view.setUint32(offset, 0x52494646, false); offset += 4; // "RIFF"
            view.setUint32(offset, 36 + dataSize, true); offset += 4; // file size - 8
            view.setUint32(offset, 0x57415645, false); offset += 4; // "WAVE"

            // fmt chunk
            view.setUint32(offset, 0x666d7420, false); offset += 4; // "fmt "
            view.setUint32(offset, 16, true); offset += 4; // chunk size
            view.setUint16(offset, 1, true); offset += 2; // format (1 = PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // channels
            view.setUint32(offset, sampleRate, true); offset += 4; // sample rate
            view.setUint32(offset, byteRate, true); offset += 4; // byte rate
            view.setUint16(offset, blockAlign, true); offset += 2; // block align
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; // bits per sample

            // data chunk
            view.setUint32(offset, 0x64617461, false); offset += 4; // "data"
            view.setUint32(offset, dataSize, true); offset += 4; // data size

            // write PCM data
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function speak(text) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        // Assuming a default sample rate of 16000 Hz for PCM16 audio
                        const sampleRate = 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                        return;
                    }
                } catch (error) {
                    console.error(`TTS API failed (attempt ${i + 1}):`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    } else {
                        console.error('TTS failed after multiple retries.');
                    }
                }
            }
        }

        // --- Quáº£n lÃ½ Giá» hÃ ng ---
        function updateCart(itemId, change) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const wasEmpty = Object.keys(cart).length === 0;
            const previousQty = cart[itemId]?.quantity || 0;
            
            // LÆ°u tráº¡ng thÃ¡i giá» hÃ ng trÆ°á»›c khi render láº¡i
            const cartWasOpen = !document.getElementById('cart-sidebar')?.classList.contains('translate-x-full');

            if (cart[itemId]) {
                cart[itemId].quantity += change;
            } else if (change > 0) {
                cart[itemId] = { item: item, quantity: 1 };
            }

            if (cart[itemId] && cart[itemId].quantity <= 0) {
                delete cart[itemId];
            }

            // Tá»± Ä‘á»™ng Ä‘Ã³ng giá» hÃ ng CHá»ˆ KHI xÃ³a háº¿t mÃ³n
            if (Object.keys(cart).length === 0 && !wasEmpty) {
                closeCart();
                showMessage("Giá» hÃ ng trá»‘ng", 'info');
            }

            // Hiá»‡n thÃ´ng bÃ¡o khi thÃªm mÃ³n tá»« menu (khÃ´ng tá»« giá» hÃ ng)
            if (change > 0 && cart[itemId] && !cartWasOpen) {
                showMessage(`âœ… ÄÃ£ thÃªm "${item.name}" vÃ o giá» hÃ ng!`, 'success');
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            renderApp();
            
            // Giá»¯ nguyÃªn tráº¡ng thÃ¡i giá» hÃ ng sau khi render
            if (cartWasOpen && Object.keys(cart).length > 0) {
                openCart();
            }
        }
        
        // ÄÃ³ng giá» hÃ ng
        function closeCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.add('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.add('hidden');
            }
        }
        
        // Má»Ÿ giá» hÃ ng
        function openCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.remove('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.remove('hidden');
            }
        }

        // --- Quáº£n lÃ½ State View ---
        function setView(viewName) {
            currentView = viewName;

            // Setup specific page data
            if (viewName === 'admin-orders') {
                setupOrdersPage();
            }

            renderApp();
            if (viewName !== 'login') {
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.reset();
                }
            }
        }

        function setCategory(categoryName) {
            currentCategory = categoryName;
            renderApp();
        }

        function toggleAdminMode() {
            if (isAdmin) {
                if (currentView.startsWith('admin')) {
                    // Chuyá»ƒn sang preview mode (xem nhÆ° khÃ¡ch)
                    isPreviewMode = true;
                    currentView = 'customer';
                } else {
                    // Quay vá» admin dashboard
                    isPreviewMode = false;
                    currentView = 'admin-stats'; // Default admin view
                }
                renderApp();
            }
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' â‚«';
        }

        // --- Quáº£n lÃ½ Dá»¯ liá»‡u Firebase ---
        const PUBLIC_DATA_PATH = `menuItems`; // ÄÆ¡n giáº£n hÃ³a path cho development
        const PRIVATE_SALES_PATH = `sales/${userId}`;

        // ==================== CATEGORIES MANAGEMENT ====================

        const CATEGORIES_DOC_ID = 'categories_config';

        async function loadCategories() {
            try {
                console.log("ğŸ”„ Loading categories from Firebase...");
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    categories = data.categories || ['Äá»“ Uá»‘ng', 'Äá»“ Ä‚n', 'Äá»“ Nháº­u'];
                    console.log("âœ… Loaded categories:", categories);
                } else {
                    // Náº¿u chÆ°a cÃ³, táº¡o document máº·c Ä‘á»‹nh
                    categories = ['Äá»“ Uá»‘ng', 'Äá»“ Ä‚n', 'Äá»“ Nháº­u'];
                    await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                    console.log("âœ… Created default categories in Firebase");
                }
            } catch (error) {
                console.error("âŒ Error loading categories:", error);
                categories = ['Äá»“ Uá»‘ng', 'Äá»“ Ä‚n', 'Äá»“ Nháº­u']; // Fallback
            }
        }

        async function saveCategories() {
            try {
                console.log("ğŸ’¾ Saving categories to Firebase...");
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                console.log("âœ… Categories saved successfully");
            } catch (error) {
                console.error("âŒ Error saving categories:", error);
                showMessage("Lá»—i khi lÆ°u danh má»¥c: " + error.message, "error");
            }
        }

        function setupMenuListener() {
            if (!db) {
                console.warn("âŒ DB chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o");
                return;
            }
            const q = query(collection(db, PUBLIC_DATA_PATH));
            console.log("ğŸ”„ Setting up menu listener for path:", PUBLIC_DATA_PATH);

            onSnapshot(q, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("âœ… Loaded menu items:", menuItems.length, "items");
                console.log("ğŸ“‹ Menu items:", menuItems.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    priceType: typeof item.price,
                    newPrice: item.newPrice,
                    newPriceType: typeof item.newPrice
                })));
                console.log("ğŸ” Raw snapshot:", snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));

                // Kiá»ƒm tra currentCategory cÃ³ cÃ²n active khÃ´ng (cÃ³ mÃ³n khÃ´ng)
                const activeCategories = categories.filter(cat =>
                    menuItems.some(item => item.category === cat && item.status !== 'deleted')
                );
                if (!activeCategories.includes(currentCategory) && activeCategories.length > 0) {
                    // Náº¿u currentCategory khÃ´ng cÃ²n active, chuyá»ƒn vá» category Ä‘áº§u tiÃªn
                    currentCategory = activeCategories[0];
                    console.log("ğŸ”„ Current category changed to:", currentCategory);
                }

                // Auto-cleanup expired items
                cleanupExpiredItems();

                renderApp();
            }, (error) => {
                console.error("âŒ Lá»—i khi nghe thay Ä‘á»•i menu:", error);
                console.error("âŒ Error details:", error.code, error.message);
                // Fallback: thá»­ load má»™t láº§n
                loadMenuItemsOnce();
            });
        }

        async function loadMenuItemsOnce() {
            try {
                console.log("ğŸ”„ Loading menu items once...");
                const querySnapshot = await getDocs(collection(db, PUBLIC_DATA_PATH));
                menuItems = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("âœ… Loaded menu items (once):", menuItems.length, "items");
                renderApp();
            } catch (error) {
                console.error("âŒ Failed to load menu items:", error);
            }
        }
        
        async function saveItem(item) {
            const isNew = !item.id;

            try {
                let imageUrl = item.imageUrl;

                // Handle file upload - Convert to Data URL
                const fileInput = document.getElementById('admin-form-image-file');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    console.log("ğŸ“¸ Processing image...");
                    showMessage("Äang xá»­ lÃ½ áº£nh...", "info");
                    
                    try {
                        imageUrl = await uploadImage(fileInput.files[0]);
                        showMessage("âœ… áº¢nh Ä‘Ã£ sáºµn sÃ ng!", "success");
                        console.log("âœ… Image ready for save");
                    } catch (error) {
                        showMessage("âŒ Lá»—i xá»­ lÃ½ áº£nh: " + error.message, "error");
                        throw error;
                    }
                }

                // Fallback to placeholder if no image provided
                if (!imageUrl || imageUrl.trim() === '') {
                    imageUrl = `https://via.placeholder.com/400x300/f0d48f/8b542f?text=${encodeURIComponent(item.name.substring(0, 10))}`;
                    console.log("ğŸ“ Using placeholder image");
                }

                const itemToSave = {
                    name: item.name,
                    description: item.description,
                    price: parseFloat(item.price),
                    category: item.category,
                    status: item.status || 'active',
                    imageUrl: imageUrl,
                    updatedAt: new Date(),
                };

                // Add size if provided (for drinks)
                if (item.size && item.size.trim() !== '') {
                    itemToSave.size = item.size;
                }

                // Add newPrice if provided, remove if empty/0
                if (item.newPrice && parseFloat(item.newPrice) > 0) {
                    itemToSave.newPrice = parseFloat(item.newPrice);
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(itemToSave).forEach(key => {
                    if (itemToSave[key] === undefined || itemToSave[key] === null) {
                        delete itemToSave[key];
                    }
                });
                // Note: If newPrice is not included, Firestore will remove the field

                if (isNew) {
                    await addDoc(collection(db, PUBLIC_DATA_PATH), itemToSave);
                    console.log("ThÃªm mÃ³n thÃ nh cÃ´ng");
                    showMessage("ThÃªm mÃ³n thÃ nh cÃ´ng!", "success");
                } else {
                    const itemRef = doc(db, PUBLIC_DATA_PATH, item.id);
                    await updateDoc(itemRef, itemToSave);
                    console.log("Cáº­p nháº­t mÃ³n thÃ nh cÃ´ng");
                    showMessage("Cáº­p nháº­t mÃ³n thÃ nh cÃ´ng!", "success");
                }

                // Clear file input
                if (fileInput) fileInput.value = '';

                setView('admin'); // Trá»Ÿ vá» trang quáº£n lÃ½
            } catch (e) {
                console.error("Lá»—i khi lÆ°u mÃ³n:", e);
                showMessage("Lá»—i khi lÆ°u mÃ³n: " + e.message, "error");
            }
        }
        
        async function deleteItem(id) {
            if (!confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a mÃ³n nÃ y? MÃ³n sáº½ Ä‘Æ°á»£c chuyá»ƒn vÃ o thÃ¹ng rÃ¡c.")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'deleted',
                    deletedAt: new Date(),
                    updatedAt: new Date()
                });
                console.log("âœ… Chuyá»ƒn mÃ³n vÃ o thÃ¹ng rÃ¡c thÃ nh cÃ´ng");
                showMessage("ÄÃ£ chuyá»ƒn mÃ³n vÃ o thÃ¹ng rÃ¡c!", "success");
            } catch (e) {
                console.error("âŒ Lá»—i khi xÃ³a mÃ³n:", e);
                showMessage("Lá»—i khi xÃ³a mÃ³n: " + e.message, "error");
            }
        }

        // Convert image to Base64 Data URL (lÆ°u trá»±c tiáº¿p trong database)
        async function uploadImage(file) {
            if (!file) return null;

            try {
                console.log("ğŸ“¸ Converting image to Data URL...");
                console.log("ğŸ“ File:", file.name, "Size:", (file.size / 1024).toFixed(2), "KB");

                // Check file size (max 1MB recommended for Data URL)
                if (file.size > 1024 * 1024) {
                    throw new Error("áº¢nh quÃ¡ lá»›n! Vui lÃ²ng chá»n áº£nh nhá» hÆ¡n 1MB");
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const dataURL = e.target.result;
                        console.log("âœ… Image converted successfully!");
                        console.log("ğŸ“Š Data URL length:", dataURL.length);
                        resolve(dataURL);
                    };
                    
                    reader.onerror = function(error) {
                        console.error("âŒ Error reading file:", error);
                        reject(error);
                    };
                    
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error("âŒ Error processing image:", error);
                throw error;
            }
        }

        // Thay Ä‘á»•i máº­t kháº©u
        async function changePassword(currentPassword, newPassword) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("KhÃ´ng cÃ³ user Ä‘Äƒng nháº­p");

                // Re-authenticate vá»›i password hiá»‡n táº¡i
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);

                // Update password má»›i
                await updatePassword(user, newPassword);
                console.log("Password changed successfully");

                showMessage("Äá»•i máº­t kháº©u thÃ nh cÃ´ng!", "success");
                return true;
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = "Lá»—i khi Ä‘á»•i máº­t kháº©u";

                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Máº­t kháº©u má»›i quÃ¡ yáº¿u";
                }

                showMessage(errorMessage, "error");
                return false;
            }
        }

        // --- Quáº£n lÃ½ ÄÄƒng nháº­p/ÄÄƒng xuáº¥t ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            console.log("ğŸ” Attempting login with email:", email);

            try {
                showMessage("Äang Ä‘Äƒng nháº­p...", "info");
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                console.log("âœ… Login successful!");
                console.log("ğŸ‘¤ User:", userCredential.user.email);
                console.log("ğŸ†” UID:", userCredential.user.uid);
                
                // Check if admin
                const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                const isAdminUser = adminEmails.includes(userCredential.user.email);
                
                console.log("ğŸ‘‘ Is Admin:", isAdminUser);
                
                if (isAdminUser) {
                    showMessage("âœ… ÄÄƒng nháº­p Admin thÃ nh cÃ´ng! Chuyá»ƒn Ä‘áº¿n Dashboard...", "success");
                    console.log("ğŸš€ Redirecting to Admin Dashboard");
                } else {
                    showMessage("âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! NhÆ°ng tÃ i khoáº£n khÃ´ng cÃ³ quyá»n Admin.", "info");
                    console.log("âš ï¸ User is not admin, staying in customer view");
                }
                
                // AuthStateChanged sáº½ lo viá»‡c chuyá»ƒn view
            } catch (error) {
                console.error("âŒ Login failed:", error.code, error.message);
                let errorMessage = "ÄÄƒng nháº­p tháº¥t báº¡i.";

                if (error.code === 'auth/user-not-found') {
                    errorMessage = "âŒ TÃ i khoáº£n khÃ´ng tá»“n táº¡i.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "âŒ Email khÃ´ng há»£p lá»‡.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "âŒ Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng.";
                }

                document.getElementById('login-message').textContent = errorMessage;
                showMessage(errorMessage, "error");
                console.log("âŒ Error details:", error);
            }
        }
        
        async function handleLogout() {
            try {
                console.log("ğŸ”“ Logging out...");
                await signOut(auth);
                console.log("âœ… Logout successful");
                showMessage("ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!", "success");
                isPreviewMode = false;
                // AuthStateChanged sáº½ lo viá»‡c chuyá»ƒn view
            } catch (error) {
                console.error("âŒ Logout error:", error);
                showMessage("Lá»—i khi Ä‘Äƒng xuáº¥t", "error");
            }
        }

        // --- Khá»Ÿi táº¡o vÃ  Quáº£n lÃ½ Auth ---
        // ==================== SESSION MANAGEMENT (COOKIE) ====================

        let currentSessionId = null; // ID session cá»§a khÃ¡ch
        let guestOrders = []; // Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng cá»§a khÃ¡ch trong session

        // Táº¡o session ID duy nháº¥t
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // LÆ°u session vÃ o cookie (expire sau 2 giá»)
        function saveSessionToCookie() {
            const sessionData = {
                sessionId: currentSessionId,
                tableNumber: currentTableNumber,
                orders: guestOrders,
                createdAt: new Date().toISOString()
            };

            const expirationTime = new Date();
            // expirationTime.setTime(expirationTime.getTime() + (2 * 60 * 60 * 1000)); // 2 giá» (production)
            expirationTime.setTime(expirationTime.getTime() + (1 * 60 * 1000)); // 1 phÃºt (Ä‘á»ƒ test)

            document.cookie = `guest_session=${JSON.stringify(sessionData)}; expires=${expirationTime.toUTCString()}; path=/`;

            console.log('ğŸ’¾ Session saved to cookie:', sessionData);
        }

        // Äá»c session tá»« cookie
        function loadSessionFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'guest_session') {
                    try {
                        const sessionData = JSON.parse(decodeURIComponent(value));

                        // Kiá»ƒm tra xem session cÃ³ cÃ²n há»£p lá»‡ khÃ´ng (1 phÃºt)
                        const sessionAge = Date.now() - new Date(sessionData.createdAt).getTime();
                        const maxAge = 1 * 60 * 1000; // 1 phÃºt (Ä‘á»ƒ test)

                        console.log('ğŸª Cookie check:', {
                            sessionAge: Math.round(sessionAge / 1000) + 's',
                            maxAge: Math.round(maxAge / 1000) + 's',
                            isExpired: sessionAge >= maxAge,
                            createdAt: new Date(sessionData.createdAt).toLocaleTimeString(),
                            now: new Date().toLocaleTimeString()
                        });

                        if (sessionAge < maxAge) {
                            currentSessionId = sessionData.sessionId;
                            currentTableNumber = sessionData.tableNumber;
                            guestOrders = sessionData.orders || [];
                            userRole = 'guest';

                            console.log('ğŸ“– Session loaded from cookie:', sessionData);
                            return true;
                        } else {
                            // Session háº¿t háº¡n, xÃ³a cookie
                            clearSessionCookie();
                            console.log('â° Session expired, cleared cookie');
                        }
                    } catch (error) {
                        console.error('Error parsing session cookie:', error);
                        clearSessionCookie();
                    }
                    break;
                }
            }
            return false;
        }

        // XÃ³a session cookie
        function clearSessionCookie() {
            document.cookie = 'guest_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            currentSessionId = null;
            currentTableNumber = null;
            guestOrders = [];
            userRole = 'guest';
        }

        // ==================== TABLE MANAGEMENT ====================

        // Äá»c table number tá»« URL (QR code scan)
        function checkTableFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const tableNumber = urlParams.get('table');

            if (tableNumber) {
                // Kiá»ƒm tra xem bÃ n cÃ³ tá»“n táº¡i khÃ´ng (chá»‰ check náº¿u Ä‘Ã£ load tables)
                if (tables.length > 0) {
                    const tableExists = tables.some(t => t.tableNumber === tableNumber);
                    if (!tableExists) {
                        console.warn(`Table ${tableNumber} does not exist`);
                        showMessage(`BÃ n ${tableNumber} khÃ´ng tá»“n táº¡i!`, 'error');
                        return;
                    }
                }

                // Kiá»ƒm tra xem cÃ³ session cÅ© vá»›i bÃ n khÃ¡c khÃ´ng
                if (currentTableNumber && currentTableNumber !== tableNumber) {
                    // Äá»•i bÃ n má»›i, táº¡o session má»›i
                    console.log(`ğŸ”„ Changing table from ${currentTableNumber} to ${tableNumber}`);
                    guestOrders = []; // Reset orders khi Ä‘á»•i bÃ n
                }

                currentTableNumber = tableNumber;
                userRole = 'guest';

                // Táº¡o session ID má»›i náº¿u chÆ°a cÃ³
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                }

                console.log(`ğŸ½ï¸ Guest accessing from Table ${tableNumber} (Session: ${currentSessionId})`);
                showMessage(`ChÃ o má»«ng Ä‘áº¿n BÃ n ${tableNumber}!`, 'success');

                // LÆ°u session vÃ o cookie
                saveSessionToCookie();

                // Re-render Ä‘á»ƒ cáº­p nháº­t header
                renderApp();
            }
        }
        
        // Setup realtime listener cho tables
        function setupTablesListener() {
            if (!db) return;
            
            try {
                console.log("ğŸ“¡ Setting up tables realtime listener...");
                const tablesRef = collection(db, 'tables');
                
                onSnapshot(tablesRef, (snapshot) => {
                    tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("ğŸ½ï¸ Tables updated:", tables.length);
                    
                    // Re-render náº¿u Ä‘ang á»Ÿ admin tables view
                    if (isAdmin && currentView === 'admin-tables') {
                        renderApp();
                    }

                    // Re-render náº¿u Ä‘ang á»Ÿ admin view (for backward compatibility)
                    if (isAdmin && currentView === 'admin') {
                        renderApp();
                    }

                    // Cáº­p nháº­t modal chá»n bÃ n náº¿u Ä‘ang má»Ÿ
                    const tableModal = document.getElementById('table-selection-modal');
                    if (tableModal && !tableModal.classList.contains('hidden')) {
                        console.log("ğŸ”„ Updating table selection modal");
                        // Re-load danh sÃ¡ch bÃ n trong modal
                        const content = document.getElementById('table-selection-content');
                        if (content) {
                            const availableTables = tables.filter(table => !table.status || table.status === 'available');
                            console.log("âœ… Available tables for modal:", availableTables);
                            content.innerHTML = availableTables.map(table => `
                                <button onclick="selectTable('${table.tableNumber}')" class="p-2 sm:p-3 lg:p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-1 sm:space-y-2 active:scale-95">
                                    <i data-lucide="table-2" class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-teal-600"></i>
                                    <span class="font-semibold text-gray-800 text-sm sm:text-base">BÃ n ${table.tableNumber}</span>
                                    <span class="text-xs text-green-600 bg-green-100 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full">${table.status || 'Trá»‘ng'}</span>
                                </button>
                            `).join('');
                            renderLucideIcons();
                        }
                    }
                });
                
            } catch (error) {
                console.error("Error setting up tables listener:", error);
            }
        }

        // Load tables má»™t láº§n (fallback náº¿u realtime chÆ°a load)
        async function loadTablesOnce() {
            if (!db || tables.length > 0) return; // ÄÃ£ cÃ³ data rá»“i

            try {
                console.log("ğŸ”„ Loading tables once...");
                const tablesRef = collection(db, 'tables');
                const snapshot = await getDocs(tablesRef);
                tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("âœ… Tables loaded once:", tables.length);
                console.log("ğŸ“‹ Tables data:", tables);
            } catch (error) {
                console.error("Error loading tables once:", error);
            }
        }
        
        // ThÃªm bÃ n má»›i
        async function addTable() {
            const tableNumber = document.getElementById('new-table-number').value.trim();
            
            if (!tableNumber) {
                showMessage("Vui lÃ²ng nháº­p sá»‘ bÃ n!", "warning");
                return;
            }
            
            // Kiá»ƒm tra trÃ¹ng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`BÃ n ${tableNumber} Ä‘Ã£ tá»“n táº¡i!`, "error");
                return;
            }
            
            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                await addDoc(collection(db, 'tables'), tableData);
                
                showMessage(`âœ… ÄÃ£ thÃªm BÃ n ${tableNumber}`, "success");
                closeAddTableModal();
                
            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("Lá»—i thÃªm bÃ n: " + error.message, "error");
            }
        }
        
        // XÃ³a bÃ n
        async function deleteTable(tableId) {
            if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a bÃ n nÃ y?")) return;
            
            try {
                await deleteDoc(doc(db, 'tables', tableId));
                showMessage("âœ… ÄÃ£ xÃ³a bÃ n", "success");
                
            } catch (error) {
                console.error("Error deleting table:", error);
                showMessage("Lá»—i xÃ³a bÃ n: " + error.message, "error");
            }
        }
        
        // Hiá»ƒn thá»‹ QR Code cá»§a bÃ n
        function showTableQR(tableId, tableNumber) {
            const modal = document.getElementById('qr-modal');
            const qrContainer = document.getElementById('qr-code-container');
            const tableInfo = document.getElementById('qr-table-info');
            
            // Clear previous QR
            qrContainer.innerHTML = '';
            
            // Táº¡o URL vá»›i table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;
            
            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">BÃ n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">QuÃ©t QR code nÃ y Ä‘á»ƒ vÃ o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function closeQRModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }
        
        function openAddTableModal() {
            document.getElementById('add-table-modal').classList.remove('hidden');
        }
        
        function closeAddTableModal() {
            document.getElementById('add-table-modal').classList.add('hidden');
            document.getElementById('new-table-number').value = '';
        }
        
        // Download QR Code as image
        function downloadQR() {
            const qrCanvas = document.querySelector('#qr-code-container canvas');
            if (!qrCanvas) return;
            
            const tableNumber = document.querySelector('#qr-table-info .text-teal-600').textContent;
            
            const link = document.createElement('a');
            link.download = `QR-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }
        
        function initFirebase() {
            try {
                // Debug: Check current cookies
                console.log('ğŸª Current cookies:', document.cookie);

                // Load session tá»« cookie trÆ°á»›c
                loadSessionFromCookie();

                // Kiá»ƒm tra table tá»« URL (cÃ³ thá»ƒ override session cÅ©)
                checkTableFromURL();

                console.log("ğŸš€ Initializing Firebase with config:", firebaseConfig);
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    storage = getStorage(app);
                    console.log("âœ… Firebase initialized successfully");
                } else {
                    console.warn("âŒ Firebase Config khÃ´ng tá»“n táº¡i. DÃ¹ng cháº¿ Ä‘á»™ Demo.");
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Check if user is admin (multiple admin emails supported)
                        const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                        isAdmin = adminEmails.includes(user.email);
                        
                        console.log("ğŸ‘¤ User authenticated:", user.email);
                        console.log("ğŸ‘‘ Is Admin:", isAdmin);
                        
                        if (__initial_auth_token && user.isAnonymous) {
                            // ÄÃ¢y lÃ  logic Ä‘áº·c biá»‡t cho mÃ´i trÆ°á»ng Canvas, dÃ¹ng token ban Ä‘áº§u
                            await signInWithCustomToken(auth, __initial_auth_token);
                            // Sau khi Ä‘Äƒng nháº­p báº±ng custom token, user váº«n lÃ  áº©n danh.
                            userId = auth.currentUser.uid;
                            isAdmin = false;
                        }
                        
                        if (db) {
                            setupMenuListener();
                            setupTablesListener(); // Always setup for table selection modal

                            // Load categories from Firebase
                            loadCategories();

                            // Setup listeners for admin
                            if (isAdmin) {
                                setupOrdersListener();
                                setupTablesListener(); // Always setup for admin tables view
                            }
                        }
                        
                        // Chuyá»ƒn vá» tráº¡ng thÃ¡i KhÃ¡ch hÃ ng náº¿u khÃ´ng pháº£i Admin
                        if (isAdmin && currentView === 'login') {
                           console.log("ğŸš€ Switching to Admin Dashboard");
                           setView('admin');
                           showMessage("ChÃ o má»«ng Admin! ğŸ‘‘", "success");
                        } else if (!isAdmin && currentView === 'login') {
                           console.log("ğŸ‘¤ Switching to Customer view");
                           setView('customer');
                        }
                    } else {
                        // User Ä‘Ã£ Ä‘Äƒng xuáº¥t
                        isAdmin = false;
                        userId = crypto.randomUUID(); // DÃ¹ng ID ngáº«u nhiÃªn cho khÃ¡ch áº©n danh
                        if (db) {
                            // Táº¡m thá»i bá» anonymous auth Ä‘á»ƒ trÃ¡nh lá»—i config
                            // if (!__initial_auth_token) await signInAnonymously(auth);
                            console.log("ğŸ”„ Setting up menu listener without auth...");
                            setupMenuListener();

                            // Load categories from Firebase
                            loadCategories();
                        }
                        setView('customer');
                    }
                    renderApp();
                });
            } catch (e) {
                console.error("Lá»—i khá»Ÿi táº¡o Firebase:", e);
            }
        }


        // --- Render UI ---
        function renderHeader() {
            const loginButton = isAdmin
                ? `<button onclick="handleLogout()" class="px-4 py-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition duration-150 flex items-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>ÄÄƒng Xuáº¥t</span>
                </button>`
                : `<button onclick="setView('login')" class="px-4 py-2 rounded-full bg-orange-600 text-white hover:bg-orange-700 transition duration-150">ÄÄƒng Nháº­p Admin</button>`;

            // Äáº¿m Ä‘Æ¡n hÃ ng chá» nháº­n (chá»‰ admin tháº¥y)
            const pendingOrdersCount = isAdmin ? orders.filter(o => o.status === 'ordered').length : 0;
            
            const adminToggle = isAdmin
                ? `<button onclick="toggleAdminMode()" class="flex items-center justify-center w-10 h-10 rounded-full ${currentView === 'admin' ? 'bg-blue-500 hover:bg-blue-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white font-semibold transition duration-150" title="${currentView === 'admin' ? 'Xem Trang KhÃ¡ch' : 'Quáº£n LÃ½ Admin'}">
                    <i data-lucide="${currentView === 'admin' ? 'eye' : 'settings'}" class="w-5 h-5"></i>
                </button>` : '';
            
            const adminBadge = isAdmin && !isPreviewMode
                ? `<span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">ğŸ‘‘ ADMIN</span>`
                : isPreviewMode
                ? `<span class="px-3 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">ğŸ‘ï¸ PREVIEW</span>`
                : '';

            // Admin page title
            const adminPageTitle = isAdmin && currentView.startsWith('admin') ? (() => {
                const titles = {
                    'admin-stats': 'ğŸ“Š Thá»‘ng KÃª',
                    'admin-orders': 'ğŸ“‹ ÄÆ¡n HÃ ng',
                    'admin-tables': 'ğŸ½ï¸ BÃ n Ä‚n',
                    'admin-menu': 'ğŸ½ï¸ Menu'
                };
                return titles[currentView] || 'ğŸ‘‘ Admin';
            })() : '';
            
            // Admin navigation buttons
            const adminNavButtons = isAdmin ? `
                <div class="flex items-center space-x-2">
                    <button onclick="setView('admin-stats')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-stats' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Thá»‘ng KÃª</span>
                    </button>
                    <button onclick="setView('admin-orders')" class="relative flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-orders' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">ÄÆ¡n HÃ ng</span>
                        ${pendingOrdersCount > 0 ? `
                            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform bg-red-600 rounded-full animate-pulse">
                                ${pendingOrdersCount}
                            </span>
                        ` : ''}
                    </button>
                    <button onclick="setView('admin-tables')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-tables' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-teal-500 hover:bg-teal-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="table-2" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">BÃ n Ä‚n</span>
                    </button>
                    <button onclick="setView('admin-menu')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-menu' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-orange-500 hover:bg-orange-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="coffee" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Menu</span>
                    </button>
                </div>
            ` : '';
            
             // TÃ­nh tá»•ng sá»‘ mÃ³n trong giá» hÃ ng
             const totalItemsInCart = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);

            return `
                <header class="sticky top-0 z-20 bg-amber-100/90 backdrop-blur-sm shadow-md border-b border-yellow-700/50">
                    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-3 sm:py-4">
                        <!-- Logo QuÃ¡n + Sá»‘ BÃ n -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                                <i data-lucide="coffee" class="text-amber-800 w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 flex-shrink-0"></i>
                                <div class="min-w-0 flex-1">
                                    <a href="/" onclick="setView('customer')" class="block">
                                        <h1 class="text-sm sm:text-lg lg:text-xl font-bold text-amber-900 font-serif truncate">Chill Coffee</h1>
                                    </a>
                                    ${adminPageTitle ? `
                                        <div class="mt-0.5">
                                            <p class="text-xs sm:text-sm text-red-600 font-semibold truncate">${adminPageTitle}</p>
                                        </div>
                                    ` : currentTableNumber ? `
                                        <div class="flex items-center gap-1 sm:gap-2 mt-0.5">
                                            <p class="text-xs sm:text-sm text-teal-600 font-semibold flex items-center gap-1 truncate">
                                                <i data-lucide="table-2" class="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0"></i>
                                                <span class="truncate">BÃ n ${currentTableNumber}</span>
                                            </p>
                                            ${guestOrders.length > 0 ? `
                                                <span class="text-xs bg-teal-100 text-teal-700 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full flex-shrink-0">
                                                    ${guestOrders.length} Ä‘Æ¡n
                                                </span>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Always Visible Actions (Contact & Table Selection & Orders & Cart) -->
                            <div class="flex items-center space-x-2 sm:space-x-3 y-2">
                                ${!isAdmin ? `
                                    <a href="#" class="hidden sm:flex items-center text-amber-800 hover:text-orange-600 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="phone" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">LiÃªn Há»‡</span>
                                    </a>
                                    <a href="#" class="sm:hidden p-1 rounded-full text-amber-800 hover:text-orange-600 transition duration-150">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                    </a>
                                ` : ''}
                                ${!currentTableNumber && !isAdmin ? `
                                    <button onclick="showTableSelectionModal()" class="hidden md:flex items-center text-teal-600 hover:text-teal-800 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="table-2" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">Chá»n BÃ n</span>
                                        <span class="lg:hidden">BÃ n</span>
                                    </button>
                                ` : ''}
                                ${!isAdmin ? `
                                <button onclick="showMyOrders()" class="p-1 sm:p-1.5 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-150 shadow-sm active:scale-95" title="ÄÆ¡n hÃ ng cá»§a tÃ´i">
                                    <i data-lucide="clipboard" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                </button>
                                ` : ''}
                                ${!isAdmin || isPreviewMode ? `
                                    <button onclick="openCart()" class="relative p-1 sm:p-1.5 rounded-full bg-orange-500 text-white hover:bg-orange-600 transition duration-150 shadow-sm">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                        ${totalItemsInCart > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full animate-pulse">${totalItemsInCart}</span>` : ''}
                                    </button>
                                ` : ''}
                            </div>

                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-amber-200 transition duration-150" id="mobile-menu-btn">
                            <i data-lucide="menu" class="w-5 h-5 text-amber-800"></i>
                        </button>

                        <!-- Desktop Navigation -->
                        <div class="hidden md:flex items-center space-x-2 lg:space-x-3 ml-6">
                              ${adminBadge}
                              ${isAdmin ? adminNavButtons : ''}
                              ${adminToggle}
                            ${loginButton}
                        </div>

                        <!-- Mobile Menu Dropdown -->
                        <div id="mobile-menu" class="absolute top-full left-0 right-0 bg-amber-50 shadow-lg border-t border-amber-200 hidden md:hidden z-30">
                            <div class="px-4 py-3 space-y-2">
                                ${isAdmin ? `
                                    <!-- Admin Mobile Menu -->
                                    <button onclick="setView('admin-stats'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-stats' ? 'bg-blue-100' : ''}">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">ğŸ“Š Thá»‘ng KÃª</span>
                                    </button>
                                    <button onclick="setView('admin-orders'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-orders' ? 'bg-purple-100' : ''}">
                                        <i data-lucide="clipboard-list" class="w-5 h-5 text-purple-600"></i>
                                        <span class="text-purple-600 font-medium">ğŸ“‹ ÄÆ¡n HÃ ng</span>
                                        ${pendingOrdersCount > 0 ? `<span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingOrdersCount}</span>` : ''}
                                    </button>
                                    <button onclick="setView('admin-tables'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-tables' ? 'bg-teal-100' : ''}">
                                        <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                        <span class="text-teal-600 font-medium">ğŸ½ï¸ BÃ n Ä‚n</span>
                                    </button>
                                    <button onclick="setView('admin-menu'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-menu' ? 'bg-orange-100' : ''}">
                                        <i data-lucide="coffee" class="w-5 h-5 text-orange-600"></i>
                                        <span class="text-orange-600 font-medium">ğŸ½ï¸ Menu</span>
                                    </button>
                                    <button onclick="setView('admin-trash'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-trash' ? 'bg-gray-100' : ''}">
                                        <i data-lucide="trash-2" class="w-5 h-5 text-gray-600"></i>
                                        <span class="text-gray-600 font-medium">ğŸ—‘ï¸ ThÃ¹ng RÃ¡c</span>
                                    </button>
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        <button onclick="handleChangePassword(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="lock" class="w-5 h-5 text-purple-600"></i>
                                            <span class="text-purple-600 font-medium">ğŸ” Äá»•i Máº­t Kháº©u</span>
                                        </button>
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg mt-2').replace('ÄÄƒng Nháº­p Admin', 'ğŸ‘¨â€ğŸ’¼ ÄÄƒng Nháº­p Admin').replace('ÄÄƒng Xuáº¥t', 'ğŸšª ÄÄƒng Xuáº¥t')}
                                    </div>
                                ` : `
                                    <!-- Guest Mobile Menu -->
                                    <button onclick="showMyOrders(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                        <i data-lucide="clipboard" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">ÄÆ¡n HÃ ng Cá»§a TÃ´i</span>
                                    </button>
                                    ${!currentTableNumber ? `
                                        <button onclick="showTableSelectionModal(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                            <span class="text-teal-600 font-medium">Chá»n BÃ n</span>
                                        </button>
                                    ` : ''}
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg').replace('ÄÄƒng Nháº­p Admin', 'ğŸ‘¨â€ğŸ’¼ ÄÄƒng Nháº­p Admin').replace('ÄÄƒng Xuáº¥t', 'ğŸšª ÄÄƒng Xuáº¥t')}
                                    </div>
                                `}
                                ${adminToggle && !isAdmin ? `<div class="border-t border-amber-200 pt-2 mt-2">${adminToggle.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderMenuSelection() {
            // Chá»‰ hiá»ƒn thá»‹ categories cÃ³ Ã­t nháº¥t 1 mÃ³n active (khÃ´ng pháº£i deleted)
            const activeCategories = categories.filter(cat =>
                menuItems.some(item => item.category === cat && item.status !== 'deleted')
            );

            return `
                <div class="flex justify-center p-2 sm:p-3 bg-amber-50 shadow-inner sticky top-[64px] sm:top-[68px] z-10 overflow-x-auto">
                    <div class="flex space-x-1 sm:space-x-2 min-w-max">
                        ${activeCategories.map(cat => `
                            <button onclick="setCategory('${cat}')" class="${currentCategory === cat ? 'bg-orange-600 text-white shadow-lg' : 'bg-white text-amber-900 hover:bg-amber-200'} font-medium py-1.5 px-3 sm:px-4 rounded-full transition duration-150 text-xs sm:text-sm whitespace-nowrap active:scale-95">
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // áº¨n mÃ³n Ä‘Ã£ xÃ³a cho khÃ¡ch hÃ ng vÃ  admin preview mode
        function renderCustomerMenu() {
            const filteredItems = menuItems.filter(item => {
                // áº¨n mÃ³n Ä‘Ã£ xÃ³a cho khÃ¡ch hÃ ng
                if (!isAdmin && item.status === 'deleted') return false;
                if (isAdmin && item.status === 'deleted') return false;
                return item.category === currentCategory;
            });
            
            // Kiá»ƒm tra xem cÃ³ pháº£i admin Ä‘ang á»Ÿ mode admin khÃ´ng (áº©n nÃºt +)
            const showAddButton = !isAdmin || isPreviewMode;
            
            if (currentCategory === 'Äá»“ Uá»‘ng') {
                // Layout Äá»“ Uá»‘ng: 1 mÃ³n/hÃ ng, áº£nh trÃ¡i
                return filteredItems.map(item => {
                    const statusBadge = getStatusBadge(item.status);
                    const isOutOfStock = item.status === 'out_of_stock';
                    
                    return `
                    <div class="flex items-center bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 p-2 sm:p-3 border border-amber-200 ${isOutOfStock ? 'opacity-60' : ''}">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 sm:w-16 sm:h-16 lg:w-20 lg:h-20 object-cover rounded-md mr-2 sm:mr-3 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/96x96/f0d48f/8b542f?text=NÆ°á»›c'">
                        <div class="flex-grow min-w-0">
                            <div class="flex items-start justify-between gap-1 sm:gap-2 mb-1">
                                <h3 class="text-sm sm:text-base font-medium text-amber-900 truncate">${item.name}</h3>
                                ${showAddButton && !isOutOfStock ? `
                                    <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 flex-shrink-0 shadow-sm active:scale-95">
                                        <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-1 sm:gap-2 mb-1">
                                ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded whitespace-nowrap">${item.size}</span>` : ''}
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-500 mb-1 line-clamp-2">${item.description}</p>
                            <div class="flex items-center justify-between gap-1 sm:gap-2">
                                <div class="flex items-center gap-1 sm:gap-2">
                                    ${item.newPrice ?
                                        (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                            // GiÃ¡ má»›i >= giÃ¡ cÅ©: chá»‰ hiá»‡n giÃ¡ má»›i
                                            `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                            // GiÃ¡ má»›i < giÃ¡ cÅ©: gáº¡ch giÃ¡ cÅ©, hiá»‡n giÃ¡ má»›i
                                            `<div class="flex items-center gap-1">
                                                <span class="text-xs sm:text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>
                                             </div>`
                                        ) :
                                        // KhÃ´ng cÃ³ giÃ¡ má»›i: chá»‰ hiá»‡n giÃ¡ cÅ©
                                        `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                    }
                                </div>
                                ${isAdmin && !isPreviewMode ? `<button onclick="openPriceModal('${item.id}')" class="px-1.5 py-0.5 sm:px-2 sm:py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-150">ğŸ’°</button>` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('');
            } else {
                // Layout Äá»“ Ä‚n/Äá»“ Nháº­u: 2 mÃ³n/hÃ ng, khung vuÃ´ng
                return `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 p-3 sm:p-4">
                        ${filteredItems.map(item => {
                            const statusBadge = getStatusBadge(item.status);
                            const isOutOfStock = item.status === 'out_of_stock';
                            
                            return `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-amber-300 flex flex-col hover:shadow-lg transition duration-300 ${isOutOfStock ? 'opacity-60' : ''}">
                                <div class="relative">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-24 sm:h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x160/f0d48f/8b542f?text=MÃ³n+Ä‚n'">
                                    <div class="absolute top-1 right-1 sm:top-2 sm:right-2">
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="p-3 flex flex-col flex-grow">
                                    <h3 class="text-sm sm:text-base font-semibold text-amber-900 mb-1">${item.name} ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded ml-1">${item.size}</span>` : ''}</h3>
                                    <p class="text-xs text-gray-500 line-clamp-2 mb-2">${item.description}</p>
                                    <div class="mt-auto flex justify-between items-center">
                                        <div class="flex items-center gap-1 sm:gap-2">
                                            ${item.newPrice ?
                                                (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                    // GiÃ¡ má»›i >= giÃ¡ cÅ©: chá»‰ hiá»‡n giÃ¡ má»›i
                                                    `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                                    // GiÃ¡ má»›i < giÃ¡ cÅ©: gáº¡ch giÃ¡ cÅ©, hiá»‡n giÃ¡ má»›i
                                                    `<span class="text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                     <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>`
                                                ) :
                                                // KhÃ´ng cÃ³ giÃ¡ má»›i: chá»‰ hiá»‡n giÃ¡ cÅ©
                                                `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                            }
                                            ${isAdmin && !isPreviewMode ? `<button onclick="openPriceModal('${item.id}')" class="ml-1 px-1 py-0.5 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">ğŸ’°</button>` : ''}
                                        </div>
                                        ${showAddButton && !isOutOfStock ? `
                                            <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 shadow-sm">
                                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            }
        }

        function getStatusBadge(status) {
            if (!status || status === 'active') return '';

            const badges = {
                'hot': '<span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">ğŸ”¥ BÃN CHáº Y</span>',
                'new': '<span class="px-2 py-1 bg-green-500 text-white text-xs font-bold rounded-full">ğŸ†• Má»šI</span>',
                'sale': '<span class="px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded-full">ğŸ’° SALE</span>',
                'best_seller': '<span class="px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded-full">â­ BEST SELLER</span>',
                'out_of_stock': '<span class="px-2 py-1 bg-gray-500 text-white text-xs font-bold rounded-full">âŒ Háº¾T HÃ€NG</span>',
                'coming_soon': '<span class="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">â³ Sáº®P CÃ“</span>',
                'deleted': '<span class="px-2 py-1 bg-black text-white text-xs font-bold rounded-full">ğŸ—‘ï¸ ÄÃƒ XÃ“A</span>'
            };

            return badges[status] || '';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Äá»“ Uá»‘ng': 'â˜•',
                'Äá»“ Ä‚n': 'ğŸ½ï¸',
                'Äá»“ Nháº­u': 'ğŸº'
            };
            return icons[category] || 'ğŸ“‚';
        }

        // Category Management Functions
        let editingCategory = null;

        function editCategory(categoryName) {
            editingCategory = categoryName;
            document.getElementById('new-category-name').value = categoryName;
            document.getElementById('category-modal').classList.remove('hidden');
            document.getElementById('category-modal').querySelector('h3').textContent = 'âœï¸ Sá»­a Danh Má»¥c';
            document.querySelector('button[onclick="addNewCategory()"]').textContent = 'Cáº­p Nháº­t';
            document.querySelector('button[onclick="addNewCategory()"]').onclick = () => updateCategory();
        }

        async function updateCategory() {
            const newName = document.getElementById('new-category-name').value.trim();
            if (!newName) {
                showMessage("Vui lÃ²ng nháº­p tÃªn danh má»¥c!", "error");
                return;
            }

            if (newName !== editingCategory && categories.includes(newName)) {
                showMessage("Danh má»¥c nÃ y Ä‘Ã£ tá»“n táº¡i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategory);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategory) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ÄÃ£ cáº­p nháº­t danh má»¥c: ${editingCategory} â†’ ${newName}`, "success");
                closeCategoryModal();
                renderApp();
            }
        }

        async function deleteCategory(categoryName) {
            const index = categories.indexOf(categoryName);
            if (index < 3) {
                showMessage("KhÃ´ng thá»ƒ xÃ³a 3 danh má»¥c máº·c Ä‘á»‹nh!", "error");
                return;
            }

            const itemsInCategory = menuItems.filter(item => item.category === categoryName);
            if (itemsInCategory.length > 0) {
                const confirmDelete = confirm(`Danh má»¥c "${categoryName}" cÃ³ ${itemsInCategory.length} mÃ³n. Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a?\n\nTáº¥t cáº£ mÃ³n sáº½ Ä‘Æ°á»£c chuyá»ƒn sang "Äá»“ Ä‚n".`);
                if (!confirmDelete) return;

                // Move items to default category
                itemsInCategory.forEach(item => {
                    updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                        category: 'Äá»“ Ä‚n',
                        updatedAt: new Date()
                    });
                });
            }

            categories.splice(index, 1);
            await saveCategories();
            showMessage(`ÄÃ£ xÃ³a danh má»¥c: ${categoryName}`, "success");
            renderApp();
        }

        // Price Update Modal
        let currentPriceUpdateItem = null;

        function openPriceModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            currentPriceUpdateItem = item;

            const modalContent = document.getElementById('price-modal-content');
            const oldPrice = item.price;
            const newPrice = item.newPrice || '';

            modalContent.innerHTML = `
                        <div class="mb-4">
                    <h4 class="font-semibold text-amber-900 mb-2">${item.name}</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GiÃ¡ Hiá»‡n Táº¡i</label>
                            <div class="text-lg font-bold text-orange-600">
                                ${formatCurrency(oldPrice)}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GiÃ¡ Má»›i (CÃ³ Thá»ƒ Bá» Trá»‘ng)</label>
                            <input type="number" id="new-price-input" value="${newPrice}" placeholder="Nháº­p giÃ¡ má»›i..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <p class="text-xs text-gray-500 mt-1">Äá»ƒ trá»‘ng náº¿u muá»‘n xÃ³a giÃ¡ má»›i</p>
                        </div>

                        ${newPrice ? `
                            <div class="p-3 rounded-lg bg-amber-50 border border-amber-200">
                                <div class="text-sm text-amber-800">
                                    <strong>Preview hiá»ƒn thá»‹:</strong><br>
                                    ${parseFloat(newPrice) >= oldPrice ?
                                        `Chá»‰ hiá»‡n: ${formatCurrency(parseFloat(newPrice))}` :
                                        `Gáº¡ch ${formatCurrency(oldPrice)} â†’ ${formatCurrency(parseFloat(newPrice))}`
                                    }
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('price-modal').classList.remove('hidden');
        }

        function closePriceModal() {
            document.getElementById('price-modal').classList.add('hidden');
            currentPriceUpdateItem = null;
        }

        async function savePriceUpdate() {
            if (!currentPriceUpdateItem) return;

            const newPriceInput = document.getElementById('new-price-input');
            const newPriceValue = newPriceInput.value.trim();

            try {
                const updateData = {
                    name: currentPriceUpdateItem.name,
                    description: currentPriceUpdateItem.description,
                    price: currentPriceUpdateItem.price,
                    category: currentPriceUpdateItem.category,
                    status: currentPriceUpdateItem.status,
                    imageUrl: currentPriceUpdateItem.imageUrl,
                    updatedAt: new Date()
                };

                // Only add size if it exists and is not null/undefined
                if (currentPriceUpdateItem.size && currentPriceUpdateItem.size.trim() !== '') {
                    updateData.size = currentPriceUpdateItem.size;
                }

                if (newPriceValue === '') {
                    // XÃ³a giÃ¡ má»›i, chá»‰ giá»¯ giÃ¡ cÅ©
                    // Firestore sáº½ xÃ³a field newPrice náº¿u khÃ´ng include
                } else {
                    // Cáº­p nháº­t giÃ¡ má»›i
                    const newPriceNum = parseFloat(newPriceValue);
                    if (newPriceNum <= 0) {
                        showMessage("GiÃ¡ pháº£i lá»›n hÆ¡n 0!", "error");
                        return;
                    }

                    // LuÃ´n luÃ´n cáº­p nháº­t newPrice
                    updateData.newPrice = newPriceNum;
                    showMessage("Cáº­p nháº­t giÃ¡ thÃ nh cÃ´ng!", "success");
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === undefined) {
                        delete updateData[key];
                    }
                });

                await updateDoc(doc(db, PUBLIC_DATA_PATH, currentPriceUpdateItem.id), updateData);
                showMessage("Cáº­p nháº­t giÃ¡ thÃ nh cÃ´ng!", "success");

                closePriceModal();
                // Refresh data
                loadMenuItemsOnce();

            } catch (error) {
                console.error("Error updating price:", error);
                showMessage("Lá»—i khi cáº­p nháº­t giÃ¡: " + error.message, "error");
            }
        }

        // Category Management
        function openCategoryModal() {
            console.log('Opening category modal...');
            const modal = document.getElementById('category-modal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.classList.remove('hidden');
                const input = document.getElementById('new-category-name');
                if (input) {
                    input.focus();
                }
                console.log('Category modal opened successfully');
            } else {
                console.error('Category modal not found!');
            }
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('new-category-name').value = '';
            resetCategoryModal();
        }

        async function addNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            if (!categoryName) {
                showMessage("Vui lÃ²ng nháº­p tÃªn danh má»¥c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh má»¥c nÃ y Ä‘Ã£ tá»“n táº¡i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ÄÃ£ thÃªm danh má»¥c: ${categoryName}`, "success");
            closeCategoryModal();
            renderApp(); // Re-render Ä‘á»ƒ cáº­p nháº­t menu selection
        }

        function resetCategoryModal() {
            editingCategory = null;
            document.getElementById('category-modal').querySelector('h3').textContent = 'â• ThÃªm Danh Má»¥c Má»›i';
            document.querySelector('button[onclick*="addNewCategory"]').textContent = 'ThÃªm';
            document.querySelector('button[onclick*="addNewCategory"]').onclick = () => addNewCategory();
        }
        
        function renderLoginView() {
            return `
                <div class="flex justify-center items-center py-20 bg-amber-50 min-h-screen">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-yellow-700/50">
                        <h2 class="text-3xl font-bold text-center text-amber-900 mb-6">ğŸ‘‘ ÄÄƒng Nháº­p Admin</h2>
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <label for="email" class="block text-amber-800 font-semibold mb-2">Email Admin</label>
                                <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="binhbiinshop@admin.com">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-amber-800 font-semibold mb-2">Máº­t kháº©u</label>
                                <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                            </div>
                            <p id="login-message" class="text-red-500 text-sm mb-4"></p>
                            <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition duration-150 shadow-lg">ÄÄƒng Nháº­p</button>
                        </form>
                        <p class="mt-4 text-center text-sm text-gray-500">
                            (Chá»‰ dÃ nh cho Quáº£n trá»‹ viÃªn)
                        </p>
                        <button onclick="setView('customer')" class="w-full mt-4 text-orange-600 hover:text-orange-800 transition duration-150 text-sm">
                            Trá»Ÿ vá» trang khÃ¡ch hÃ ng
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== ADMIN DASHBOARD COMPONENTS ====================

        function renderAdminStats() {
            const totalRevenue = 15000000; // Mock data - will be replaced with real stats
            const totalOrders = orders.length;
            const activeItems = menuItems.filter(item => item.status !== 'deleted').length;
            const pendingOrders = orders.filter(o => o.status === 'ordered').length;

            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-amber-900">ğŸ“Š Thá»‘ng KÃª Tá»•ng Quan</h2>
                        <div class="flex gap-2">
                            <button onclick="setView('admin-orders')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                                ÄÆ¡n HÃ ng (${pendingOrders})
                            </button>
                        </div>
                    </div>

                    <!-- Thá»‘ng kÃª chÃ­nh -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Doanh Thu ThÃ¡ng</p>
                                    <p class="text-3xl font-extrabold text-amber-900 mt-1">${formatCurrency(totalRevenue)}</p>
                                </div>
                                <i data-lucide="dollar-sign" class="w-8 h-8 text-orange-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Tá»•ng ÄÆ¡n HÃ ng</p>
                                    <p class="text-3xl font-extrabold text-amber-900 mt-1">${totalOrders}</p>
                                </div>
                                <i data-lucide="shopping-bag" class="w-8 h-8 text-blue-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Sá»‘ MÃ³n Äang BÃ¡n</p>
                                    <p class="text-3xl font-extrabold text-amber-900 mt-1">${activeItems}</p>
                                </div>
                                <i data-lucide="coffee" class="w-8 h-8 text-green-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">ÄÆ¡n Chá» Xá»­ LÃ½</p>
                                    <p class="text-3xl font-extrabold text-amber-900 mt-1">${pendingOrders}</p>
                                </div>
                                <i data-lucide="clock" class="w-8 h-8 text-purple-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Thá»‘ng kÃª theo tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“ˆ Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng</h3>
                            <div class="space-y-3">
                                ${[
                                    { status: 'ordered', label: 'Chá» nháº­n', color: 'blue', count: orders.filter(o => o.status === 'ordered').length },
                                    { status: 'preparing', label: 'Äang lÃ m', color: 'yellow', count: orders.filter(o => o.status === 'preparing').length },
                                    { status: 'completed', label: 'HoÃ n thÃ nh', color: 'green', count: orders.filter(o => o.status === 'completed').length },
                                    { status: 'cancelled', label: 'ÄÃ£ há»§y', color: 'red', count: orders.filter(o => o.status === 'cancelled').length }
                                ].map(stat => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-700">${stat.label}</span>
                                        <div class="flex items-center gap-2">
                                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                                <div class="bg-${stat.color}-500 h-2 rounded-full" style="width: ${orders.length > 0 ? (stat.count / orders.length * 100) : 0}%"></div>
                                            </div>
                                            <span class="text-sm font-semibold text-${stat.color}-600 min-w-[2rem]">${stat.count}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“Š Thá»‘ng KÃª MÃ³n Ä‚n</h3>
                            <div class="space-y-3">
                                ${categories.map(cat => {
                                    const count = menuItems.filter(item => item.category === cat && item.status !== 'deleted').length;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-700">${getCategoryIcon(cat)} ${cat}</span>
                                            <span class="text-sm font-semibold text-orange-600">${count} mÃ³n</span>
                                        </div>
                                    `;
                                }).join('')}
                                <hr class="my-3">
                                <div class="flex justify-between items-center font-bold">
                                    <span class="text-gray-900">Tá»•ng cá»™ng</span>
                                    <span class="text-orange-600">${activeItems} mÃ³n</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÄÆ¡n hÃ ng gáº§n Ä‘Ã¢y -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">ğŸ•’ ÄÆ¡n HÃ ng Gáº§n ÄÃ¢y</h3>
                            <button onclick="setView('admin-orders')" class="text-blue-600 hover:text-blue-800 text-sm">Xem táº¥t cáº£ â†’</button>
                        </div>
                        <div class="space-y-3">
                            ${orders.slice(0, 5).map(order => `
                                <div class="flex justify-between items-center p-3 border rounded-lg hover:bg-gray-50">
                                    <div>
                                        <p class="font-semibold text-gray-900">Order #${order.id.slice(-6).toUpperCase()}</p>
                                        <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-orange-600">${formatCurrency(order.total)}</p>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(order.status)}">
                                            ${getStatusText(order.status)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}

                            ${orders.length === 0 ? '<p class="text-center text-gray-500 py-8">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminOrders() {
            // Load orders management content after a short delay to ensure DOM is ready
            setTimeout(() => {
                renderOrdersManagementList();
            }, 100);

            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-purple-900">ğŸ“‹ Quáº£n LÃ½ ÄÆ¡n HÃ ng</h2>
                        <div class="flex gap-2">
                            <button onclick="loadOrders()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                Táº£i Láº¡i
                            </button>
                        </div>
                    </div>

                    <div id="orders-management-content">
                        <!-- Orders management will be loaded here -->
                        <div class="text-center py-12">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 text-purple-500 animate-spin"></i>
                            <p class="text-gray-600">Äang táº£i Ä‘Æ¡n hÃ ng...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTables() {
            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-teal-900">ğŸ½ï¸ Quáº£n LÃ½ BÃ n Ä‚n</h2>
                        <div class="flex gap-2">
                            <button onclick="openAddTableModalAdmin()" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                ThÃªm BÃ n Má»›i
                            </button>
                        </div>
                    </div>

                    <!-- Thá»‘ng kÃª bÃ n -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">BÃ n Trá»‘ng</p>
                                    <p class="text-3xl font-extrabold text-green-600 mt-1">${tables.filter(t => !t.status || t.status === 'available').length}</p>
                                </div>
                                <i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">BÃ n Äang DÃ¹ng</p>
                                    <p class="text-3xl font-extrabold text-red-600 mt-1">${tables.filter(t => t.status === 'occupied').length}</p>
                                </div>
                                <i data-lucide="users" class="w-8 h-8 text-red-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Tá»•ng Sá»‘ BÃ n</p>
                                    <p class="text-3xl font-extrabold text-blue-600 mt-1">${tables.length}</p>
                                </div>
                                <i data-lucide="table-2" class="w-8 h-8 text-blue-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Danh sÃ¡ch bÃ n -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Danh SÃ¡ch BÃ n Ä‚n</h3>

                        ${tables.length === 0 ? `
                            <div class="text-center py-12">
                                <i data-lucide="table-2" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                <p class="text-gray-500 text-lg">ChÆ°a cÃ³ bÃ n nÃ o</p>
                                <p class="text-gray-400 text-sm mt-2">Click "ThÃªm BÃ n Má»›i" Ä‘á»ƒ báº¯t Ä‘áº§u</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${tables.map(table => `
                                    <div class="bg-white p-4 rounded-lg border-2 ${table.status === 'occupied' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'} shadow-sm hover:shadow-md transition duration-150">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h4 class="text-lg font-bold text-gray-800">BÃ n ${table.tableNumber}</h4>
                                                <span class="text-xs px-2 py-1 rounded-full ${table.status === 'occupied' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${table.status === 'occupied' ? 'ğŸ”´ Äang dÃ¹ng' : 'ğŸŸ¢ Trá»‘ng'}
                                                </span>
                                            </div>
                                            <div class="flex gap-1">
                                                <button onclick="showTableQRAdmin('${table.tableNumber}')" class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Xem QR Code">
                                                    <i data-lucide="qr-code" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="openEditTableModalAdmin('${table.id}', '${table.tableNumber}', '${table.status || 'available'}')" class="p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600" title="Chá»‰nh sá»­a">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="deleteTable('${table.id}')" class="p-2 bg-red-500 text-white rounded hover:bg-red-600" title="XÃ³a bÃ n">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-600">
                                            <p>Táº¡o: ${table.createdAt ? new Date(table.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Add Table Modal for Admin Tables -->
                    <div id="add-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">ğŸ½ï¸ ThÃªm BÃ n Má»›i</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sá»‘ BÃ n</label>
                                <input type="text" id="new-table-number-admin" placeholder="VÃ­ dá»¥: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">CÃ³ thá»ƒ dÃ¹ng sá»‘ hoáº·c chá»¯ cÃ¡i</p>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeAddTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                                <button onclick="addTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">ThÃªm BÃ n</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Table Modal for Admin Tables -->
                    <div id="edit-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">âœï¸ Chá»‰nh Sá»­a BÃ n</h3>

                            <input type="hidden" id="edit-table-id-admin">

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sá»‘ BÃ n</label>
                                <input type="text" id="edit-table-number-admin" placeholder="VÃ­ dá»¥: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">CÃ³ thá»ƒ dÃ¹ng sá»‘ hoáº·c chá»¯ cÃ¡i</p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tráº¡ng ThÃ¡i</label>
                                <select id="edit-table-status-admin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                    <option value="available">ğŸŸ¢ Trá»‘ng</option>
                                    <option value="occupied">ğŸ”´ Äang dÃ¹ng</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                                <button onclick="updateTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Cáº­p Nháº­t</button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Modal for Admin Tables -->
                    <div id="qr-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-teal-600">ğŸ“± QR Code BÃ n</h3>
                                <button onclick="closeQRTableModalAdmin()" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>

                            <div id="qr-table-info-admin" class="mb-4 text-center">
                                <!-- Table info will be inserted here -->
                            </div>

                            <div id="qr-table-code-container-admin" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                                <!-- QR Code will be generated here -->
                            </div>

                            <div class="flex gap-3">
                                <button onclick="downloadTableQRAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Táº£i Xuá»‘ng
                                </button>
                                <button onclick="closeQRTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ÄÃ³ng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTrash() {
            // Lá»c items Ä‘Ã£ xÃ³a vÃ  sáº¯p xáº¿p theo thá»i gian xÃ³a (má»›i nháº¥t trÆ°á»›c)
            const deletedItems = menuItems
                .filter(item => item.status === 'deleted')
                .sort((a, b) => {
                    const timeA = a.deletedAt?.seconds || 0;
                    const timeB = b.deletedAt?.seconds || 0;
                    return timeB - timeA;
                });

            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">ğŸ—‘ï¸ ThÃ¹ng RÃ¡c</h2>
                        <div class="text-sm text-gray-600">
                            ${deletedItems.length} mÃ³n Ä‘Ã£ xÃ³a
                        </div>
                    </div>

                    <!-- ThÃ´ng bÃ¡o -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0"></i>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-800">ThÃ´ng tin vá» thÃ¹ng rÃ¡c</h4>
                                <div class="mt-1 text-sm text-yellow-700">
                                    <p>â€¢ CÃ¡c mÃ³n Ä‘Ã£ xÃ³a sáº½ Ä‘Æ°á»£c lÆ°u trong thÃ¹ng rÃ¡c 30 ngÃ y</p>
                                    <p>â€¢ Sau 30 ngÃ y, mÃ³n sáº½ Ä‘Æ°á»£c xÃ³a vÄ©nh viá»…n tá»± Ä‘á»™ng</p>
                                    <p>â€¢ Báº¡n cÃ³ thá»ƒ khÃ´i phá»¥c hoáº·c xÃ³a vÄ©nh viá»…n mÃ³n báº¥t ká»³ lÃºc nÃ o</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Danh sÃ¡ch items Ä‘Ã£ xÃ³a -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">MÃ³n Ä‘Ã£ xÃ³a</h3>

                            ${deletedItems.length === 0 ? `
                                <div class="text-center py-12">
                                    <i data-lucide="trash-2" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                    <p class="text-gray-500 text-lg">ThÃ¹ng rÃ¡c trá»‘ng</p>
                                    <p class="text-gray-400 text-sm mt-2">KhÃ´ng cÃ³ mÃ³n nÃ o Ä‘Ã£ xÃ³a</p>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${deletedItems.map(item => {
                                        const deletedDate = item.deletedAt ? new Date(item.deletedAt.seconds * 1000) : new Date();
                                        const daysSinceDeleted = Math.floor((Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24));
                                        const daysUntilAutoDelete = 30 - daysSinceDeleted;

                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-3 mb-2">
                                                            <h4 class="font-semibold text-gray-900">${item.name}</h4>
                                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">${item.category}</span>
                                                            ${daysUntilAutoDelete <= 7 ? `<span class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full">XÃ³a sau ${daysUntilAutoDelete} ngÃ y</span>` : ''}
                                                        </div>
                                                        <p class="text-sm text-gray-600 mb-2">${item.description}</p>
                                                        <div class="text-sm text-gray-500">
                                                            <p>GiÃ¡: ${formatCurrency(item.price)} ${item.newPrice ? `(Má»›i: ${formatCurrency(item.newPrice)})` : ''}</p>
                                                            <p>XÃ³a: ${deletedDate.toLocaleString('vi-VN')} (${daysSinceDeleted} ngÃ y trÆ°á»›c)</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2 ml-4">
                                                        <button onclick="restoreItem('${item.id}')" class="px-3 py-1.5 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition duration-150" title="KhÃ´i phá»¥c">
                                                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="permanentDeleteItem('${item.id}')" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition duration-150" title="XÃ³a vÄ©nh viá»…n">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminMenu() {
            const itemToEdit = menuItems.find(i => i.id === (document.getElementById('admin-form-id')?.value || null));

            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-orange-900">ğŸ½ï¸ Quáº£n LÃ½ Menu</h2>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('category-modal-admin').classList.remove('hidden'); document.getElementById('new-category-name-admin').focus()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                                <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                ThÃªm Danh Má»¥c
                            </button>
                        </div>
                    </div>

                    <!-- Danh má»¥c -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-indigo-900 mb-4">ğŸ“‚ Danh Má»¥c MÃ³n Ä‚n</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            ${categories.map((cat, index) => `
                                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${getCategoryIcon(cat)}</span>
                                        <span class="font-medium text-gray-800">${cat}</span>
                                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">
                                            ${menuItems.filter(item => item.category === cat && item.status !== 'deleted').length} mÃ³n
                                        </span>
                                    </div>
                                    ${index >= 3 ? `
                                        <div class="flex gap-1">
                                            <button onclick="openEditCategoryModalAdmin('${cat}')" class="text-blue-600 hover:text-blue-800 p-1" title="Sá»­a">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 p-1" title="XÃ³a">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-sm text-gray-600">
                            <strong>LÆ°u Ã½:</strong> 3 danh má»¥c Ä‘áº§u tiÃªn (Äá»“ Uá»‘ng, Äá»“ Ä‚n, Äá»“ Nháº­u) khÃ´ng thá»ƒ xÃ³a. CÃ¡c danh má»¥c khÃ¡c cÃ³ thá»ƒ sá»­a/xÃ³a.
                        </div>
                    </div>

                    <!-- Form thÃªm/sá»­a mÃ³n -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-orange-900 mb-4">${itemToEdit ? 'âœï¸ Chá»‰nh Sá»­a MÃ³n' : 'â• ThÃªm MÃ³n Má»›i'}</h3>
                        <form id="admin-item-form" onsubmit="event.preventDefault(); handleSaveItem()">
                            <input type="hidden" id="admin-form-id" value="${itemToEdit ? itemToEdit.id : ''}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">TÃªn MÃ³n</label>
                                    <input type="text" id="admin-form-name" required value="${itemToEdit ? itemToEdit.name : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">GiÃ¡ CÅ© (VNÄ)</label>
                                    <input type="number" id="admin-form-price" required value="${itemToEdit ? itemToEdit.price : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">GiÃ¡ Má»›i (VNÄ) <span class="text-xs text-gray-500">(KhÃ´ng báº¯t buá»™c)</span></label>
                                    <input type="number" id="admin-form-new-price" value="${itemToEdit ? itemToEdit.newPrice || '' : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Danh Má»¥c</label>
                                    <select id="admin-form-category" required class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        ${categories.map(cat => `<option value="${cat}" ${itemToEdit && itemToEdit.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tráº¡ng ThÃ¡i</label>
                                    <select id="admin-form-status" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        <option value="active" ${!itemToEdit || itemToEdit.status === 'active' ? 'selected' : ''}>âœ… Äang bÃ¡n</option>
                                        <option value="hot" ${itemToEdit && itemToEdit.status === 'hot' ? 'selected' : ''}>ğŸ”¥ BÃ¡n cháº¡y</option>
                                        <option value="new" ${itemToEdit && itemToEdit.status === 'new' ? 'selected' : ''}>ğŸ†• MÃ³n má»›i</option>
                                        <option value="sale" ${itemToEdit && itemToEdit.status === 'sale' ? 'selected' : ''}>ğŸ’° Sale</option>
                                        <option value="best_seller" ${itemToEdit && itemToEdit.status === 'best_seller' ? 'selected' : ''}>â­ Best Seller</option>
                                        <option value="out_of_stock" ${itemToEdit && itemToEdit.status === 'out_of_stock' ? 'selected' : ''}>âŒ Háº¿t hÃ ng</option>
                                        <option value="coming_soon" ${itemToEdit && itemToEdit.status === 'coming_soon' ? 'selected' : ''}>â³ Sáº¯p cÃ³</option>
                                        <option value="deleted" ${itemToEdit && itemToEdit.status === 'deleted' ? 'selected' : ''}>ğŸ—‘ï¸ ÄÃ£ xÃ³a</option>
                                    </select>
                                </div>

                                <div id="size-field" style="display: ${itemToEdit && itemToEdit.category === 'Äá»“ Uá»‘ng' ? 'block' : 'none'};">
                                    <label class="block text-sm font-medium text-gray-700">Size (Äá»“ Uá»‘ng)</label>
                                    <select id="admin-form-size" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        <option value="" ${!itemToEdit || !itemToEdit.size ? 'selected' : ''}>KhÃ´ng chá»n size</option>
                                        ${drinkSizes.map(size => `<option value="${size}" ${itemToEdit && itemToEdit.size === size ? 'selected' : ''}>${size}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">áº¢nh</label>
                                    <input type="file" id="admin-form-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                    <p class="mt-1 text-xs text-gray-500">Hoáº·c nháº­p URL trá»±c tiáº¿p:</p>
                                    <input type="url" id="admin-form-image" value="${itemToEdit ? itemToEdit.imageUrl : ''}" placeholder="https://..." class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                            </div>

                            <!-- Price Preview -->
                            <div id="admin-price-preview" class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200" style="display: none;">
                                <div class="text-sm text-amber-800">
                                    <strong>Preview hiá»ƒn thá»‹:</strong><br>
                                    <span id="admin-price-preview-text"></span>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">MÃ´ Táº£</label>
                                <textarea id="admin-form-description" rows="2" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">${itemToEdit ? itemToEdit.description : ''}</textarea>
                            </div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" onclick="clearAdminForm()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Há»§y/ThÃªm Má»›i</button>
                                <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md shadow-lg text-sm font-medium hover:bg-orange-700">
                                    ${itemToEdit ? 'Cáº­p Nháº­t MÃ³n' : 'ThÃªm MÃ³n'}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Danh sÃ¡ch mÃ³n -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-amber-900 mb-4">ğŸ“‹ Danh SÃ¡ch MÃ³n Ä‚n/Äá»“ Uá»‘ng (${menuItems.length})</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-amber-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TÃªn MÃ³n</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Danh Má»¥c</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tráº¡ng ThÃ¡i</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GiÃ¡</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Thao TÃ¡c</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${menuItems.map(item => `
                                        <tr class="${item.status === 'deleted' ? 'bg-gray-100' : ''}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-amber-900">${item.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${item.size || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(item.status) || '<span class="text-green-600">âœ… Äang bÃ¡n</span>'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600 font-semibold">
                                                ${item.newPrice ?
                                                    (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                        formatCurrency(item.newPrice) :
                                                        `${formatCurrency(item.price)} â†’ ${formatCurrency(item.newPrice)}`
                                                    ) :
                                                    formatCurrency(item.price)
                                                }
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                <button onclick="openPriceModal('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-2">ğŸ’°</button>
                                                <button onclick="loadItemForEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-900">Sá»­a</button>
                                                <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-900 ml-2">XÃ³a</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Category Modal for Admin Menu -->
                    <div id="category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">â• ThÃªm Danh Má»¥c Má»›i</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">TÃªn Danh Má»¥c</label>
                                <input type="text" id="new-category-name-admin" placeholder="VÃ­ dá»¥: Äá»“ Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                                <button onclick="addNewCategoryAdmin()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ThÃªm</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Category Modal for Admin Menu -->
                    <div id="edit-category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">âœï¸ Sá»­a Danh Má»¥c</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">TÃªn Danh Má»¥c</label>
                                <input type="text" id="edit-category-name-admin" placeholder="VÃ­ dá»¥: Äá»“ Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                                <button onclick="updateCategoryAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Cáº­p Nháº­t</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeCategoryModalAdmin() {
            document.getElementById('category-modal-admin').classList.add('hidden');
            document.getElementById('new-category-name-admin').value = '';
        }

        async function addNewCategoryAdmin() {
            const categoryName = document.getElementById('new-category-name-admin').value.trim();
            if (!categoryName) {
                showMessage("Vui lÃ²ng nháº­p tÃªn danh má»¥c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh má»¥c nÃ y Ä‘Ã£ tá»“n táº¡i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ÄÃ£ thÃªm danh má»¥c: ${categoryName}`, "success");
            closeCategoryModalAdmin();
            renderApp(); // Re-render Ä‘á»ƒ cáº­p nháº­t menu selection
        }

        // ==================== TRASH MANAGEMENT ====================

        async function restoreItem(id) {
            if (!confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n khÃ´i phá»¥c mÃ³n nÃ y?")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'active',
                    deletedAt: null,
                    updatedAt: new Date()
                });
                console.log("âœ… KhÃ´i phá»¥c mÃ³n thÃ nh cÃ´ng");
                showMessage("ÄÃ£ khÃ´i phá»¥c mÃ³n!", "success");
            } catch (e) {
                console.error("âŒ Lá»—i khi khÃ´i phá»¥c mÃ³n:", e);
                showMessage("Lá»—i khi khÃ´i phá»¥c mÃ³n: " + e.message, "error");
            }
        }

        async function permanentDeleteItem(id) {
            if (!confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A VÄ¨NH VIá»„N mÃ³n nÃ y? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!")) return;
            try {
                await deleteDoc(doc(db, PUBLIC_DATA_PATH, id));
                console.log("âœ… XÃ³a vÄ©nh viá»…n mÃ³n thÃ nh cÃ´ng");
                showMessage("ÄÃ£ xÃ³a vÄ©nh viá»…n mÃ³n!", "success");
            } catch (e) {
                console.error("âŒ Lá»—i khi xÃ³a vÄ©nh viá»…n mÃ³n:", e);
                showMessage("Lá»—i khi xÃ³a vÄ©nh viá»…n mÃ³n: " + e.message, "error");
            }
        }

        // Auto-cleanup deleted items after 30 days
        async function cleanupExpiredItems() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            try {
                const expiredItems = menuItems.filter(item =>
                    item.status === 'deleted' &&
                    item.deletedAt &&
                    new Date(item.deletedAt.seconds * 1000) < thirtyDaysAgo
                );

                if (expiredItems.length > 0) {
                    console.log(`ğŸ—‘ï¸ Auto-deleting ${expiredItems.length} expired items`);
                    for (const item of expiredItems) {
                        await deleteDoc(doc(db, PUBLIC_DATA_PATH, item.id));
                    }
                    console.log("âœ… Auto-cleanup completed");
                }
            } catch (error) {
                console.error("âŒ Error during auto-cleanup:", error);
            }
        }

        let editingCategoryAdmin = null;

        function openEditCategoryModalAdmin(categoryName) {
            editingCategoryAdmin = categoryName;
            document.getElementById('edit-category-name-admin').value = categoryName;
            document.getElementById('edit-category-modal-admin').classList.remove('hidden');
        }

        function closeEditCategoryModalAdmin() {
            document.getElementById('edit-category-modal-admin').classList.add('hidden');
            document.getElementById('edit-category-name-admin').value = '';
            editingCategoryAdmin = null;
        }

        async function updateCategoryAdmin() {
            const newName = document.getElementById('edit-category-name-admin').value.trim();
            if (!newName) {
                showMessage("Vui lÃ²ng nháº­p tÃªn danh má»¥c!", "error");
                return;
            }

            if (newName !== editingCategoryAdmin && categories.includes(newName)) {
                showMessage("Danh má»¥c nÃ y Ä‘Ã£ tá»“n táº¡i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategoryAdmin);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategoryAdmin) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ÄÃ£ cáº­p nháº­t danh má»¥c: ${editingCategoryAdmin} â†’ ${newName}`, "success");
                closeEditCategoryModalAdmin();
                renderApp();
            }
        }

        function openAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.remove('hidden');
            document.getElementById('new-table-number-admin').focus();
        }

        function closeAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.add('hidden');
            document.getElementById('new-table-number-admin').value = '';
        }

        async function addTableAdmin() {
            const tableNumber = document.getElementById('new-table-number-admin').value.trim();

            if (!tableNumber) {
                showMessage("Vui lÃ²ng nháº­p sá»‘ bÃ n!", "error");
                return;
            }

            // Kiá»ƒm tra trÃ¹ng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`BÃ n ${tableNumber} Ä‘Ã£ tá»“n táº¡i!`, "error");
                return;
            }

            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await addDoc(collection(db, 'tables'), tableData);

                showMessage(`âœ… ÄÃ£ thÃªm BÃ n ${tableNumber}`, "success");
                closeAddTableModalAdmin();

            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("Lá»—i thÃªm bÃ n: " + error.message, "error");
            }
        }

        function openEditTableModalAdmin(tableId, tableNumber, status) {
            document.getElementById('edit-table-id-admin').value = tableId;
            document.getElementById('edit-table-number-admin').value = tableNumber;
            document.getElementById('edit-table-status-admin').value = status;
            document.getElementById('edit-table-modal-admin').classList.remove('hidden');
        }

        function closeEditTableModalAdmin() {
            document.getElementById('edit-table-modal-admin').classList.add('hidden');
            document.getElementById('edit-table-id-admin').value = '';
            document.getElementById('edit-table-number-admin').value = '';
            document.getElementById('edit-table-status-admin').value = 'available';
        }

        async function updateTableAdmin() {
            const tableId = document.getElementById('edit-table-id-admin').value;
            const newTableNumber = document.getElementById('edit-table-number-admin').value.trim();
            const newStatus = document.getElementById('edit-table-status-admin').value;

            if (!newTableNumber) {
                showMessage("Vui lÃ²ng nháº­p sá»‘ bÃ n!", "error");
                return;
            }

            // Kiá»ƒm tra trÃ¹ng (trá»« bÃ n hiá»‡n táº¡i)
            const currentTable = tables.find(t => t.id === tableId);
            if (tables.some(t => t.tableNumber === newTableNumber && t.id !== tableId)) {
                showMessage(`BÃ n ${newTableNumber} Ä‘Ã£ tá»“n táº¡i!`, "error");
                return;
            }

            try {
                await updateDoc(doc(db, 'tables', tableId), {
                    tableNumber: newTableNumber,
                    status: newStatus,
                    updatedAt: new Date()
                });

                showMessage(`âœ… ÄÃ£ cáº­p nháº­t BÃ n ${newTableNumber}`, "success");
                closeEditTableModalAdmin();

            } catch (error) {
                console.error("Error updating table:", error);
                showMessage("Lá»—i cáº­p nháº­t bÃ n: " + error.message, "error");
            }
        }

        function showTableQRAdmin(tableNumber) {
            const modal = document.getElementById('qr-table-modal-admin');
            const qrContainer = document.getElementById('qr-table-code-container-admin');
            const tableInfo = document.getElementById('qr-table-info-admin');

            // Clear previous QR
            qrContainer.innerHTML = '';

            // Táº¡o URL vá»›i table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;

            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">BÃ n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">QuÃ©t QR code nÃ y Ä‘á»ƒ vÃ o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeQRTableModalAdmin() {
            document.getElementById('qr-table-modal-admin').classList.add('hidden');
        }

        function downloadTableQRAdmin() {
            const qrCanvas = document.querySelector('#qr-table-code-container-admin canvas');
            if (!qrCanvas) return;

            const tableNumber = document.querySelector('#qr-table-info-admin .text-teal-600').textContent;

            const link = document.createElement('a');
            link.download = `QR-Ban-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }

        function clearAdminForm() {
            document.getElementById('admin-item-form').reset();
            document.getElementById('admin-form-id').value = '';
            // Hide price preview
            const previewDiv = document.getElementById('admin-price-preview');
            if (previewDiv) {
                previewDiv.style.display = 'none';
            }
            renderApp(); // Force re-render Ä‘á»ƒ cáº­p nháº­t tiÃªu Ä‘á» form
        }
        
        function loadItemForEdit(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                document.getElementById('admin-form-id').value = item.id;
                document.getElementById('admin-form-name').value = item.name;
                document.getElementById('admin-form-price').value = item.price;
                document.getElementById('admin-form-new-price').value = item.newPrice || '';
                document.getElementById('admin-form-category').value = item.category;
                document.getElementById('admin-form-status').value = item.status || 'active';
                document.getElementById('admin-form-size').value = item.size || '';
                document.getElementById('admin-form-image').value = item.imageUrl || '';
                document.getElementById('admin-form-description').value = item.description || '';

                // Update price preview
                updateAdminPricePreview();

                // Show/hide size field based on category
                toggleSizeField(item.category);

                renderApp(); // Force re-render Ä‘á»ƒ cáº­p nháº­t tiÃªu Ä‘á» form
            }
        }

        function toggleSizeField(category) {
            const sizeField = document.getElementById('size-field');
            if (sizeField) {
                sizeField.style.display = category === 'Äá»“ Uá»‘ng' ? 'block' : 'none';
            }
        }

        function updateAdminPricePreview() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');
            const previewDiv = document.getElementById('admin-price-preview');
            const previewText = document.getElementById('admin-price-preview-text');

            if (!oldPriceInput || !newPriceInput || !previewDiv || !previewText) return;

            const oldPrice = parseFloat(oldPriceInput.value);
            const newPrice = parseFloat(newPriceInput.value);

            if (newPriceInput.value && !isNaN(newPrice) && newPrice > 0) {
                previewDiv.style.display = 'block';
                if (newPrice >= oldPrice) {
                    // GiÃ¡ má»›i >= giÃ¡ cÅ©: chá»‰ hiá»‡n giÃ¡ má»›i
                    previewText.innerHTML = `Chá»‰ hiá»‡n: ${formatCurrency(newPrice)}`;
                } else {
                    // GiÃ¡ má»›i < giÃ¡ cÅ©: gáº¡ch giÃ¡ cÅ©, hiá»‡n giÃ¡ má»›i
                    previewText.innerHTML = `Gáº¡ch ${formatCurrency(oldPrice)} â†’ ${formatCurrency(newPrice)}`;
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function setupAdminPricePreviewListeners() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');

            if (oldPriceInput && newPriceInput) {
                oldPriceInput.addEventListener('input', updateAdminPricePreview);
                newPriceInput.addEventListener('input', updateAdminPricePreview);
            }
        }

        // Add event listener for category change
        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('admin-form-category');
            if (categorySelect) {
                categorySelect.addEventListener('change', function(e) {
                    toggleSizeField(e.target.value);
                });
            }
        });
        
        function handleSaveItem() {
            const newPriceValue = document.getElementById('admin-form-new-price').value.trim();
            const item = {
                id: document.getElementById('admin-form-id').value,
                name: document.getElementById('admin-form-name').value,
                price: parseFloat(document.getElementById('admin-form-price').value),
                category: document.getElementById('admin-form-category').value,
                status: document.getElementById('admin-form-status').value,
                size: document.getElementById('admin-form-size').value || null,
                imageUrl: document.getElementById('admin-form-image').value,
                description: document.getElementById('admin-form-description').value,
            };

            // Add newPrice if provided
            if (newPriceValue && parseFloat(newPriceValue) > 0) {
                item.newPrice = parseFloat(newPriceValue);
            }

            saveItem(item);
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showMessage("Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!", "error");
                return;
            }

            if (newPassword.length < 6) {
                showMessage("Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!", "error");
                return;
            }

            const success = await changePassword(currentPassword, newPassword);
            if (success) {
                document.getElementById('change-password-form').reset();
            }
        }


        function renderMainContent() {
            switch (currentView) {
                case 'login':
                    return renderLoginView();
                case 'admin-stats':
                    return isAdmin ? renderAdminStats() : renderLoginView();
                case 'admin-orders':
                    return isAdmin ? renderAdminOrders() : renderLoginView();
                case 'admin-tables':
                    return isAdmin ? renderAdminTables() : renderLoginView();
                case 'admin-menu':
                    return isAdmin ? renderAdminMenu() : renderLoginView();
                case 'admin-trash':
                    return isAdmin ? renderAdminTrash() : renderLoginView();
                case 'customer':
                default:
                    const menuHtml = currentCategory === 'Äá»“ Uá»‘ng'
                        ? `<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4">${renderCustomerMenu()}</div>`
                        : `<div class="max-w-7xl mx-auto">${renderCustomerMenu()}</div>`;

                    return `
                        ${renderMenuSelection()}
                        <main class="bg-amber-50">
                            ${menuHtml}
                        </main>
                    `;
            }
        }
        
        function renderCartSidebar() {
            const itemsInCart = Object.values(cart);
            const total = itemsInCart.reduce((sum, entry) => sum + (entry.item.price * entry.quantity), 0);
            const cartClasses = Object.keys(cart).length === 0 
                ? 'translate-x-full' // áº¨n khi khÃ´ng cÃ³ mÃ³n
                : ''; // Giá»¯ tráº¡ng thÃ¡i áº©n/hiá»‡n dá»±a trÃªn click

            return `
                <!-- Ná»n Ä‘en má» (overlay) - click Ä‘á»ƒ Ä‘Ã³ng giá» hÃ ng -->
                <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity duration-300 hidden" onclick="closeCart()"></div>
            
                <div id="cart-sidebar" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white shadow-2xl z-[60] transform transition-transform duration-300 translate-x-full">
                    <div class="flex justify-between items-center p-4 border-b border-amber-200 bg-amber-50">
                        <h3 class="text-xl font-bold text-amber-900 flex items-center">
                            <i data-lucide="shopping-basket" class="w-6 h-6 mr-2"></i> Giá» HÃ ng
                            ${Object.keys(cart).length > 0 ? `<span class="ml-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full">${Object.values(cart).reduce((sum, item) => sum + item.quantity, 0)}</span>` : ''}
                        </h3>
                        <button onclick="closeCart()" class="p-2 rounded-full hover:bg-gray-100 text-amber-800">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="p-4 overflow-y-auto h-[calc(100%-140px)]">
                        ${itemsInCart.length > 0 ? itemsInCart.map(entry => `
                            <div class="flex items-center justify-between py-3 border-b border-dashed border-amber-100">
                                <div class="flex-grow pr-4">
                                    <p class="font-semibold text-amber-900">${entry.item.name}</p>
                                    <p class="text-sm text-orange-600">${formatCurrency(entry.item.price)} x ${entry.quantity}</p>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <button onclick="updateCart('${entry.item.id}', -1)" class="p-1 text-sm bg-amber-200 rounded-full hover:bg-amber-300 transition duration-150">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span class="w-6 text-center text-amber-900 font-medium">${entry.quantity}</span>
                                    <button onclick="updateCart('${entry.item.id}', 1)" class="p-1 text-sm bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 mt-10">Giá» hÃ ng trá»‘ng.</p>'}
                    </div>
                    
                    <div class="absolute bottom-0 w-full p-4 border-t border-amber-300 bg-white">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-lg font-bold text-amber-900">Tá»•ng Cá»™ng:</p>
                            <p class="text-2xl font-extrabold text-red-600">${formatCurrency(total)}</p>
                        </div>
                         <button class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition duration-150 shadow-lg" onclick="handleOrder()">
                             <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order
                         </button>
                    </div>
                </div>
            `;
        }

          function disableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = true;
                  button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i> Äang xá»­ lÃ½...';
              }
          }

          function enableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = false;
                  button.innerHTML = '<i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order';
                  renderLucideIcons();
              }
          }

          async function handleOrder() {
              const total = Object.values(cart).reduce((sum, entry) => sum + (entry.item.price * entry.quantity), 0);

              if (total === 0) {
                  showMessage("Giá» hÃ ng trá»‘ng! Vui lÃ²ng chá»n mÃ³n.", 'warning');
                  return;
              }

              // Kiá»ƒm tra table number - náº¿u chÆ°a cÃ³ thÃ¬ hiá»‡n modal chá»n bÃ n
              if (!currentTableNumber) {
                  showTableSelectionModal();
                  return;
              }

              // Hiá»ƒn thá»‹ confirm dialog
              const itemsInCart = Object.values(cart);
              const confirmMessage = `Báº¡n cÃ³ muá»‘n Ä‘áº·t hÃ ng vá»›i ${itemsInCart.length} mÃ³n vÃ  tá»•ng tiá»n ${formatCurrency(total)} khÃ´ng?`;
              if (!confirm(confirmMessage)) {
                  return; // User canceled
              }

              // Disable order button to prevent multiple clicks
              disableOrderButton();

              try {
                  // Táº¡o order object
                  const orderItems = Object.values(cart).map(entry => ({
                      id: entry.item.id,
                      name: entry.item.name,
                      price: entry.item.price,
                      quantity: entry.quantity,
                      size: entry.item.size || null,
                      category: entry.item.category
                  }));

                  const orderData = {
                      items: orderItems,
                      total: total,
                      status: 'ordered', // ordered, confirmed, preparing, ready, completed, cancelled, updated
                      customerId: userId,
                      customerEmail: auth.currentUser?.email || 'anonymous',
                      tableNumber: currentTableNumber || null, // Sá»‘ bÃ n (náº¿u order tá»« QR code)
                      createdAt: new Date(),
                      updatedAt: new Date()
                  };

                  // LÆ°u order vÃ o Firestore
                  const docRef = await addDoc(collection(db, 'orders'), orderData);

                  showMessage(`ğŸ‰ ÄÃ£ Ä‘áº·t hÃ ng thÃ nh cÃ´ng! MÃ£ Ä‘Æ¡n: #${docRef.id.slice(-6).toUpperCase()}`, 'success');

                  // TTS
                  speak(`Cáº£m Æ¡n báº¡n. ÄÆ¡n hÃ ng trá»‹ giÃ¡ ${total.toLocaleString('vi-VN')} Ä‘á»“ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh cÃ´ng. MÃ£ Ä‘Æ¡n hÃ ng lÃ  ${docRef.id.slice(-6).toUpperCase()}.`);

                  // LÆ°u order vÃ o session cho khÃ¡ch hÃ ng (náº¿u lÃ  guest)
                  if (userRole === 'guest' && currentSessionId) {
                      const guestOrderData = {
                          orderId: docRef.id,
                          shortId: docRef.id.slice(-6).toUpperCase(),
                          items: orderItems,
                          total: total,
                          status: 'ordered',
                          tableNumber: currentTableNumber,
                          createdAt: orderData.createdAt,
                          updatedAt: orderData.updatedAt
                      };
                      guestOrders.push(guestOrderData);
                      saveSessionToCookie();
                  }

                  // ÄÃ³ng cart vÃ  xÃ³a giá» hÃ ng
                  document.getElementById('cart-sidebar').classList.add('translate-x-full');
                  cart = {};
                  localStorage.removeItem('cart');
                  renderApp();

              } catch (error) {
                  console.error("Error creating order:", error);
                  showMessage("Lá»—i khi Ä‘áº·t hÃ ng: " + error.message, "error");
              } finally {
                  // Always re-enable button regardless of success/failure
                  enableOrderButton();
              }
          }

          // ==================== ORDER MANAGEMENT (ADMIN) ====================
          
          let currentOrderFilter = 'ordered'; // ordered, preparing, completed, cancelled, all, today
          let currentDateFilter = 'today'; // today, all
          let currentPage = 1;
          let itemsPerPage = 5; // Default 10 items per page
          let processingOrderId = localStorage.getItem('processingOrderId'); // Láº¥y tá»« storage náº¿u reload

          // Setup realtime listener cho orders
          function setupOrdersListener() {
              if (!db) {
                  console.error("Database not initialized");
                  return;
              }

              try {
                  console.log("ğŸ“¡ Setting up orders realtime listener...");
                  const ordersRef = collection(db, 'orders');
                  
                  onSnapshot(ordersRef, (snapshot) => {
                      orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      console.log("ğŸ“‹ Orders updated:", orders.length);
                      
                      // --- LOGIC Tá»° Äá»˜NG CHUYá»‚N TAB VÃ€ TRáº NG THÃI ---
                      if (isAdmin) {
                           // 1. Kiá»ƒm tra Ä‘Æ¡n hÃ ng Ä‘ang lÃ m (processingOrderId)
                           if (processingOrderId) {
                               const processingOrder = orders.find(o => o.id === processingOrderId);
                               
                               // Náº¿u Ä‘Æ¡n váº«n Ä‘ang lÃ m ('preparing') -> Giá»¯ mÃ n hÃ¬nh á»Ÿ tab 'preparing'
                               if (processingOrder && processingOrder.status === 'preparing') {
                                   if (currentOrderFilter !== 'preparing') {
                                       currentOrderFilter = 'preparing';
                                   }
                               } 
                               // Náº¿u Ä‘Æ¡n Ä‘Ã£ xong hoáº·c há»§y -> XÃ³a tráº¡ng thÃ¡i Ä‘ang lÃ m
                               else {
                                   processingOrderId = null;
                                   localStorage.removeItem('processingOrderId');
                                   
                                   // Náº¿u vá»«a xong Ä‘Æ¡n lÃ m, kiá»ƒm tra xem cÃ³ Ä‘Æ¡n chá» nÃ o khÃ´ng Ä‘á»ƒ chuyá»ƒn vá» tab ordered
                                   const hasPendingOrders = orders.some(o => o.status === 'ordered');
                                   if (hasPendingOrders && currentOrderFilter !== 'ordered') {
                                       currentOrderFilter = 'ordered';
                                   }
                               }
                           }
                           
                           // 2. Logic khi cÃ³ Ä‘Æ¡n má»›i
                           snapshot.docChanges().forEach(change => {
                               if (change.type === 'added') {
                                   const order = change.doc.data();
                                   if (order.status === 'ordered') {
                                       showMessage(`ğŸ”” ÄÆ¡n hÃ ng má»›i: #${change.doc.id.slice(-6).toUpperCase()}`, 'info');
                                       speak(`CÃ³ Ä‘Æ¡n hÃ ng má»›i`);
                                       
                                       // Náº¾U KHÃ”NG ÄANG LÃ€M ÄÆ N NÃ€O -> Tá»± Ä‘á»™ng chuyá»ƒn sang tab chá» nháº­n
                                       if (!processingOrderId && currentOrderFilter !== 'ordered') {
                                           currentOrderFilter = 'ordered';
                                       }
                                   }
                               }
                           });
                      }

                      // Re-render header Ä‘á»ƒ cáº­p nháº­t badge
                      if (isAdmin) {
                          document.getElementById('header-container').innerHTML = renderHeader();
                          renderLucideIcons();
                      }
                      
                      // Render náº¿u Ä‘ang á»Ÿ trang admin orders
                      if (currentView === 'admin-orders') {
                          renderOrdersManagementList();
                      }
                      
                      // Cáº­p nháº­t guest orders náº¿u cÃ³ thay Ä‘á»•i
                      snapshot.docChanges().forEach(change => {
                          if (userRole === 'guest' && change.type === 'modified') {
                              const orderData = change.doc.data();
                              const guestOrder = guestOrders.find(o => o.orderId === change.doc.id);
                              if (guestOrder) {
                                  guestOrder.status = orderData.status;
                                  guestOrder.updatedAt = orderData.updatedAt;
                                  saveSessionToCookie();
                                  console.log('ğŸ“ Guest order updated:', guestOrder);
                              }
                          }
                      });
                  }, (error) => {
                      console.error("Error in orders listener:", error);
                  });
                  
              } catch (error) {
                  console.error("Error setting up orders listener:", error);
              }
          }
          
          // Setup máº·c Ä‘á»‹nh cho trang quáº£n lÃ½ Ä‘Æ¡n hÃ ng
          function setupOrdersPage() {
              currentOrderFilter = 'ordered'; // Máº·c Ä‘á»‹nh hiá»ƒn thá»‹ Ä‘Æ¡n chá»
              currentDateFilter = 'today';
          }
          
          function setOrderFilter(filter) {
              currentOrderFilter = filter;
              renderOrdersManagementList();
          }
          
          function setDateFilter(filter) {
              currentDateFilter = filter;
              currentPage = 1; // Reset to first page when changing filters
              renderOrdersManagementList();
          }

          function setItemsPerPage(count) {
              itemsPerPage = parseInt(count);
              currentPage = 1; // Reset to first page when changing items per page
              renderOrdersManagementList();
          }

          function setPage(page) {
              currentPage = page;
              renderOrdersManagementList();
          }

          function nextPage() {
              const totalPages = Math.ceil(getFilteredOrders().length / itemsPerPage);
              if (currentPage < totalPages) {
                  currentPage++;
                  renderOrdersManagementList();
              }
          }

          function prevPage() {
              if (currentPage > 1) {
                  currentPage--;
                  renderOrdersManagementList();
              }
          }

          function getFilteredOrders() {
              // Filter orders
              let filteredOrders = [...orders];

              // Filter theo date
              if (currentDateFilter === 'today') {
                  const today = new Date();
                  today.setHours(0, 0, 0, 0);
                  filteredOrders = filteredOrders.filter(order => {
                      if (!order.createdAt) return false;
                      const orderDate = new Date(order.createdAt.seconds * 1000);
                      orderDate.setHours(0, 0, 0, 0);
                      return orderDate.getTime() === today.getTime();
                  });
              }

              // Filter theo status
              if (currentOrderFilter !== 'all') {
                  filteredOrders = filteredOrders.filter(order => order.status === currentOrderFilter);
              }

              // Sort: Æ°u tiÃªn Ä‘Æ¡n chá» (ordered) lÃªn Ä‘áº§u, sau Ä‘Ã³ theo thá»i gian má»›i nháº¥t
              filteredOrders.sort((a, b) => {
                  // Æ¯u tiÃªn ordered
                  if (a.status === 'ordered' && b.status !== 'ordered') return -1;
                  if (a.status !== 'ordered' && b.status === 'ordered') return 1;

                  // Sau Ä‘Ã³ preparing
                  if (a.status === 'preparing' && b.status !== 'preparing' && b.status !== 'ordered') return -1;
                  if (a.status !== 'preparing' && b.status === 'preparing') return 1;

                  // Cuá»‘i cÃ¹ng theo thá»i gian
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  return timeB - timeA;
              });

              return filteredOrders;
          }

          function renderOrdersManagementList() {
              const container = document.getElementById('orders-management-content');
              if (!container) {
                  console.log('Container not found, skipping render');
                  return;
              }

              const filteredOrders = getFilteredOrders();

              // Count theo status (táº¥t cáº£ orders, khÃ´ng filter)
              const counts = {
                  ordered: orders.filter(o => o.status === 'ordered').length,
                  preparing: orders.filter(o => o.status === 'preparing').length,
                  completed: orders.filter(o => o.status === 'completed').length,
                  cancelled: orders.filter(o => o.status === 'cancelled').length
              };

              // Pagination calculations
              const totalItems = filteredOrders.length;
              const totalPages = Math.ceil(totalItems / itemsPerPage);
              const startIndex = (currentPage - 1) * itemsPerPage;
              const endIndex = startIndex + itemsPerPage;
              const paginatedOrders = filteredOrders.slice(startIndex, endIndex);
              
              container.innerHTML = `
                  <!-- Filter Bar -->
                  <div class="bg-gray-50 p-4 rounded-lg mb-4 space-y-3">
                      <!-- Date Filter -->
                      <div>
                          <label class="text-sm font-medium text-gray-700 mb-2 block">ğŸ—“ï¸ Lá»c theo ngÃ y:</label>
                          <div class="flex gap-2">
                              <button onclick="setDateFilter('today')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentDateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  HÃ´m nay
                              </button>
                              <button onclick="setDateFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentDateFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  Táº¥t cáº£
                              </button>
                          </div>
                      </div>
                      
                      <!-- Status Filter -->
                      <div>
                          <label class="text-sm font-medium text-gray-700 mb-2 block">ğŸ“Š Lá»c theo tráº¡ng thÃ¡i:</label>
                          <div class="flex flex-wrap gap-2">
                              <button onclick="setOrderFilter('ordered')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentOrderFilter === 'ordered' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  ğŸ“‹ Chá» nháº­n (${counts.ordered})
                              </button>
                              <button onclick="setOrderFilter('preparing')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentOrderFilter === 'preparing' ? 'bg-yellow-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  ğŸ‘¨â€ğŸ³ Äang lÃ m (${counts.preparing})
                              </button>
                              <button onclick="setOrderFilter('completed')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentOrderFilter === 'completed' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  âœ… HoÃ n thÃ nh (${counts.completed})
                              </button>
                              <button onclick="setOrderFilter('cancelled')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentOrderFilter === 'cancelled' ? 'bg-red-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  âŒ ÄÃ£ há»§y (${counts.cancelled})
                              </button>
                              <button onclick="setOrderFilter('all')" class="px-4 py-2 rounded-lg text-sm font-medium ${currentOrderFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                  ğŸ“‚ Táº¥t cáº£ (${orders.length})
                              </button>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Orders List -->
                  <div class="space-y-4">
                      ${paginatedOrders.length === 0 ? `
                          <p class="text-center text-gray-500 py-12">
                              <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                              <br>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o
                          </p>
                      ` : paginatedOrders.map(order => `
                          <div class="bg-white p-4 rounded-lg border-2 ${
                              order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                              order.status === 'completed' ? 'border-green-200 bg-green-50' :
                              order.status === 'preparing' ? 'border-yellow-200 bg-yellow-50' :
                              'border-blue-200 bg-blue-50'
                          }">
                              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-3">
                                  <div class="flex-1 min-w-0">
                                      <h4 class="font-semibold text-purple-800 flex flex-wrap items-center gap-2 mb-1">
                                          <span class="text-sm sm:text-base">Order #${order.id.slice(-6).toUpperCase()}</span>
                                          ${order.tableNumber ? `<span class="px-2 py-0.5 bg-teal-100 text-teal-700 text-xs rounded-full">ğŸ½ï¸ BÃ n ${order.tableNumber}</span>` : ''}
                                      </h4>
                                      <p class="text-sm text-gray-600 mb-1">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                      <p class="text-xs text-gray-500 truncate">KhÃ¡ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                                  </div>
                                  <div class="flex flex-wrap items-center gap-2 sm:justify-end">
                                        ${order.status === 'ordered' ? `
                                          <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-green-600 text-xs sm:text-sm font-medium whitespace-nowrap">
                                              âœ… Nháº­n Ä‘Æ¡n
                                          </button>
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-red-600 text-xs sm:text-sm font-medium whitespace-nowrap ml-1 sm:ml-2">
                                              âŒ Há»§y
                                          </button>
                                        ` : order.status === 'preparing' ? `
                                          <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-blue-600 text-xs sm:text-sm font-medium whitespace-nowrap">
                                              âœ… HoÃ n thÃ nh
                                          </button>
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-red-600 text-xs sm:text-sm font-medium whitespace-nowrap ml-1 sm:ml-2">
                                              âŒ Há»§y
                                          </button>
                                        ` : `
                                          <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                              ${getStatusText(order.status)}
                                          </span>
                                      `}
                                  </div>
                              </div>

                              <div class="space-y-2 mb-3">
                                  ${order.items.map(item => `
                                      <div class="flex justify-between items-center bg-white p-2 rounded">
                                          <div class="flex-1">
                                              <span class="font-medium">${item.name}</span>
                                              ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                              <span class="text-sm text-gray-600">x${item.quantity}</span>
                                          </div>
                                          <div class="flex items-center gap-2">
                                              <span class="text-sm font-semibold text-orange-600">${formatCurrency(item.price * item.quantity)}</span>
                                              ${order.status === 'preparing' ? `
                                                  <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-1" title="XÃ³a mÃ³n">
                                                      <i data-lucide="x" class="w-4 h-4"></i>
                                                  </button>
                                              ` : ''}
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>

                              ${order.status === 'preparing' ? `
                                  <div class="border-t pt-3 mb-3">
                                      <p class="text-xs text-gray-600 mb-2 font-medium">ğŸ›  Chá»‰nh sá»­a Ä‘Æ¡n hÃ ng:</p>
                                      <div class="flex gap-2">
                                          <select id="add-item-${order.id}" class="flex-1 text-sm border rounded px-2 py-1">
                                              <option value="">Chá»n mÃ³n thÃªm...</option>
                                              ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                                  <option value="${item.id}">${item.name} - ${formatCurrency(item.price)}</option>
                                              `).join('')}
                                          </select>
                                          <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                              <i data-lucide="plus" class="w-4 h-4"></i>
                                          </button>
                                      </div>
                                  </div>
                              ` : ''}

                              <div class="flex justify-between items-center pt-2 border-t">
                                  <span class="font-bold text-lg text-orange-600">Tá»•ng: ${formatCurrency(order.total)}</span>
                                  <span class="text-sm px-3 py-1 rounded-full ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              </div>
                          </div>
                      `).join('')}

                      <!-- Pagination Controls -->
                      ${totalPages > 1 ? `
                          <div class="bg-white p-4 rounded-lg border border-gray-200 mt-6">
                              <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                                  <!-- Items per page selector -->
                                  <div class="flex items-center gap-2">
                                      <label class="text-sm text-gray-600">Hiá»ƒn thá»‹:</label>
                                      <select onchange="setItemsPerPage(this.value)" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                          <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5</option>
                                          <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                          <option value="20" ${itemsPerPage === 20 ? 'selected' : ''}>20</option>
                                          <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                      </select>
                                      <span class="text-sm text-gray-600">Ä‘Æ¡n/trang</span>
                                  </div>

                                  <!-- Pagination info -->
                                  <div class="text-sm text-gray-600 text-center sm:text-left">
                                      Hiá»ƒn thá»‹ ${totalItems > 0 ? startIndex + 1 : 0}-${Math.min(endIndex, totalItems)} cá»§a ${totalItems} Ä‘Æ¡n hÃ ng
                                  </div>

                                  <!-- Page navigation -->
                                  <div class="flex items-center gap-1 sm:gap-2">
                                      <button onclick="setPage(1)" class="px-2 sm:px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                                      </button>
                                      <button onclick="prevPage()" class="px-2 sm:px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                      </button>

                                      <span class="px-2 sm:px-3 py-1 text-sm bg-blue-50 border border-blue-200 rounded">
                                          Trang ${currentPage} / ${totalPages}
                                      </span>

                                      <button onclick="nextPage()" class="px-2 sm:px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                      </button>
                                      <button onclick="setPage(${totalPages})" class="px-2 sm:px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                                      </button>
                                  </div>
                              </div>
                          </div>
                      ` : ''}
                  </div>
              `;
              
              renderLucideIcons();
          }

          async function loadOrders() {
              try {
                  console.log("Loading orders...");
                  const querySnapshot = await getDocs(collection(db, 'orders'));
                  orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log("Loaded orders:", orders.length);
                  renderOrdersList();

              } catch (error) {
                  console.error("Error loading orders:", error);
                  showMessage("Lá»—i táº£i Ä‘Æ¡n hÃ ng: " + error.message, "error");
              }
          }

          function renderOrdersList() {
              const ordersList = document.getElementById('orders-list');
              const orderCount = document.getElementById('order-count');

              if (!ordersList || !orderCount) return;

              orderCount.textContent = orders.length;

              if (orders.length === 0) {
                  ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</p>';
                  return;
              }

              // Sort orders by createdAt (newest first)
              const sortedOrders = [...orders].sort((a, b) => {
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  return timeB - timeA;
              });

              ordersList.innerHTML = sortedOrders.map(order => `
                  <div class="bg-white p-4 rounded-lg border-2 ${
                      order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                      order.status === 'completed' ? 'border-green-200 bg-green-50' :
                      order.status === 'updated' ? 'border-yellow-200 bg-yellow-50' :
                      'border-purple-200'
                  }">
                      <div class="flex justify-between items-start mb-3">
                          <div>
                              <h4 class="font-semibold text-purple-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                              <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                              <p class="text-xs text-gray-500">KhÃ¡ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                          </div>
                          <div class="flex items-center gap-2">
                              ${order.status === 'ordered' ? `
                                  <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600 text-sm font-medium">
                                      âœ… Nháº­n Ä‘Æ¡n
                                  </button>
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium ml-2">
                                      âŒ Há»§y
                                  </button>
                              ` : order.status === 'preparing' ? `
                                  <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600 text-sm font-medium">
                                      âœ… HoÃ n thÃ nh
                                  </button>
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium ml-2">
                                      âŒ Há»§y
                                  </button>
                              ` : order.status === 'completed' || order.status === 'cancelled' ? `
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              ` : ''}
                          </div>
                      </div>

                      <div class="space-y-2 mb-3">
                          ${order.items.map(item => `
                              <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                  <div class="flex-1">
                                      <span class="font-medium">${item.name}</span>
                                      ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                      <span class="text-sm text-gray-600">x${item.quantity}</span>
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <span class="text-sm font-semibold text-orange-600">${formatCurrency(item.price * item.quantity)}</span>
                                      ${order.status === 'preparing' ? `
                                          <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-1" title="XÃ³a mÃ³n">
                                              <i data-lucide="x" class="w-4 h-4"></i>
                                          </button>
                                      ` : ''}
                                  </div>
                              </div>
                          `).join('')}
                      </div>

                      ${order.status === 'preparing' ? `
                          <div class="border-t pt-3 mb-3">
                              <p class="text-xs text-gray-600 mb-2 font-medium">ğŸ›  Chá»‰nh sá»­a Ä‘Æ¡n hÃ ng:</p>
                              <div class="flex gap-2">
                                  <select id="add-item-${order.id}" class="flex-1 text-sm border rounded px-2 py-1">
                                      <option value="">Chá»n mÃ³n thÃªm...</option>
                                      ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                          <option value="${item.id}">${item.name} - ${formatCurrency(item.price)}</option>
                                      `).join('')}
                                  </select>
                                  <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                      <i data-lucide="plus" class="w-4 h-4"></i>
                                  </button>
                              </div>
                          </div>
                      ` : ''}

                      <div class="flex justify-between items-center pt-2 border-t">
                          <span class="font-bold text-lg text-orange-600">Tá»•ng: ${formatCurrency(order.total)}</span>
                          <span class="text-sm px-3 py-1 rounded-full ${getStatusBadgeClass(order.status)}">
                              ${getStatusText(order.status)}
                          </span>
                      </div>
                  </div>
              `).join('');

              renderLucideIcons();
          }

          function getStatusText(status) {
              const statusMap = {
                  'ordered': 'ğŸ“‹ Chá» nháº­n',
                  'preparing': 'ğŸ‘¨â€ğŸ³ Äang lÃ m',
                  'completed': 'âœ… HoÃ n thÃ nh',
                  'cancelled': 'âŒ ÄÃ£ há»§y',
                  'updated': 'ğŸ”„ ÄÃ£ cáº­p nháº­t'
              };
              return statusMap[status] || status;
          }

          function getStatusBadgeClass(status) {
              const classMap = {
                  'ordered': 'bg-blue-100 text-blue-800',
                  'preparing': 'bg-yellow-100 text-yellow-800',
                  'completed': 'bg-green-200 text-green-900',
                  'cancelled': 'bg-red-100 text-red-800',
                  'updated': 'bg-orange-100 text-orange-800'
              };
              return classMap[status] || 'bg-gray-100 text-gray-800';
          }

          // Nháº­n Ä‘Æ¡n hÃ ng
          async function acceptOrder(orderId) {
              if (!confirm("XÃ¡c nháº­n nháº­n Ä‘Æ¡n hÃ ng nÃ y?")) return; // Add confirm check

              try {
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'preparing',
                      acceptedAt: new Date(),
                      updatedAt: new Date()
                  });

                  // Set as currently processing order
                  processingOrderId = orderId;
                  localStorage.setItem('processingOrderId', orderId);
                  currentOrderFilter = 'preparing'; // Chuyá»ƒn sang tab Ä‘ang lÃ m
                  renderOrdersManagementList(); // Update UI immediately

                  showMessage(`âœ… ÄÃ£ nháº­n Ä‘Æ¡n #${orderId.slice(-6).toUpperCase()}`, "success");
                  speak("ÄÃ£ nháº­n Ä‘Æ¡n");

              } catch (error) {
                  console.error("Error accepting order:", error);
                  showMessage("Lá»—i nháº­n Ä‘Æ¡n: " + error.message, "error");
              }
          }

          // Há»§y Ä‘Æ¡n hÃ ng
          async function cancelOrder(orderId) {
              if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n Há»¦Y Ä‘Æ¡n hÃ ng nÃ y?")) return;

              try {
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'cancelled',
                      cancelledAt: new Date(),
                      cancelledBy: 'admin',
                      updatedAt: new Date()
                  });

                  showMessage(`âŒ ÄÃ£ há»§y Ä‘Æ¡n #${orderId.slice(-6).toUpperCase()}`, "warning");

              } catch (error) {
                  console.error("Error cancelling order:", error);
                  showMessage("Lá»—i há»§y Ä‘Æ¡n: " + error.message, "error");
              }
          }

          // HoÃ n thÃ nh Ä‘Æ¡n hÃ ng vÃ  lÆ°u thá»‘ng kÃª
          async function completeOrder(orderId) {
              if (!confirm("XÃ¡c nháº­n HOÃ€N THÃ€NH Ä‘Æ¡n hÃ ng nÃ y?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const completedAt = new Date();
                  
                  // 1. Cáº­p nháº­t tráº¡ng thÃ¡i order
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'completed',
                      completedAt: completedAt,
                      updatedAt: completedAt
                  });

                  // Clear processing state
                  if (processingOrderId === orderId) {
                      processingOrderId = null;
                      localStorage.removeItem('processingOrderId');
                      
                      // Check for pending orders to switch back
                      const hasPendingOrders = orders.some(o => o.status === 'ordered');
                      if (hasPendingOrders && currentOrderFilter !== 'ordered') {
                          currentOrderFilter = 'ordered';
                      }
                      renderOrdersManagementList();
                  }

                  // 2. LÆ°u thá»‘ng kÃª doanh thu
                  const year = completedAt.getFullYear();
                  const month = completedAt.getMonth() + 1; // 1-12
                  const statsId = `${year}-${month.toString().padStart(2, '0')}`;

                  const statsRef = doc(db, 'statistics', statsId);
                  
                  try {
                      // Kiá»ƒm tra xem thÃ¡ng nÃ y Ä‘Ã£ cÃ³ chÆ°a
                      const statsDoc = await getDoc(statsRef);
                      
                      if (statsDoc.exists()) {
                          // Cá»™ng dá»“n vÃ o thÃ¡ng hiá»‡n táº¡i
                          const currentData = statsDoc.data();
                          await updateDoc(statsRef, {
                              totalRevenue: (currentData.totalRevenue || 0) + order.total,
                              orderCount: (currentData.orderCount || 0) + 1,
                              updatedAt: completedAt
                          });
                      } else {
                          // Táº¡o má»›i cho thÃ¡ng nÃ y
                          await setDoc(statsRef, {
                              year: year,
                              month: month,
                              totalRevenue: order.total,
                              orderCount: 1,
                              createdAt: completedAt,
                              updatedAt: completedAt
                          });
                      }
                  } catch (statsError) {
                      console.error("Error updating statistics:", statsError);
                      // Váº«n tiáº¿p tá»¥c hoÃ n thÃ nh Ä‘Æ¡n dÃ¹ lÆ°u thá»‘ng kÃª lá»—i
                  }

                  showMessage(`âœ… HoÃ n thÃ nh Ä‘Æ¡n #${orderId.slice(-6).toUpperCase()} - ${formatCurrency(order.total)}`, "success");
                  speak("ÄÆ¡n hÃ ng hoÃ n thÃ nh");

              } catch (error) {
                  console.error("Error completing order:", error);
                  showMessage("Lá»—i hoÃ n thÃ nh Ä‘Æ¡n: " + error.message, "error");
              }
          }

          async function addItemToOrder(orderId) {
              const selectElement = document.getElementById(`add-item-${orderId}`);
              const itemId = selectElement.value;

              if (!itemId) {
                  showMessage("Vui lÃ²ng chá»n mÃ³n!", "warning");
                  return;
              }

              try {
                  const order = orders.find(o => o.id === orderId);
                  const menuItem = menuItems.find(item => item.id === itemId);

                  if (!order || !menuItem) return;

                  // Check if item already exists in order
                  const existingItem = order.items.find(item => item.id === itemId);
                  if (existingItem) {
                      existingItem.quantity += 1;
                  } else {
                      order.items.push({
                          id: menuItem.id,
                          name: menuItem.name,
                          price: menuItem.price,
                          quantity: 1,
                          size: menuItem.size || null,
                          category: menuItem.category
                      });
                  }

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                  // Update in Firestore - váº«n giá»¯ status preparing, khÃ´ng Ä‘á»•i thÃ nh updated
                  await updateDoc(doc(db, 'orders', orderId), {
                      items: order.items,
                      total: order.total,
                      updatedAt: new Date(),
                      updatedBy: 'admin'
                  });

                  selectElement.value = '';
                  showMessage(`âœ… ÄÃ£ thÃªm ${menuItem.name}`, "success");

              } catch (error) {
                  console.error("Error adding item to order:", error);
                  showMessage("Lá»—i thÃªm mÃ³n: " + error.message, "error");
              }
          }

          async function removeItemFromOrder(orderId, itemId) {
              if (!confirm("XÃ³a mÃ³n nÃ y khá»i Ä‘Æ¡n hÃ ng?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const removedItem = order.items.find(item => item.id === itemId);
                  
                  // Remove item
                  order.items = order.items.filter(item => item.id !== itemId);

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                  // If no items left, cancel the order
                  if (order.items.length === 0) {
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: 0,
                          status: 'cancelled',
                          cancelledBy: 'admin-no-items',
                          updatedAt: new Date()
                      });
                      showMessage("âš ï¸ ÄÆ¡n hÃ ng Ä‘Ã£ bá»‹ há»§y (khÃ´ng cÃ²n mÃ³n)", "warning");
                  } else {
                      // Update in Firestore
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: order.total,
                          updatedAt: new Date(),
                          updatedBy: 'admin'
                      });
                      showMessage(`ğŸ—‘ï¸ ÄÃ£ xÃ³a ${removedItem?.name || 'mÃ³n'}`, "success");
                  }

              } catch (error) {
                  console.error("Error removing item from order:", error);
                  showMessage("Lá»—i xÃ³a mÃ³n: " + error.message, "error");
              }
          }

          // ==================== CUSTOMER ORDER HISTORY ====================
          async function showMyOrders() {
              // Guest: xem tá»« cookie session
              if (userRole === 'guest') {
                  console.log("Loading guest orders from session...");
                  showGuestOrders();
                  return;
              }

              // Customer: query Firebase
              if (!auth.currentUser) {
                  showMessage("Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ xem Ä‘Æ¡n hÃ ng!", "warning");
                  return;
              }

              try {
                  console.log("Loading customer orders from Firebase...");
                  const q = query(collection(db, 'orders'), where('customerId', '==', userId));
                  const querySnapshot = await getDocs(q);
                  const myOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log("Loaded customer orders:", myOrders.length);

                  const modalContent = document.getElementById('my-orders-content');

                  if (myOrders.length === 0) {
                      modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</p>';
                  } else {
                      // Sort by newest first
                      const sortedOrders = myOrders.sort((a, b) => {
                          const timeA = a.createdAt?.seconds || 0;
                          const timeB = b.createdAt?.seconds || 0;
                          return timeB - timeA;
                      });

                      modalContent.innerHTML = sortedOrders.map(order => `
                          <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                              order.status === 'cancelled' ? 'border-red-200' :
                              order.status === 'completed' ? 'border-green-200' :
                              'border-blue-200'
                          } mb-4">
                              <div class="flex justify-between items-start mb-3">
                                  <div>
                                      <h4 class="font-semibold text-blue-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                                      <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                  </div>
                                  <div class="text-right">
                                      <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                          ${getStatusText(order.status)}
                                      </span>
                                  </div>
                              </div>

                              <div class="space-y-2 mb-3">
                                  ${order.items.map(item => `
                                      <div class="flex justify-between items-center bg-white p-2 rounded">
                                          <div class="flex-1">
                                              <span class="font-medium">${item.name}</span>
                                              ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                              <span class="text-sm text-gray-600">x${item.quantity}</span>
                                          </div>
                                          <div class="text-right">
                                              <span class="text-sm font-semibold text-orange-600">${formatCurrency(item.price * item.quantity)}</span>
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>

                              <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                  <span class="font-bold text-lg text-orange-600">Tá»•ng: ${formatCurrency(order.total)}</span>
                                  <span class="text-xs font-medium ${
                                      order.status === 'ordered' ? 'text-blue-600' :
                                      order.status === 'preparing' ? 'text-yellow-600' :
                                      order.status === 'cancelled' ? 'text-red-600' :
                                      order.status === 'completed' ? 'text-green-600' :
                                      'text-gray-600'
                                  }">
                                      ${order.status === 'ordered' ? 'ğŸ“‹ Chá» nháº­n Ä‘Æ¡n' :
                                        order.status === 'preparing' ? 'ğŸ‘¨â€ğŸ³ Äang lÃ m' :
                                        order.status === 'cancelled' ? 'âŒ ÄÃ£ há»§y' :
                                        order.status === 'completed' ? 'âœ… HoÃ n thÃ nh' :
                                        'ğŸ”„ Äang xá»­ lÃ½'}
                                  </span>
                              </div>

                              ${order.updatedBy === 'admin' && order.status === 'preparing' ? `
                                  <div class="mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800 border border-yellow-200">
                                      <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                      Admin Ä‘Ã£ chá»‰nh sá»­a Ä‘Æ¡n hÃ ng (thÃªm/xÃ³a mÃ³n)
                                  </div>
                              ` : ''}
                          </div>
                      `).join('');
                  }

                  document.getElementById('my-orders-modal').classList.remove('hidden');
                  renderLucideIcons();

              } catch (error) {
                  console.error("Error loading my orders:", error);
                  showMessage("Lá»—i táº£i Ä‘Æ¡n hÃ ng: " + error.message, "error");
              }
          }

          function closeMyOrdersModal() {
              document.getElementById('my-orders-modal').classList.add('hidden');
          }

          // Hiá»ƒn thá»‹ Ä‘Æ¡n hÃ ng cá»§a guest tá»« session
          function showGuestOrders() {
              const modalContent = document.getElementById('my-orders-content');

              if (guestOrders.length === 0) {
                  modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o trong phiÃªn nÃ y</p>';
              } else {
                  // Sort by newest first
                  const sortedOrders = [...guestOrders].sort((a, b) => {
                      const timeA = new Date(a.createdAt).getTime();
                      const timeB = new Date(b.createdAt).getTime();
                      return timeB - timeA;
                  });

                  modalContent.innerHTML = sortedOrders.map(order => `
                      <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                          order.status === 'cancelled' ? 'border-red-200' :
                          order.status === 'completed' ? 'border-green-200' :
                          'border-blue-200'
                      } mb-4">
                          <div class="flex justify-between items-start mb-3">
                              <div>
                                  <h4 class="font-semibold text-blue-800">Order #${order.shortId}</h4>
                                  <p class="text-sm text-gray-600">${new Date(order.createdAt).toLocaleString('vi-VN')}</p>
                                  <p class="text-xs text-gray-500">BÃ n: ${order.tableNumber || 'N/A'}</p>
                              </div>
                              <div class="text-right">
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              </div>
                          </div>

                          <div class="space-y-2 mb-3">
                              ${order.items.map(item => `
                                  <div class="flex justify-between items-center bg-white p-2 rounded">
                                      <div class="flex-1">
                                          <span class="font-medium">${item.name}</span>
                                          ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                          <span class="text-sm text-gray-600">x${item.quantity}</span>
                                      </div>
                                      <div class="text-right">
                                          <span class="text-sm font-semibold text-orange-600">${formatCurrency(item.price * item.quantity)}</span>
                                      </div>
                                  </div>
                              `).join('')}
                          </div>

                          <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                              <span class="font-bold text-lg text-orange-600">Tá»•ng: ${formatCurrency(order.total)}</span>
                              <span class="text-xs text-gray-500">
                                  ${order.status === 'ordered' ? 'â³ Chá» nháº­n Ä‘Æ¡n' :
                                    order.status === 'cancelled' ? 'âŒ ÄÃ£ há»§y' :
                                    order.status === 'completed' ? 'âœ… HoÃ n thÃ nh' :
                                    'ğŸ”„ Äang xá»­ lÃ½'}
                              </span>
                          </div>
                      </div>
                  `).join('');
              }

              document.getElementById('my-orders-modal').classList.remove('hidden');
              renderLucideIcons();
          }
        
        // --- Custom Alert/Message ---
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            
            let classes = '';
            if (type === 'success') {
                classes = 'bg-green-100 text-green-800 border-green-400';
            } else if (type === 'warning') {
                classes = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            } else { // info/error
                classes = 'bg-red-100 text-red-800 border-red-400';
            }
            
            messageBox.className = `p-3 rounded-lg border fixed top-4 left-1/2 -translate-x-1/2 z-50 shadow-lg transition-opacity duration-300 ${classes}`;
            messageBox.style.opacity = '1';
            
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        function renderApp() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // Hide loading screen
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }

            // Render Header
            document.getElementById('header-container').innerHTML = renderHeader();

            // Render Main Content (Menu/Login/Admin)
            document.getElementById('main-content-container').innerHTML = renderMainContent();

            // Render Cart Sidebar
            document.getElementById('cart-container').innerHTML = renderCartSidebar();

            // Xá»­ lÃ½ giá» hÃ ng ban Ä‘áº§u (khi user má»Ÿ app)
            const storedCart = localStorage.getItem('cart');
            if (storedCart) {
                try {
                    cart = JSON.parse(storedCart);
                } catch(e) {
                    console.error("Lá»—i parse giá» hÃ ng:", e);
                    cart = {};
                }
            }

            // Setup admin price preview listeners
            setTimeout(() => {
                setupAdminPricePreviewListeners();
            }, 100);

            renderLucideIcons();
        }


        // ==================== MOBILE MENU ====================

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            const icon = btn.querySelector('i');

            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'x');
            } else {
                menu.classList.add('hidden');
                icon.setAttribute('data-lucide', 'menu');
            }
            renderLucideIcons();
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');

            if (!btn.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.add('hidden');
                const icon = btn.querySelector('i');
                if (icon) icon.setAttribute('data-lucide', 'menu');
                renderLucideIcons();
            }
        });

        // ==================== TABLE SELECTION MODAL ====================

        // Hiá»ƒn thá»‹ modal chá»n bÃ n
        async function showTableSelectionModal() {
            const modal = document.getElementById('table-selection-modal');
            const content = document.getElementById('table-selection-content');

            console.log('ğŸ“‹ Current tables:', tables);
            console.log('ğŸ“Š Tables length:', tables.length);

            // Náº¿u chÆ°a load Ä‘Æ°á»£c tables, thá»­ load má»™t láº§n
            if (tables.length === 0) {
                console.log('ğŸ”„ Tables empty, trying to load once...');
                await loadTablesOnce();

                console.log('ğŸ“‹ After loading tables:', tables);
                console.log('ğŸ“Š Tables length after load:', tables.length);
            }

            // Náº¿u váº«n chÆ°a cÃ³ tables, hiá»ƒn thá»‹ loading
            if (tables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">KhÃ´ng thá»ƒ táº£i danh sÃ¡ch bÃ n</p>
                        <p class="text-sm text-gray-500 mt-2">Vui lÃ²ng liÃªn há»‡ nhÃ¢n viÃªn hoáº·c thá»­ láº¡i sau.</p>
                        <button onclick="showTableSelectionModal()" class="mt-4 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            ğŸ”„ Thá»­ láº¡i
                        </button>
                    </div>
                `;
                modal.classList.remove('hidden');
                renderLucideIcons();
                return;
            }

            // Load danh sÃ¡ch bÃ n - cháº¥p nháº­n cáº£ 'available' vÃ  undefined status (máº·c Ä‘á»‹nh lÃ  trá»‘ng)
            const availableTables = tables.filter(table => !table.status || table.status === 'available');

            console.log('âœ… Available tables:', availableTables);

            if (availableTables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">KhÃ´ng cÃ³ bÃ n trá»‘ng lÃºc nÃ y.</p>
                        <p class="text-sm text-gray-500 mt-2">Vui lÃ²ng liÃªn há»‡ nhÃ¢n viÃªn Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£.</p>
                        <p class="text-xs text-gray-400 mt-4">Debug: ${tables.length} bÃ n trong há»‡ thá»‘ng</p>
                    </div>
                `;
            } else {
                content.innerHTML = availableTables.map(table => `
                    <button onclick="selectTable('${table.tableNumber}')" class="p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-2">
                        <i data-lucide="table-2" class="w-8 h-8 text-teal-600"></i>
                        <span class="font-semibold text-gray-800">BÃ n ${table.tableNumber}</span>
                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">${table.status || 'Trá»‘ng'}</span>
                    </button>
                `).join('');
            }

            modal.classList.remove('hidden');
            renderLucideIcons();
        }

        // ÄÃ³ng modal chá»n bÃ n
        function closeTableSelectionModal() {
            document.getElementById('table-selection-modal').classList.add('hidden');
        }

        // Chá»n bÃ n vÃ  tiáº¿p tá»¥c Ä‘áº·t hÃ ng
        function selectTable(tableNumber) {
            // Äáº·t table number
            currentTableNumber = tableNumber;
            userRole = 'guest';

            // Táº¡o session má»›i náº¿u chÆ°a cÃ³
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            // LÆ°u session
            saveSessionToCookie();

            // ÄÃ³ng modal
            closeTableSelectionModal();

            // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
            showMessage(`ÄÃ£ chá»n BÃ n ${tableNumber}!`, 'success');

            // Tiáº¿p tá»¥c Ä‘áº·t hÃ ng
            handleOrder();

            // Re-render Ä‘á»ƒ cáº­p nháº­t header
            renderApp();
        }

        // --- Khá»Ÿi táº¡o á»¨ng dá»¥ng ---
        window.onload = function() {
            console.log("ğŸŒŸ á»¨ng dá»¥ng QuÃ¡n TrÃ  Äá»“ khá»Ÿi Ä‘á»™ng...");

            initFirebase();
            window.updateCart = updateCart;
            window.openCart = openCart;
            window.closeCart = closeCart;
            window.setView = setView;
            window.setCategory = setCategory;
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            window.toggleAdminMode = toggleAdminMode;
            window.saveItem = saveItem;
            window.deleteItem = deleteItem;
            window.handleSaveItem = handleSaveItem;
            window.handleChangePassword = handleChangePassword;
            window.loadItemForEdit = loadItemForEdit;
            window.clearAdminForm = clearAdminForm;
            window.speak = speak;
            window.loadMenuItemsOnce = loadMenuItemsOnce;
            window.openPriceModal = openPriceModal;
            window.closePriceModal = closePriceModal;
            window.savePriceUpdate = savePriceUpdate;
            window.openCategoryModal = openCategoryModal;
            window.closeCategoryModalAdmin = closeCategoryModalAdmin;
            window.addNewCategoryAdmin = addNewCategoryAdmin;
            window.openEditCategoryModalAdmin = openEditCategoryModalAdmin;
            window.closeEditCategoryModalAdmin = closeEditCategoryModalAdmin;
            window.updateCategoryAdmin = updateCategoryAdmin;
            window.openAddTableModalAdmin = openAddTableModalAdmin;
            window.closeAddTableModalAdmin = closeAddTableModalAdmin;
            window.addTableAdmin = addTableAdmin;
            window.openEditTableModalAdmin = openEditTableModalAdmin;
            window.closeEditTableModalAdmin = closeEditTableModalAdmin;
            window.updateTableAdmin = updateTableAdmin;
            window.showTableQRAdmin = showTableQRAdmin;
            window.closeQRTableModalAdmin = closeQRTableModalAdmin;
            window.downloadTableQRAdmin = downloadTableQRAdmin;
            window.restoreItem = restoreItem;
            window.permanentDeleteItem = permanentDeleteItem;
            window.cleanupExpiredItems = cleanupExpiredItems;
            window.loadCategories = loadCategories;
            window.saveCategories = saveCategories;
            window.updateAdminPricePreview = updateAdminPricePreview;
            window.setupAdminPricePreviewListeners = setupAdminPricePreviewListeners;
            window.closeCategoryModal = closeCategoryModal;
            window.addNewCategory = addNewCategory;
            window.editCategory = editCategory;
            window.deleteCategory = deleteCategory;
            window.loadOrders = loadOrders;
            window.acceptOrder = acceptOrder;
            window.cancelOrder = cancelOrder;
            window.completeOrder = completeOrder;
            window.addItemToOrder = addItemToOrder;
            window.removeItemFromOrder = removeItemFromOrder;
            window.handleOrder = handleOrder;
            window.showMyOrders = showMyOrders;
            window.closeMyOrdersModal = closeMyOrdersModal;
            window.setOrderFilter = setOrderFilter;
            window.setDateFilter = setDateFilter;
            window.setItemsPerPage = setItemsPerPage;
            window.setPage = setPage;
            window.nextPage = nextPage;
            window.prevPage = prevPage;
            window.addTable = addTable;
            window.deleteTable = deleteTable;
            window.showTableQR = showTableQR;
            window.closeQRModal = closeQRModal;
            window.openAddTableModal = openAddTableModal;
            window.closeAddTableModal = closeAddTableModal;
            window.downloadQR = downloadQR;
            window.showTableSelectionModal = showTableSelectionModal;
            window.closeTableSelectionModal = closeTableSelectionModal;
            window.selectTable = selectTable;
            window.toggleMobileMenu = toggleMobileMenu;

              // Fallback: Hide loading after 10 seconds if Firebase fails
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen && loadingScreen.style.display !== 'none') {
                    console.warn("âš ï¸ Firebase load timeout - showing app anyway");
                    loadingScreen.style.display = 'none';
                }
            }, 10000);

            renderApp(); // Render láº§n Ä‘áº§u
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5e6d3;
        }
        ::-webkit-scrollbar-thumb {
            background: #d97706; /* Orange-700 */
            border-radius: 10px;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app-container" class="relative">
        <div id="header-container">
            <!-- Header sáº½ Ä‘Æ°á»£c render táº¡i Ä‘Ã¢y -->
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-amber-50 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold text-amber-900 mb-2">Chill Coffee</h2>
                <p class="text-amber-700">Äang táº£i menu...</p>
                <p class="text-sm text-amber-600 mt-2">ğŸ’¡ Náº¿u load lÃ¢u, thá»­ enable Authentication trong Firebase Console</p>
            </div>
        </div>

        <div id="main-content-container">
            <!-- Ná»™i dung chÃ­nh (Menu, Login, Admin) sáº½ Ä‘Æ°á»£c render táº¡i Ä‘Ã¢y -->
        </div>

        <div id="cart-container">
            <!-- Giá» hÃ ng Sidebar sáº½ Ä‘Æ°á»£c render táº¡i Ä‘Ã¢y -->
        </div>
        
        <!-- Há»™p thÃ´ng bÃ¡o tÃ¹y chá»‰nh (thay tháº¿ alert) -->
        <div id="message-box" style="opacity: 0; pointer-events: none;" class="p-3 rounded-lg border fixed top-4 left-1/2 -translate-x-1/2 z-50 shadow-lg transition-opacity duration-300"></div>

        <!-- Price Update Modal -->
        <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">ğŸ’° Cáº­p Nháº­t GiÃ¡</h3>

                <div id="price-modal-content">
                    <!-- Content sáº½ Ä‘Æ°á»£c render bá»Ÿi JavaScript -->
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closePriceModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                    <button onclick="savePriceUpdate()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">LÆ°u</button>
                </div>
              </div>
          </div>

          <!-- My Orders Modal (Customer) -->
          <div id="my-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
              <div class="bg-white p-6 rounded-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-2xl font-bold text-blue-600">ğŸ“‹ ÄÆ¡n HÃ ng Cá»§a TÃ´i</h3>
                      <button onclick="closeMyOrdersModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div id="my-orders-content">
                      <!-- Orders will be loaded here -->
                  </div>
              </div>
          </div>
          

          <!-- Table Selection Modal (Guest) -->
          <div id="table-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden p-4">
              <div class="bg-white rounded-xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-teal-600">ğŸ½ï¸ Chá»n BÃ n Cá»§a Báº¡n</h3>
                      <button onclick="closeTableSelectionModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div class="p-4 sm:p-6">
                      <div class="mb-4">
                          <p class="text-gray-600 text-sm sm:text-base mb-4">Vui lÃ²ng chá»n bÃ n mÃ  báº¡n Ä‘ang ngá»“i Ä‘á»ƒ chÃºng tÃ´i phá»¥c vá»¥ tá»‘t nháº¥t:</p>
                      </div>

                      <div class="flex justify-between items-center mb-4">
                          <p class="text-sm text-gray-600">Danh sÃ¡ch bÃ n trá»‘ng:</p>
                          <div class="flex gap-1 sm:gap-2">
                              <button onclick="loadTablesOnce().then(() => showTableSelectionModal())" class="px-2 py-1 sm:px-3 sm:py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition duration-150">
                                  ğŸ”„ Táº£i láº¡i
                              </button>
                              <span class="text-xs text-gray-500 self-center hidden sm:inline">${tables.length} bÃ n</span>
                          </div>
                      </div>

                      <div id="table-selection-content" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 sm:gap-3">
                      <!-- Tables will be loaded here -->
                  </div>

                  <div class="flex gap-3 mt-4 sm:mt-6 px-4 sm:px-6 pb-4 sm:pb-6">
                      <button onclick="closeTableSelectionModal()" class="flex-1 px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm sm:text-base transition duration-150">
                          Há»§y
                      </button>
                      <div class="text-xs sm:text-sm text-gray-500 self-center px-2">
                          Chá»n bÃ n Ä‘á»ƒ tiáº¿p tá»¥c Ä‘áº·t hÃ ng
                      </div>
                  </div>
              </div>
          </div>

          <!-- Add Category Modal -->
        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">â• ThÃªm Danh Má»¥c Má»›i</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">TÃªn Danh Má»¥c</label>
                    <input type="text" id="new-category-name" placeholder="VÃ­ dá»¥: Äá»“ Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div class="flex gap-3">
                    <button onclick="closeCategoryModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                    <button onclick="addNewCategory()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ThÃªm</button>
                </div>
            </div>
        </div>
        
        <!-- Add Table Modal -->
        <div id="add-table-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-teal-600 mb-4">ğŸ½ï¸ ThÃªm BÃ n Má»›i</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sá»‘ BÃ n</label>
                    <input type="text" id="new-table-number" placeholder="VÃ­ dá»¥: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    <p class="text-xs text-gray-500 mt-1">CÃ³ thá»ƒ dÃ¹ng sá»‘ hoáº·c chá»¯ cÃ¡i</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeAddTableModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Há»§y</button>
                    <button onclick="addTable()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">ThÃªm BÃ n</button>
                </div>
            </div>
        </div>
        
        <!-- QR Code Modal -->
        <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-teal-600">ğŸ“± QR Code</h3>
                    <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="qr-table-info" class="mb-4 text-center">
                    <!-- Table info will be inserted here -->
                </div>
                
                <div id="qr-code-container" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                    <!-- QR Code will be generated here -->
                </div>
                
                <div class="flex gap-3">
                    <button onclick="downloadQR()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Táº£i Xuá»‘ng
                    </button>
                    <button onclick="closeQRModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ÄÃ³ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Ä‘Æ¡n giáº£n -->
    <footer class="bg-amber-700 text-white p-2 mt-6 text-center text-xs fixed bottom-0 left-0 right-0 z-50">
        &copy; 2025 by GTD Fry. Chill Coffee
    </footer>
</body>
</html>