<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="logo.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d4a574">
    <title>Chill Coffee</title>
    <!-- Tailwind CSS via CDN (for development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* Custom Tailwind config for production */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        position: relative;
        overflow-x: hidden;
    }

    /* Tr√¢n ch√¢u (boba pearls) effect */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background-image: 
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 11px, transparent 11px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 5px, transparent 5px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 12px, transparent 12px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px);
        background-size: 
            80px 80px, 60px 60px, 100px 100px, 70px 70px, 90px 90px,
            75px 75px, 110px 110px, 65px 65px, 85px 85px, 55px 55px,
            95px 95px, 78px 78px, 50px 50px, 115px 115px, 88px 88px;
        background-position: 
            10% 85%, 25% 90%, 40% 88%, 60% 92%, 75% 87%,
            15% 78%, 88% 95%, 50% 80%, 30% 93%, 70% 82%,
            5% 75%, 95% 90%, 45% 96%, 82% 85%, 20% 70%;
        background-repeat: no-repeat;
        opacity: 0.8;
        /* Gradient mask ƒë·ªÉ l√†m m·ªèng d·∫ßn ·ªü tr√™n */
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
        mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
    }

    /* ƒê·∫£m b·∫£o n·ªôi dung n·∫±m tr√™n background */
    body > * {
        position: relative;
        z-index: 1;
    }

    /* Hide scrollbar for webkit browsers */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f5e6d3; }
    ::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }

    /* Custom utilities */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Hide scrollbar */
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    </style>
    <!-- Lucide Icons for nice, clean icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // C·∫•u h√¨nh Firebase v√† Kh·ªüi t·∫°o
        setLogLevel('Debug');
        const appId = 'order-app'; // App ID cho qu√°n tr√† s·ªØa

        // Firebase config cho project order-d8a0c
        const firebaseConfig = {
            apiKey: "AIzaSyCGs3xD2uC153yGlV7IpRftllAKx-NHt88",
            authDomain: "order-d8a0c.firebaseapp.com",
            projectId: "order-d8a0c",
            storageBucket: "order-d8a0c.firebasestorage.app",
            messagingSenderId: "559568129038",
            appId: "1:559568129038:web:dd1ebcefb23f7cf03dc05f"
        };
        const __initial_auth_token = null; // For Canvas environment - set to null for direct usage

        let app, db, auth, storage, userId;
          let menuItems = [];
          let cart = {}; // { itemId: { item, quantity } }
          let orders = []; // Danh s√°ch orders cho admin
          let tables = []; // Danh s√°ch b√†n ƒÉn
          let currentView = 'customer'; // 'customer', 'login', 'admin', 'admin-orders', 'admin-stats', 'admin-tables', 'admin-menu', 'admin-trash', 'preview'
          let currentCategory = 'ƒê·ªì U·ªëng'; // 'ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'
          let currentTableNumber = null; // S·ªë b√†n hi·ªán t·∫°i (t·ª´ QR code)
          let userRole = 'guest'; // 'guest', 'customer', 'admin'
          let statsTimeFilter = 'month'; // 'day', 'week', 'month', 'year' - cho th·ªëng k√™ tr·∫°ng th√°i ƒë∆°n h√†ng
          let currentItemDetails = null; // L∆∞u t·∫°m th·ªùi details c·ªßa m√≥n ƒëang config

          // Filter orders theo kho·∫£ng th·ªùi gian cho th·ªëng k√™
          function filterOrdersByTimeRange(orders, timeFilter) {
              const now = new Date();
              let startDate;

              switch(timeFilter) {
                  case 'day':
                      startDate = new Date(now);
                      startDate.setHours(0, 0, 0, 0);
                      break;
                  case 'week':
                      startDate = new Date(now);
                      startDate.setDate(now.getDate() - now.getDay()); // Monday of current week
                      startDate.setHours(0, 0, 0, 0);
                      break;
                  case 'month':
                      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                      break;
                  case 'year':
                      startDate = new Date(now.getFullYear(), 0, 1);
                      break;
                  default:
                      return orders; // Return all if invalid filter
              }

              return orders.filter(order => {
                  if (!order.createdAt || !order.createdAt.seconds) return false;
                  const orderDate = new Date(order.createdAt.seconds * 1000);
                  return orderDate >= startDate;
              });
          }

          // Handle thay ƒë·ªïi time filter cho th·ªëng k√™ tr·∫°ng th√°i ƒë∆°n h√†ng
          function setStatsTimeFilter(filter) {
              statsTimeFilter = filter;
              if (currentView === 'admin-stats') {
                  renderApp(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™
              }
          }
        let isAdmin = false;
        let isPreviewMode = false; // Admin ƒëang xem nh∆∞ kh√°ch h√†ng
        let categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u']; // Danh s√°ch categories m·∫∑c ƒë·ªãnh
        let drinkSizes = ['S', 'M', 'L', 'Big Size']; // Size cho ƒë·ªì u·ªëng

        // --- H√†m h·ªó tr·ª£ chung ---
        function renderLucideIcons() {
            lucide.createIcons();
        }


        // --- Qu·∫£n l√Ω Gi·ªè h√†ng ---
        function updateCart(itemId, change, selectedDetails = null, cartEntryId = null) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            // N·∫øu ƒëang th√™m m√≥n m·ªõi (change > 0) v√† m√≥n c√≥ details nh∆∞ng ch∆∞a ch·ªçn details
            // Bao g·ªìm c·∫£ tr∆∞·ªùng h·ª£p b·∫•m "+" t·ª´ gi·ªè h√†ng
            if (change > 0 && item.itemType !== 'simple' && item.details && !selectedDetails) {
                // N·∫øu c√≥ cartEntryId (b·∫•m "+" t·ª´ gi·ªè h√†ng), l∆∞u l·∫°i ƒë·ªÉ sau khi ch·ªçn details s·∫Ω th√™m m√≥n m·ªõi
                // N·∫øu kh√¥ng c√≥ cartEntryId (b·∫•m "+" t·ª´ menu), m·ªü modal b√¨nh th∆∞·ªùng
                if (cartEntryId) {
                    // L∆∞u context ƒë·ªÉ bi·∫øt ƒë√¢y l√† th√™m m√≥n m·ªõi t·ª´ gi·ªè h√†ng
                    window.addingFromCart = true;
                    window.addingFromCartItemId = itemId;
                }
                // M·ªü modal ch·ªçn details
                openCustomerItemDetailsModal(item);
                return;
            }

            const wasEmpty = Object.keys(cart).length === 0;
            
            // L∆∞u tr·∫°ng th√°i gi·ªè h√†ng tr∆∞·ªõc khi render l·∫°i
            const cartWasOpen = !document.getElementById('cart-sidebar')?.classList.contains('translate-x-full');

            // N·∫øu c√≥ cartEntryId (ƒëang update t·ª´ gi·ªè h√†ng), t√¨m entry ƒë√≥
            if (cartEntryId && cart[cartEntryId]) {
                cart[cartEntryId].quantity += change;
                
                if (cart[cartEntryId].quantity <= 0) {
                    delete cart[cartEntryId];
                }
            } else if (change > 0) {
                // Ki·ªÉm tra xem c√≥ item n√†o trong gi·ªè c√≥ c√πng itemId v√† details kh√¥ng
                const existingEntry = findCartEntryWithSameDetails(itemId, selectedDetails);
                
                if (existingEntry) {
                    // TƒÉng quantity c·ªßa item ƒë√£ c√≥
                    existingEntry.quantity += 1;
                    // Hi·ªán th√¥ng b√°o khi tƒÉng quantity
                    showMessage(`‚úÖ ƒê√£ th√™m "${item.name}" (x${existingEntry.quantity})`, 'success');
                } else {
                    // T·∫°o unique ID cho cart entry m·ªõi
                    const uniqueId = `${itemId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    cart[uniqueId] = { 
                        id: uniqueId,
                        item: item, 
                        quantity: 1,
                        selectedDetails: selectedDetails,
                        finalPrice: selectedDetails ? calculateItemPrice(item, selectedDetails) : getItemPrice(item)
                    };
                    // Hi·ªán th√¥ng b√°o khi th√™m m√≥n m·ªõi t·ª´ menu (kh√¥ng t·ª´ gi·ªè h√†ng)
                    if (!cartWasOpen) {
                        showMessage(`‚úÖ ƒê√£ th√™m "${item.name}" v√†o gi·ªè h√†ng!`, 'success');
                    }
                }
            }

            // T·ª± ƒë·ªông ƒë√≥ng gi·ªè h√†ng CH·ªà KHI x√≥a h·∫øt m√≥n
            if (Object.keys(cart).length === 0 && !wasEmpty) {
                closeCart();
                showMessage("Gi·ªè h√†ng tr·ªëng", 'info');
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            renderApp();
            
            // Gi·ªØ nguy√™n tr·∫°ng th√°i gi·ªè h√†ng sau khi render
            if (cartWasOpen && Object.keys(cart).length > 0) {
                openCart();
            }
        }
        
        // ƒê√≥ng gi·ªè h√†ng
        function closeCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.add('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.add('hidden');
            }
        }
        
        // M·ªü gi·ªè h√†ng
        function openCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.remove('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.remove('hidden');
            }
        }

        // --- Customer Item Details Modal ---
        let currentSelectingItem = null;
        let modalMode = 'add'; // 'add' ho·∫∑c 'edit'
        
        // So s√°nh 2 details objects c√≥ gi·ªëng nhau kh√¥ng
        function areDetailsEqual(details1, details2) {
            if (!details1 && !details2) return true;
            if (!details1 || !details2) return false;
            
            // So s√°nh t·ª´ng field
            if (details1.size !== details2.size) return false;
            
            // So s√°nh toppings (array)
            const toppings1 = (details1.toppings || []).sort().join(',');
            const toppings2 = (details2.toppings || []).sort().join(',');
            if (toppings1 !== toppings2) return false;
            
            // So s√°nh c√°c field kh√°c (chuy·ªÉn v·ªÅ s·ªë ƒë·ªÉ so s√°nh ƒë√∫ng)
            const ice1 = details1.ice !== undefined ? Number(details1.ice) : undefined;
            const ice2 = details2.ice !== undefined ? Number(details2.ice) : undefined;
            if (ice1 !== ice2) return false;
            
            const sugar1 = details1.sugar !== undefined ? Number(details1.sugar) : undefined;
            const sugar2 = details2.sugar !== undefined ? Number(details2.sugar) : undefined;
            if (sugar1 !== sugar2) return false;
            
            if (details1.spice !== details2.spice) return false;
            if (details1.noodle !== details2.noodle) return false;
            if (details1.notes !== details2.notes) return false;
            
            return true;
        }
        
        // T√¨m item trong gi·ªè c√≥ c√πng itemId v√† details
        function findCartEntryWithSameDetails(itemId, selectedDetails) {
            const entries = Object.values(cart);
            return entries.find(entry => {
                if (entry.item.id !== itemId) return false;
                return areDetailsEqual(entry.selectedDetails, selectedDetails);
            });
        }

        // T√≠nh gi√° cu·ªëi c√πng d·ª±a tr√™n item v√† details ƒë√£ ch·ªçn
        function calculateItemPrice(item, selectedDetails) {
            const itemBasePrice = getItemPrice(item); // L·∫•y gi√° m·ªõi nh·∫•t (newPrice n·∫øu c√≥, kh√¥ng th√¨ price)
            
            if (!selectedDetails) return itemBasePrice;
            
            // B·∫Øt ƒë·∫ßu v·ªõi gi√° c·ªßa size ƒë√£ ch·ªçn (thay th·∫ø gi√° m√≥n), ho·∫∑c gi√° m√≥n m·ªõi nh·∫•t n·∫øu kh√¥ng c√≥ size
            let finalPrice = itemBasePrice;
            
            // N·∫øu c√≥ ch·ªçn size, th√¨ gi√° = gi√° c·ªßa size ƒë√≥ (THAY TH·∫æ gi√° m√≥n, kh√¥ng c·ªông th√™m)
            if (selectedDetails.size && item.details?.sizes) {
                const sizeOption = item.details.sizes.find(s => s.name === selectedDetails.size);
                if (sizeOption) {
                    const sizePrice = sizeOption.priceAdd || sizeOption.price || 0;
                    // N·∫øu priceAdd > 0 th√¨ d√πng priceAdd l√†m gi√° cu·ªëi (thay th·∫ø gi√° m√≥n)
                    // N·∫øu priceAdd = 0 th√¨ gi·ªØ nguy√™n gi√° m√≥n m·ªõi nh·∫•t
                    if (sizePrice > 0) {
                        finalPrice = parseFloat(sizePrice);
                    }
                }
            }
            
            // C·ªông th√™m gi√° c·ªßa c√°c topping ƒë√£ ch·ªçn
            if (selectedDetails.toppings && item.details?.toppings) {
                selectedDetails.toppings.forEach(toppingName => {
                    const topping = item.details.toppings.find(t => t.name === toppingName);
                    if (topping && topping.price) {
                        finalPrice += parseFloat(topping.price);
                    }
                });
            }
            
            return finalPrice;
        }

        // M·ªü modal ch·ªçn details cho kh√°ch h√†ng
        function openCustomerItemDetailsModal(item) {
            currentSelectingItem = item;
            
            const modal = document.getElementById('customer-item-details-modal');
            if (!modal) return;
            
            // Render n·ªôi dung modal
            const detailsContent = document.getElementById('customer-item-details-content');
            const itemType = item.itemType || 'simple';
            const details = item.details || {};
            
            const itemBasePrice = getItemPrice(item); // L·∫•y gi√° m·ªõi nh·∫•t (newPrice n·∫øu c√≥, kh√¥ng th√¨ price)
            
            let html = `
                <div class="mb-3 sm:mb-4">
                    <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-1.5 sm:mb-2">${item.name}</h4>
                    <p class="text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-2">${item.description || ''}</p>
                    <p class="text-sm sm:text-base font-semibold text-teal-600">Gi√° g·ªëc: ${itemBasePrice.toLocaleString()}ƒë</p>
                </div>
            `;
            
            // Sizes - ch·ªâ hi·ªÉn th·ªã size c√≥ enabled = true
            if (details.sizes && details.sizes.length > 0) {
                const enabledSizes = details.sizes.filter(s => s.enabled);
                if (enabledSizes.length > 0) {
                    html += `
                        <div class="mb-3 sm:mb-4">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Size</label>
                            <div class="space-y-1.5 sm:space-y-2">
                                ${enabledSizes.map((size, idx) => {
                                    const priceAdd = size.priceAdd || size.price || 0;
                                    // N·∫øu priceAdd = 0 th√¨ d√πng gi√° m√≥n m·ªõi nh·∫•t, n·∫øu kh√¥ng th√¨ d√πng priceAdd
                                    const displayPrice = priceAdd > 0 ? priceAdd : itemBasePrice;
                                    return `
                                        <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                            <div class="flex items-center">
                                                <input type="radio" name="customer-size" value="${size.name}" ${idx === 0 ? 'checked' : ''} 
                                                    onchange="updateCustomerItemPrice()" 
                                                    class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                                <span>${size.name}</span>
                                            </div>
                                            <span class="text-teal-600 text-xs sm:text-sm font-medium">${displayPrice.toLocaleString()}ƒë</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Toppings
            if (details.toppings && details.toppings.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Topping (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <div class="space-y-1.5 sm:space-y-2">
                            ${details.toppings.map(topping => `
                                <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                    <div class="flex items-center">
                                        <input type="checkbox" name="customer-topping" value="${topping.name}" 
                                            onchange="updateCustomerItemPrice()" 
                                            class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                        <span>${topping.name}</span>
                                    </div>
                                    <span class="text-teal-600 text-xs sm:text-sm font-medium">+${topping.price?.toLocaleString() || 0}ƒë</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Ice/Sugar level - radio buttons vu√¥ng
            if (details.iceOptions && details.iceOptions.length > 0) {
                // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                const sortedIceOptions = [...details.iceOptions].sort((a, b) => b - a);
                const defaultIce = sortedIceOptions.includes(100) ? 100 : sortedIceOptions[0];
                
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üßä ƒê√° (%)</label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                            ${sortedIceOptions.map((opt) => `
                                <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="customer-ice" value="${opt}" ${opt === defaultIce ? 'checked' : ''} 
                                        onchange="updateCustomerItemPrice()" 
                                        class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                    <span class="text-xs sm:text-sm">${opt}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (details.sugarOptions && details.sugarOptions.length > 0) {
                // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                const sortedSugarOptions = [...details.sugarOptions].sort((a, b) => b - a);
                const defaultSugar = sortedSugarOptions.includes(100) ? 100 : sortedSugarOptions[0];
                
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üçØ ƒê∆∞·ªùng (%)</label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                            ${sortedSugarOptions.map((opt) => `
                                <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="customer-sugar" value="${opt}" ${opt === defaultSugar ? 'checked' : ''} 
                                        onchange="updateCustomerItemPrice()" 
                                        class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                    <span class="text-xs sm:text-sm">${opt}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Spice level
            if (details.spiceLevels && details.spiceLevels.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">ƒê·ªô cay</label>
                        <select name="customer-spice" onchange="updateCustomerItemPrice()" 
                            class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                            ${details.spiceLevels.map((opt, idx) => `
                                <option value="${opt}" ${idx === 0 ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Noodle type
            if (details.noodleTypes && details.noodleTypes.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Lo·∫°i s·ª£i</label>
                        <select name="customer-noodle" onchange="updateCustomerItemPrice()" 
                            class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                            ${details.noodleTypes.map((opt, idx) => `
                                <option value="${opt}" ${idx === 0 ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Special requests
            html += `
                <div class="mb-3 sm:mb-4">
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Ghi ch√∫ ƒë·∫∑c bi·ªát</label>
                    <textarea name="customer-notes" rows="2" 
                        class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base" 
                        placeholder="V√≠ d·ª•: √çt ƒë√°, kh√¥ng h√†nh..."></textarea>
                </div>
            `;
            
            // Final price display
            html += `
                <div class="mb-3 sm:mb-4 p-2 sm:p-3 bg-teal-50 rounded">
                    <div class="flex justify-between items-center">
                        <span class="text-sm sm:text-base font-medium text-gray-700">T·ªïng c·ªông:</span>
                        <span id="customer-item-final-price" class="text-lg sm:text-xl font-bold text-teal-600">${item.price?.toLocaleString() || 0}ƒë</span>
                    </div>
                </div>
            `;
            
            detailsContent.innerHTML = html;
            
            // Set mode = 'add' (th√™m m·ªõi)
            modalMode = 'add';
            updateModalButtonText();
            
            // Hi·ªÉn th·ªã modal
            modal.classList.remove('hidden');
            
            // T√≠nh gi√° ban ƒë·∫ßu
            updateCustomerItemPrice();
        }

        // C·∫≠p nh·∫≠t gi√° khi kh√°ch ch·ªçn details
        function updateCustomerItemPrice() {
            if (!currentSelectingItem) return;
            
            const selectedDetails = getCustomerSelectedDetails();
            const finalPrice = calculateItemPrice(currentSelectingItem, selectedDetails);
            
            const priceElement = document.getElementById('customer-item-final-price');
            if (priceElement) {
                priceElement.textContent = `${finalPrice.toLocaleString()}ƒë`;
            }
        }
        
        // Expose to global scope for inline event handlers
        window.updateCustomerItemPrice = updateCustomerItemPrice;

        // L·∫•y details ƒë√£ ch·ªçn t·ª´ form
        function getCustomerSelectedDetails() {
            const modal = document.getElementById('customer-item-details-modal');
            if (!modal) return null;
            
            const selectedDetails = {};
            
            // Size
            const sizeRadio = modal.querySelector('input[name="customer-size"]:checked');
            if (sizeRadio) {
                selectedDetails.size = sizeRadio.value;
            }
            
            // Toppings
            const toppingCheckboxes = modal.querySelectorAll('input[name="customer-topping"]:checked');
            if (toppingCheckboxes.length > 0) {
                selectedDetails.toppings = Array.from(toppingCheckboxes).map(cb => cb.value);
            }
            
            // Ice (radio buttons)
            const iceRadio = modal.querySelector('input[name="customer-ice"]:checked');
            if (iceRadio) {
                selectedDetails.ice = parseInt(iceRadio.value);
            }
            
            // Sugar (radio buttons)
            const sugarRadio = modal.querySelector('input[name="customer-sugar"]:checked');
            if (sugarRadio) {
                selectedDetails.sugar = parseInt(sugarRadio.value);
            }
            
            // Spice
            const spiceSelect = modal.querySelector('select[name="customer-spice"]');
            if (spiceSelect) {
                selectedDetails.spice = spiceSelect.value;
            }
            
            // Noodle
            const noodleSelect = modal.querySelector('select[name="customer-noodle"]');
            if (noodleSelect) {
                selectedDetails.noodle = noodleSelect.value;
            }
            
            // Notes
            const notesTextarea = modal.querySelector('textarea[name="customer-notes"]');
            if (notesTextarea && notesTextarea.value.trim()) {
                selectedDetails.notes = notesTextarea.value.trim();
            }
            
            return Object.keys(selectedDetails).length > 0 ? selectedDetails : null;
        }

        // C·∫≠p nh·∫≠t text button trong modal
        function updateModalButtonText() {
            const button = document.querySelector('#customer-item-details-modal button[onclick="addItemWithDetailsToCart()"]');
            if (!button) return;
            
            if (modalMode === 'edit') {
                button.textContent = 'C·∫≠p nh·∫≠t';
            } else if (currentAdminAddingOrderId) {
                // Admin ƒëang th√™m m√≥n v√†o order
                button.textContent = 'Th√™m m·ªõi';
            } else {
                // Kh√°ch h√†ng th√™m v√†o gi·ªè h√†ng
                button.textContent = 'Th√™m v√†o gi·ªè';
            }
        }

        // ƒê√≥ng modal ch·ªçn details
        function closeCustomerItemDetailsModal() {
            const modal = document.getElementById('customer-item-details-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentSelectingItem = null;
            modalMode = 'add'; // Reset v·ªÅ add
            
            // Reset bi·∫øn n·∫øu ƒëang th√™m t·ª´ gi·ªè h√†ng
            if (window.addingFromCart) {
                window.addingFromCart = false;
                window.addingFromCartItemId = null;
            }
            
            // Reset bi·∫øn n·∫øu admin ƒëang th√™m m√≥n v√†o order
            if (currentAdminAddingOrderId) {
                currentAdminAddingOrderId = null;
                window.adminAddingItemId = null;
            }
        }
        
        // Expose to global scope
        window.closeCustomerItemDetailsModal = closeCustomerItemDetailsModal;

        // Th√™m item v·ªõi details v√†o gi·ªè h√†ng
        function addItemWithDetailsToCart() {
            if (!currentSelectingItem) return;
            
            const selectedDetails = getCustomerSelectedDetails();
            
            // N·∫øu admin ƒëang th√™m m√≥n v√†o order
            if (currentAdminAddingOrderId && window.adminAddingItemId) {
                const menuItem = menuItems.find(item => item.id === window.adminAddingItemId);
                if (menuItem) {
                    addItemToOrderDirectly(currentAdminAddingOrderId, menuItem, selectedDetails);
                }
                currentAdminAddingOrderId = null;
                window.adminAddingItemId = null;
                
                // ƒê√≥ng modal
                closeCustomerItemDetailsModal();
                return;
            }
            
            // N·∫øu ƒëang edit order item
            if (currentEditingOrderId && currentEditingItemIndex !== null) {
                const order = orders.find(o => o.id === currentEditingOrderId);
                if (order && order.items[currentEditingItemIndex]) {
                    const orderItem = order.items[currentEditingItemIndex];
                    orderItem.selectedDetails = selectedDetails;
                    orderItem.price = calculateItemPrice(currentSelectingItem, selectedDetails);
                    
                    // Recalculate order total
                    order.total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    
                    // Mark order as having pending changes
                    order.hasPendingChanges = true;
                    
                    showMessage(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t chi ti·∫øt m√≥n "${orderItem.name}" (ch∆∞a l∆∞u)`, 'info');
                    renderOrdersManagementList();
                }
                currentEditingOrderId = null;
                currentEditingItemIndex = null;
                
                // ƒê√≥ng modal
                closeCustomerItemDetailsModal();
                return;
            }
            
            // N·∫øu ƒëang edit cart item
            if (currentEditingCartEntryId) {
                const cartEntry = cart[currentEditingCartEntryId];
                if (cartEntry) {
                    cartEntry.selectedDetails = selectedDetails;
                    cartEntry.finalPrice = calculateItemPrice(cartEntry.item, selectedDetails);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderApp();
                    showMessage(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t chi ti·∫øt m√≥n "${cartEntry.item.name}"!`, 'success');
                }
                currentEditingCartEntryId = null;
            } else {
                // Th√™m v√†o gi·ªè h√†ng v·ªõi details
                const itemId = currentSelectingItem.id;
                updateCart(itemId, 1, selectedDetails);
                
                // Reset bi·∫øn n·∫øu ƒëang th√™m t·ª´ gi·ªè h√†ng
                if (window.addingFromCart) {
                    window.addingFromCart = false;
                    window.addingFromCartItemId = null;
                }
            }
            
            // ƒê√≥ng modal
            closeCustomerItemDetailsModal();
        }
        
        // Expose to global scope
        window.addItemWithDetailsToCart = addItemWithDetailsToCart;

        // Edit details c·ªßa item trong gi·ªè h√†ng
        let currentEditingCartEntryId = null;
        
        function editCartItemDetails(cartEntryId) {
            const cartEntry = cart[cartEntryId];
            if (!cartEntry) return;
            
            currentEditingCartEntryId = cartEntryId;
            
            // M·ªü modal v·ªõi details hi·ªán t·∫°i
            openCustomerItemDetailsModalForEdit(cartEntry);
        }
        
        // Expose to global scope
        window.editCartItemDetails = editCartItemDetails;

        function openCustomerItemDetailsModalForEdit(cartEntry) {
            currentSelectingItem = cartEntry.item;
            const item = cartEntry.item;
            const currentDetails = cartEntry.selectedDetails || {};
            
            const modal = document.getElementById('customer-item-details-modal');
            if (!modal) return;
            
            // Render n·ªôi dung modal (gi·ªëng nh∆∞ openCustomerItemDetailsModal nh∆∞ng v·ªõi gi√° tr·ªã hi·ªán t·∫°i)
            const detailsContent = document.getElementById('customer-item-details-content');
            const details = item.details || {};
            
            const itemBasePrice = getItemPrice(item); // L·∫•y gi√° m·ªõi nh·∫•t (newPrice n·∫øu c√≥, kh√¥ng th√¨ price)
            
            let html = `
                <div class="mb-3 sm:mb-4">
                    <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-1.5 sm:mb-2">${item.name}</h4>
                    <p class="text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-2">${item.description || ''}</p>
                    <p class="text-sm sm:text-base font-semibold text-teal-600">Gi√° g·ªëc: ${itemBasePrice.toLocaleString()}ƒë</p>
                </div>
            `;
            
            // Sizes - ch·ªâ hi·ªÉn th·ªã size c√≥ enabled = true
            if (details.sizes && details.sizes.length > 0) {
                const enabledSizes = details.sizes.filter(s => s.enabled);
                if (enabledSizes.length > 0) {
                    html += `
                        <div class="mb-3 sm:mb-4">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Size</label>
                            <div class="space-y-1.5 sm:space-y-2">
                                ${enabledSizes.map((size) => {
                                    const priceAdd = size.priceAdd || size.price || 0;
                                    // N·∫øu priceAdd = 0 th√¨ d√πng gi√° m√≥n m·ªõi nh·∫•t, n·∫øu kh√¥ng th√¨ d√πng priceAdd
                                    const displayPrice = priceAdd > 0 ? priceAdd : itemBasePrice;
                                    return `
                                        <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                            <div class="flex items-center">
                                                <input type="radio" name="customer-size" value="${size.name}" ${currentDetails.size === size.name ? 'checked' : ''} 
                                                    onchange="updateCustomerItemPrice()" 
                                                    class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                                <span>${size.name}</span>
                                            </div>
                                            <span class="text-teal-600 text-xs sm:text-sm font-medium">${displayPrice.toLocaleString()}ƒë</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Toppings
            if (details.toppings && details.toppings.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Topping (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <div class="space-y-1.5 sm:space-y-2">
                            ${details.toppings.map(topping => {
                                const isChecked = currentDetails.toppings && currentDetails.toppings.includes(topping.name);
                                return `
                                    <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                        <div class="flex items-center">
                                            <input type="checkbox" name="customer-topping" value="${topping.name}" ${isChecked ? 'checked' : ''}
                                                onchange="updateCustomerItemPrice()" 
                                                class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                            <span>${topping.name}</span>
                                        </div>
                                        <span class="text-teal-600 text-xs sm:text-sm font-medium">+${topping.price?.toLocaleString() || 0}ƒë</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Ice/Sugar level - radio buttons vu√¥ng
            if (details.iceOptions && details.iceOptions.length > 0) {
                // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                const sortedIceOptions = [...details.iceOptions].sort((a, b) => b - a);
                const defaultIce = sortedIceOptions.includes(100) ? 100 : sortedIceOptions[0];
                const currentIce = currentDetails.ice !== undefined ? currentDetails.ice : defaultIce;
                
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üßä ƒê√° (%)</label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                            ${sortedIceOptions.map((opt) => `
                                <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="customer-ice" value="${opt}" ${currentIce === opt ? 'checked' : ''} 
                                        onchange="updateCustomerItemPrice()" 
                                        class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                    <span class="text-xs sm:text-sm">${opt}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (details.sugarOptions && details.sugarOptions.length > 0) {
                // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                const sortedSugarOptions = [...details.sugarOptions].sort((a, b) => b - a);
                const defaultSugar = sortedSugarOptions.includes(100) ? 100 : sortedSugarOptions[0];
                const currentSugar = currentDetails.sugar !== undefined ? currentDetails.sugar : defaultSugar;
                
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üçØ ƒê∆∞·ªùng (%)</label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                            ${sortedSugarOptions.map((opt) => `
                                <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="customer-sugar" value="${opt}" ${currentSugar === opt ? 'checked' : ''} 
                                        onchange="updateCustomerItemPrice()" 
                                        class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                    <span class="text-xs sm:text-sm">${opt}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Spice level
            if (details.spiceLevels && details.spiceLevels.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">ƒê·ªô cay</label>
                        <select name="customer-spice" onchange="updateCustomerItemPrice()" 
                            class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                            ${details.spiceLevels.map((opt) => `
                                <option value="${opt}" ${currentDetails.spice === opt ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Noodle type
            if (details.noodleTypes && details.noodleTypes.length > 0) {
                html += `
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Lo·∫°i s·ª£i</label>
                        <select name="customer-noodle" onchange="updateCustomerItemPrice()" 
                            class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                            ${details.noodleTypes.map((opt) => `
                                <option value="${opt}" ${currentDetails.noodle === opt ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Special requests
            html += `
                <div class="mb-3 sm:mb-4">
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Ghi ch√∫ ƒë·∫∑c bi·ªát</label>
                    <textarea name="customer-notes" rows="2" 
                        class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base" 
                        placeholder="V√≠ d·ª•: √çt ƒë√°, kh√¥ng h√†nh...">${currentDetails.notes || ''}</textarea>
                </div>
            `;
            
            // Final price display
            html += `
                <div class="mb-3 sm:mb-4 p-2 sm:p-3 bg-teal-50 rounded">
                    <div class="flex justify-between items-center">
                        <span class="text-sm sm:text-base font-medium text-gray-700">T·ªïng c·ªông:</span>
                        <span id="customer-item-final-price" class="text-lg sm:text-xl font-bold text-teal-600">${(cartEntry.finalPrice || item.price)?.toLocaleString() || 0}ƒë</span>
                    </div>
                </div>
            `;
            
            detailsContent.innerHTML = html;
            
            // Set mode = 'edit' (c·∫≠p nh·∫≠t trong gi·ªè h√†ng)
            modalMode = 'edit';
            updateModalButtonText();
            
            // Hi·ªÉn th·ªã modal
            modal.classList.remove('hidden');
            
            // T√≠nh gi√° ban ƒë·∫ßu
            updateCustomerItemPrice();
        }

        // --- Qu·∫£n l√Ω State View ---
        function setView(viewName) {
            currentView = viewName;

            // Setup specific page data
            if (viewName === 'admin-orders') {
                setupOrdersPage();
            }

            renderApp();
            if (viewName !== 'login') {
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.reset();
                }
            }
        }

        function setCategory(categoryName) {
            currentCategory = categoryName;
            renderApp();
        }

        function toggleAdminMode() {
            if (isAdmin) {
                if (currentView.startsWith('admin')) {
                    // Chuy·ªÉn sang preview mode (xem nh∆∞ kh√°ch)
                    isPreviewMode = true;
                    currentView = 'customer';
                } else {
                    // Quay v·ªÅ admin dashboard
                    isPreviewMode = false;
                    currentView = 'admin-stats'; // Default admin view
                }
                renderApp();
            }
        }

        function previewAsCustomer() {
            if (isAdmin) {
                isPreviewMode = true;
                setView('customer');
                showMessage("ƒêang xem d∆∞·ªõi d·∫°ng kh√°ch h√†ng", "info");
            }
        }

        // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin touch cho vi·ªác ph√¢n bi·ªát tap v√† drag
        let touchStartInfo = null;
        const TOUCH_MOVE_THRESHOLD = 10; // Ng∆∞·ª°ng di chuy·ªÉn (pixels) ƒë·ªÉ coi l√† scroll

        // X·ª≠ l√Ω touch events cho c√°c h√†ng trong b·∫£ng ƒë·ªÉ ph√¢n bi·ªát tap v√† scroll
        function handleTableRowTouch(event, itemId) {
            // L·∫•y touch object t·ª´ event
            let touch = null;
            if (event.touches && event.touches.length > 0) {
                touch = event.touches[0];
            } else if (event.changedTouches && event.changedTouches.length > 0) {
                touch = event.changedTouches[0];
            }
            
            if (!touch) return;

            if (event.type === 'touchstart') {
                // L∆∞u v·ªã tr√≠ b·∫Øt ƒë·∫ßu touch
                touchStartInfo = {
                    x: touch.clientX,
                    y: touch.clientY,
                    itemId: itemId,
                    target: event.currentTarget || event.target.closest('tr'),
                    timestamp: Date.now(),
                    isScrolling: false
                };
                // Kh√¥ng preventDefault ƒë·ªÉ cho ph√©p scroll t·ª± nhi√™n
            } else if (event.type === 'touchmove') {
                // Ki·ªÉm tra n·∫øu ƒëang scroll (di chuy·ªÉn nhi·ªÅu)
                if (touchStartInfo) {
                    const deltaX = Math.abs(touch.clientX - touchStartInfo.x);
                    const deltaY = Math.abs(touch.clientY - touchStartInfo.y);
                    
                    // N·∫øu di chuy·ªÉn qu√° ng∆∞·ª°ng, coi nh∆∞ ƒëang scroll
                    if (deltaX > TOUCH_MOVE_THRESHOLD || deltaY > TOUCH_MOVE_THRESHOLD) {
                        // ƒê√°nh d·∫•u l√† ƒëang scroll, kh√¥ng m·ªü menu
                        touchStartInfo.isScrolling = true;
                    }
                }
            } else if (event.type === 'touchend' || event.type === 'touchcancel') {
                // Ch·ªâ m·ªü menu n·∫øu kh√¥ng ph·∫£i l√† scroll v√† itemId kh·ªõp
                if (touchStartInfo && 
                    touchStartInfo.itemId === itemId && 
                    !touchStartInfo.isScrolling) {
                    
                    // Ki·ªÉm tra th·ªùi gian touch (n·∫øu qu√° ng·∫Øn ho·∫∑c qu√° d√†i c√≥ th·ªÉ l√† l·ªói)
                    const touchDuration = Date.now() - touchStartInfo.timestamp;
                    if (touchDuration < 1000) { // Ch·ªâ m·ªü menu n·∫øu touch < 1 gi√¢y
                        // T·∫°o m·ªôt event gi·∫£ ƒë·ªÉ truy·ªÅn v√†o showItemContextMenu
                        const syntheticEvent = {
                            preventDefault: () => {},
                            stopPropagation: () => {},
                            clientX: touch.clientX,
                            clientY: touch.clientY,
                            currentTarget: touchStartInfo.target,
                            target: event.target,
                            touches: event.changedTouches
                        };
                        
                        showItemContextMenu(syntheticEvent, itemId);
                    }
                }
                
                // Reset th√¥ng tin touch
                touchStartInfo = null;
            }
        }

        function showItemContextMenu(event, itemId) {
            event.preventDefault();
            event.stopPropagation();

            // Hide any existing menu first
            hideContextMenu();

            const menu = document.getElementById('item-context-menu');
            window.currentContextItemId = itemId;

            // Hi·ªÉn th·ªã menu t·∫°m th·ªùi ƒë·ªÉ l·∫•y k√≠ch th∆∞·ªõc th·ª±c t·∫ø
            menu.style.visibility = 'hidden';
            menu.classList.remove('hidden');
            
            const menuRect = menu.getBoundingClientRect();
            const menuWidth = menuRect.width;
            const menuHeight = menuRect.height;
            
            // ·∫®n l·∫°i ƒë·ªÉ t√≠nh to√°n v·ªã tr√≠
            menu.classList.add('hidden');
            menu.style.visibility = 'visible';

            // L·∫•y th√¥ng tin viewport v√† scroll
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            // D·ª± tr·ªØ kh√¥ng gian cho footer (100px)
            const footerHeight = 100;
            const safeViewportHeight = viewportHeight - footerHeight;

            // Ki·ªÉm tra xem c√≥ ph·∫£i mobile/touch kh√¥ng
            const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window);
            
            // T√≠nh to√°n v·ªã tr√≠
            let leftPosition, topPosition;
            const padding = 10;
            
            // L·∫•y ph·∫ßn t·ª≠ row ƒë∆∞·ª£c click
            // ∆Øu ti√™n currentTarget (element c√≥ event handler), sau ƒë√≥ t√¨m closest tr
            let clickedRow = event.currentTarget;
            if (!clickedRow || clickedRow.tagName !== 'TR') {
                clickedRow = event.target.closest('tr');
            }
            let rowRect = null;
            if (clickedRow && clickedRow.tagName === 'TR') {
                rowRect = clickedRow.getBoundingClientRect();
            }
            
            // L·∫•y v·ªã tr√≠ click/touch (∆∞u ti√™n clientX/Y ƒë·ªÉ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi scroll)
            const clickX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clickY = event.clientY || (event.touches ? event.touches[0].clientY : 0);
            
            if (isMobile && rowRect) {
                // Mobile/Touch: Menu hi·ªÉn th·ªã PH√çA TR√äN h√†ng ƒë∆∞·ª£c click
                // CƒÉn gi·ªØa theo chi·ªÅu ngang c·ªßa viewport
                leftPosition = (viewportWidth / 2) - (menuWidth / 2);
                
                // Menu hi·ªÉn th·ªã ph√≠a tr√™n h√†ng (s·ª≠ d·ª•ng getBoundingClientRect ƒë·ªÉ l·∫•y v·ªã tr√≠ ch√≠nh x√°c)
                // T√≠nh to√°n d·ª±a tr√™n v·ªã tr√≠ c·ªßa row tr√™n viewport
                topPosition = rowRect.top - menuHeight - padding;
                
                // N·∫øu kh√¥ng ƒë·ªß kh√¥ng gian ph√≠a tr√™n, hi·ªÉn th·ªã ph√≠a d∆∞·ªõi h√†ng
                if (topPosition < padding) {
                    topPosition = rowRect.bottom + padding;
                }
                
                // ƒê·∫£m b·∫£o menu kh√¥ng tr√†n ra ngo√†i viewport
                if (topPosition + menuHeight > safeViewportHeight) {
                    topPosition = safeViewportHeight - menuHeight - padding;
                }
                
                // ƒê·∫£m b·∫£o kh√¥ng tr√†n ra ngo√†i tr√™n c√πng
                if (topPosition < padding) {
                    topPosition = padding;
                }
            } else if (isMobile) {
                // Fallback n·∫øu kh√¥ng t√¨m th·∫•y row: cƒÉn gi·ªØa viewport
                leftPosition = (viewportWidth / 2) - (menuWidth / 2);
                topPosition = padding;
            } else {
                // Desktop: Hi·ªÉn th·ªã b√™n c·∫°nh ho·∫∑c ph√≠a tr√™n t√πy kh√¥ng gian
                leftPosition = scrollX + clickX + padding;
                topPosition = scrollY + clickY - (menuHeight / 2);
                
                // Ki·ªÉm tra kh√¥ng gian ph√≠a d∆∞·ªõi
                const spaceBelow = safeViewportHeight - clickY;
                const spaceAbove = clickY;
                
                if (spaceBelow < menuHeight + padding || clickY > safeViewportHeight / 2) {
                    // Hi·ªÉn th·ªã ph√≠a tr√™n
                    topPosition = scrollY + clickY - menuHeight - padding;
                } else {
                    // Hi·ªÉn th·ªã ph√≠a d∆∞·ªõi
                    topPosition = scrollY + clickY + padding;
                }
                
                // Ki·ªÉm tra v√† ƒëi·ªÅu ch·ªânh n·∫øu menu tr√†n ra ngo√†i b√™n ph·∫£i
                if (clickX + menuWidth + padding > viewportWidth) {
                    leftPosition = scrollX + clickX - menuWidth - padding;
                }
            }

            // ƒê·∫£m b·∫£o menu kh√¥ng tr√†n ra ngo√†i c√°c c·∫°nh
            if (isMobile) {
                // Mobile: S·ª≠ d·ª•ng viewport coordinates (kh√¥ng t√≠nh scroll)
                if (leftPosition < padding) {
                    leftPosition = padding;
                }
                if (topPosition < padding) {
                    topPosition = padding;
                }
                if (leftPosition + menuWidth > viewportWidth - padding) {
                    leftPosition = viewportWidth - menuWidth - padding;
                }
                // Ki·ªÉm tra bottom ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng tr√†n ra ngo√†i
                if (topPosition + menuHeight > safeViewportHeight - padding) {
                    topPosition = safeViewportHeight - menuHeight - padding;
                }
            } else {
                // Desktop: S·ª≠ d·ª•ng page coordinates (t√≠nh scroll)
                if (leftPosition < scrollX + padding) {
                    leftPosition = scrollX + padding;
                }
                if (topPosition < scrollY + padding) {
                    topPosition = scrollY + padding;
                }
                if (leftPosition + menuWidth > viewportWidth + scrollX - padding) {
                    leftPosition = viewportWidth + scrollX - menuWidth - padding;
                }
                if (topPosition + menuHeight > viewportHeight + scrollY - footerHeight - padding) {
                    topPosition = viewportHeight + scrollY - menuHeight - footerHeight - padding;
                }
            }

            // √Åp d·ª•ng v·ªã tr√≠ v√† hi·ªÉn th·ªã menu
            menu.style.left = leftPosition + 'px';
            menu.style.top = topPosition + 'px';
            menu.classList.remove('hidden');

            // Hide menu when clicking outside
            setTimeout(() => {
                const handleClickOutside = (e) => {
                    if (!menu.contains(e.target)) {
                        hideContextMenu();
                    }
                };
                document.addEventListener('click', handleClickOutside, { capture: true, once: true });
                document.addEventListener('touchstart', handleClickOutside, { capture: true, once: true });
            }, 1);
        }

        function hideContextMenu() {
            const menu = document.getElementById('item-context-menu');
            menu.classList.add('hidden');
            window.currentContextItemId = null;
            // Remove any existing event listeners to prevent conflicts
            document.removeEventListener('click', hideContextMenu);
        }

        function handleLogoClick() {
            if (isAdmin) {
                if (isPreviewMode) {
                    // Admin ƒëang ·ªü ch·∫ø ƒë·ªô preview ‚Üí tho√°t preview v√† v·ªÅ admin
                    isPreviewMode = false;
                    setView('admin-stats');
                    showMessage("ƒê√£ tho√°t ch·∫ø ƒë·ªô xem kh√°ch h√†ng", "info");
                } else {
                    // Admin ƒëang ·ªü trang admin ‚Üí v·ªÅ trang th·ªëng k√™
                    setView('admin-stats');
                }
            } else {
                // Kh√°ch h√†ng ‚Üí v·ªÅ trang kh√°ch
                setView('customer');
            }
            return false; // Prevent default link behavior
        }

        function openAddItemModal() {
            document.getElementById('item-modal-title').textContent = '‚ûï Th√™m M√≥n M·ªõi';
            document.getElementById('item-modal-submit').textContent = 'Th√™m M√≥n';

            // Reset form
            document.getElementById('item-modal-id').value = '';
            document.getElementById('item-modal-name').value = '';
            document.getElementById('item-modal-price').value = '';
            document.getElementById('item-modal-new-price').value = '';
            document.getElementById('item-modal-status').value = 'active';
            document.getElementById('item-modal-item-type').value = 'simple';
            document.getElementById('item-modal-image').value = '';
            document.getElementById('item-modal-description').value = '';
            document.getElementById('item-modal-config-button-field').style.display = 'none';

            // Reset item details
            currentItemDetails = null;

            document.getElementById('item-modal').classList.remove('hidden');

            // Setup item type change listener
            const itemTypeSelect = document.getElementById('item-modal-item-type');
            itemTypeSelect.addEventListener('change', function() {
                const configButton = document.getElementById('item-modal-config-button-field');
                configButton.style.display = this.value !== 'simple' ? 'block' : 'none';
                // Reset details when changing type
                if (this.value !== 'simple') {
                    currentItemDetails = getDefaultDetails(this.value);
                } else {
                    currentItemDetails = null;
                }
            });

            // Setup image preview
            setupImagePreview();
        }

        // Variables for image cropping
        let cropImageSrc = null;
        let cropImageElement = null;
        let cropOverlay = null;
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null; // 'top-left' or 'bottom-right'
        let cropStartX = 0;
        let cropStartY = 0;
        let cropStartSize = 0;
        let cropSize = 200; // Default crop size
        let cropLeft = 0;
        let cropTop = 0;

        function setupImagePreview() {
            // Update preview when file is selected
            const fileInput = document.getElementById('item-modal-image-file');
            const urlInput = document.getElementById('item-modal-image');
            const previewImg = document.getElementById('item-modal-preview-img');

            // Remove old listeners to avoid duplicates
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            // File input listener
            newFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                    if (file.size > maxSize) {
                        showMessage(`‚ö†Ô∏è File ·∫£nh qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 10MB. (File hi·ªán t·∫°i: ${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'error');
                        e.target.value = ''; // Reset input
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Open crop modal instead of directly setting preview
                        openImageCropModal(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // URL input listener
            urlInput.addEventListener('input', function(e) {
                const url = e.target.value.trim();
                if (url) {
                    previewImg.src = url;
                    previewImg.onerror = function() {
                        previewImg.src = 'https://via.placeholder.com/200x150?text=Invalid+URL';
                    };
                } else {
                    previewImg.src = 'https://via.placeholder.com/200x150?text=No+Image';
                }
            });
        }

        function openImageCropModal(imageSrc) {
            cropImageSrc = imageSrc;
            const modal = document.getElementById('image-crop-modal');
            const cropImg = document.getElementById('crop-image');
            cropOverlay = document.getElementById('crop-overlay');
            
            if (!modal || !cropImg) return;

            cropImg.src = imageSrc;
            cropImageElement = cropImg;
            
            // Wait for image to load
            cropImg.onload = function() {
                initializeCrop();
            };
            
            modal.classList.remove('hidden');
        }

        function closeImageCropModal() {
            const modal = document.getElementById('image-crop-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            cropImageSrc = null;
            cropImageElement = null;
            cropOverlay = null;
        }

        function initializeCrop() {
            if (!cropImageElement || !cropOverlay) return;

            const img = cropImageElement;
            const container = document.getElementById('crop-container');
            const parentContainer = container.parentElement;
            
            // Wait for image to be fully rendered
            setTimeout(() => {
                // Get actual parent container dimensions
                const parentRect = parentContainer.getBoundingClientRect();
                const maxHeight = Math.min(500, parentRect.height - 40); // Max height with padding
                const maxWidth = parentRect.width - 40; // Max width with padding (accounting for mx-4)
                
                // Calculate scale factors without zooming up
                const scaleFactorHeight = maxHeight / img.naturalHeight;
                const scaleFactorWidth = maxWidth / img.naturalWidth;
                
                // Use the smaller scale factor to ensure image fits without zooming up
                // Max 1 = no zoom up (keep original size if already fits)
                const scaleFactor = Math.min(scaleFactorHeight, scaleFactorWidth, 1);
                
                // Calculate scaled dimensions (same for both portrait and landscape)
                const scaledWidth = img.naturalWidth * scaleFactor;
                const scaledHeight = img.naturalHeight * scaleFactor;
                
                // Set image size (consistent for both orientations)
                img.style.width = scaledWidth + 'px';
                img.style.height = scaledHeight + 'px';
                img.style.maxWidth = 'none';
                img.style.maxHeight = 'none';
                
                // Adjust container to match image size and center it
                container.style.width = scaledWidth + 'px';
                container.style.height = scaledHeight + 'px';
                container.style.margin = '0 auto'; // Center the container
                
                // Wait for image to be fully rendered after style change
                setTimeout(() => {
                    const imgRect = img.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    
                    // Calculate initial crop size (square, 80% of smaller displayed dimension)
                    const minDisplayDimension = Math.min(imgRect.width, imgRect.height);
                    cropSize = Math.floor(minDisplayDimension * 0.8);
                    
                    // Calculate crop overlay position relative to container
                    // Image position relative to container (accounting for flexbox centering)
                    const imgOffsetX = imgRect.left - containerRect.left;
                    const imgOffsetY = imgRect.top - containerRect.top;
                    
                    // Center the crop overlay within the image (relative to container)
                    // This ensures crop overlay is centered both horizontally and vertically in the image
                    const left = imgOffsetX + (imgRect.width - cropSize) / 2;
                    const top = imgOffsetY + (imgRect.height - cropSize) / 2;
                    
                    updateCropOverlay(left, top, cropSize);
                    
                    // Add drag functionality
                    setupCropDrag();
                }, 100);
            }, 100);
        }

        function updateCropOverlay(left, top, size) {
            if (!cropOverlay) return;
            
            cropLeft = left;
            cropTop = top;
            cropSize = size;
            
            cropOverlay.style.left = left + 'px';
            cropOverlay.style.top = top + 'px';
            cropOverlay.style.width = size + 'px';
            cropOverlay.style.height = size + 'px';
        }

        function setupCropDrag() {
            if (!cropOverlay || !cropImageElement) return;

            const container = document.getElementById('crop-container');
            const img = cropImageElement;
            const handleBottomRight = document.getElementById('crop-handle-bottom-right');
            
            // Helper function to get event coordinates (mouse or touch)
            function getEventCoords(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            // Move crop area (center area, not handles)
            function startMove(e) {
                const coords = getEventCoords(e);
                isDragging = true;
                const rect = cropOverlay.getBoundingClientRect();
                cropStartX = coords.x - rect.left;
                cropStartY = coords.y - rect.top;
                e.preventDefault();
                e.stopPropagation();
            }

            function startResizeBottomRight(e) {
                const coords = getEventCoords(e);
                isResizing = true;
                resizeHandle = 'bottom-right';
                cropStartX = coords.x;
                cropStartY = coords.y;
                cropStartSize = cropSize;
                const rect = cropOverlay.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                cropLeft = rect.left - containerRect.left;
                cropTop = rect.top - containerRect.top;
                e.preventDefault();
                e.stopPropagation();
            }

            function handleMove(e) {
                const coords = getEventCoords(e);
                
                if (isResizing && resizeHandle === 'bottom-right') {
                    const containerRect = container.getBoundingClientRect();
                    const imgRect = cropImageElement.getBoundingClientRect();
                    
                    // Calculate image offset in container
                    const imgOffsetX = imgRect.left - containerRect.left;
                    const imgOffsetY = imgRect.top - containerRect.top;
                    
                    // Calculate distance moved
                    const deltaX = coords.x - cropStartX;
                    const deltaY = coords.y - cropStartY;
                    const delta = Math.max(deltaX, deltaY); // Use larger delta to maintain square
                    
                    // Calculate new size constrained to image bounds
                    const newSize = Math.max(50, Math.min(
                        cropStartSize + delta,
                        imgRect.width - (cropLeft - imgOffsetX),
                        imgRect.height - (cropTop - imgOffsetY)
                    ));
                    
                    updateCropOverlay(cropLeft, cropTop, newSize);
                } else if (isDragging) {
                    const containerRect = container.getBoundingClientRect();
                    const imgRect = cropImageElement.getBoundingClientRect();
                    
                    // Calculate image offset in container
                    const imgOffsetX = imgRect.left - containerRect.left;
                    const imgOffsetY = imgRect.top - containerRect.top;
                    
                    // Calculate new position relative to container
                    let newLeft = coords.x - containerRect.left - cropStartX;
                    let newTop = coords.y - containerRect.top - cropStartY;
                    
                    // Constrain to image bounds (relative to container)
                    newLeft = Math.max(imgOffsetX, Math.min(newLeft, imgOffsetX + imgRect.width - cropSize));
                    newTop = Math.max(imgOffsetY, Math.min(newTop, imgOffsetY + imgRect.height - cropSize));
                    
                    updateCropOverlay(newLeft, newTop, cropSize);
                }
                
                if (isDragging || isResizing) {
                    e.preventDefault();
                }
            }

            function handleEnd(e) {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
            }

            // Mouse events
            cropOverlay.addEventListener('mousedown', startMove);
            if (handleBottomRight) {
                handleBottomRight.addEventListener('mousedown', startResizeBottomRight);
            }
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            // Touch events
            cropOverlay.addEventListener('touchstart', startMove, { passive: false });
            if (handleBottomRight) {
                handleBottomRight.addEventListener('touchstart', startResizeBottomRight, { passive: false });
            }
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
        }

        function applyCrop() {
            if (!cropImageSrc || !cropImageElement || !cropOverlay) return;

            const img = cropImageElement;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Get displayed image dimensions
            const imgRect = img.getBoundingClientRect();
            const overlayRect = cropOverlay.getBoundingClientRect();
            
            // Calculate scale factors
            const scaleX = img.naturalWidth / imgRect.width;
            const scaleY = img.naturalHeight / imgRect.height;
            
            // Calculate source coordinates in original image
            const sourceX = (overlayRect.left - imgRect.left) * scaleX;
            const sourceY = (overlayRect.top - imgRect.top) * scaleY;
            const sourceSize = (overlayRect.width * scaleX + overlayRect.height * scaleY) / 2; // Average for square
            
            // Limit output size to reduce file size (max 1200px for good quality but smaller file)
            const outputSize = Math.min(Math.max(400, Math.floor(sourceSize)), 1200);
            canvas.width = outputSize;
            canvas.height = outputSize;
            
            // Draw cropped image to canvas
            ctx.drawImage(
                img,
                sourceX, sourceY, sourceSize, sourceSize,  // Source rectangle
                0, 0, outputSize, outputSize  // Destination rectangle
            );
            
            // Convert to blob first to check size, then compress if needed
            const maxSize = 10 * 1024 * 1024; // 10MB
            const targetSize = 2 * 1024 * 1024; // Target 2MB for better compression
            let quality = 0.6; // Start with lower quality to reduce size significantly
            
            canvas.toBlob(function(blob) {
                // If blob is still too large, reduce quality further
                if (blob && blob.size > maxSize) {
                    quality = 0.5;
                    canvas.toBlob(function(compressedBlob) {
                        if (compressedBlob && compressedBlob.size > maxSize) {
                            quality = 0.4;
                            canvas.toBlob(function(finalBlob) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    updateImagePreview(e.target.result);
                                };
                                reader.readAsDataURL(finalBlob);
                            }, 'image/jpeg', quality);
                        } else {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                updateImagePreview(e.target.result);
                            };
                            reader.readAsDataURL(compressedBlob);
                        }
                    }, 'image/jpeg', quality);
                } else if (blob && blob.size > targetSize) {
                    // If larger than target but smaller than max, try to compress a bit more
                    quality = 0.55;
                    canvas.toBlob(function(optimizedBlob) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            updateImagePreview(e.target.result);
                        };
                        reader.readAsDataURL(optimizedBlob);
                    }, 'image/jpeg', quality);
                } else {
                    // Size is acceptable, use current quality
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updateImagePreview(e.target.result);
                    };
                    reader.readAsDataURL(blob);
                }
            }, 'image/jpeg', quality);
        }
        
        function updateImagePreview(dataUrl) {
            // Update preview and URL input
            const previewImg = document.getElementById('item-modal-preview-img');
            const urlInput = document.getElementById('item-modal-image');
            
            if (previewImg) previewImg.src = dataUrl;
            if (urlInput) urlInput.value = dataUrl;
            
            // Close modal
            closeImageCropModal();
            
            // Check final size
            const sizeInMB = (dataUrl.length * 3 / 4) / 1024 / 1024;
            if (sizeInMB > 10) {
                showMessage(`‚ö†Ô∏è ·∫¢nh sau khi c·∫Øt v·∫´n l·ªõn h∆°n 10MB (${sizeInMB.toFixed(2)}MB). Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.`, 'warning');
            } else {
                showMessage(`‚úÖ ƒê√£ c·∫Øt ·∫£nh th√†nh h√¨nh vu√¥ng! (${sizeInMB.toFixed(2)}MB)`, "success");
            }
        }

        // Expose to global scope
        window.openImageCropModal = openImageCropModal;
        window.closeImageCropModal = closeImageCropModal;
        window.applyCrop = applyCrop;

        function openEditItemModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            // Console log full item data including details
            console.log('üìù Ch·ªânh s·ª≠a m√≥n - D·ªØ li·ªáu ƒë·∫ßy ƒë·ªß:', item);
            if (item.details) {
                console.log('üìã Chi ti·∫øt m√≥n:', item.details);
            }

            document.getElementById('item-modal-title').textContent = '‚úèÔ∏è Ch·ªânh S·ª≠a M√≥n';
            document.getElementById('item-modal-submit').textContent = 'C·∫≠p Nh·∫≠t M√≥n';

            // Fill form
            document.getElementById('item-modal-id').value = item.id;
            document.getElementById('item-modal-name').value = item.name;
            document.getElementById('item-modal-price').value = item.price;
            document.getElementById('item-modal-new-price').value = item.newPrice || '';
            document.getElementById('item-modal-category').value = item.category;
            document.getElementById('item-modal-status').value = item.status;
            document.getElementById('item-modal-item-type').value = item.itemType || 'simple';
            document.getElementById('item-modal-image').value = item.imageUrl || '';
            document.getElementById('item-modal-description').value = item.description || '';

            // Load item details - deep clone ƒë·ªÉ tr√°nh reference issues
            if (item.details && item.itemType && item.itemType !== 'simple') {
                const clonedDetails = JSON.parse(JSON.stringify(item.details));
                const defaultDetails = getDefaultDetails(item.itemType);
                // Merge: gi·ªØ nguy√™n gi√° tr·ªã c≈©, th√™m c√°c field m·ªõi t·ª´ default n·∫øu thi·∫øu
                currentItemDetails = {
                    ...defaultDetails,
                    ...clonedDetails,
                    // ƒê·∫£m b·∫£o arrays t·ªìn t·∫°i v√† gi·ªØ nguy√™n gi√° tr·ªã c≈©
                    sizes: clonedDetails.sizes || defaultDetails.sizes || [],
                    toppings: clonedDetails.toppings || defaultDetails.toppings || [],
                    iceOptions: clonedDetails.iceOptions || defaultDetails.iceOptions || [],
                    sugarOptions: clonedDetails.sugarOptions || defaultDetails.sugarOptions || [],
                    spiceLevels: clonedDetails.spiceLevels || defaultDetails.spiceLevels || [],
                    noodleTypes: clonedDetails.noodleTypes || defaultDetails.noodleTypes || []
                };
            } else {
                currentItemDetails = null;
            }

            // Show/hide config button
            const configButton = document.getElementById('item-modal-config-button-field');
            configButton.style.display = (item.itemType && item.itemType !== 'simple') ? 'block' : 'none';

            document.getElementById('item-modal').classList.remove('hidden');

            // Setup item type change listener
            const itemTypeSelect = document.getElementById('item-modal-item-type');
            itemTypeSelect.addEventListener('change', function() {
                const configButton = document.getElementById('item-modal-config-button-field');
                configButton.style.display = this.value !== 'simple' ? 'block' : 'none';
                // Reset details when changing type (but ask confirmation if already configured)
                if (this.value !== 'simple' && !currentItemDetails) {
                    currentItemDetails = getDefaultDetails(this.value);
                } else if (this.value === 'simple') {
                    currentItemDetails = null;
                }
            });

            // Setup image preview and update with current image
            setupImagePreview();
            const previewImg = document.getElementById('item-modal-preview-img');
            if (item.imageUrl) {
                previewImg.src = item.imageUrl;
                previewImg.onerror = function() {
                    previewImg.src = 'https://via.placeholder.com/200x150?text=No+Image';
                };
            } else {
                previewImg.src = 'https://via.placeholder.com/200x150?text=No+Image';
            }
        }

        function closeItemModal() {
            document.getElementById('item-modal').classList.add('hidden');
        }

        // M·ªü modal xem chi ti·∫øt m√≥n
        function openItemDetailModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            // Console log full item data including details
            console.log('üëÄ Xem chi ti·∫øt m√≥n - D·ªØ li·ªáu ƒë·∫ßy ƒë·ªß:', item);
            if (item.details) {
                console.log('üìã Chi ti·∫øt m√≥n:', item.details);
            }

            const modal = document.getElementById('item-detail-modal');
            const content = document.getElementById('item-detail-content');
            
            if (!modal || !content) return;

            // Render chi ti·∫øt m√≥n
            const itemPrice = getItemPrice(item);
            const hasDetails = item.itemType !== 'simple' && item.details;
            
            let detailsHtml = '';
            if (hasDetails) {
                const details = item.details;
                detailsHtml = '<div class="mt-3 sm:mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">';
                detailsHtml += '<h4 class="font-semibold text-blue-900 mb-2 text-sm sm:text-base">üìã Chi ti·∫øt c·∫•u h√¨nh:</h4>';
                detailsHtml += '<div class="grid grid-cols-2 sm:grid-cols-1 gap-2 sm:gap-0">';
                
                // Sizes
                if (details.sizes && details.sizes.length > 0) {
                    const enabledSizes = details.sizes.filter(s => s.enabled);
                    if (enabledSizes.length > 0) {
                        const sizesText = enabledSizes.map(s => {
                            const priceAdd = s.priceAdd || s.price || 0;
                            return `${s.name} ${priceAdd > 0 ? `(${priceAdd.toLocaleString()}ƒë)` : '(Gi√° m√≥n)'}`;
                        }).join(', ');
                        detailsHtml += '<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">Size: </span><span class="text-xs sm:text-sm text-gray-600">' + sizesText + '</span></div>';
                    }
                }
                
                // Toppings
                if (details.toppings && details.toppings.length > 0) {
                    const toppingsText = details.toppings.map(t => `${t.name} (+${t.price?.toLocaleString() || 0}ƒë)`).join(', ');
                    detailsHtml += '<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">Topping: </span><span class="text-xs sm:text-sm text-gray-600">' + toppingsText + '</span></div>';
                }
                
                // Ice/Sugar options
                if (details.iceOptions && details.iceOptions.length > 0) {
                    detailsHtml += `<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">ƒê√°: </span><span class="text-xs sm:text-sm text-gray-600">${details.iceOptions.join('%, ')}%</span></div>`;
                }
                if (details.sugarOptions && details.sugarOptions.length > 0) {
                    detailsHtml += `<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">ƒê∆∞·ªùng: </span><span class="text-xs sm:text-sm text-gray-600">${details.sugarOptions.join('%, ')}%</span></div>`;
                }
                
                // Spice levels
                if (details.spiceLevels && details.spiceLevels.length > 0) {
                    detailsHtml += `<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">ƒê·ªô cay: </span><span class="text-xs sm:text-sm text-gray-600">${details.spiceLevels.join(', ')}</span></div>`;
                }
                
                // Noodle types
                if (details.noodleTypes && details.noodleTypes.length > 0) {
                    detailsHtml += `<div class="mb-2 sm:mb-2"><span class="text-xs sm:text-sm font-medium text-gray-700">Lo·∫°i s·ª£i: </span><span class="text-xs sm:text-sm text-gray-600">${details.noodleTypes.join(', ')}</span></div>`;
                }
                
                detailsHtml += '</div></div>';
            }

            content.innerHTML = `
                <div class="space-y-3 sm:space-y-4">
                    ${item.imageUrl ? `
                        <div class="flex justify-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-full max-w-xs aspect-square object-cover rounded-lg border border-gray-200" onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
                        </div>
                    ` : ''}
                    
                    <!-- T√™n m√≥n - 1 h√†ng ri√™ng -->
                    <div class="pb-3 border-b border-gray-200">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">T√™n m√≥n</label>
                        <p class="text-sm sm:text-base font-semibold text-gray-900">${item.name}</p>
                    </div>
                    
                    <!-- Danh m·ª•c v√† Lo·∫°i m√≥n - c√πng 1 h√†ng -->
                    <div class="py-3 border-b border-gray-200">
                        <div class="grid grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Danh m·ª•c</label>
                                <p class="text-sm sm:text-base text-gray-900">${item.category}</p>
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Lo·∫°i m√≥n</label>
                                <p class="text-sm sm:text-base text-gray-900">
                                    ${item.itemType === 'simple' ? 'ƒê∆°n gi·∫£n' :
                                      item.itemType === 'drink' ? 'ƒê·ªì u·ªëng' :
                                      item.itemType === 'noodle' ? 'M√¨/Ph·ªü' :
                                      item.itemType === 'food' ? 'ƒê·ªì ƒÉn' :
                                      item.itemType === 'alcohol' ? 'ƒê·ªì nh·∫≠u' : 'Kh√°c'}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gi√° v√† Tr·∫°ng th√°i - c√πng 1 h√†ng -->
                    <div class="py-3 border-b border-gray-200">
                        <div class="grid grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Gi√°</label>
                                <p class="text-sm sm:text-base font-semibold text-orange-600">
                                    ${item.newPrice ? 
                                        (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                            `${formatCurrency(item.newPrice)}` :
                                            `${formatCurrency(item.price)} ‚Üí ${formatCurrency(item.newPrice)}`
                                        ) :
                                        formatCurrency(item.price)
                                    }
                                </p>
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                                <p class="text-sm sm:text-base">${getStatusBadge(item.status) || '<span class="text-green-600">‚úÖ ƒêang b√°n</span>'}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${item.size ? `
                        <!-- Size - 1 h√†ng ri√™ng -->
                        <div class="py-3 border-b border-gray-200">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Size</label>
                            <p class="text-sm sm:text-base text-gray-900">${item.size}</p>
                        </div>
                    ` : ''}
                    
                    ${item.description ? `
                        <!-- M√¥ t·∫£ - 1 h√†ng ri√™ng -->
                        <div class="py-3 border-b border-gray-200">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">M√¥ t·∫£</label>
                            <p class="text-sm sm:text-base text-gray-700">${item.description}</p>
                        </div>
                    ` : ''}
                    
                    ${detailsHtml}
                    
                    ${item.createdAt ? `
                        <div class="pt-3 border-t text-xs sm:text-sm text-gray-500">
                            <p>T·∫°o l√∫c: ${new Date(item.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                            ${item.updatedAt ? `<p>C·∫≠p nh·∫≠t l√∫c: ${new Date(item.updatedAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            // Set itemId ƒë·ªÉ c√°c n√∫t c√≥ th·ªÉ s·ª≠ d·ª•ng
            document.getElementById('item-detail-item-id').value = itemId;
            
            modal.classList.remove('hidden');
            renderLucideIcons();
        }

        function closeItemDetailModal() {
            document.getElementById('item-detail-modal').classList.add('hidden');
        }

        // ==================== ITEM DETAILS CONFIG ====================
        
        function openItemDetailsConfig() {
            const itemType = document.getElementById('item-modal-item-type').value;
            if (itemType === 'simple') {
                showMessage("M√≥n ƒë∆°n gi·∫£n kh√¥ng c·∫ßn c·∫•u h√¨nh chi ti·∫øt", "info");
                return;
            }

            // Load current details if editing - ∆∞u ti√™n d√πng currentItemDetails ƒë√£ ƒë∆∞·ª£c set khi m·ªü edit modal
            const itemId = document.getElementById('item-modal-id').value;
            if (itemId) {
                const item = menuItems.find(i => i.id === itemId);
                // N·∫øu ch∆∞a c√≥ currentItemDetails ho·∫∑c currentItemDetails l√† null, th√¨ load t·ª´ item
                if (!currentItemDetails && item?.details) {
                    // Deep clone ƒë·ªÉ kh√¥ng b·ªã reference
                    currentItemDetails = JSON.parse(JSON.stringify(item.details));
                } else if (!currentItemDetails) {
                    // N·∫øu kh√¥ng c√≥ details t·ª´ item, d√πng default
                    currentItemDetails = getDefaultDetails(itemType);
                }
                // N·∫øu ƒë√£ c√≥ currentItemDetails r·ªìi (t·ª´ khi m·ªü edit modal), gi·ªØ nguy√™n - kh√¥ng override
            } else {
                // N·∫øu l√† m√≥n m·ªõi, d√πng currentItemDetails hi·ªán t·∫°i ho·∫∑c default
                currentItemDetails = currentItemDetails || getDefaultDetails(itemType);
            }

            renderItemDetailsConfig(itemType);
            document.getElementById('item-details-modal').classList.remove('hidden');
        }

        function closeItemDetailsConfig() {
            document.getElementById('item-details-modal').classList.add('hidden');
        }

        function getDefaultDetails(itemType) {
            switch (itemType) {
                case 'drink':
                    return {
                        sizes: [
                            { name: 'S', priceAdd: 0, enabled: true },
                            { name: 'M', priceAdd: 5000, enabled: true },
                            { name: 'L', priceAdd: 10000, enabled: true }
                        ],
                        toppings: [],
                        iceOptions: [0, 25, 50, 75, 100],
                        sugarOptions: [0, 25, 50, 75, 100]
                    };
                case 'noodle':
                    return {
                        spiceLevels: [0, 1, 2, 3, 4, 5, 6, 7], // 0 = kh√¥ng cay, 1-7 = c·∫•p ƒë·ªô cay
                        toppings: []
                    };
                case 'food':
                    return {
                        sizes: [
                            { name: 'Nh·ªè', priceAdd: 0, enabled: true },
                            { name: 'V·ª´a', priceAdd: 10000, enabled: true },
                            { name: 'L·ªõn', priceAdd: 20000, enabled: true }
                        ]
                    };
                case 'alcohol':
                    return {
                        sizes: [
                            { name: 'Nh·ªè', priceAdd: 0, enabled: true },
                            { name: 'L·ªõn', priceAdd: 20000, enabled: true }
                        ]
                    };
                default:
                    return {};
            }
        }

        function renderItemDetailsConfig(itemType) {
            const content = document.getElementById('item-details-content');
            
            switch (itemType) {
                case 'drink':
                    content.innerHTML = renderDrinkConfig();
                    break;
                case 'noodle':
                    content.innerHTML = renderNoodleConfig();
                    break;
                case 'food':
                    content.innerHTML = renderFoodConfig();
                    break;
                case 'alcohol':
                    content.innerHTML = renderAlcoholConfig();
                    break;
                default:
                    content.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ c·∫•u h√¨nh cho lo·∫°i n√†y</p>';
            }

            renderLucideIcons();
        }

        function renderDrinkConfig() {
            const itemPrice = parseFloat(document.getElementById('item-modal-price')?.value) || 0;
            const itemNewPrice = parseFloat(document.getElementById('item-modal-new-price')?.value) || 0;
            const basePrice = itemNewPrice > 0 ? itemNewPrice : itemPrice;
            
            const enabledSizes = currentItemDetails.sizes.filter(s => s.enabled);
            const smallestEnabledIdx = enabledSizes.length > 0 ? 
                currentItemDetails.sizes.findIndex(s => s.enabled) : -1;
            
            return `
                <div class="space-y-4 sm:space-y-6">
                    <!-- Sizes -->
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-lg border border-blue-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-bold text-blue-900">üìè Size (K√≠ch c·ª°)</h4>
                            <button onclick="addDrinkSize()" class="w-full sm:w-auto bg-blue-500 text-white px-3 py-2 sm:py-1 rounded text-sm hover:bg-blue-600 active:scale-95 transition">+ Th√™m Size</button>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-600 mb-2 sm:mb-3">üí° Size nh·ªè nh·∫•t ƒë∆∞·ª£c ch·ªçn s·∫Ω l·∫•y gi√° t·ª´ m√≥n (${formatCurrency(basePrice)}). C√°c size l·ªõn h∆°n nh·∫≠p gi√° th√™m.</p>
                        <div id="drink-sizes-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${currentItemDetails.sizes.map((size, idx) => {
                                const isSmallest = idx === smallestEnabledIdx;
                                const displayPrice = isSmallest && size.enabled ? basePrice : size.priceAdd;
                                return `
                                    <div class="flex gap-2 items-center bg-white p-2 sm:p-3 rounded ${size.enabled ? '' : 'opacity-60'}">
                                        <input type="checkbox" ${size.enabled ? 'checked' : ''} onchange="toggleDrinkSize(${idx}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0">
                                        <input type="text" value="${size.name}" onchange="updateDrinkSize(${idx}, 'name', this.value)" placeholder="T√™n size" class="flex-1 min-w-0 px-2 py-1.5 sm:py-1 border rounded text-sm ${size.enabled ? '' : 'bg-gray-100'}">
                                        <input type="number" value="${displayPrice}" onchange="updateDrinkSize(${idx}, 'priceAdd', this.value)" placeholder="${isSmallest && size.enabled ? 'Gi√° t·ª´ m√≥n' : 'Gi√° th√™m'}" class="w-20 sm:w-32 px-2 py-1.5 sm:py-1 border rounded text-sm ${isSmallest && size.enabled ? 'bg-gray-100 cursor-not-allowed' : ''}" ${isSmallest && size.enabled ? 'disabled' : ''}>
                                        <button onclick="removeDrinkSize(${idx})" class="text-red-600 hover:text-red-800 px-2 text-lg sm:text-base active:scale-95 transition">üóëÔ∏è</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Toppings -->
                    <div class="bg-purple-50 p-3 sm:p-4 rounded-lg border border-purple-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-bold text-purple-900">üßã Topping</h4>
                            <button onclick="addDrinkTopping()" class="w-full sm:w-auto bg-purple-500 text-white px-3 py-2 sm:py-1 rounded text-sm hover:bg-purple-600 active:scale-95 transition">+ Th√™m Topping</button>
                        </div>
                        <div id="drink-toppings-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${currentItemDetails.toppings.map((topping, idx) => `
                                <div class="flex gap-2 items-center bg-white p-2 sm:p-3 rounded">
                                    <input type="text" value="${topping.name}" onchange="updateDrinkTopping(${idx}, 'name', this.value)" placeholder="T√™n topping" class="flex-1 min-w-0 px-2 py-1.5 sm:py-1 border rounded text-sm">
                                    <input type="number" value="${topping.price}" onchange="updateDrinkTopping(${idx}, 'price', this.value)" placeholder="Gi√°" class="w-20 sm:w-32 px-2 py-1.5 sm:py-1 border rounded text-sm">
                                    <button onclick="removeDrinkTopping(${idx})" class="text-red-600 hover:text-red-800 px-2 text-lg sm:text-base active:scale-95 transition">üóëÔ∏è</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Ice Options -->
                    <div class="bg-cyan-50 p-3 sm:p-4 rounded-lg border border-cyan-200">
                        <h4 class="text-base sm:text-lg font-bold text-cyan-900 mb-2 sm:mb-3">üßä T√πy ch·ªçn ƒê√° (%)</h4>
                        <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2">
                            ${[0, 25, 50, 75, 100].map(val => `
                                <label class="flex items-center justify-center gap-1.5 sm:gap-1 bg-white px-3 sm:px-4 py-2.5 sm:py-2 rounded border cursor-pointer hover:bg-cyan-100 active:scale-95 transition touch-manipulation">
                                    <input type="checkbox" ${currentItemDetails.iceOptions.includes(val) ? 'checked' : ''} onchange="toggleIceOption(${val}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-4">
                                    <span class="text-sm sm:text-xs">${val}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Sugar Options -->
                    <div class="bg-yellow-50 p-3 sm:p-4 rounded-lg border border-yellow-200">
                        <h4 class="text-base sm:text-lg font-bold text-yellow-900 mb-2 sm:mb-3">üçØ T√πy ch·ªçn ƒê∆∞·ªùng (%)</h4>
                        <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2">
                            ${[0, 25, 50, 75, 100].map(val => `
                                <label class="flex items-center justify-center gap-1.5 sm:gap-1 bg-white px-3 sm:px-4 py-2.5 sm:py-2 rounded border cursor-pointer hover:bg-yellow-100 active:scale-95 transition touch-manipulation">
                                    <input type="checkbox" ${currentItemDetails.sugarOptions.includes(val) ? 'checked' : ''} onchange="toggleSugarOption(${val}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-4">
                                    <span class="text-sm sm:text-xs">${val}%</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNoodleConfig() {
            const maxLevel = Math.max(...currentItemDetails.spiceLevels);
            return `
                <div class="space-y-4 sm:space-y-6">
                    <!-- Spice Levels -->
                    <div class="bg-red-50 p-3 sm:p-4 rounded-lg border border-red-200">
                        <h4 class="text-base sm:text-lg font-bold text-red-900 mb-2 sm:mb-3">üå∂Ô∏è ƒê·ªô Cay (C·∫•p ƒë·ªô)</h4>
                        <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2">
                            ${[0, 1, 2, 3, 4, 5, 6, 7].map(val => {
                                const label = val === 0 ? 'Kh√¥ng cay' : `C·∫•p ${val}`;
                                return `
                                    <label class="flex items-center justify-center gap-1.5 sm:gap-1 bg-white px-3 sm:px-4 py-2.5 sm:py-2 rounded border cursor-pointer hover:bg-red-100 active:scale-95 transition touch-manipulation">
                                        <input type="checkbox" ${currentItemDetails.spiceLevels.includes(val) ? 'checked' : ''} onchange="toggleSpiceLevel(${val}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-4">
                                        <span class="text-sm sm:text-xs">${label}</span>
                                    </label>
                                `;
                            }).join('')}
                            ${currentItemDetails.spiceLevels.filter(l => l > 7).map(val => `
                                <label class="flex items-center justify-center gap-1.5 sm:gap-1 bg-white px-3 sm:px-4 py-2.5 sm:py-2 rounded border cursor-pointer hover:bg-red-100 relative group active:scale-95 transition touch-manipulation">
                                    <input type="checkbox" checked disabled class="opacity-50 w-4 h-4 sm:w-5 sm:h-4">
                                    <span class="text-sm sm:text-xs">C·∫•p ${val}</span>
                                    <button onclick="event.preventDefault(); removeCustomSpiceLevel(${val})" class="text-red-600 hover:text-red-800 ml-1 text-lg sm:text-base">üóëÔ∏è</button>
                                </label>
                            `).join('')}
                        </div>
                        <button onclick="addCustomSpiceLevel()" class="mt-3 bg-red-500 text-white px-4 py-2.5 sm:py-2 rounded text-sm hover:bg-red-600 w-full active:scale-95 transition">
                            + Th√™m C·∫•p ƒê·ªô Cao H∆°n (C·∫•p ${maxLevel + 1})
                        </button>
                        <p class="text-xs sm:text-sm text-gray-500 mt-2">üí° Ch·ªçn c√°c c·∫•p ƒë·ªô cay c∆° b·∫£n 0-7, ho·∫∑c th√™m c·∫•p ƒë·ªô cao h∆°n n·∫øu c·∫ßn</p>
                    </div>

                    <!-- Toppings -->
                    <div class="bg-purple-50 p-3 sm:p-4 rounded-lg border border-purple-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-bold text-purple-900">üçú Topping</h4>
                            <button onclick="addNoodleTopping()" class="w-full sm:w-auto bg-purple-500 text-white px-3 py-2 sm:py-1 rounded text-sm hover:bg-purple-600 active:scale-95 transition">+ Th√™m Topping</button>
                        </div>
                        <div id="noodle-toppings-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${currentItemDetails.toppings.map((topping, idx) => `
                                <div class="flex gap-2 items-center bg-white p-2 sm:p-3 rounded">
                                    <input type="text" value="${topping.name}" onchange="updateNoodleTopping(${idx}, 'name', this.value)" placeholder="T√™n topping" class="flex-1 min-w-0 px-2 py-1.5 sm:py-1 border rounded text-sm">
                                    <input type="number" value="${topping.price}" onchange="updateNoodleTopping(${idx}, 'price', this.value)" placeholder="Gi√°" class="w-20 sm:w-32 px-2 py-1.5 sm:py-1 border rounded text-sm">
                                    <button onclick="removeNoodleTopping(${idx})" class="text-red-600 hover:text-red-800 px-2 text-lg sm:text-base active:scale-95 transition">üóëÔ∏è</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFoodConfig() {
            const itemPrice = parseFloat(document.getElementById('item-modal-price')?.value) || 0;
            const itemNewPrice = parseFloat(document.getElementById('item-modal-new-price')?.value) || 0;
            const basePrice = itemNewPrice > 0 ? itemNewPrice : itemPrice;
            
            const enabledSizes = currentItemDetails.sizes.filter(s => s.enabled);
            const smallestEnabledIdx = enabledSizes.length > 0 ? 
                currentItemDetails.sizes.findIndex(s => s.enabled) : -1;
            
            return `
                <div class="space-y-4 sm:space-y-6">
                    <!-- Sizes -->
                    <div class="bg-green-50 p-3 sm:p-4 rounded-lg border border-green-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-bold text-green-900">üìè Size/Ph·∫ßn</h4>
                            <button onclick="addFoodSize()" class="w-full sm:w-auto bg-green-500 text-white px-3 py-2 sm:py-1 rounded text-sm hover:bg-green-600 active:scale-95 transition">+ Th√™m Size</button>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-600 mb-2 sm:mb-3">üí° Size nh·ªè nh·∫•t ƒë∆∞·ª£c ch·ªçn s·∫Ω l·∫•y gi√° t·ª´ m√≥n (${formatCurrency(basePrice)}). C√°c size l·ªõn h∆°n nh·∫≠p gi√° th√™m.</p>
                        <div id="food-sizes-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${currentItemDetails.sizes.map((size, idx) => {
                                const isSmallest = idx === smallestEnabledIdx;
                                const displayPrice = isSmallest && size.enabled ? basePrice : size.priceAdd;
                                return `
                                    <div class="flex gap-2 items-center bg-white p-2 sm:p-3 rounded ${size.enabled ? '' : 'opacity-60'}">
                                        <input type="checkbox" ${size.enabled ? 'checked' : ''} onchange="toggleFoodSize(${idx}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-4 flex-shrink-0">
                                        <input type="text" value="${size.name}" onchange="updateFoodSize(${idx}, 'name', this.value)" placeholder="T√™n size" class="flex-1 min-w-0 px-2 py-1.5 sm:py-1 border rounded text-sm ${size.enabled ? '' : 'bg-gray-100'}">
                                        <input type="number" value="${displayPrice}" onchange="updateFoodSize(${idx}, 'priceAdd', this.value)" placeholder="${isSmallest && size.enabled ? 'Gi√° t·ª´ m√≥n' : 'Gi√° th√™m'}" class="w-20 sm:w-32 px-2 py-1.5 sm:py-1 border rounded text-sm ${isSmallest && size.enabled ? 'bg-gray-100 cursor-not-allowed' : ''}" ${isSmallest && size.enabled ? 'disabled' : ''}>
                                        <button onclick="removeFoodSize(${idx})" class="text-red-600 hover:text-red-800 px-2 text-lg sm:text-base active:scale-95 transition">üóëÔ∏è</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAlcoholConfig() {
            const itemPrice = parseFloat(document.getElementById('item-modal-price')?.value) || 0;
            const itemNewPrice = parseFloat(document.getElementById('item-modal-new-price')?.value) || 0;
            const basePrice = itemNewPrice > 0 ? itemNewPrice : itemPrice;
            
            const enabledSizes = currentItemDetails.sizes.filter(s => s.enabled);
            const smallestEnabledIdx = enabledSizes.length > 0 ? 
                currentItemDetails.sizes.findIndex(s => s.enabled) : -1;
            
            return `
                <div class="space-y-4 sm:space-y-6">
                    <!-- Sizes -->
                    <div class="bg-amber-50 p-3 sm:p-4 rounded-lg border border-amber-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-bold text-amber-900">üç∫ Size</h4>
                            <button onclick="addAlcoholSize()" class="w-full sm:w-auto bg-amber-500 text-white px-3 py-2 sm:py-1 rounded text-sm hover:bg-amber-600 active:scale-95 transition">+ Th√™m Size</button>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-600 mb-2 sm:mb-3">üí° Size nh·ªè nh·∫•t ƒë∆∞·ª£c ch·ªçn s·∫Ω l·∫•y gi√° t·ª´ m√≥n (${formatCurrency(basePrice)}). C√°c size l·ªõn h∆°n nh·∫≠p gi√° th√™m.</p>
                        <div id="alcohol-sizes-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${currentItemDetails.sizes.map((size, idx) => {
                                const isSmallest = idx === smallestEnabledIdx;
                                const displayPrice = isSmallest && size.enabled ? basePrice : size.priceAdd;
                                return `
                                    <div class="flex gap-2 items-center bg-white p-2 sm:p-3 rounded ${size.enabled ? '' : 'opacity-60'}">
                                        <input type="checkbox" ${size.enabled ? 'checked' : ''} onchange="toggleAlcoholSize(${idx}, this.checked)" class="w-4 h-4 sm:w-5 sm:h-4 flex-shrink-0">
                                        <input type="text" value="${size.name}" onchange="updateAlcoholSize(${idx}, 'name', this.value)" placeholder="T√™n size" class="flex-1 min-w-0 px-2 py-1.5 sm:py-1 border rounded text-sm ${size.enabled ? '' : 'bg-gray-100'}">
                                        <input type="number" value="${displayPrice}" onchange="updateAlcoholSize(${idx}, 'priceAdd', this.value)" placeholder="${isSmallest && size.enabled ? 'Gi√° t·ª´ m√≥n' : 'Gi√° th√™m'}" class="w-20 sm:w-32 px-2 py-1.5 sm:py-1 border rounded text-sm ${isSmallest && size.enabled ? 'bg-gray-100 cursor-not-allowed' : ''}" ${isSmallest && size.enabled ? 'disabled' : ''}>
                                        <button onclick="removeAlcoholSize(${idx})" class="text-red-600 hover:text-red-800 px-2 text-lg sm:text-base active:scale-95 transition">üóëÔ∏è</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function saveItemDetailsConfig() {
            // Details ƒë√£ ƒë∆∞·ª£c update qua c√°c h√†m update* r·ªìi, ch·ªâ c·∫ßn ƒë√≥ng modal
            showMessage("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh chi ti·∫øt", "success");
            closeItemDetailsConfig();
        }

        // === DRINK HELPERS ===
        function addDrinkSize() {
            currentItemDetails.sizes.push({ name: '', priceAdd: 0, enabled: true });
            renderItemDetailsConfig('drink');
        }
        function updateDrinkSize(idx, field, value) {
            currentItemDetails.sizes[idx][field] = field === 'priceAdd' ? parseFloat(value) || 0 : value;
        }
        function toggleDrinkSize(idx, checked) {
            currentItemDetails.sizes[idx].enabled = checked;
            renderItemDetailsConfig('drink');
        }
        function removeDrinkSize(idx) {
            currentItemDetails.sizes.splice(idx, 1);
            renderItemDetailsConfig('drink');
        }
        function addDrinkTopping() {
            currentItemDetails.toppings.push({ name: '', price: 0 });
            renderItemDetailsConfig('drink');
        }
        function updateDrinkTopping(idx, field, value) {
            currentItemDetails.toppings[idx][field] = field === 'price' ? parseFloat(value) || 0 : value;
        }
        function removeDrinkTopping(idx) {
            currentItemDetails.toppings.splice(idx, 1);
            renderItemDetailsConfig('drink');
        }
        function toggleIceOption(val, checked) {
            if (checked) {
                if (!currentItemDetails.iceOptions.includes(val)) {
                    currentItemDetails.iceOptions.push(val);
                    currentItemDetails.iceOptions.sort((a, b) => a - b);
                }
            } else {
                currentItemDetails.iceOptions = currentItemDetails.iceOptions.filter(v => v !== val);
            }
        }
        function toggleSugarOption(val, checked) {
            if (checked) {
                if (!currentItemDetails.sugarOptions.includes(val)) {
                    currentItemDetails.sugarOptions.push(val);
                    currentItemDetails.sugarOptions.sort((a, b) => a - b);
                }
            } else {
                currentItemDetails.sugarOptions = currentItemDetails.sugarOptions.filter(v => v !== val);
            }
        }

        // === NOODLE HELPERS ===
        function toggleSpiceLevel(val, checked) {
            if (checked) {
                if (!currentItemDetails.spiceLevels.includes(val)) {
                    currentItemDetails.spiceLevels.push(val);
                    currentItemDetails.spiceLevels.sort((a, b) => a - b);
                }
            } else {
                currentItemDetails.spiceLevels = currentItemDetails.spiceLevels.filter(v => v !== val);
            }
        }
        function addCustomSpiceLevel() {
            const maxLevel = Math.max(...currentItemDetails.spiceLevels);
            const newLevel = maxLevel + 1;
            currentItemDetails.spiceLevels.push(newLevel);
            currentItemDetails.spiceLevels.sort((a, b) => a - b);
            renderItemDetailsConfig('noodle');
            showMessage(`‚úÖ ƒê√£ th√™m C·∫•p ${newLevel}`, "success");
        }
        function removeCustomSpiceLevel(val) {
            if (val <= 7) {
                showMessage("‚ùå Kh√¥ng th·ªÉ x√≥a c·∫•p ƒë·ªô c∆° b·∫£n 0-7", "error");
                return;
            }
            currentItemDetails.spiceLevels = currentItemDetails.spiceLevels.filter(v => v !== val);
            renderItemDetailsConfig('noodle');
            showMessage(`‚úÖ ƒê√£ x√≥a C·∫•p ${val}`, "success");
        }
        function addNoodleTopping() {
            currentItemDetails.toppings.push({ name: '', price: 0 });
            renderItemDetailsConfig('noodle');
        }
        function updateNoodleTopping(idx, field, value) {
            currentItemDetails.toppings[idx][field] = field === 'price' ? parseFloat(value) || 0 : value;
        }
        function removeNoodleTopping(idx) {
            currentItemDetails.toppings.splice(idx, 1);
            renderItemDetailsConfig('noodle');
        }

        // === FOOD HELPERS ===
        function addFoodSize() {
            currentItemDetails.sizes.push({ name: '', priceAdd: 0, enabled: true });
            renderItemDetailsConfig('food');
        }
        function updateFoodSize(idx, field, value) {
            currentItemDetails.sizes[idx][field] = field === 'priceAdd' ? parseFloat(value) || 0 : value;
        }
        function toggleFoodSize(idx, checked) {
            currentItemDetails.sizes[idx].enabled = checked;
            renderItemDetailsConfig('food');
        }
        function removeFoodSize(idx) {
            currentItemDetails.sizes.splice(idx, 1);
            renderItemDetailsConfig('food');
        }

        // === ALCOHOL HELPERS ===
        function addAlcoholSize() {
            currentItemDetails.sizes.push({ name: '', priceAdd: 0, enabled: true });
            renderItemDetailsConfig('alcohol');
        }
        function updateAlcoholSize(idx, field, value) {
            currentItemDetails.sizes[idx][field] = field === 'priceAdd' ? parseFloat(value) || 0 : value;
        }
        function toggleAlcoholSize(idx, checked) {
            currentItemDetails.sizes[idx].enabled = checked;
            renderItemDetailsConfig('alcohol');
        }
        function removeAlcoholSize(idx) {
            currentItemDetails.sizes.splice(idx, 1);
            renderItemDetailsConfig('alcohol');
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' ‚Ç´';
        }

        // Helper function to get the appropriate price (prefer newPrice, fallback to price)
        function getItemPrice(item) {
            return item.newPrice ? parseFloat(item.newPrice) : parseFloat(item.price);
        }

        // Normalize item details: Set priceAdd = 0 cho size nh·ªè nh·∫•t ƒë∆∞·ª£c enabled
        function normalizeItemDetails(details) {
            if (!details || !details.sizes) return details;
            
            // Deep clone ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn original
            const normalized = JSON.parse(JSON.stringify(details));
            
            // T√¨m size nh·ªè nh·∫•t ƒë∆∞·ª£c enabled (enabled = true ƒë·∫ßu ti√™n)
            const enabledSizes = normalized.sizes.filter(s => s.enabled);
            if (enabledSizes.length > 0) {
                // T√¨m index c·ªßa size nh·ªè nh·∫•t trong m·∫£ng g·ªëc
                const smallestEnabledIndex = normalized.sizes.findIndex(s => s.enabled);
                if (smallestEnabledIndex !== -1) {
                    // Set priceAdd = 0 cho size nh·ªè nh·∫•t
                    normalized.sizes[smallestEnabledIndex].priceAdd = 0;
                }
            }
            
            return normalized;
        }

        // --- Qu·∫£n l√Ω D·ªØ li·ªáu Firebase ---
        const PUBLIC_DATA_PATH = `menuItems`; // ƒê∆°n gi·∫£n h√≥a path cho development
        const PRIVATE_SALES_PATH = `sales/${userId}`;

        // ==================== CATEGORIES MANAGEMENT ====================

        const CATEGORIES_DOC_ID = 'categories_config';

        async function loadCategories() {
            try {
                // console.log("üîÑ Loading categories from Firebase..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    categories = data.categories || ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'];
                    // console.log("‚úÖ Loaded categories:", categories); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                } else {
                    // N·∫øu ch∆∞a c√≥, t·∫°o document m·∫∑c ƒë·ªãnh
                    categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'];
                    await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                    // console.log("‚úÖ Created default categories in Firebase"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                }
            } catch (error) {
                // console.error("‚ùå Error loading categories:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u']; // Fallback
            }
        }

        async function saveCategories() {
            try {
                // console.log("üíæ Saving categories to Firebase..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                // console.log("‚úÖ Categories saved successfully"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            } catch (error) {
                // console.error("‚ùå Error saving categories:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi l∆∞u danh m·ª•c: " + error.message, "error");
            }
        }

        function setupMenuListener() {
            if (!db) {
                // console.warn("‚ùå DB ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                return;
            }
            const q = query(collection(db, PUBLIC_DATA_PATH));
                // console.log("üîÑ Setting up menu listener for path:", PUBLIC_DATA_PATH); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

            onSnapshot(q, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // console.log("‚úÖ Loaded menu items:", menuItems.length, "items"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.log("üìã Menu items:", menuItems.map(...)); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.log("üîç Raw snapshot:", snapshot.docs.map(...)); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Ki·ªÉm tra currentCategory c√≥ c√≤n active kh√¥ng (c√≥ m√≥n kh√¥ng)
                const activeCategories = categories.filter(cat =>
                    menuItems.some(item => item.category === cat && item.status !== 'deleted')
                );
                if (!activeCategories.includes(currentCategory) && activeCategories.length > 0) {
                    // N·∫øu currentCategory kh√¥ng c√≤n active, chuy·ªÉn v·ªÅ category ƒë·∫ßu ti√™n
                    currentCategory = activeCategories[0];
                    // console.log("üîÑ Current category changed to:", currentCategory); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                }

                // Auto-cleanup expired items
                cleanupExpiredItems();

                renderApp();
            }, (error) => {
                // console.error("‚ùå L·ªói khi nghe thay ƒë·ªïi menu:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.error("‚ùå Error details:", error.code, error.message); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // Fallback: th·ª≠ load m·ªôt l·∫ßn
                loadMenuItemsOnce();
            });
        }

        async function loadMenuItemsOnce() {
            try {
                // console.log("üîÑ Loading menu items once..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                const querySnapshot = await getDocs(collection(db, PUBLIC_DATA_PATH));
                menuItems = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // console.log("‚úÖ Loaded menu items (once):", menuItems.length, "items"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                renderApp();
            } catch (error) {
                // console.error("‚ùå Failed to load menu items:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            }
        }
        
        async function saveItem(item) {
            const isNew = !item.id;

            try {
                let imageUrl = item.imageUrl;

                // Handle file upload - Convert to Data URL
                const fileInput = document.getElementById('item-modal-image-file');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    // console.log("üì∏ Processing image..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    showMessage("ƒêang x·ª≠ l√Ω ·∫£nh...", "info");
                    
                    try {
                        imageUrl = await uploadImage(fileInput.files[0]);
                        showMessage("‚úÖ ·∫¢nh ƒë√£ s·∫µn s√†ng!", "success");
                        // console.log("‚úÖ Image ready for save"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    } catch (error) {
                        showMessage("‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: " + error.message, "error");
                        throw error;
                    }
                }

                // Fallback to placeholder if no image provided
                if (!imageUrl || imageUrl.trim() === '') {
                    imageUrl = `https://via.placeholder.com/400x300/f0d48f/8b542f?text=${encodeURIComponent(item.name.substring(0, 10))}`;
                    // console.log("üìù Using placeholder image"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                }

                const itemToSave = {
                    name: item.name,
                    description: item.description,
                    price: parseFloat(item.price),
                    category: item.category,
                    status: item.status || 'active',
                    imageUrl: imageUrl,
                    updatedAt: new Date(),
                };

                // Add itemType if provided
                if (item.itemType) {
                    itemToSave.itemType = item.itemType;
                }

                // Add details if provided (for drink, noodle, food, alcohol types)
                if (item.details) {
                    // Normalize details: Set priceAdd = 0 cho size nh·ªè nh·∫•t ƒë∆∞·ª£c enabled
                    const normalizedDetails = normalizeItemDetails(item.details);
                    itemToSave.details = normalizedDetails;
                }

                // Add size if provided (for drinks)
                if (item.size && item.size.trim() !== '') {
                    itemToSave.size = item.size;
                }

                // Add newPrice if provided, remove if empty/0
                if (item.newPrice && parseFloat(item.newPrice) > 0) {
                    itemToSave.newPrice = parseFloat(item.newPrice);
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(itemToSave).forEach(key => {
                    if (itemToSave[key] === undefined || itemToSave[key] === null) {
                        delete itemToSave[key];
                    }
                });
                // Note: If newPrice is not included, Firestore will remove the field

                if (isNew) {
                    // T·∫°o itemId t·ª± ƒë·ªông tƒÉng d·∫ßn
                    // T√¨m itemId l·ªõn nh·∫•t hi·ªán c√≥
                    const maxItemId = menuItems
                        .filter(item => item.itemId !== undefined && item.itemId !== null)
                        .reduce((max, item) => Math.max(max, item.itemId || 0), 0);
                    
                    // T·∫°o itemId m·ªõi = maxItemId + 1
                    itemToSave.itemId = maxItemId + 1;
                    itemToSave.createdAt = new Date();
                    
                    await addDoc(collection(db, PUBLIC_DATA_PATH), itemToSave);
                    // console.log("Th√™m m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    showMessage("Th√™m m√≥n th√†nh c√¥ng!", "success");
                } else {
                    const itemRef = doc(db, PUBLIC_DATA_PATH, item.id);
                    await updateDoc(itemRef, itemToSave);
                    // console.log("C·∫≠p nh·∫≠t m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    showMessage("C·∫≠p nh·∫≠t m√≥n th√†nh c√¥ng!", "success");
                }

                // Clear file input
                if (fileInput) fileInput.value = '';

                // Reload menu items and close modal
                await loadMenuItemsOnce();
                closeItemModal();
            } catch (e) {
                // console.error("L·ªói khi l∆∞u m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi l∆∞u m√≥n: " + e.message, "error");
            }
        }
        
        async function deleteItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y? M√≥n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v√†o th√πng r√°c.")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'deleted',
                    deletedAt: new Date(),
                    updatedAt: new Date()
                });
                // console.log("‚úÖ Chuy·ªÉn m√≥n v√†o th√πng r√°c th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Reload menu items to reflect changes
                await loadMenuItemsOnce();

                showMessage("ƒê√£ chuy·ªÉn m√≥n v√†o th√πng r√°c!", "success");
            } catch (e) {
                // console.error("‚ùå L·ªói khi x√≥a m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi x√≥a m√≥n: " + e.message, "error");
            }
        }

        // Kh√¥i ph·ª•c m√≥n ƒÉn t·ª´ th√πng r√°c
        window.restoreMenuItem = async function(id) {
            if (!confirm("Kh√¥i ph·ª•c m√≥n ƒÉn n√†y?")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: null, // Tr·ªü v·ªÅ tr·∫°ng th√°i active
                    restoredAt: new Date(),
                    updatedAt: new Date()
                });
                // console.log("‚úÖ Kh√¥i ph·ª•c m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Reload menu items to reflect changes
                await loadMenuItemsOnce();

                // Re-render trash view
                if (currentView === 'admin-trash') {
                    renderApp();
                }

                showMessage("ƒê√£ kh√¥i ph·ª•c m√≥n ƒÉn!", "success");
            } catch (e) {
                // console.error("‚ùå L·ªói khi kh√¥i ph·ª•c m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi kh√¥i ph·ª•c m√≥n: " + e.message, "error");
            }
        }

        // X√≥a vƒ©nh vi·ªÖn m√≥n ƒÉn
        window.permanentDeleteMenuItem = async function(id) {
            if (!confirm("‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN m√≥n n√†y? H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!")) return;
            if (!confirm("B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën x√≥a vƒ©nh vi·ªÖn?")) return;
            
            try {
                await deleteDoc(doc(db, PUBLIC_DATA_PATH, id));
                // console.log("‚úÖ X√≥a vƒ©nh vi·ªÖn m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Reload menu items to reflect changes
                await loadMenuItemsOnce();

                // Re-render trash view
                if (currentView === 'admin-trash') {
                    renderApp();
                }

                showMessage("ƒê√£ x√≥a vƒ©nh vi·ªÖn m√≥n ƒÉn!", "success");
            } catch (e) {
                // console.error("‚ùå L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n: " + e.message, "error");
            }
        }

        // Convert image to Base64 Data URL (l∆∞u tr·ª±c ti·∫øp trong database)
        async function uploadImage(file) {
            if (!file) return null;

            try {
                // console.log("üì∏ Converting image to Data URL..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.log("üìÅ File:", file.name, "Size:", (file.size / 1024).toFixed(2), "KB"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Check file size (max 10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error(`·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 10MB. (File hi·ªán t·∫°i: ${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const dataURL = e.target.result;
                        // console.log("‚úÖ Image converted successfully!"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        // console.log("üìä Data URL length:", dataURL.length); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        resolve(dataURL);
                    };
                    
                    reader.onerror = function(error) {
                        // console.error("‚ùå Error reading file:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        reject(error);
                    };
                    
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                // console.error("‚ùå Error processing image:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                throw error;
            }
        }

        // Thay ƒë·ªïi m·∫≠t kh·∫©u
        async function changePassword(currentPassword, newPassword) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("Kh√¥ng c√≥ user ƒëƒÉng nh·∫≠p");

                // Re-authenticate v·ªõi password hi·ªán t·∫°i
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);

                // Update password m·ªõi
                await updatePassword(user, newPassword);
                // console.log("Password changed successfully"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                showMessage("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
                return true;
            } catch (error) {
                // console.error("Error changing password:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                let errorMessage = "L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u";

                if (error.code === 'auth/wrong-password') {
                    errorMessage = "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "M·∫≠t kh·∫©u m·ªõi qu√° y·∫øu";
                }

                showMessage(errorMessage, "error");
                return false;
            }
        }

        // --- Qu·∫£n l√Ω ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

                // console.log("üîê Attempting login with email:", email); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

            try {
                showMessage("ƒêang ƒëƒÉng nh·∫≠p...", "info");
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // console.log("‚úÖ Login successful!"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.log("üë§ User:", userCredential.user.email); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                // console.log("üÜî UID:", userCredential.user.uid); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                
                // Check if admin
                const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                const isAdminUser = adminEmails.includes(userCredential.user.email);
                
                // console.log("üëë Is Admin:", isAdminUser); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                
                if (isAdminUser) {
                    showMessage("‚úÖ ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng! Chuy·ªÉn ƒë·∫øn Dashboard...", "success");
                    // console.log("üöÄ Redirecting to Admin Dashboard"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                    // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát cho admin
                    setTimeout(() => {
                        requestNotificationPermission();
                    }, 1000);
                } else {
                    showMessage("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Nh∆∞ng t√†i kho·∫£n kh√¥ng c√≥ quy·ªÅn Admin.", "info");
                    // console.log("‚ö†Ô∏è User is not admin, staying in customer view"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                }
                
                // AuthStateChanged s·∫Ω lo vi·ªác chuy·ªÉn view
            } catch (error) {
                // console.error("‚ùå Login failed:", error.code, error.message); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                let errorMessage = "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.";

                if (error.code === 'auth/user-not-found') {
                    errorMessage = "‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "‚ùå Email kh√¥ng h·ª£p l·ªá.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "‚ùå Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                }

                document.getElementById('login-message').textContent = errorMessage;
                showMessage(errorMessage, "error");
                // console.log("‚ùå Error details:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            }
        }
        
        async function handleLogout() {
            try {
                // console.log("üîì Logging out..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                await signOut(auth);
                // console.log("‚úÖ Logout successful"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!", "success");
                isPreviewMode = false;
                // AuthStateChanged s·∫Ω lo vi·ªác chuy·ªÉn view
            } catch (error) {
                // console.error("‚ùå Logout error:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi ƒëƒÉng xu·∫•t", "error");
            }
        }

        // --- Kh·ªüi t·∫°o v√† Qu·∫£n l√Ω Auth ---
        // ==================== SESSION MANAGEMENT (COOKIE) ====================

        let currentSessionId = null; // ID session c·ªßa kh√°ch
        let guestOrders = []; // L·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa kh√°ch trong session

        // T·∫°o session ID duy nh·∫•t
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // L∆∞u session v√†o cookie (expire sau 2 gi·ªù)
        function saveSessionToCookie() {
            const sessionData = {
                sessionId: currentSessionId,
                tableNumber: currentTableNumber,
                orders: guestOrders,
                createdAt: new Date().toISOString()
            };

            const expirationTime = new Date();
            expirationTime.setTime(expirationTime.getTime() + (30 * 60 * 1000)); // 30 ph√∫t
            // expirationTime.setTime(expirationTime.getTime() + (1 * 60 * 1000)); // 1 ph√∫t (ƒë·ªÉ test)
            // expirationTime.setTime(expirationTime.getTime() + (2 * 60 * 60 * 1000)); // 2 gi·ªù (production)

            document.cookie = `guest_session=${JSON.stringify(sessionData)}; expires=${expirationTime.toUTCString()}; path=/`;

            // console.log('üíæ Session saved to cookie:', sessionData); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
        }

        // ƒê·ªçc session t·ª´ cookie
        function loadSessionFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'guest_session') {
                    try {
                        const sessionData = JSON.parse(decodeURIComponent(value));

                        // Ki·ªÉm tra xem session c√≥ c√≤n h·ª£p l·ªá kh√¥ng (1 ph√∫t)
                        const sessionAge = Date.now() - new Date(sessionData.createdAt).getTime();
                        const maxAge = 1 * 60 * 1000; // 1 ph√∫t (ƒë·ªÉ test)

                        // console.log('üç™ Cookie check:', {...}); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                        if (sessionAge < maxAge) {
                            currentSessionId = sessionData.sessionId;
                            currentTableNumber = sessionData.tableNumber;
                            guestOrders = sessionData.orders || [];
                            userRole = 'guest';

                            // console.log('üìñ Session loaded from cookie:', sessionData); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                            return true;
                        } else {
                            // Session h·∫øt h·∫°n, x√≥a cookie
                            clearSessionCookie();
                            console.log('‚è∞ Session expired, cleared cookie');
                        }
                    } catch (error) {
                        console.error('Error parsing session cookie:', error);
                        clearSessionCookie();
                    }
                    break;
                }
            }
            return false;
        }

        // X√≥a session cookie
        function clearSessionCookie() {
            document.cookie = 'guest_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            currentSessionId = null;
            currentTableNumber = null;
            guestOrders = [];
            userRole = 'guest';
        }

        // ==================== TABLE MANAGEMENT ====================

        // ƒê·ªçc table number t·ª´ URL (QR code scan)
        function checkTableFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const tableNumber = urlParams.get('table');

            if (tableNumber) {
                // Ki·ªÉm tra xem b√†n c√≥ t·ªìn t·∫°i kh√¥ng (ch·ªâ check n·∫øu ƒë√£ load tables)
                if (tables.length > 0) {
                    const tableExists = tables.some(t => t.tableNumber === tableNumber);
                    if (!tableExists) {
                        console.warn(`Table ${tableNumber} does not exist`);
                        showMessage(`B√†n ${tableNumber} kh√¥ng t·ªìn t·∫°i!`, 'error');
                        return;
                    }
                }

                // Ki·ªÉm tra xem c√≥ session c≈© v·ªõi b√†n kh√°c kh√¥ng
                if (currentTableNumber && currentTableNumber !== tableNumber) {
                    // ƒê·ªïi b√†n m·ªõi, t·∫°o session m·ªõi
                    console.log(`üîÑ Changing table from ${currentTableNumber} to ${tableNumber}`);
                    guestOrders = []; // Reset orders khi ƒë·ªïi b√†n
                }

                currentTableNumber = tableNumber;
                userRole = 'guest';

                // T·∫°o session ID m·ªõi n·∫øu ch∆∞a c√≥
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                }

                console.log(`üçΩÔ∏è Guest accessing from Table ${tableNumber} (Session: ${currentSessionId})`);
                showMessage(`Ch√†o m·ª´ng ƒë·∫øn B√†n ${tableNumber}!`, 'success');

                // L∆∞u session v√†o cookie
                saveSessionToCookie();

                // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t header
                renderApp();
            }
        }
        
        // Setup realtime listener cho tables
        function setupTablesListener() {
            if (!db) return;
            
            try {
                console.log("üì° Setting up tables realtime listener...");
                const tablesRef = collection(db, 'tables');
                
                onSnapshot(tablesRef, (snapshot) => {
                    tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("üçΩÔ∏è Tables updated:", tables.length);
                    
                    // Re-render n·∫øu ƒëang ·ªü admin tables view
                    if (isAdmin && currentView === 'admin-tables') {
                        renderApp();
                    }

                    // Re-render n·∫øu ƒëang ·ªü admin view (for backward compatibility)
                    if (isAdmin && currentView === 'admin') {
                        renderApp();
                    }

                    // C·∫≠p nh·∫≠t modal ch·ªçn b√†n n·∫øu ƒëang m·ªü
                    const tableModal = document.getElementById('table-selection-modal');
                    if (tableModal && !tableModal.classList.contains('hidden')) {
                        console.log("üîÑ Updating table selection modal");
                        // Re-load danh s√°ch b√†n trong modal
                        const content = document.getElementById('table-selection-content');
                        if (content) {
                            const availableTables = tables.filter(table => !table.status || table.status === 'available');
                            console.log("‚úÖ Available tables for modal:", availableTables);
                            content.innerHTML = availableTables.map(table => `
                                <button onclick="selectTable('${table.tableNumber}')" class="p-2 sm:p-3 lg:p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-1 sm:space-y-2 active:scale-95">
                                    <i data-lucide="table-2" class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-teal-600"></i>
                                    <span class="font-semibold text-gray-800 text-sm sm:text-base">B√†n ${table.tableNumber}</span>
                                    <span class="text-xs text-green-600 bg-green-100 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full">${table.status || 'Tr·ªëng'}</span>
                                </button>
                            `).join('');
                            renderLucideIcons();
                        }
                    }
                });
                
            } catch (error) {
                console.error("Error setting up tables listener:", error);
            }
        }

        // Load tables m·ªôt l·∫ßn (fallback n·∫øu realtime ch∆∞a load)
        async function loadTablesOnce() {
            if (!db || tables.length > 0) return; // ƒê√£ c√≥ data r·ªìi

            try {
                console.log("üîÑ Loading tables once...");
                const tablesRef = collection(db, 'tables');
                const snapshot = await getDocs(tablesRef);
                tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("‚úÖ Tables loaded once:", tables.length);
                console.log("üìã Tables data:", tables);
            } catch (error) {
                console.error("Error loading tables once:", error);
            }
        }
        
        // Th√™m b√†n m·ªõi
        async function addTable() {
            const tableNumber = document.getElementById('new-table-number').value.trim();
            
            if (!tableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "warning");
                return;
            }
            
            // Ki·ªÉm tra tr√πng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`B√†n ${tableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }
            
            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                await addDoc(collection(db, 'tables'), tableData);
                
                showMessage(`‚úÖ ƒê√£ th√™m B√†n ${tableNumber}`, "success");
                closeAddTableModal();
                
            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("L·ªói th√™m b√†n: " + error.message, "error");
            }
        }
        
        // X√≥a b√†n
        async function deleteTable(tableId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†n n√†y?")) return;
            
            try {
                await deleteDoc(doc(db, 'tables', tableId));
                showMessage("‚úÖ ƒê√£ x√≥a b√†n", "success");
                
            } catch (error) {
                console.error("Error deleting table:", error);
                showMessage("L·ªói x√≥a b√†n: " + error.message, "error");
            }
        }
        
        // Hi·ªÉn th·ªã QR Code c·ªßa b√†n
        function showTableQR(tableId, tableNumber) {
            const modal = document.getElementById('qr-modal');
            const qrContainer = document.getElementById('qr-code-container');
            const tableInfo = document.getElementById('qr-table-info');
            
            // Clear previous QR
            qrContainer.innerHTML = '';
            
            // T·∫°o URL v·ªõi table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;
            
            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">B√†n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">Qu√©t QR code n√†y ƒë·ªÉ v√†o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function closeQRModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }
        
        function openAddTableModal() {
            document.getElementById('add-table-modal').classList.remove('hidden');
        }
        
        function closeAddTableModal() {
            document.getElementById('add-table-modal').classList.add('hidden');
            document.getElementById('new-table-number').value = '';
        }
        
        // Download QR Code as image
        function downloadQR() {
            const qrCanvas = document.querySelector('#qr-code-container canvas');
            if (!qrCanvas) return;
            
            const tableNumber = document.querySelector('#qr-table-info .text-teal-600').textContent;
            
            const link = document.createElement('a');
            link.download = `QR-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }
        
        function initFirebase() {
            try {
                // Debug: Check current cookies
                // console.log('üç™ Current cookies:', document.cookie); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

                // Load session t·ª´ cookie tr∆∞·ªõc
                loadSessionFromCookie();

                // Ki·ªÉm tra table t·ª´ URL (c√≥ th·ªÉ override session c≈©)
                checkTableFromURL();

                // console.log("üöÄ Initializing Firebase with config:", firebaseConfig); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    storage = getStorage(app);
                    console.log("‚úÖ Firebase initialized successfully");
                } else {
                    console.warn("‚ùå Firebase Config kh√¥ng t·ªìn t·∫°i. D√πng ch·∫ø ƒë·ªô Demo.");
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Check if user is admin (multiple admin emails supported)
                        const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                        isAdmin = adminEmails.includes(user.email);
                        
                        // console.log("üë§ User authenticated:", user.email); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        // console.log("üëë Is Admin:", isAdmin); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        
                        if (__initial_auth_token && user.isAnonymous) {
                            // ƒê√¢y l√† logic ƒë·∫∑c bi·ªát cho m√¥i tr∆∞·ªùng Canvas, d√πng token ban ƒë·∫ßu
                            await signInWithCustomToken(auth, __initial_auth_token);
                            // Sau khi ƒëƒÉng nh·∫≠p b·∫±ng custom token, user v·∫´n l√† ·∫©n danh.
                            userId = auth.currentUser.uid;
                            isAdmin = false;
                        }
                        
                        if (db) {
                            setupMenuListener();
                            setupTablesListener(); // Always setup for table selection modal

                            // Load categories from Firebase and re-render after loading
                            loadCategories().then(() => {
                                renderApp(); // Re-render after categories are loaded
                            });

                            // Setup listeners for admin
                            if (isAdmin) {
                                setupOrdersListener();
                                setupTablesListener(); // Always setup for admin tables view
                            }
                        }
                        
                        // Chuy·ªÉn v·ªÅ tr·∫°ng th√°i Kh√°ch h√†ng n·∫øu kh√¥ng ph·∫£i Admin
                        if (isAdmin && currentView === 'login') {
                           console.log("üöÄ Switching to Admin Dashboard");
                           setView('admin-stats');
                           showMessage("Ch√†o m·ª´ng Admin! üëë", "success");
                        } else if (!isAdmin && currentView === 'login') {
                           console.log("üë§ Switching to Customer view");
                           setView('customer');
                        } else if (isAdmin && currentView === 'customer' && !isPreviewMode) {
                           // Admin ƒëƒÉng nh·∫≠p nh∆∞ng ƒëang ·ªü trang customer ‚Üí chuy·ªÉn v·ªÅ admin
                           console.log("üöÄ Admin logged in, redirecting to admin dashboard");
                           setView('admin-stats');
                        }

                        // Kh·ªüi t·∫°o timer session cleanup sau khi authentication ho√†n th√†nh
                        // Ch·ªâ √°p d·ª•ng cho kh√°ch h√†ng, kh√¥ng √°p d·ª•ng cho admin
                        if (!isAdmin) {
                            console.log('‚è∞ Timer b·∫Øt ƒë·∫ßu: S·∫Ω t·ª± ƒë·ªông x√≥a d·ªØ li·ªáu sau 2 gi·ªù');
                            const autoCleanupTimer = setTimeout(autoCleanupCustomerData, TWO_HOURS);

                            // L∆∞u th·ªùi gian b·∫Øt ƒë·∫ßu ƒë·ªÉ c√≥ th·ªÉ ki·ªÉm tra
                            const startTime = new Date();
                            console.log('üïê Th·ªùi gian b·∫Øt ƒë·∫ßu:', startTime.toLocaleString('vi-VN'));
                            console.log('üïê Th·ªùi gian x√≥a d·ª± ki·∫øn:', new Date(startTime.getTime() + TWO_HOURS).toLocaleString('vi-VN'));

                            // Optional: L∆∞u timer ID ƒë·ªÉ c√≥ th·ªÉ h·ªßy n·∫øu c·∫ßn (v√≠ d·ª•: khi user logout)
                            window.autoCleanupTimerId = autoCleanupTimer;
                        } else {
                            console.log('üëë Admin mode: Timer t·ª± ƒë·ªông x√≥a d·ªØ li·ªáu b·ªã t·∫Øt ƒë·ªÉ kh√¥ng l√†m gi√°n ƒëo·∫°n c√¥ng vi·ªác');
                        }
                    } else {
                        // User ƒë√£ ƒëƒÉng xu·∫•t
                        isAdmin = false;
                        userId = crypto.randomUUID(); // D√πng ID ng·∫´u nhi√™n cho kh√°ch ·∫©n danh
                        if (db) {
                            // T·∫°m th·ªùi b·ªè anonymous auth ƒë·ªÉ tr√°nh l·ªói config
                            // if (!__initial_auth_token) await signInAnonymously(auth);
                            // console.log("üîÑ Setting up menu listener without auth..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                            setupMenuListener();

                            // Kh·ªüi t·∫°o timer cho kh√°ch h√†ng ·∫©n danh
                            console.log('‚è∞ Timer b·∫Øt ƒë·∫ßu: S·∫Ω t·ª± ƒë·ªông x√≥a d·ªØ li·ªáu sau 2 gi·ªù (kh√°ch h√†ng ·∫©n danh)');
                            const autoCleanupTimer = setTimeout(autoCleanupCustomerData, TWO_HOURS);

                            // L∆∞u th·ªùi gian b·∫Øt ƒë·∫ßu ƒë·ªÉ c√≥ th·ªÉ ki·ªÉm tra
                            const startTime = new Date();
                            console.log('üïê Th·ªùi gian b·∫Øt ƒë·∫ßu:', startTime.toLocaleString('vi-VN'));
                            console.log('üïê Th·ªùi gian x√≥a d·ª± ki·∫øn:', new Date(startTime.getTime() + TWO_HOURS).toLocaleString('vi-VN'));

                            // Optional: L∆∞u timer ID ƒë·ªÉ c√≥ th·ªÉ h·ªßy n·∫øu c·∫ßn (v√≠ d·ª•: khi user logout)
                            window.autoCleanupTimerId = autoCleanupTimer;

                            // Load categories from Firebase and re-render after loading
                            loadCategories().then(() => {
                                renderApp(); // Re-render after categories are loaded
                            });
                        }
                        setView('customer');
                    }
                    renderApp();
                });
            } catch (e) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
            }
        }


        // --- Render UI ---
        function renderHeader() {
            const loginButton = isAdmin
                ? `<button onclick="handleLogout()" class="px-4 py-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition duration-150 flex items-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>ƒêƒÉng Xu·∫•t</span>
                </button>`
                : `<button onclick="setView('login')" class="px-4 py-2 rounded-full bg-orange-600 text-white hover:bg-orange-700 transition duration-150">ƒêƒÉng Nh·∫≠p Admin</button>`;

            // ƒê·∫øm ƒë∆°n h√†ng ch·ªù nh·∫≠n (ch·ªâ admin th·∫•y)
            const pendingOrdersCount = isAdmin ? orders.filter(o => o.status === 'ordered').length : 0;
            
            const adminToggle = isAdmin
                ? `<button onclick="toggleAdminMode()" class="flex items-center justify-center w-10 h-10 rounded-full ${currentView === 'admin' ? 'bg-blue-500 hover:bg-blue-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white font-semibold transition duration-150" title="${currentView === 'admin' ? 'Xem Trang Kh√°ch' : 'Qu·∫£n L√Ω Admin'}">
                    <i data-lucide="${currentView === 'admin' ? 'eye' : 'settings'}" class="w-5 h-5"></i>
                </button>` : '';
            
            const adminBadge = isAdmin && !isPreviewMode
                ? `<span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">üëë ADMIN</span>`
                : isPreviewMode
                ? `<span class="px-3 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">üëÅÔ∏è PREVIEW</span>`
                : '';

            // Admin page title
            const adminPageTitle = isAdmin && currentView.startsWith('admin') ? (() => {
                const titles = {
                    'admin-stats': 'üìä Th·ªëng K√™',
                    'admin-orders': 'üìã ƒê∆°n H√†ng',
                    'admin-tables': 'üçΩÔ∏è B√†n ƒÇn',
                    'admin-menu': 'üçΩÔ∏è Menu',
                    'admin-trash': 'üóëÔ∏è Th√πng R√°c'
                };
                return titles[currentView] || 'üëë Admin';
            })() : '';
            
            // Admin navigation buttons
            const adminNavButtons = isAdmin ? `
                <div class="flex items-center space-x-2">
                    <button onclick="setView('admin-stats')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-stats' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Th·ªëng K√™</span>
                    </button>
                    <button onclick="setView('admin-orders')" class="relative flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-orders' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">ƒê∆°n H√†ng</span>
                        ${pendingOrdersCount > 0 ? `
                            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform bg-red-600 rounded-full animate-pulse">
                                ${pendingOrdersCount}
                            </span>
                        ` : ''}
                    </button>
                    <button onclick="setView('admin-tables')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-tables' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-teal-500 hover:bg-teal-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="table-2" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">B√†n ƒÇn</span>
                    </button>
                    <button onclick="setView('admin-menu')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-menu' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-orange-500 hover:bg-orange-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="coffee" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Menu</span>
                    </button>
                    <button onclick="setView('admin-trash')" class="relative flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-trash' ? 'bg-gray-700 hover:bg-gray-800' : 'bg-gray-600 hover:bg-gray-700'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Th√πng R√°c</span>
                        ${(() => {
                            const deletedOrdersCount = orders.filter(o => o.status === 'deleted').length;
                            const deletedMenuCount = menuItems.filter(m => m.status === 'deleted').length;
                            const totalDeleted = deletedOrdersCount + deletedMenuCount;
                            return totalDeleted > 0 ? `
                                <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform bg-red-600 rounded-full">
                                    ${totalDeleted}
                                </span>
                            ` : '';
                        })()}
                    </button>
                </div>
            ` : '';
            
             // T√≠nh t·ªïng s·ªë m√≥n trong gi·ªè h√†ng
             const totalItemsInCart = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);

            return `
                <header class="sticky top-0 z-20 bg-amber-100/90 backdrop-blur-sm shadow-md border-b border-yellow-700/50">
                    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-3 sm:py-4">
                        <!-- Logo Qu√°n + S·ªë B√†n -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                                <a href="#" onclick="handleLogoClick()" class="block"><img src="logo.png" alt="Logo" class="w-10 h-10 border-2 border-amber-200 rounded-full sm:w-6 sm:h-6 lg:w-8 lg:h-8 flex-shrink-0 object-contain"></a>
                                <div class="min-w-0 flex-1">
                                    
                                        <h1 class="text-sm sm:text-lg lg:text-xl font-bold text-amber-900 font-serif truncate"><a href="#" onclick="handleLogoClick()" class="block">Chill Coffee</a></h1>
                                    
                                    ${adminPageTitle ? `
                                        <div class="mt-0.5">
                                            <p class="text-xs sm:text-sm text-red-600 font-semibold truncate">${adminPageTitle}</p>
                                        </div>
                                    ` : currentTableNumber ? `
                                        <div class="flex items-center gap-1 sm:gap-2 mt-0.5">
                                            <p class="text-xs sm:text-sm text-teal-600 font-semibold flex items-center gap-1 truncate">
                                                <i data-lucide="table-2" class="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0"></i>
                                                <span class="truncate">B√†n ${currentTableNumber}</span>
                                            </p>
                                            ${guestOrders.length > 0 ? `
                                                <span class="text-xs bg-teal-100 text-teal-700 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full flex-shrink-0">
                                                    ${guestOrders.length} ƒë∆°n
                                                </span>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Always Visible Actions (Contact & Table Selection & Orders & Cart) -->
                            <div class="flex items-center space-x-2 sm:space-x-3 y-2">
                                ${!isAdmin ? `
                                    <a href="#" class="hidden sm:flex items-center text-amber-800 hover:text-orange-600 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="phone" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">Li√™n H·ªá</span>
                                    </a>
                                    <a href="#" class="sm:hidden p-1 rounded-full text-amber-800 hover:text-orange-600 transition duration-150">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                    </a>
                                ` : ''}
                                ${!currentTableNumber && !isAdmin ? `
                                    <button onclick="showTableSelectionModal()" class="hidden md:flex items-center text-teal-600 hover:text-teal-800 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="table-2" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">Ch·ªçn B√†n</span>
                                        <span class="lg:hidden">B√†n</span>
                                    </button>
                                ` : ''}
                                ${!isAdmin ? `
                                <button onclick="showMyOrders()" class="p-1 sm:p-1.5 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-150 shadow-sm active:scale-95" title="ƒê∆°n h√†ng c·ªßa t√¥i">
                                    <i data-lucide="clipboard" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                </button>
                                ` : ''}
                                ${isAdmin ? `
                                <button onclick="setView('admin-orders')" class="md:hidden relative p-1 sm:p-1.5 rounded-full bg-purple-500 text-white hover:bg-purple-600 transition duration-150 shadow-sm active:scale-95" title="ƒê∆°n h√†ng">
                                    <i data-lucide="clipboard-list" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    ${pendingOrdersCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full animate-pulse">${pendingOrdersCount}</span>` : ''}
                                </button>
                                ` : ''}
                                ${!isAdmin ? `
                                    <button onclick="openCart()" class="relative p-1 sm:p-1.5 rounded-full bg-orange-500 text-white hover:bg-orange-600 transition duration-150 shadow-sm">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                        ${totalItemsInCart > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full animate-pulse">${totalItemsInCart}</span>` : ''}
                                    </button>
                                ` : ''}
                            </div>

                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-amber-200 transition duration-150" id="mobile-menu-btn">
                            <i data-lucide="menu" class="w-5 h-5 text-amber-800"></i>
                        </button>

                        <!-- Desktop Navigation -->
                        <div class="hidden md:flex items-center space-x-2 lg:space-x-3 ml-6">
                              ${adminBadge}
                              ${isAdmin ? adminNavButtons : ''}
                              ${adminToggle}
                            ${loginButton}
                        </div>

                        <!-- Mobile Menu Dropdown -->
                        <div id="mobile-menu" class="absolute top-full left-0 right-0 bg-amber-50 shadow-lg border-t border-amber-200 hidden md:hidden z-30">
                            <div class="px-4 py-3 space-y-2">
                                ${isAdmin ? `
                                    <!-- Admin Mobile Menu -->
                                    <button onclick="setView('admin-stats'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-stats' ? 'bg-blue-100' : ''}">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">üìä Th·ªëng K√™</span>
                                    </button>
                                    <button onclick="setView('admin-orders'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-orders' ? 'bg-purple-100' : ''}">
                                        <i data-lucide="clipboard-list" class="w-5 h-5 text-purple-600"></i>
                                        <span class="text-purple-600 font-medium">üìã ƒê∆°n H√†ng</span>
                                        ${pendingOrdersCount > 0 ? `<span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingOrdersCount}</span>` : ''}
                                    </button>
                                    <button onclick="setView('admin-tables'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-tables' ? 'bg-teal-100' : ''}">
                                        <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                        <span class="text-teal-600 font-medium">üçΩÔ∏è B√†n ƒÇn</span>
                                    </button>
                                    <button onclick="setView('admin-menu'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-menu' ? 'bg-orange-100' : ''}">
                                        <i data-lucide="coffee" class="w-5 h-5 text-orange-600"></i>
                                        <span class="text-orange-600 font-medium">üçΩÔ∏è Menu</span>
                                    </button>
                                    <button onclick="setView('admin-trash'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-trash' ? 'bg-gray-100' : ''}">
                                        <i data-lucide="trash-2" class="w-5 h-5 text-gray-600"></i>
                                        <span class="text-gray-600 font-medium">üóëÔ∏è Th√πng R√°c</span>
                                    </button>
                                    <button onclick="previewAsCustomer(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                        <i data-lucide="eye" class="w-5 h-5 text-green-600"></i>
                                        <span class="text-green-600 font-medium">üëÅÔ∏è Xem Ph√≠a Kh√°ch</span>
                                    </button>
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        <button onclick="handleChangePassword(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="lock" class="w-5 h-5 text-purple-600"></i>
                                            <span class="text-purple-600 font-medium">üîê ƒê·ªïi M·∫≠t Kh·∫©u</span>
                                        </button>
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg mt-2').replace('ƒêƒÉng Nh·∫≠p Admin', 'üë®‚Äçüíº ƒêƒÉng Nh·∫≠p Admin').replace('ƒêƒÉng Xu·∫•t', 'üö™ ƒêƒÉng Xu·∫•t')}
                                    </div>
                                ` : `
                                    <!-- Guest Mobile Menu -->
                                    <button onclick="showMyOrders(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                        <i data-lucide="clipboard" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">ƒê∆°n H√†ng C·ªßa T√¥i</span>
                                    </button>
                                    ${!currentTableNumber ? `
                                        <button onclick="showTableSelectionModal(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                            <span class="text-teal-600 font-medium">Ch·ªçn B√†n</span>
                                        </button>
                                    ` : ''}
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg').replace('ƒêƒÉng Nh·∫≠p Admin', 'üë®‚Äçüíº ƒêƒÉng Nh·∫≠p Admin').replace('ƒêƒÉng Xu·∫•t', 'üö™ ƒêƒÉng Xu·∫•t')}
                                    </div>
                                `}
                                ${adminToggle && !isAdmin ? `<div class="border-t border-amber-200 pt-2 mt-2">${adminToggle.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderFeaturedItems() {
            // L·∫•y c√°c m√≥n ƒë·∫∑c bi·ªát: new, hot, best_seller, sale
            const featuredItems = menuItems
                .filter(item => {
                    if (!isAdmin && item.status === 'deleted') return false;
                    if (isAdmin && item.status === 'deleted') return false;
                    return ['new', 'hot', 'best_seller', 'sale'].includes(item.status);
                })
                .sort((a, b) => {
                    // S·∫Øp x·∫øp theo itemId gi·∫£m d·∫ßn
                    const idA = a.itemId !== undefined && a.itemId !== null ? a.itemId : 0;
                    const idB = b.itemId !== undefined && b.itemId !== null ? b.itemId : 0;
                    if (idA > 0 && idB > 0) return idB - idA;
                    if (idA > 0 && idB === 0) return -1;
                    if (idA === 0 && idB > 0) return 1;
                    const timeA = a.createdAt?.seconds || a.updatedAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || b.updatedAt?.seconds || 0;
                    return timeB - timeA;
                });

            if (featuredItems.length === 0) return '';

            // Get badge image based on status
            function getBadgeImage(status) {
                if (status === 'new') return 'new-rmbg.png';
                if (status === 'hot' || status === 'best_seller') return 'Ban-chay-rmbg.png';
                if (status === 'sale') return 'Sale-rmbg.png';
                return '';
            }

            const showAddButton = !isAdmin;

            // Schedule update buttons after render
            setTimeout(() => {
                updateFeaturedScrollButtons();
                renderLucideIcons();
            }, 100);

            return `
                <div class="bg-amber-50 py-3 sm:py-6">
                    <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6">
                        <h2 class="text-base sm:text-xl md:text-2xl font-bold text-amber-900 mb-2 sm:mb-4 px-1">‚≠ê M√≥n ƒê·∫∑c Bi·ªát</h2>
                        <div class="relative">
                            <!-- Navigation Buttons -->
                            ${featuredItems.length > 1 ? `
                                <button onclick="scrollFeaturedItems('left')" class="absolute left-1 sm:left-0 top-1/2 -translate-y-1/2 z-10 bg-white/95 hover:bg-white shadow-md rounded-full p-1.5 sm:p-3 transition-all flex items-center justify-center" id="featured-scroll-left">
                                    <i data-lucide="chevron-left" class="w-4 h-4 sm:w-6 sm:h-6 text-orange-600"></i>
                                </button>
                                <button onclick="scrollFeaturedItems('right')" class="absolute right-1 sm:right-0 top-1/2 -translate-y-1/2 z-10 bg-white/95 hover:bg-white shadow-md rounded-full p-1.5 sm:p-3 transition-all flex items-center justify-center" id="featured-scroll-right">
                                    <i data-lucide="chevron-right" class="w-4 h-4 sm:w-6 sm:h-6 text-orange-600"></i>
                                </button>
                            ` : ''}
                            
                            <!-- Scrollable Container -->
                            <div id="featured-items-container" class="overflow-x-auto scrollbar-hide scroll-smooth pb-2 -mx-2 sm:mx-0 px-2 sm:px-0" style="scrollbar-width: none; -ms-overflow-style: none;" onscroll="updateFeaturedScrollButtons()">
                                <div class="flex gap-2.5 sm:gap-4" style="width: max-content;">
                                    ${featuredItems.map(item => {
                                        const statusBadge = getStatusBadge(item.status);
                                        const isOutOfStock = item.status === 'out_of_stock';
                                        const badgeImage = getBadgeImage(item.status);
                                        
                                        return `
                                            <div class="flex-shrink-0 w-[calc(100vw-3rem)] sm:w-80 bg-white rounded-lg shadow-md overflow-hidden border border-amber-300 flex flex-col hover:shadow-lg transition duration-300 ${isOutOfStock ? 'opacity-60' : ''}">
                                                <div class="relative">
                                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full aspect-square object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400/f0d48f/8b542f?text=M√≥n+ƒÇn'">
                                                    ${badgeImage ? `
                                                        <img src="${badgeImage}" alt="${item.status}" class="absolute top-1.5 left-1.5 sm:top-2 sm:left-2 w-12 h-12 sm:w-20 sm:h-20 object-contain drop-shadow-lg">
                                                    ` : ''}
                                                    <div class="absolute top-1.5 right-1.5 sm:top-2 sm:right-2">
                                                        ${statusBadge}
                                                    </div>
                                                </div>
                                                <div class="p-2.5 sm:p-4 flex flex-col flex-grow">
                                                    <h3 class="text-sm sm:text-lg font-semibold text-amber-900 mb-1 sm:mb-2 leading-tight">${item.name} ${item.size ? `<span class="text-[10px] sm:text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded ml-1">${item.size}</span>` : ''}</h3>
                                                    <p class="text-[11px] sm:text-sm text-gray-500 line-clamp-2 mb-2 sm:mb-3 leading-snug">${item.description}</p>
                                                    <div class="mt-auto flex justify-between items-center gap-2">
                                                        <div class="flex items-center gap-1 sm:gap-2 flex-1 min-w-0">
                                                            ${item.newPrice ?
                                                                (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                                    `<span class="text-base sm:text-xl font-semibold text-orange-600 whitespace-nowrap">${formatCurrency(item.newPrice)}</span>` :
                                                                    `<div class="flex flex-col sm:flex-row sm:items-center sm:gap-1">
                                                                        <span class="text-[10px] sm:text-sm text-gray-500 line-through whitespace-nowrap">${formatCurrency(item.price)}</span>
                                                                        <span class="text-base sm:text-xl font-semibold text-orange-600 whitespace-nowrap">${formatCurrency(item.newPrice)}</span>
                                                                     </div>`
                                                                ) :
                                                                `<span class="text-base sm:text-xl font-semibold text-orange-600 whitespace-nowrap">${formatCurrency(item.price)}</span>`
                                                            }
                                                            ${isAdmin ? `<button onclick="openPriceModal('${item.id}')" class="ml-1 px-1 py-0.5 text-[10px] sm:text-xs bg-blue-500 text-white rounded hover:bg-blue-600">üí∞</button>` : ''}
                                                        </div>
                                                        ${showAddButton && !isOutOfStock ? `
                                                            <button onclick="updateCart('${item.id}', 1)" class="flex-shrink-0 p-1.5 sm:p-2.5 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 shadow-sm active:scale-95">
                                                                <i data-lucide="plus" class="w-3.5 h-3.5 sm:w-5 sm:h-5"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function scrollFeaturedItems(direction) {
            const container = document.getElementById('featured-items-container');
            if (!container) return;
            
            // Calculate scroll amount based on item width + gap
            const firstItem = container.querySelector('.flex-shrink-0');
            if (!firstItem) return;
            
            const itemWidth = firstItem.offsetWidth;
            const gap = 12; // gap-3 = 12px
            const scrollAmount = itemWidth + gap;
            
            const currentScroll = container.scrollLeft;
            const newScroll = direction === 'left' 
                ? Math.max(0, currentScroll - scrollAmount)
                : Math.min(container.scrollWidth - container.clientWidth, currentScroll + scrollAmount);
            
            container.scrollTo({
                left: newScroll,
                behavior: 'smooth'
            });
            
            // Update button visibility
            updateFeaturedScrollButtons();
        }

        function updateFeaturedScrollButtons() {
            const container = document.getElementById('featured-items-container');
            const leftBtn = document.getElementById('featured-scroll-left');
            const rightBtn = document.getElementById('featured-scroll-right');
            
            if (!container) return;
            
            const { scrollLeft, scrollWidth, clientWidth } = container;
            const isScrollable = scrollWidth > clientWidth;
            const isAtStart = scrollLeft <= 5;
            const isAtEnd = scrollLeft >= scrollWidth - clientWidth - 5;
            
            if (leftBtn) {
                leftBtn.style.display = (isScrollable && !isAtStart) ? 'flex' : 'none';
            }
            if (rightBtn) {
                rightBtn.style.display = (isScrollable && !isAtEnd) ? 'flex' : 'none';
            }
        }

        // Expose to global scope
        window.scrollFeaturedItems = scrollFeaturedItems;
        window.updateFeaturedScrollButtons = updateFeaturedScrollButtons;

        function renderMenuSelection() {
            // Ch·ªâ hi·ªÉn th·ªã categories c√≥ √≠t nh·∫•t 1 m√≥n active (kh√¥ng ph·∫£i deleted)
            const activeCategories = categories.filter(cat =>
                menuItems.some(item => item.category === cat && item.status !== 'deleted')
            );

            return `
                <div class="p-5 sm:p-3 bg-amber-50 shadow-inner sticky top-[64px] sm:top-[68px] z-10 overflow-x-auto">
                    <div class="flex space-x-1 sm:space-x-2 min-w-max **px-2 sm:px-3**">
                        ${activeCategories.map(cat => `
                            <button onclick="setCategory('${cat}')" class="${currentCategory === cat ? 'bg-orange-600 text-white shadow-lg' : 'bg-white text-amber-900 hover:bg-amber-200'} font-medium py-1.5 px-3 sm:px-4 rounded-full transition duration-150 text-xs sm:text-sm whitespace-nowrap active:scale-95">
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // ·∫®n m√≥n ƒë√£ x√≥a cho kh√°ch h√†ng v√† admin preview mode
        function renderCustomerMenu() {
            // Filter v√† s·∫Øp x·∫øp m√≥n gi·∫£m d·∫ßn theo itemId (m√≥n m·ªõi nh·∫•t c√≥ ID l·ªõn nh·∫•t l√™n ƒë·∫ßu)
            const filteredItems = menuItems
                .filter(item => {
                    // ·∫®n m√≥n ƒë√£ x√≥a cho kh√°ch h√†ng
                    if (!isAdmin && item.status === 'deleted') return false;
                    if (isAdmin && item.status === 'deleted') return false;
                    return item.category === currentCategory;
                })
                .sort((a, b) => {
                    // S·∫Øp x·∫øp theo itemId gi·∫£m d·∫ßn
                    const idA = a.itemId !== undefined && a.itemId !== null ? a.itemId : 0;
                    const idB = b.itemId !== undefined && b.itemId !== null ? b.itemId : 0;
                    
                    // N·∫øu c·∫£ hai ƒë·ªÅu c√≥ itemId, s·∫Øp x·∫øp theo itemId
                    if (idA > 0 && idB > 0) {
                        return idB - idA; // ID l·ªõn nh·∫•t tr∆∞·ªõc (m√≥n m·ªõi nh·∫•t)
                    }
                    
                    // N·∫øu m·ªôt trong hai kh√¥ng c√≥ itemId, ∆∞u ti√™n m√≥n c√≥ itemId
                    if (idA > 0 && idB === 0) return -1; // a c√≥ itemId, a l√™n tr∆∞·ªõc
                    if (idA === 0 && idB > 0) return 1;  // b c√≥ itemId, b l√™n tr∆∞·ªõc
                    
                    // N·∫øu c·∫£ hai ƒë·ªÅu kh√¥ng c√≥ itemId, s·∫Øp x·∫øp theo th·ªùi gian (fallback)
                    const timeA = a.createdAt?.seconds || a.updatedAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || b.updatedAt?.seconds || 0;
                    return timeB - timeA; // M·ªõi nh·∫•t tr∆∞·ªõc
                });
            
            // Ch·ªâ hi·ªÉn th·ªã n√∫t th√™m khi kh√¥ng ph·∫£i admin (·∫©n ho√†n to√†n v·ªõi admin)
            const showAddButton = !isAdmin;
            
            // Ph√¢n chia items theo categoryType
            // N·∫øu kh√¥ng c√≥ categoryType, fallback: drink n·∫øu itemType l√† 'drink' ho·∫∑c 'alcohol', c√≤n l·∫°i l√† food
            const drinkItems = filteredItems.filter(item => {
                if (item.categoryType === 'drink') return true;
                if (!item.categoryType) {
                    // Fallback cho items c≈©: d·ª±a v√†o itemType
                    return item.itemType === 'drink' || item.itemType === 'alcohol';
                }
                return false;
            });
            const foodItems = filteredItems.filter(item => {
                // N·∫øu ƒë√£ l√† drink th√¨ kh√¥ng th√™m v√†o food
                if (item.categoryType === 'drink') return false;
                if (item.categoryType === 'food') return true;
                if (!item.categoryType) {
                    // Fallback cho items c≈©: kh√¥ng ph·∫£i drink/alcohol th√¨ l√† food
                    return item.itemType !== 'drink' && item.itemType !== 'alcohol';
                }
                // M·∫∑c ƒë·ªãnh l√† food n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c
                return true;
            });
            
            let html = '';
            
            // Render drink items: Layout 1 m√≥n/h√†ng, ·∫£nh tr√°i
            if (drinkItems.length > 0) {
                html += `
                    <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4">
                        ${drinkItems.map(item => {
                            const statusBadge = getStatusBadge(item.status);
                            const isOutOfStock = item.status === 'out_of_stock';
                            
                            return `
                            <div class="flex items-center bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 p-2 sm:p-3 border border-amber-200 ${isOutOfStock ? 'opacity-60' : ''}">
                                <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 sm:w-16 sm:h-16 lg:w-20 lg:h-20 object-cover rounded-md mr-2 sm:mr-3 flex-shrink-0 aspect-square" onerror="this.onerror=null;this.src='https://placehold.co/96x96/f0d48f/8b542f?text=N∆∞·ªõc'">
                                <div class="flex-grow min-w-0">
                                    <div class="flex items-start justify-between gap-1 sm:gap-2 mb-1">
                                        <h3 class="text-sm sm:text-base font-medium text-amber-900 truncate">${item.name}</h3>
                                        ${showAddButton && !isOutOfStock ? `
                                            <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 flex-shrink-0 shadow-sm active:scale-95">
                                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center gap-1 sm:gap-2 mb-1">
                                        ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded whitespace-nowrap">${item.size}</span>` : ''}
                                        ${statusBadge}
                                    </div>
                                    <p class="text-xs text-gray-500 mb-1 line-clamp-2">${item.description}</p>
                                    <div class="flex items-center justify-between gap-1 sm:gap-2">
                                        <div class="flex items-center gap-1 sm:gap-2">
                                            ${item.newPrice ?
                                                (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                    // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                                                    `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                                    // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                                                    `<div class="flex items-center gap-1">
                                                        <span class="text-xs sm:text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                        <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>
                                                     </div>`
                                                ) :
                                                // Kh√¥ng c√≥ gi√° m·ªõi: ch·ªâ hi·ªán gi√° c≈©
                                                `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                            }
                                        </div>
                                        ${isAdmin ? `<button onclick="openPriceModal('${item.id}')" class="px-1.5 py-0.5 sm:px-2 sm:py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-150">üí∞</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            }
            
            // Render food items: Layout lu√¥n 2 m√≥n/h√†ng ·ªü m·ªçi k√≠ch th∆∞·ªõc m√†n h√¨nh
            if (foodItems.length > 0) {
                // Th√™m margin-top n·∫øu c√≥ drink items tr∆∞·ªõc ƒë√≥
                const marginTop = drinkItems.length > 0 ? 'mt-4' : '';
                html += `
                    <div class="max-w-7xl mx-auto ${marginTop}">
                        <div class="grid grid-cols-2 gap-3 sm:gap-4 p-3 sm:p-4">
                        ${foodItems.map(item => {
                            const statusBadge = getStatusBadge(item.status);
                            const isOutOfStock = item.status === 'out_of_stock';
                            
                            return `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-amber-300 flex flex-col hover:shadow-lg transition duration-300 ${isOutOfStock ? 'opacity-60' : ''}">
                                <div class="relative">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full aspect-square object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400/f0d48f/8b542f?text=M√≥n+ƒÇn'">
                                    <div class="absolute top-1 right-1 sm:top-2 sm:right-2">
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="p-3 flex flex-col flex-grow">
                                    <h3 class="text-sm sm:text-base font-semibold text-amber-900 mb-1">${item.name} ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded ml-1">${item.size}</span>` : ''}</h3>
                                    <p class="text-xs text-gray-500 line-clamp-2 mb-2">${item.description}</p>
                                    <div class="mt-auto flex justify-between items-center">
                                        <div class="flex items-center gap-1 sm:gap-2">
                                            ${item.newPrice ?
                                                (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                    // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                                                    `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                                    // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                                                    `<span class="text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                     <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>`
                                                ) :
                                                // Kh√¥ng c√≥ gi√° m·ªõi: ch·ªâ hi·ªán gi√° c≈©
                                                `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                            }
                                            ${isAdmin ? `<button onclick="openPriceModal('${item.id}')" class="ml-1 px-1 py-0.5 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">üí∞</button>` : ''}
                                        </div>
                                        ${showAddButton && !isOutOfStock ? `
                                            <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 shadow-sm">
                                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function getStatusBadge(status) {
            if (!status || status === 'active') return '';

            const badges = {
                'hot': '<span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">üî• B√ÅN CH·∫†Y</span>',
                'new': '<span class="px-2 py-1 bg-green-500 text-white text-xs font-bold rounded-full">üÜï M·ªöI</span>',
                'sale': '<span class="px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded-full">üí∞ SALE</span>',
                'best_seller': '<span class="px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded-full">‚≠ê BEST SELLER</span>',
                'out_of_stock': '<span class="px-2 py-1 bg-gray-500 text-white text-xs font-bold rounded-full">‚ùå H·∫æT H√ÄNG</span>',
                'coming_soon': '<span class="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">‚è≥ S·∫ÆP C√ì</span>',
                'deleted': '<span class="px-2 py-1 bg-black text-white text-xs font-bold rounded-full">üóëÔ∏è ƒê√É X√ìA</span>'
            };

            return badges[status] || '';
        }

        function getCategoryIcon(category) {
            const icons = {
                'ƒê·ªì U·ªëng': '‚òï',
                'ƒê·ªì ƒÇn': 'üçΩÔ∏è',
                'ƒê·ªì Nh·∫≠u': 'üç∫'
            };
            return icons[category] || 'üìÇ';
        }

        // Category Management Functions
        let editingCategory = null;

        function editCategory(categoryName) {
            editingCategory = categoryName;
            document.getElementById('new-category-name').value = categoryName;
            document.getElementById('category-modal').classList.remove('hidden');
            document.getElementById('category-modal').querySelector('h3').textContent = '‚úèÔ∏è S·ª≠a Danh M·ª•c';
            document.querySelector('button[onclick="addNewCategory()"]').textContent = 'C·∫≠p Nh·∫≠t';
            document.querySelector('button[onclick="addNewCategory()"]').onclick = () => updateCategory();
        }

        async function updateCategory() {
            const newName = document.getElementById('new-category-name').value.trim();
            if (!newName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (newName !== editingCategory && categories.includes(newName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategory);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategory) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ƒê√£ c·∫≠p nh·∫≠t danh m·ª•c: ${editingCategory} ‚Üí ${newName}`, "success");
                closeCategoryModal();
                renderApp();
            }
        }

        async function deleteCategory(categoryName) {
            const index = categories.indexOf(categoryName);
            if (index < 3) {
                showMessage("Kh√¥ng th·ªÉ x√≥a 3 danh m·ª•c m·∫∑c ƒë·ªãnh!", "error");
                return;
            }

            const itemsInCategory = menuItems.filter(item => item.category === categoryName);
            if (itemsInCategory.length > 0) {
                const confirmDelete = confirm(`Danh m·ª•c "${categoryName}" c√≥ ${itemsInCategory.length} m√≥n. B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?\n\nT·∫•t c·∫£ m√≥n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang "ƒê·ªì ƒÇn".`);
                if (!confirmDelete) return;

                // Move items to default category
                itemsInCategory.forEach(item => {
                    updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                        category: 'ƒê·ªì ƒÇn',
                        updatedAt: new Date()
                    });
                });
            }

            categories.splice(index, 1);
            await saveCategories();
            showMessage(`ƒê√£ x√≥a danh m·ª•c: ${categoryName}`, "success");
            renderApp();
        }

        // Price Update Modal
        let currentPriceUpdateItem = null;

        function openPriceModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            currentPriceUpdateItem = item;

            const modalContent = document.getElementById('price-modal-content');
            const oldPrice = item.price;
            const newPrice = item.newPrice || '';

            modalContent.innerHTML = `
                        <div class="mb-4">
                    <h4 class="font-semibold text-amber-900 mb-2">${item.name}</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° Hi·ªán T·∫°i</label>
                            <div class="text-lg font-bold text-orange-600">
                                ${formatCurrency(oldPrice)}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° M·ªõi (C√≥ Th·ªÉ B·ªè Tr·ªëng)</label>
                            <input type="number" id="new-price-input" value="${newPrice}" placeholder="Nh·∫≠p gi√° m·ªõi..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën x√≥a gi√° m·ªõi</p>
                        </div>

                        ${newPrice ? `
                            <div class="p-3 rounded-lg bg-amber-50 border border-amber-200">
                                <div class="text-sm text-amber-800">
                                    <strong>Preview hi·ªÉn th·ªã:</strong><br>
                                    ${parseFloat(newPrice) >= oldPrice ?
                                        `Ch·ªâ hi·ªán: ${formatCurrency(parseFloat(newPrice))}` :
                                        `G·∫°ch ${formatCurrency(oldPrice)} ‚Üí ${formatCurrency(parseFloat(newPrice))}`
                                    }
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('price-modal').classList.remove('hidden');
        }

        function closePriceModal() {
            document.getElementById('price-modal').classList.add('hidden');
            currentPriceUpdateItem = null;
        }

        let currentCancelOrderId = null;

        function openCancelModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            currentCancelOrderId = orderId;

            const modalContent = document.getElementById('cancel-modal-content');

            modalContent.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-900 mb-2">ƒê∆°n h√†ng #${orderId.slice(-6).toUpperCase()}</h4>
                    <div class="text-sm text-gray-600 mb-4">
                        <p><strong>T·ªïng ti·ªÅn:</strong> ${formatCurrency(order.total)}</p>
                        <p><strong>Th·ªùi gian:</strong> ${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">L√Ω do h·ªßy ƒë∆°n h√†ng *</label>
                            <textarea id="cancel-reason-input" placeholder="Nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 resize-none"
                                rows="3" required></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">G·ª£i √Ω l√Ω do:</label>
                            <div class="space-y-1">
                                <button onclick="selectCancelReason('Kh√°ch h√†ng thay ƒë·ªïi ƒë∆°n h√†ng')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    üîÑ Kh√°ch h√†ng thay ƒë·ªïi ƒë∆°n h√†ng
                                </button>
                                <button onclick="selectCancelReason('Kh√°ch h√†ng y√™u c·∫ßu h·ªßy')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    üôã Kh√°ch h√†ng y√™u c·∫ßu h·ªßy
                                </button>
                                <button onclick="selectCancelReason('ƒê∆°n h√†ng qu√° h·∫°n')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    ‚è∞ ƒê∆°n h√†ng qu√° h·∫°n
                                </button>
                                <button onclick="selectCancelReason('Kh√°ch h√†ng mu·ªën ƒë·ªïi ƒë∆°n kh√°c')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    üîÑ Kh√°ch h√†ng mu·ªën ƒë·ªïi ƒë∆°n kh√°c
                                </button>
                                <button onclick="selectCancelReason('Kh√¥ng ƒë·ªß nguy√™n li·ªáu')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    üç≥ Kh√¥ng ƒë·ªß nguy√™n li·ªáu
                                </button>
                                <button onclick="selectCancelReason('L·ªói h·ªá th·ªëng')" type="button"
                                    class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border text-gray-700 transition">
                                    ‚ö†Ô∏è L·ªói h·ªá th·ªëng
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('cancel-order-modal').classList.remove('hidden');
        }

        function selectCancelReason(reason) {
            document.getElementById('cancel-reason-input').value = reason;
        }

        function closeCancelModal() {
            document.getElementById('cancel-order-modal').classList.add('hidden');
            currentCancelOrderId = null;
            // Clear the input
            const input = document.getElementById('cancel-reason-input');
            if (input) input.value = '';
        }

        async function confirmCancelOrder() {
            if (!currentCancelOrderId) return;

            const reasonInput = document.getElementById('cancel-reason-input');
            const cancelReason = reasonInput.value.trim();

            if (!cancelReason) {
                showMessage("Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng!", "error");
                reasonInput.focus();
                return;
            }

            try {
                console.log("Cancelling order with reason:", cancelReason);
                await updateDoc(doc(db, 'orders', currentCancelOrderId), {
                    status: 'cancelled',
                    cancelReason: cancelReason,
                    cancelledAt: { seconds: Math.floor(Date.now() / 1000), nanoseconds: 0 },
                    cancelledBy: 'admin',
                    updatedAt: new Date()
                });

                console.log("Order cancelled successfully with reason:", cancelReason);
                showMessage(`‚ùå ƒê√£ h·ªßy ƒë∆°n #${currentCancelOrderId.slice(-6).toUpperCase()}`, "warning");
                closeCancelModal();

                // Always reload orders to reflect the changes
                loadOrders();

            } catch (error) {
                console.error("Error cancelling order:", error);
                showMessage("L·ªói h·ªßy ƒë∆°n: " + error.message, "error");
            }
        }

        async function savePriceUpdate() {
            if (!currentPriceUpdateItem) return;

            const newPriceInput = document.getElementById('new-price-input');
            const newPriceValue = newPriceInput.value.trim();

            try {
                const updateData = {
                    name: currentPriceUpdateItem.name,
                    description: currentPriceUpdateItem.description,
                    price: currentPriceUpdateItem.price,
                    category: currentPriceUpdateItem.category,
                    status: currentPriceUpdateItem.status,
                    imageUrl: currentPriceUpdateItem.imageUrl,
                    updatedAt: new Date()
                };

                // Only add size if it exists and is not null/undefined
                if (currentPriceUpdateItem.size && currentPriceUpdateItem.size.trim() !== '') {
                    updateData.size = currentPriceUpdateItem.size;
                }

                if (newPriceValue === '') {
                    // X√≥a gi√° m·ªõi, ch·ªâ gi·ªØ gi√° c≈©
                    // Firestore s·∫Ω x√≥a field newPrice n·∫øu kh√¥ng include
                } else {
                    // C·∫≠p nh·∫≠t gi√° m·ªõi
                    const newPriceNum = parseFloat(newPriceValue);
                    if (newPriceNum <= 0) {
                        showMessage("Gi√° ph·∫£i l·ªõn h∆°n 0!", "error");
                        return;
                    }

                    // Lu√¥n lu√¥n c·∫≠p nh·∫≠t newPrice
                    updateData.newPrice = newPriceNum;
                    showMessage("C·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!", "success");
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === undefined) {
                        delete updateData[key];
                    }
                });

                await updateDoc(doc(db, PUBLIC_DATA_PATH, currentPriceUpdateItem.id), updateData);
                showMessage("C·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!", "success");

                closePriceModal();
                // Refresh data
                loadMenuItemsOnce();

            } catch (error) {
                console.error("Error updating price:", error);
                showMessage("L·ªói khi c·∫≠p nh·∫≠t gi√°: " + error.message, "error");
            }
        }

        // Category Management
        function openCategoryModal() {
            console.log('Opening category modal...');
            const modal = document.getElementById('category-modal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.classList.remove('hidden');
                const input = document.getElementById('new-category-name');
                if (input) {
                    input.focus();
                }
                console.log('Category modal opened successfully');
            } else {
                console.error('Category modal not found!');
            }
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('new-category-name').value = '';
            resetCategoryModal();
        }

        async function addNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            if (!categoryName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ƒê√£ th√™m danh m·ª•c: ${categoryName}`, "success");
            closeCategoryModal();
            renderApp(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t menu selection
        }

        function resetCategoryModal() {
            editingCategory = null;
            document.getElementById('category-modal').querySelector('h3').textContent = '‚ûï Th√™m Danh M·ª•c M·ªõi';
            document.querySelector('button[onclick*="addNewCategory"]').textContent = 'Th√™m';
            document.querySelector('button[onclick*="addNewCategory"]').onclick = () => addNewCategory();
        }
        
        function renderLoginView() {
            return `
                <div class="flex justify-center items-center py-20 bg-amber-50 min-h-screen pb-16 sm:pb-20">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-yellow-700/50">
                        <h2 class="text-3xl font-bold text-center text-amber-900 mb-6">üëë ƒêƒÉng Nh·∫≠p Admin</h2>
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <label for="email" class="block text-amber-800 font-semibold mb-2">Email Admin</label>
                                <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="binhbiinshop@admin.com">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-amber-800 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <p id="login-message" class="text-red-500 text-sm mb-4"></p>
                            <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition duration-150 shadow-lg">ƒêƒÉng Nh·∫≠p</button>
                        </form>
                        <p class="mt-4 text-center text-sm text-gray-500">
                            (Ch·ªâ d√†nh cho Qu·∫£n tr·ªã vi√™n)
                        </p>
                        <button onclick="setView('customer')" class="w-full mt-4 text-orange-600 hover:text-orange-800 transition duration-150 text-sm">
                            Tr·ªü v·ªÅ trang kh√°ch h√†ng
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== ADMIN DASHBOARD COMPONENTS ====================

        function renderAdminStats() {
            // T√≠nh doanh thu th√°ng hi·ªán t·∫°i t·ª´ c√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const totalRevenue = orders
                .filter(order => order.status === 'completed')
                .filter(order => {
                    if (!order.createdAt || !order.createdAt.seconds) return false;
                    const orderDate = new Date(order.createdAt.seconds * 1000);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                })
                .reduce((sum, order) => sum + (order.total || 0), 0);
            const totalOrders = orders.length;
            const activeItems = menuItems.filter(item => item.status !== 'deleted').length;
            const pendingOrders = orders.filter(o => o.status === 'ordered').length;

            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-amber-900">üìä Th·ªëng K√™ T·ªïng Quan</h2>
                        <div class="flex gap-2">
                            <button onclick="setView('admin-orders')" class="bg-purple-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-purple-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="clipboard-list" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">ƒê∆°n H√†ng (${pendingOrders})</span>
                                <span class="sm:hidden">ƒê∆°n (${pendingOrders})</span>
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ ch√≠nh -->
                    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 md:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">Doanh Thu Th√°ng</p>
                                    <p class="text-sm sm:text-lg md:text-xl lg:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 md:truncate">${formatCurrency(totalRevenue)}</p>
                                </div>
                                <i data-lucide="dollar-sign" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 lg:w-8 lg:h-8 text-orange-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">T·ªïng ƒê∆°n H√†ng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${totalOrders}</p>
                                </div>
                                <i data-lucide="shopping-bag" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-blue-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">S·ªë M√≥n ƒêang B√°n</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${activeItems}</p>
                                </div>
                                <i data-lucide="coffee" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-green-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">ƒê∆°n Ch·ªù X·ª≠ L√Ω</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${pendingOrders}</p>
                                </div>
                                <i data-lucide="clock" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-purple-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ theo tr·∫°ng th√°i ƒë∆°n h√†ng -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-3 sm:mb-4">
                                <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900">üìà Tr·∫°ng Th√°i ƒê∆°n H√†ng</h3>
                                <select onchange="setStatsTimeFilter(this.value)" class="text-xs sm:text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="day" ${statsTimeFilter === 'day' ? 'selected' : ''}>Theo ng√†y</option>
                                    <option value="week" ${statsTimeFilter === 'week' ? 'selected' : ''}>Theo tu·∫ßn</option>
                                    <option value="month" ${statsTimeFilter === 'month' ? 'selected' : ''}>Theo th√°ng</option>
                                    <option value="year" ${statsTimeFilter === 'year' ? 'selected' : ''}>Theo nƒÉm</option>
                                </select>
                            </div>
                            <div class="space-y-2 sm:space-y-3">
                                ${(() => {
                                    // Filter orders theo kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn
                                    const filteredOrders = filterOrdersByTimeRange(orders, statsTimeFilter);
                                    const totalFiltered = filteredOrders.length;

                                    return [
                                        { status: 'ordered', label: 'Ch·ªù nh·∫≠n', color: 'blue', count: filteredOrders.filter(o => o.status === 'ordered').length },
                                        { status: 'preparing', label: 'ƒêang l√†m', color: 'yellow', count: filteredOrders.filter(o => o.status === 'preparing').length },
                                        { status: 'completed', label: 'Ho√†n th√†nh', color: 'green', count: filteredOrders.filter(o => o.status === 'completed').length },
                                        { status: 'cancelled', label: 'ƒê√£ h·ªßy', color: 'red', count: filteredOrders.filter(o => o.status === 'cancelled').length }
                                    ].map(stat => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs sm:text-sm text-gray-700">${stat.label}</span>
                                        <div class="flex items-center gap-1.5 sm:gap-2">
                                            <div class="w-16 sm:w-20 md:w-24 bg-gray-200 rounded-full h-1.5 sm:h-2">
                                                <div class="bg-${stat.color}-500 h-1.5 sm:h-2 rounded-full transition-all duration-300" style="width: ${totalFiltered > 0 ? (stat.count / totalFiltered * 100) : 0}%"></div>
                                            </div>
                                            <span class="text-[10px] sm:text-xs md:text-sm font-semibold text-${stat.color}-600 min-w-[1.5rem] sm:min-w-[2rem]">${stat.count}</span>
                                        </div>
                                    </div>
                                `).join('');
                                })()}
                            </div>
                        </div>

                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900 mb-3 sm:mb-4">üìä Th·ªëng K√™ M√≥n ƒÇn</h3>
                            <div class="space-y-2 sm:space-y-3 max-h-32 sm:max-h-40 md:max-h-48 overflow-y-auto pr-2 sm:pr-3">
                                ${categories.map(cat => {
                                    const count = menuItems.filter(item => item.category === cat && item.status !== 'deleted').length;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs sm:text-sm text-gray-700">${getCategoryIcon(cat)} ${cat}</span>
                                            <span class="text-[10px] sm:text-xs md:text-sm font-semibold text-orange-600">${count} m√≥n</span>
                                        </div>
                                    `;
                                }).join('')}
                                <hr class="my-2 sm:my-3">
                                
                            </div>
                            <div class="flex justify-between mt-2 items-center pr-2 font-bold">
                                    <span class="text-xs sm:text-sm text-gray-900">T·ªïng c·ªông</span>
                                    <span class="text-[10px] sm:text-xs md:text-sm text-orange-600">${activeItems} m√≥n</span>
                                </div>
                        </div>
                    </div>

                    <!-- ƒê∆°n h√†ng g·∫ßn ƒë√¢y -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900">üïí ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h3>
                            <button onclick="setView('admin-orders')" class="text-blue-600 hover:text-blue-800 text-xs sm:text-sm">Xem t·∫•t c·∫£ ‚Üí</button>
                        </div>
                        <div class="space-y-2 sm:space-y-3">
                            ${orders.slice(0, 5).map(order => `
                                <div class="flex justify-between items-center p-2 sm:p-3 border rounded-lg hover:bg-gray-50 active:scale-[0.98] transition">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-gray-900 text-xs sm:text-sm md:text-base truncate">Order #${order.id.slice(-6).toUpperCase()}</p>
                                        <p class="text-[10px] sm:text-xs md:text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                    </div>
                                    <div class="text-right ml-2">
                                        <p class="font-semibold text-orange-600 text-xs sm:text-sm md:text-base">${formatCurrency(order.total)}</p>
                                        <span class="px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-[9px] sm:text-xs font-medium ${getStatusBadgeClass(order.status)}">
                                            ${getStatusText(order.status)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}

                            ${orders.length === 0 ? '<p class="text-center text-gray-500 py-6 sm:py-8 text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>' : ''}
                        </div>
                    </div>

                    <!-- Test Th√¥ng B√°o (ch·ªâ hi·ªÉn th·ªã cho admin) -->
                    <div class="bg-white p-3 mt-3 sm:p-4 rounded-lg sm:rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm sm:text-base font-bold text-gray-900">üîî Test Th√¥ng B√°o</h3>
                            <button onclick="toggleNotifications()" class="px-3 py-1.5 rounded text-xs sm:text-sm font-medium transition ${notificationsEnabled ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-400 text-white hover:bg-gray-500'}">
                                ${notificationsEnabled ? '‚úÖ B·∫≠t' : '‚ùå T·∫Øt'} Th√¥ng B√°o
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="requestNotificationPermission()" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-xs sm:text-sm active:scale-95 transition">
                                C·∫•p Quy·ªÅn Th√¥ng B√°o
                            </button>
                            <button onclick="showBrowserNotification('Test Th√¥ng B√°o', 'ƒê√¢y l√† th√¥ng b√°o test v·ªõi √¢m thanh!', 'logo.png')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-xs sm:text-sm active:scale-95 transition">
                                Test Th√¥ng B√°o
                            </button>
                            <button onclick="playNotificationSound()" class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 text-xs sm:text-sm active:scale-95 transition">
                                Test √Çm Thanh
                            </button>
                            <button onclick="vibrateDevice([200, 100, 200, 100, 200])" class="bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600 text-xs sm:text-sm active:scale-95 transition">
                                üì≥ Test Rung
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">S·ª≠ d·ª•ng c√°c n√∫t n√†y ƒë·ªÉ test t√≠nh nƒÉng th√¥ng b√°o tr√¨nh duy·ªát, √¢m thanh v√† rung.</p>
                        <p class="text-xs mt-1 font-medium ${notificationsEnabled ? 'text-green-600' : 'text-red-600'}">
                            ${notificationsEnabled ? '‚úÖ Th√¥ng b√°o ƒë√£ b·∫≠t' : '‚ùå ƒê√£ t·∫Øt th√¥ng b√°o'}
                        </p>
                    </div>
                </div>
            `;
        }

        function renderAdminOrders() {
            // Load orders management content after a short delay to ensure DOM is ready
            setTimeout(() => {
                renderOrdersManagementList();
            }, 100);

            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-purple-900">üìã Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                        <div class="flex gap-2">
                            <button onclick="loadOrders()" class="bg-purple-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-purple-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">T·∫£i L·∫°i</span>
                            </button>
                        </div>
                    </div>

                    <div id="orders-management-content">
                        <!-- Orders management will be loaded here -->
                        <div class="text-center py-12">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 text-purple-500 animate-spin"></i>
                            <p class="text-gray-600">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTables() {
            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-teal-900">üçΩÔ∏è Qu·∫£n L√Ω B√†n ƒÇn</h2>
                        <div class="flex gap-2">
                            <button onclick="openAddTableModalAdmin()" class="bg-teal-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-teal-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">Th√™m B√†n M·ªõi</span>
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ b√†n -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-4 md:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">B√†n Tr·ªëng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-green-600 mt-0.5 sm:mt-1 truncate">${tables.filter(t => !t.status || t.status === 'available').length}</p>
                                </div>
                                <i data-lucide="check-circle" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-green-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">ƒêang D√πng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-red-600 mt-0.5 sm:mt-1 truncate">${tables.filter(t => t.status === 'occupied').length}</p>
                                </div>
                                <i data-lucide="users" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-red-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">T·ªïng S·ªë</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-blue-600 mt-0.5 sm:mt-1 truncate">${tables.length}</p>
                                </div>
                                <i data-lucide="table-2" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-blue-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Danh s√°ch b√†n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">Danh S√°ch B√†n ƒÇn</h3>

                        ${tables.length === 0 ? `
                            <div class="text-center py-8 sm:py-12">
                                <i data-lucide="table-2" class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 text-gray-300"></i>
                                <p class="text-gray-500 text-sm sm:text-base md:text-lg">Ch∆∞a c√≥ b√†n n√†o</p>
                                <p class="text-gray-400 text-xs sm:text-sm mt-1 sm:mt-2">Click "Th√™m B√†n M·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-6">
                                ${tables.map(table => `
                                    <div class="bg-white p-3 sm:p-4 rounded-lg border-2 ${table.status === 'occupied' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'} shadow-sm hover:shadow-md transition duration-150 active:scale-[0.98]">
                                        <div class="flex justify-between items-start mb-2 sm:mb-3">
                                            <div class="flex-1 min-w-0">
                                                <h4 class="text-sm sm:text-base md:text-lg font-bold text-gray-800 truncate">B√†n ${table.tableNumber}</h4>
                                                <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full inline-block mt-1 ${table.status === 'occupied' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${table.status === 'occupied' ? 'üî¥ ƒêang d√πng' : 'üü¢ Tr·ªëng'}
                                                </span>
                                            </div>
                                            <div class="flex gap-0.5 sm:gap-1 ml-2">
                                                <button onclick="showTableQRAdmin('${table.tableNumber}')" class="p-1.5 sm:p-2 bg-blue-500 text-white rounded hover:bg-blue-600 active:scale-95 transition" title="Xem QR Code">
                                                    <i data-lucide="qr-code" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                                <button onclick="openEditTableModalAdmin('${table.id}', '${table.tableNumber}', '${table.status || 'available'}')" class="p-1.5 sm:p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 active:scale-95 transition" title="Ch·ªânh s·ª≠a">
                                                    <i data-lucide="edit" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                                <button onclick="deleteTable('${table.id}')" class="p-1.5 sm:p-2 bg-red-500 text-white rounded hover:bg-red-600 active:scale-95 transition" title="X√≥a b√†n">
                                                    <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-[10px] sm:text-xs text-gray-600">
                                            <p class="truncate">T·∫°o: ${table.createdAt ? new Date(table.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Add Table Modal for Admin Tables -->
                    <div id="add-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">üçΩÔ∏è Th√™m B√†n M·ªõi</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                                <input type="text" id="new-table-number-admin" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeAddTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="addTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Th√™m B√†n</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Table Modal for Admin Tables -->
                    <div id="edit-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">‚úèÔ∏è Ch·ªânh S·ª≠a B√†n</h3>

                            <input type="hidden" id="edit-table-id-admin">

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                                <input type="text" id="edit-table-number-admin" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng Th√°i</label>
                                <select id="edit-table-status-admin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                    <option value="available">üü¢ Tr·ªëng</option>
                                    <option value="occupied">üî¥ ƒêang d√πng</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="updateTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">C·∫≠p Nh·∫≠t</button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Modal for Admin Tables -->
                    <div id="qr-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-teal-600">üì± QR Code B√†n</h3>
                                <button onclick="closeQRTableModalAdmin()" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>

                            <div id="qr-table-info-admin" class="mb-4 text-center">
                                <!-- Table info will be inserted here -->
                            </div>

                            <div id="qr-table-code-container-admin" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                                <!-- QR Code will be generated here -->
                            </div>

                            <div class="flex gap-3">
                                <button onclick="downloadTableQRAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    T·∫£i Xu·ªëng
                                </button>
                                <button onclick="closeQRTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminMenu() {
            const itemToEdit = menuItems.find(i => i.id === (document.getElementById('admin-form-id')?.value || null));


            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-orange-900">üçΩÔ∏è Qu·∫£n L√Ω Menu</h2>
                    </div>

                    <!-- Danh m·ª•c -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg mb-6 sm:mb-8">
                        <div class="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-indigo-900">üìÇ Danh M·ª•c M√≥n ƒÇn</h3>
                            <button onclick="document.getElementById('category-modal-admin').classList.remove('hidden'); document.getElementById('new-category-name-admin').focus()" class="bg-indigo-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="folder-plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">Th√™m Danh M·ª•c</span>
                            </button>
                        </div>
                        <div class="space-y-2 ${categories.length > 6 ? 'max-h-80 overflow-y-auto' : ''}">
                            ${categories.map((cat, index) => `
                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200 flex justify-between items-center active:scale-[0.98] transition">
                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                        <span class="text-lg flex-shrink-0">${getCategoryIcon(cat)}</span>
                                        <span class="font-medium text-gray-800 truncate">${cat}</span>
                                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full flex-shrink-0 ml-2">
                                            ${menuItems.filter(item => item.category === cat && item.status !== 'deleted').length} m√≥n
                                        </span>
                                    </div>
                                    <div class="flex gap-1 ml-2">
                                        <button onclick="openEditCategoryModalAdmin('${cat}')" class="text-blue-600 hover:text-blue-800 p-1.5 active:scale-95 transition" title="S·ª≠a">
                                            <i data-lucide="edit" class="w-4 h-4"></i>
                                        </button>
                                        ${index >= 3 ? `
                                            <button onclick="deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 p-1.5 active:scale-95 transition" title="X√≥a">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-[10px] sm:text-xs md:text-sm text-gray-600">
                            <strong>L∆∞u √Ω:</strong> T·∫•t c·∫£ danh m·ª•c ƒë·ªÅu c√≥ th·ªÉ s·ª≠a t√™n. 3 danh m·ª•c ƒë·∫ßu ti√™n (ƒê·ªì U·ªëng, ƒê·ªì ƒÇn, ƒê·ªì Nh·∫≠u) kh√¥ng th·ªÉ x√≥a.
                        </div>
                    </div>

                    <!-- N√∫t th√™m m√≥n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg mb-6 sm:mb-8">
                        <div class="flex justify-center">
                            <button onclick="openAddItemModal()" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 flex items-center gap-2 text-sm sm:text-base font-medium active:scale-95 transition">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                ‚ûï Th√™m M√≥n M·ªõi
                            </button>
                        </div>
                    </div>

                    <!-- Danh s√°ch m√≥n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 sm:mb-4 gap-2 sm:gap-0">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-amber-900">üìã Danh S√°ch M√≥n ƒÇn/ƒê·ªì U·ªëng (${getFilteredMenuItems().length})</h3>
                            <div class="flex items-center gap-2">
                                <label class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">Hi·ªÉn th·ªã:</label>
                                <select onchange="setMenuItemsPerPage(parseInt(this.value)); event.stopPropagation();" class="px-2 py-1 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" value="${menuItemsPerPage}">
                                    <option value="5" ${menuItemsPerPage === 5 ? 'selected' : ''}>5</option>
                                    <option value="10" ${menuItemsPerPage === 10 ? 'selected' : ''}>10</option>
                                    <option value="15" ${menuItemsPerPage === 15 ? 'selected' : ''}>15</option>
                                    <option value="20" ${menuItemsPerPage === 20 ? 'selected' : ''}>20</option>
                                    <option value="25" ${menuItemsPerPage === 25 ? 'selected' : ''}>25</option>
                                    <option value="30" ${menuItemsPerPage === 30 ? 'selected' : ''}>30</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-amber-50">
                                    <tr>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">STT</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">·∫¢nh</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">T√™n M√≥n</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Gi√°</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <div class="flex flex-col gap-1">
                                                <span>Danh M·ª•c</span>
                                                <select onchange="setMenuFilterCategory(this.value); event.stopPropagation();" class="text-[9px] sm:text-xs px-1 py-0.5 border border-gray-300 rounded focus:ring-orange-500 focus:border-orange-500" style="min-width: 100px;">
                                                    <option value="">-- T·∫•t c·∫£ --</option>
                                                    ${[...new Set(menuItems.filter(item => item.status !== 'deleted').map(item => item.category))].sort().map(cat => `
                                                        <option value="${cat}" ${menuFilterCategory === cat ? 'selected' : ''}>${cat}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                        </th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <div class="flex flex-col gap-1">
                                                <span>Tr·∫°ng Th√°i</span>
                                                <select onchange="setMenuFilterStatus(this.value); event.stopPropagation();" class="text-[9px] sm:text-xs px-1 py-0.5 border border-gray-300 rounded focus:ring-orange-500 focus:border-orange-500" style="min-width: 100px;">
                                                    <option value="">-- T·∫•t c·∫£ --</option>
                                                    <option value="active" ${menuFilterStatus === 'active' ? 'selected' : ''}>ƒêang b√°n</option>
                                                    <option value="new" ${menuFilterStatus === 'new' ? 'selected' : ''}>M·ªõi</option>
                                                    <option value="hot" ${menuFilterStatus === 'hot' ? 'selected' : ''}>üî• B√°n ch·∫°y (Hot)</option>
                                                    <option value="best_seller" ${menuFilterStatus === 'best_seller' ? 'selected' : ''}>‚≠ê Best Seller</option>
                                                    <option value="sale" ${menuFilterStatus === 'sale' ? 'selected' : ''}>Sale</option>
                                                    <option value="out_of_stock" ${menuFilterStatus === 'out_of_stock' ? 'selected' : ''}>H·∫øt h√†ng</option>
                                                    <option value="coming_soon" ${menuFilterStatus === 'coming_soon' ? 'selected' : ''}>S·∫Øp c√≥</option>
                                                </select>
                                            </div>
                                        </th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-right text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Thao T√°c</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${(() => {
                                        // Use getFilteredMenuItems() which already handles filtering and sorting
                                        const filteredItems = getFilteredMenuItems();
                                        const startIndex = (menuCurrentPage - 1) * menuItemsPerPage;
                                        const endIndex = startIndex + menuItemsPerPage;
                                        const paginatedItems = filteredItems.slice(startIndex, endIndex);

                                        return paginatedItems.map((item, index) => `
                                        <tr class="hover:bg-gray-50 cursor-pointer transition" 
                                            onclick="showItemContextMenu(event, '${item.id}')" 
                                            ontouchstart="handleTableRowTouch(event, '${item.id}')"
                                            ontouchmove="handleTableRowTouch(event, '${item.id}')"
                                            ontouchend="handleTableRowTouch(event, '${item.id}')">
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-amber-900">#${startIndex + index + 1}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap">
                                                <img src="${item.imageUrl || 'https://via.placeholder.com/40x40?text=No+Img'}" alt="${item.name}" class="w-8 h-8 sm:w-10 sm:h-10 object-cover rounded border border-gray-200" onerror="this.src='https://via.placeholder.com/40x40?text=No+Img'">
                                            </td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${item.name}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm text-orange-600 font-semibold">
                                                ${item.newPrice ?
                                                    (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                        formatCurrency(item.newPrice) :
                                                        `${formatCurrency(item.price)} ‚Üí ${formatCurrency(item.newPrice)}`
                                                    ) :
                                                    formatCurrency(item.price)
                                                }
                                            </td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.category}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm">${getStatusBadge(item.status) || '<span class="text-green-600">‚úÖ ƒêang b√°n</span>'}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-right text-xs sm:text-sm font-medium">
                                                <div class="flex justify-end gap-1 sm:gap-2">
                                                    <button onclick="event.stopPropagation(); openPriceModal('${item.id}')" class="text-blue-600 hover:text-blue-800 p-1 active:scale-95 transition" title="Ch·ªânh gi√°">üí∞</button>
                                                    <button onclick="event.stopPropagation(); openEditItemModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900 text-xs sm:text-sm active:scale-95 transition">S·ª≠a</button>
                                                    <button onclick="event.stopPropagation(); if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y kh√¥ng?')) deleteItem('${item.id}')" class="text-red-600 hover:text-red-900 text-xs sm:text-sm active:scale-95 transition ml-1">X√≥a</button>
                                                </div>
                                            </td>
                                        </tr>
                                        `).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>

                        <!-- Menu Items Pagination -->
                        ${(() => {
                            const filteredItems = getFilteredMenuItems();
                            const totalPages = Math.ceil(filteredItems.length / menuItemsPerPage);
                            if (totalPages <= 1 && filteredItems.length === 0) {
                                return '<div class="mt-4 px-4 py-3 text-center text-sm text-gray-500">Kh√¥ng c√≥ m√≥n n√†o</div>';
                            }
                            if (totalPages <= 1) return '';

                            let paginationHtml = '<div class="flex flex-col sm:flex-row items-center justify-between mt-4 px-4 py-3 bg-gray-50 border-t gap-2">';

                            // Page info
                            paginationHtml += `<span class="text-xs sm:text-sm text-gray-700">Trang ${menuCurrentPage} / ${totalPages} (${filteredItems.length} m√≥n)</span>`;

                            // Pagination buttons
                            paginationHtml += '<div class="flex items-center gap-2">';
                            
                            // First page button
                            paginationHtml += `<button onclick="setMenuPage(1)" ${menuCurrentPage <= 1 ? 'disabled' : ''} class="px-2 py-1 text-xs sm:text-sm ${menuCurrentPage <= 1 ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:text-blue-800'}">¬´ ƒê·∫ßu</button>`;
                            
                            // Previous button
                            paginationHtml += `<button onclick="setMenuPage(${menuCurrentPage - 1})" ${menuCurrentPage <= 1 ? 'disabled' : ''} class="px-2 py-1 text-xs sm:text-sm ${menuCurrentPage <= 1 ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:text-blue-800'}">‚Üê Tr∆∞·ªõc</button>`;

                            // Page numbers (show max 5 pages around current)
                            const maxPagesToShow = 5;
                            let startPage = Math.max(1, menuCurrentPage - Math.floor(maxPagesToShow / 2));
                            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                            if (endPage - startPage < maxPagesToShow - 1) {
                                startPage = Math.max(1, endPage - maxPagesToShow + 1);
                            }

                            if (startPage > 1) {
                                paginationHtml += `<button onclick="setMenuPage(1)" class="px-2 py-1 text-xs sm:text-sm text-blue-600 hover:text-blue-800">1</button>`;
                                if (startPage > 2) {
                                    paginationHtml += '<span class="px-1 text-gray-400">...</span>';
                                }
                            }

                            for (let i = startPage; i <= endPage; i++) {
                                paginationHtml += `<button onclick="setMenuPage(${i})" class="px-2 py-1 text-xs sm:text-sm ${i === menuCurrentPage ? 'bg-blue-600 text-white' : 'text-blue-600 hover:text-blue-800'}">${i}</button>`;
                            }

                            if (endPage < totalPages) {
                                if (endPage < totalPages - 1) {
                                    paginationHtml += '<span class="px-1 text-gray-400">...</span>';
                                }
                                paginationHtml += `<button onclick="setMenuPage(${totalPages})" class="px-2 py-1 text-xs sm:text-sm text-blue-600 hover:text-blue-800">${totalPages}</button>`;
                            }

                            // Next button
                            paginationHtml += `<button onclick="setMenuPage(${menuCurrentPage + 1})" ${menuCurrentPage >= totalPages ? 'disabled' : ''} class="px-2 py-1 text-xs sm:text-sm ${menuCurrentPage >= totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:text-blue-800'}">Sau ‚Üí</button>`;
                            
                            // Last page button
                            paginationHtml += `<button onclick="setMenuPage(${totalPages})" ${menuCurrentPage >= totalPages ? 'disabled' : ''} class="px-2 py-1 text-xs sm:text-sm ${menuCurrentPage >= totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:text-blue-800'}">Cu·ªëi ¬ª</button>`;
                            
                            paginationHtml += '</div>';
                            paginationHtml += '</div>';
                            return paginationHtml;
                        })()}

                            <!-- Context Menu -->
                        <div id="item-context-menu" class="fixed bg-white border border-gray-300 rounded-lg shadow-lg py-2 z-[9999] hidden min-w-[180px]">
                            <button onclick="openItemDetailModal(window.currentContextItemId); hideContextMenu()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                Xem chi ti·∫øt m√≥n
                            </button>
                            <hr class="my-1">
                            <button onclick="openEditItemModal(window.currentContextItemId); hideContextMenu()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                                Ch·ªânh s·ª≠a
                            </button>
                            <button onclick="openPriceModal(window.currentContextItemId); hideContextMenu()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2">
                                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                Ch·ªânh gi√°
                            </button>
                            <hr class="my-1">
                            <button onclick="if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y kh√¥ng?')) { deleteItem(window.currentContextItemId); } hideContextMenu()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                X√≥a m√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Add/Edit Item Modal -->
                    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="item-modal-title" class="text-xl font-bold text-orange-900">‚ûï Th√™m M√≥n M·ªõi</h3>
                                <button onclick="closeItemModal()" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>

                            <form id="item-modal-form" onsubmit="event.preventDefault(); handleSaveItem()">
                                <input type="hidden" id="item-modal-id" value="">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">T√™n M√≥n</label>
                                        <input type="text" id="item-modal-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° C≈© (VNƒê)</label>
                                        <input type="number" id="item-modal-price" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° M·ªõi (VNƒê) <span class="text-xs text-gray-500">(Kh√¥ng b·∫Øt bu·ªôc)</span></label>
                                        <input type="number" id="item-modal-new-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Danh M·ª•c</label>
                                        <select id="item-modal-category" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                            ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Chi Ti·∫øt</label>
                                        <select id="item-modal-item-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                            <option value="simple">üçΩÔ∏è M√≥n ƒë∆°n gi·∫£n (Kh√¥ng c√≥ t√πy ch·ªçn)</option>
                                            <option value="drink">ü•§ N∆∞·ªõc u·ªëng (Size, Topping, ƒê√°, ƒê∆∞·ªùng)</option>
                                            <option value="noodle">üçú M√¨/B√∫n (ƒê·ªô cay, Topping)</option>
                                            <option value="food">üç± ƒê·ªì ƒÉn (Size/Ph·∫ßn)</option>
                                            <option value="alcohol">üç∫ ƒê·ªì nh·∫≠u (Size L·ªõn/Nh·ªè)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng Th√°i</label>
                                        <select id="item-modal-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                            <option value="active">‚úÖ ƒêang b√°n</option>
                                            <option value="hot">üî• B√°n ch·∫°y</option>
                                            <option value="new">üÜï M√≥n m·ªõi</option>
                                            <option value="sale">üí∞ Sale</option>
                                            <option value="best_seller">‚≠ê Best Seller</option>
                                            <option value="out_of_stock">‚ùå H·∫øt h√†ng</option>
                                            <option value="coming_soon">‚è≥ S·∫Øp c√≥</option>
                                        </select>
                                    </div>
                                    <div id="item-modal-config-button-field" class="md:col-span-2" style="display: none;">
                                        <button type="button" onclick="openItemDetailsConfig()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition flex items-center justify-center gap-2 font-medium shadow-md hover:shadow-lg">
                                            <i data-lucide="settings" class="w-5 h-5"></i>
                                            <span>‚öôÔ∏è C·∫•u H√¨nh Chi Ti·∫øt (Size, Topping, ...)</span>
                                        </button>
                                        <p class="text-xs text-gray-500 mt-1 text-center">Click ƒë·ªÉ thi·∫øt l·∫≠p c√°c t√πy ch·ªçn chi ti·∫øt cho m√≥n n√†y</p>
                                    </div>
                                </div>
                                <!-- Image Preview -->
                                <div id="item-modal-image-preview" class="mt-4 p-3 rounded-lg bg-gray-50 border border-gray-200">
                                    <div class="text-sm text-gray-700 mb-2"><strong>Preview ·∫£nh:</strong></div>
                                    <div class="flex justify-center">
                                        <img id="item-modal-preview-img" src="image.png" alt="Preview" class="max-w-full w-48 aspect-square object-cover rounded border border-gray-300">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">·∫¢nh</label>
                                        <input type="file" id="item-modal-image-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                        <p class="mt-1 text-xs text-gray-500">Ho·∫∑c nh·∫≠p URL tr·ª±c ti·∫øp:</p>
                                        <input type="url" id="item-modal-image" placeholder="https://..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                </div>

                                <!-- Price Preview -->
                                <div id="item-modal-price-preview" class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 hidden">
                                    <div class="text-sm text-amber-800">
                                        <strong>Preview hi·ªÉn th·ªã:</strong><br>
                                        <span id="item-modal-price-preview-text"></span>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">M√¥ T·∫£</label>
                                    <textarea id="item-modal-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"></textarea>
                                </div>
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" onclick="closeItemModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">H·ªßy</button>
                                    <button type="submit" id="item-modal-submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700">Th√™m M√≥n</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Image Crop Modal -->
                    <div id="image-crop-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[105] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-2xl w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">‚úÇÔ∏è C·∫Øt ·∫¢nh H√¨nh Vu√¥ng</h3>
                                <button onclick="closeImageCropModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-3">K√©o ƒë·ªÉ ƒëi·ªÅu ch·ªânh v√πng c·∫Øt (h√¨nh vu√¥ng):</p>
                                <div class="relative border-2 border-orange-500 rounded-lg overflow-hidden bg-gray-100" style="max-height: 500px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    <div id="crop-container" class="relative" style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                                        <img id="crop-image" src="" alt="Crop" style="display: block;">
                                        <div id="crop-overlay" class="absolute border-2 border-white shadow-lg" style="box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); cursor: move; touch-action: none;">
                                            <div class="absolute inset-0 border-2 border-dashed border-white"></div>
                                            <!-- Top-left resize handle (hidden) -->
                                            <div id="crop-handle-top-left" class="hidden"></div>
                                            <!-- Bottom-right resize handle -->
                                            <div id="crop-handle-bottom-right" class="absolute -bottom-2 -right-2 w-6 h-6 bg-white border-2 border-orange-500 rounded-full cursor:nwse-resize" style="touch-action: none; cursor: nwse-resize;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeImageCropModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">H·ªßy</button>
                                <button onclick="applyCrop()" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700">‚úì √Åp D·ª•ng</button>
                            </div>
                        </div>
                    </div>

                    <!-- Item Details Config Modal -->
                    <div id="item-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] hidden overflow-y-auto p-2 sm:p-4">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl max-w-4xl w-full mx-2 sm:mx-4 my-2 sm:my-4 md:my-8 max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-3 sm:mb-4 md:mb-6">
                                <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-purple-900">‚öôÔ∏è C·∫•u H√¨nh Chi Ti·∫øt M√≥n</h3>
                                <button onclick="closeItemDetailsConfig()" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl p-1 sm:p-2">√ó</button>
                            </div>

                            <div id="item-details-content" class="text-sm sm:text-base">
                                <!-- Content will be dynamically loaded based on itemType -->
                            </div>

                            <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                                <button type="button" onclick="closeItemDetailsConfig()" class="w-full sm:w-auto px-4 py-2.5 sm:py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 active:scale-95 transition">H·ªßy</button>
                                <button type="button" onclick="saveItemDetailsConfig()" class="w-full sm:w-auto px-4 py-2.5 sm:py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 active:scale-95 transition">üíæ L∆∞u C·∫•u H√¨nh</button>
                            </div>
                        </div>
                    </div>

                    <!-- Category Modal for Admin Menu -->
                    <div id="category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">‚ûï Th√™m Danh M·ª•c M·ªõi</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                                <input type="text" id="new-category-name-admin" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="addNewCategoryAdmin()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Th√™m</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Category Modal for Admin Menu -->
                    <div id="edit-category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">‚úèÔ∏è S·ª≠a Danh M·ª•c</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                                <input type="text" id="edit-category-name-admin" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="updateCategoryAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">C·∫≠p Nh·∫≠t</button>
                            </div>
                        </div>
                    </div>

                    <!-- Item Detail View Modal -->
                    <div id="item-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden p-2 sm:p-4">
                        <div class="bg-white rounded-lg sm:rounded-xl max-w-2xl w-full mx-4 max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
                            <!-- Header -->
                            <div class="flex justify-between items-center p-3 sm:p-4 border-b border-gray-200 flex-shrink-0">
                                <h3 class="text-lg sm:text-xl font-bold text-orange-900">üìã Chi Ti·∫øt M√≥n</h3>
                                <button onclick="closeItemDetailModal()" class="text-gray-500 hover:text-gray-700 p-1 sm:p-2">
                                    <i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Content (scrollable) -->
                            <div id="item-detail-content" class="p-3 sm:p-4 overflow-y-auto flex-1 min-h-0">
                                <!-- Content will be inserted here by JavaScript -->
                            </div>
                            
                            <!-- Footer v·ªõi n√∫t C·∫≠p nh·∫≠t v√† X√≥a -->
                            <div class="p-3 sm:p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                                <input type="hidden" id="item-detail-item-id" value="">
                                <div class="flex gap-2 sm:gap-3">
                                    <button onclick="closeItemDetailModal()" 
                                        class="flex-1 px-3 py-2 sm:px-4 sm:py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium text-sm sm:text-base">
                                        ƒê√≥ng
                                    </button>
                                    <button onclick="const itemId = document.getElementById('item-detail-item-id').value; closeItemDetailModal(); openEditItemModal(itemId);" 
                                        class="flex-1 px-3 py-2 sm:px-4 sm:py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm sm:text-base">
                                        ‚úèÔ∏è C·∫≠p nh·∫≠t
                                    </button>
                                    <button onclick="const itemId = document.getElementById('item-detail-item-id').value; if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y kh√¥ng?')) { deleteItem(itemId); closeItemDetailModal(); }" 
                                        class="flex-1 px-3 py-2 sm:px-4 sm:py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm sm:text-base">
                                        üóëÔ∏è X√≥a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeCategoryModalAdmin() {
            document.getElementById('category-modal-admin').classList.add('hidden');
            document.getElementById('new-category-name-admin').value = '';
        }

        async function addNewCategoryAdmin() {
            const categoryName = document.getElementById('new-category-name-admin').value.trim();
            if (!categoryName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ƒê√£ th√™m danh m·ª•c: ${categoryName}`, "success");
            closeCategoryModalAdmin();
            renderApp(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t menu selection
        }

        // ==================== TRASH MANAGEMENT ====================

        async function restoreItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c m√≥n n√†y?")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'active',
                    deletedAt: null,
                    updatedAt: new Date()
                });
                // console.log("‚úÖ Kh√¥i ph·ª•c m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("ƒê√£ kh√¥i ph·ª•c m√≥n!", "success");
            } catch (e) {
                // console.error("‚ùå L·ªói khi kh√¥i ph·ª•c m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi kh√¥i ph·ª•c m√≥n: " + e.message, "error");
            }
        }

        async function permanentDeleteItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN m√≥n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) return;
            try {
                await deleteDoc(doc(db, PUBLIC_DATA_PATH, id));
                // console.log("‚úÖ X√≥a vƒ©nh vi·ªÖn m√≥n th√†nh c√¥ng"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("ƒê√£ x√≥a vƒ©nh vi·ªÖn m√≥n!", "success");
            } catch (e) {
                // console.error("‚ùå L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n:", e); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                showMessage("L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n: " + e.message, "error");
            }
        }

        // Auto-cleanup deleted items after 30 days
        async function cleanupExpiredItems() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            try {
                const expiredItems = menuItems.filter(item =>
                    item.status === 'deleted' &&
                    item.deletedAt &&
                    new Date(item.deletedAt.seconds * 1000) < thirtyDaysAgo
                );

                if (expiredItems.length > 0) {
                    console.log(`üóëÔ∏è Auto-deleting ${expiredItems.length} expired items`);
                    for (const item of expiredItems) {
                        await deleteDoc(doc(db, PUBLIC_DATA_PATH, item.id));
                    }
                    console.log("‚úÖ Auto-cleanup completed");
                }
            } catch (error) {
                console.error("‚ùå Error during auto-cleanup:", error);
            }
        }

        let editingCategoryAdmin = null;

        function openEditCategoryModalAdmin(categoryName) {
            editingCategoryAdmin = categoryName;
            document.getElementById('edit-category-name-admin').value = categoryName;
            document.getElementById('edit-category-modal-admin').classList.remove('hidden');
        }

        function closeEditCategoryModalAdmin() {
            document.getElementById('edit-category-modal-admin').classList.add('hidden');
            document.getElementById('edit-category-name-admin').value = '';
            editingCategoryAdmin = null;
        }

        async function updateCategoryAdmin() {
            const newName = document.getElementById('edit-category-name-admin').value.trim();
            if (!newName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (newName !== editingCategoryAdmin && categories.includes(newName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategoryAdmin);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategoryAdmin) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ƒê√£ c·∫≠p nh·∫≠t danh m·ª•c: ${editingCategoryAdmin} ‚Üí ${newName}`, "success");
                closeEditCategoryModalAdmin();
                renderApp();
            }
        }

        function openAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.remove('hidden');
            document.getElementById('new-table-number-admin').focus();
        }

        function closeAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.add('hidden');
            document.getElementById('new-table-number-admin').value = '';
        }

        async function addTableAdmin() {
            const tableNumber = document.getElementById('new-table-number-admin').value.trim();

            if (!tableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "error");
                return;
            }

            // Ki·ªÉm tra tr√πng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`B√†n ${tableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }

            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await addDoc(collection(db, 'tables'), tableData);

                showMessage(`‚úÖ ƒê√£ th√™m B√†n ${tableNumber}`, "success");
                closeAddTableModalAdmin();

            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("L·ªói th√™m b√†n: " + error.message, "error");
            }
        }

        function openEditTableModalAdmin(tableId, tableNumber, status) {
            document.getElementById('edit-table-id-admin').value = tableId;
            document.getElementById('edit-table-number-admin').value = tableNumber;
            document.getElementById('edit-table-status-admin').value = status;
            document.getElementById('edit-table-modal-admin').classList.remove('hidden');
        }

        function closeEditTableModalAdmin() {
            document.getElementById('edit-table-modal-admin').classList.add('hidden');
            document.getElementById('edit-table-id-admin').value = '';
            document.getElementById('edit-table-number-admin').value = '';
            document.getElementById('edit-table-status-admin').value = 'available';
        }

        async function updateTableAdmin() {
            const tableId = document.getElementById('edit-table-id-admin').value;
            const newTableNumber = document.getElementById('edit-table-number-admin').value.trim();
            const newStatus = document.getElementById('edit-table-status-admin').value;

            if (!newTableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "error");
                return;
            }

            // Ki·ªÉm tra tr√πng (tr·ª´ b√†n hi·ªán t·∫°i)
            const currentTable = tables.find(t => t.id === tableId);
            if (tables.some(t => t.tableNumber === newTableNumber && t.id !== tableId)) {
                showMessage(`B√†n ${newTableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }

            try {
                await updateDoc(doc(db, 'tables', tableId), {
                    tableNumber: newTableNumber,
                    status: newStatus,
                    updatedAt: new Date()
                });

                showMessage(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t B√†n ${newTableNumber}`, "success");
                closeEditTableModalAdmin();

            } catch (error) {
                console.error("Error updating table:", error);
                showMessage("L·ªói c·∫≠p nh·∫≠t b√†n: " + error.message, "error");
            }
        }

        function showTableQRAdmin(tableNumber) {
            const modal = document.getElementById('qr-table-modal-admin');
            const qrContainer = document.getElementById('qr-table-code-container-admin');
            const tableInfo = document.getElementById('qr-table-info-admin');

            // Clear previous QR
            qrContainer.innerHTML = '';

            // T·∫°o URL v·ªõi table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;

            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">B√†n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">Qu√©t QR code n√†y ƒë·ªÉ v√†o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeQRTableModalAdmin() {
            document.getElementById('qr-table-modal-admin').classList.add('hidden');
        }

        function downloadTableQRAdmin() {
            const qrCanvas = document.querySelector('#qr-table-code-container-admin canvas');
            if (!qrCanvas) return;

            const tableNumber = document.querySelector('#qr-table-info-admin .text-teal-600').textContent;

            const link = document.createElement('a');
            link.download = `QR-Ban-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }

        function clearAdminForm() {
            document.getElementById('admin-item-form').reset();
            document.getElementById('admin-form-id').value = '';
            // Hide price preview
            const previewDiv = document.getElementById('admin-price-preview');
            if (previewDiv) {
                previewDiv.style.display = 'none';
            }
            renderApp(); // Force re-render ƒë·ªÉ c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ form
        }
        
        function loadItemForEdit(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                document.getElementById('admin-form-id').value = item.id;
                document.getElementById('admin-form-name').value = item.name;
                document.getElementById('admin-form-price').value = item.price;
                document.getElementById('admin-form-new-price').value = item.newPrice || '';
                document.getElementById('admin-form-category').value = item.category;
                document.getElementById('admin-form-status').value = item.status || 'active';
                document.getElementById('admin-form-size').value = item.size || '';
                document.getElementById('admin-form-image').value = item.imageUrl || '';
                document.getElementById('admin-form-description').value = item.description || '';

                // Update price preview
                updateAdminPricePreview();

                renderApp(); // Force re-render ƒë·ªÉ c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ form
            }
        }


        function updateAdminPricePreview() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');
            const previewDiv = document.getElementById('admin-price-preview');
            const previewText = document.getElementById('admin-price-preview-text');

            if (!oldPriceInput || !newPriceInput || !previewDiv || !previewText) return;

            const oldPrice = parseFloat(oldPriceInput.value);
            const newPrice = parseFloat(newPriceInput.value);

            if (newPriceInput.value && !isNaN(newPrice) && newPrice > 0) {
                previewDiv.style.display = 'block';
                if (newPrice >= oldPrice) {
                    // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                    previewText.innerHTML = `Ch·ªâ hi·ªán: ${formatCurrency(newPrice)}`;
                } else {
                    // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                    previewText.innerHTML = `G·∫°ch ${formatCurrency(oldPrice)} ‚Üí ${formatCurrency(newPrice)}`;
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function setupAdminPricePreviewListeners() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');

            if (oldPriceInput && newPriceInput) {
                oldPriceInput.addEventListener('input', updateAdminPricePreview);
                newPriceInput.addEventListener('input', updateAdminPricePreview);
            }
        }

        
        function handleSaveItem() {
            const newPriceValue = document.getElementById('item-modal-new-price').value.trim();
            const itemType = document.getElementById('item-modal-item-type').value;

            // Determine category type based on item type
            let categoryType;
            if (['simple', 'noodle', 'food'].includes(itemType)) {
                categoryType = 'food';
            } else if (['drink', 'alcohol'].includes(itemType)) {
                categoryType = 'drink';
            }

            const item = {
                id: document.getElementById('item-modal-id').value,
                name: document.getElementById('item-modal-name').value,
                price: parseFloat(document.getElementById('item-modal-price').value),
                category: document.getElementById('item-modal-category').value,
                status: document.getElementById('item-modal-status').value,
                itemType: itemType,
                categoryType: categoryType,
                imageUrl: document.getElementById('item-modal-image').value,
                description: document.getElementById('item-modal-description').value,
            };

            // Add newPrice if provided
            if (newPriceValue && parseFloat(newPriceValue) > 0) {
                item.newPrice = parseFloat(newPriceValue);
            }

            // Add details if itemType is not simple
            if (itemType !== 'simple' && currentItemDetails) {
                item.details = currentItemDetails;
            }

            saveItem(item);
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showMessage("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!", "error");
                return;
            }

            if (newPassword.length < 6) {
                showMessage("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", "error");
                return;
            }

            const success = await changePassword(currentPassword, newPassword);
            if (success) {
                document.getElementById('change-password-form').reset();
            }
        }

        // Render Admin Trash View - Th√πng r√°c t·ªïng h·ª£p
        function renderAdminTrash() {
            const deletedOrders = orders.filter(o => o.status === 'deleted');
            const deletedMenuItems = menuItems.filter(m => m.status === 'deleted');
            
            return `
                <div class="p-2 sm:p-3 md:p-6 lg:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20 relative">
                    <div class="flex justify-between items-center mb-3 sm:mb-4 md:mb-6">
                        <h2 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-gray-900">üóëÔ∏è Th√πng R√°c</h2>
                        <button onclick="loadOrders(); loadMenuItems();" class="absolute top-2 right-2 sm:top-3 sm:right-3 md:top-6 md:right-6 lg:top-10 lg:right-10 bg-gray-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-gray-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                            <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            <span class="hidden sm:inline">L√†m m·ªõi</span>
                        </button>
                    </div>

                    <!-- Th·ªëng k√™ nhanh -->
                    <div class="grid grid-cols-1 xs:grid-cols-2 gap-3 sm:gap-4 mb-6">
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm">ƒê∆°n h√†ng ƒë√£ x√≥a</p>
                                    <p class="text-xl sm:text-2xl font-bold text-purple-600">${deletedOrders.length}</p>
                                </div>
                                <i data-lucide="clipboard-x" class="w-6 h-6 sm:w-8 sm:h-8 text-purple-400 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm">M√≥n ƒÉn ƒë√£ x√≥a</p>
                                    <p class="text-xl sm:text-2xl font-bold text-orange-600">${deletedMenuItems.length}</p>
                                </div>
                                <i data-lucide="coffee" class="w-6 h-6 sm:w-8 sm:h-8 text-orange-400 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- ƒê∆°n h√†ng ƒë√£ x√≥a -->
                    <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
                        <h3 class="text-base sm:text-lg md:text-xl font-bold text-purple-900 mb-3 sm:mb-4 flex items-center gap-2">
                            <i data-lucide="clipboard-x" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                            ƒê∆°n h√†ng ƒë√£ x√≥a (${deletedOrders.length})
                        </h3>
                        
                        ${deletedOrders.length === 0 ? `
                            <p class="text-center text-gray-500 py-8">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <br>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong th√πng r√°c
                            </p>
                        ` : `
                            <div class="space-y-3">
                                ${deletedOrders.map(order => `
                                    <div class="bg-gray-100 border-2 border-gray-300 p-3 sm:p-4 rounded-lg">
                                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-3 gap-3">
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-semibold text-gray-800 mb-1 text-sm sm:text-base">
                                                    Order #${order.id.slice(-6).toUpperCase()}
                                                    ${order.tableNumber ? `<span class="ml-1 sm:ml-2 px-2 py-0.5 bg-teal-100 text-teal-700 text-xs rounded-full inline-block">üçΩÔ∏è B√†n ${order.tableNumber}</span>` : ''}
                                                </h4>
                                                <p class="text-xs sm:text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                                ${order.previousStatus ? `<p class="text-xs text-gray-500 mt-1">Tr·∫°ng th√°i tr∆∞·ªõc: ${getStatusText(order.previousStatus)}</p>` : ''}
                                                ${order.deletedAt ? `<p class="text-xs text-red-600 mt-1">X√≥a l√∫c: ${new Date(order.deletedAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                                            </div>
                                            <div class="flex gap-2 sm:flex-shrink-0">
                                                <button onclick="restoreOrder('${order.id}')" class="bg-green-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-green-600 text-xs sm:text-sm whitespace-nowrap flex-1 sm:flex-none">
                                                    ‚ôªÔ∏è Kh√¥i ph·ª•c
                                                </button>
                                                <button onclick="permanentDeleteOrder('${order.id}')" class="bg-red-600 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-red-700 text-xs sm:text-sm whitespace-nowrap flex-1 sm:flex-none">
                                                    ‚ö†Ô∏è X√≥a vƒ©nh vi·ªÖn
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-1.5 sm:space-y-2">
                                            ${order.items.map(item => {
                                                const hasDetails = item.selectedDetails && Object.keys(item.selectedDetails).length > 0;
                                                let detailsHtml = '';
                                                
                                                if (hasDetails) {
                                                    const details = item.selectedDetails;
                                                    const detailsParts = [];
                                                    
                                                    if (details.size) detailsParts.push(`Size: ${details.size}`);
                                                    if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                                    if (details.ice !== undefined) detailsParts.push(`ƒê√°: ${details.ice}%`);
                                                    if (details.sugar !== undefined) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}%`);
                                                    if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                                    if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                                    if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                                    
                                                    if (detailsParts.length > 0) {
                                                        detailsHtml = `<div class="text-[9px] sm:text-[10px] text-gray-600 mt-0.5">${detailsParts.join(' ‚Ä¢ ')}</div>`;
                                                    }
                                                }
                                                
                                                return `
                                                    <div class="bg-white p-2 rounded">
                                                        <div class="flex justify-between text-xs sm:text-sm">
                                                            <span class="flex-1 min-w-0 pr-2 truncate">${item.name} ${item.size ? `(${item.size})` : ''} x${item.quantity}</span>
                                                            <span class="font-semibold text-orange-600 flex-shrink-0">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                                        </div>
                                                        ${detailsHtml}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>

                                        <div class="mt-3 pt-3 border-t flex justify-between items-center">
                                            <span class="font-bold text-orange-600 text-sm sm:text-base">T·ªïng: ${formatCurrency(order.total)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- M√≥n ƒÉn ƒë√£ x√≥a -->
                    <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 md:p-6">
                        <h3 class="text-base sm:text-lg md:text-xl font-bold text-orange-900 mb-3 sm:mb-4 flex items-center gap-2">
                            <i data-lucide="coffee" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                            M√≥n ƒÉn ƒë√£ x√≥a (${deletedMenuItems.length})
                        </h3>
                        
                        ${deletedMenuItems.length === 0 ? `
                            <p class="text-center text-gray-500 py-8">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <br>Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong th√πng r√°c
                            </p>
                        ` : `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                ${deletedMenuItems.map(item => `
                                    <div class="bg-gray-100 border-2 border-gray-300 p-3 sm:p-4 rounded-lg">
                                        ${item.image ? `
                                            <img src="${item.image}" alt="${item.name}" class="w-full h-24 sm:h-32 object-cover rounded-lg mb-3 opacity-60">
                                        ` : ''}
                                        <h4 class="font-semibold text-gray-800 mb-2 text-sm sm:text-base">${item.name}</h4>
                                        <p class="text-xs sm:text-sm text-gray-600 mb-2">${item.category}</p>
                                        <p class="text-orange-600 font-bold mb-2 sm:mb-3 text-sm sm:text-base">${formatCurrency(getItemPrice(item))}</p>
                                        ${item.deletedAt ? `<p class="text-xs text-red-600 mb-2 sm:mb-3">X√≥a l√∫c: ${new Date(item.deletedAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}

                                        <div class="flex gap-1.5 sm:gap-2">
                                            <button onclick="restoreMenuItem('${item.id}')" class="flex-1 bg-green-500 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-green-600 text-xs sm:text-sm">
                                                ‚ôªÔ∏è Kh√¥i ph·ª•c
                                            </button>
                                            <button onclick="permanentDeleteMenuItem('${item.id}')" class="flex-1 bg-red-600 text-white px-2 sm:px-3 py-1.5 rounded hover:bg-red-700 text-xs sm:text-sm">
                                                ‚ö†Ô∏è X√≥a vƒ©nh vi·ªÖn
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderMainContent() {
            switch (currentView) {
                case 'login':
                    return renderLoginView();
                case 'admin-stats':
                    return isAdmin ? renderAdminStats() : renderLoginView();
                case 'admin-orders':
                    return isAdmin ? renderAdminOrders() : renderLoginView();
                case 'admin-tables':
                    return isAdmin ? renderAdminTables() : renderLoginView();
                case 'admin-menu':
                    return isAdmin ? renderAdminMenu() : renderLoginView();
                case 'admin-trash':
                    return isAdmin ? renderAdminTrash() : renderLoginView();
                case 'customer':
                default:
                    const menuHtml = `<div class="pb-16 sm:pb-20">${renderCustomerMenu()}</div>`;

                    return `
                        ${renderFeaturedItems()}
                        ${renderMenuSelection()}
                        <main class="bg-amber-50">
                            ${menuHtml}
                        </main>
                    `;
            }
        }
        
        function renderCartSidebar() {
            const itemsInCart = Object.values(cart);
            const total = itemsInCart.reduce((sum, entry) => {
                const price = entry.finalPrice || getItemPrice(entry.item);
                return sum + (price * entry.quantity);
            }, 0);
            const cartClasses = Object.keys(cart).length === 0 
                ? 'translate-x-full' // ·∫®n khi kh√¥ng c√≥ m√≥n
                : ''; // Gi·ªØ tr·∫°ng th√°i ·∫©n/hi·ªán d·ª±a tr√™n click

            return `
                <!-- N·ªÅn ƒëen m·ªù (overlay) - click ƒë·ªÉ ƒë√≥ng gi·ªè h√†ng -->
                <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity duration-300 hidden" onclick="closeCart()"></div>
            
                <div id="cart-sidebar" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white shadow-2xl z-[60] transform transition-transform duration-300 translate-x-full">
                    <div class="flex justify-between items-center p-4 border-b border-amber-200 bg-amber-50">
                        <h3 class="text-xl font-bold text-amber-900 flex items-center">
                            <i data-lucide="shopping-basket" class="w-6 h-6 mr-2"></i> Gi·ªè H√†ng
                            ${Object.keys(cart).length > 0 ? `<span class="ml-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full">${Object.values(cart).reduce((sum, item) => sum + item.quantity, 0)}</span>` : ''}
                        </h3>
                        <button onclick="closeCart()" class="p-2 rounded-full hover:bg-gray-100 text-amber-800">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="p-4 overflow-y-auto h-[calc(100%-140px)]">
                        ${itemsInCart.length > 0 ? itemsInCart.map(entry => {
                            const price = entry.finalPrice || getItemPrice(entry.item);
                            const hasDetails = entry.selectedDetails && Object.keys(entry.selectedDetails).length > 0;
                            
                            let detailsHtml = '';
                            if (hasDetails) {
                                const details = entry.selectedDetails;
                                const detailsParts = [];
                                
                                if (details.size) detailsParts.push(`Size: ${details.size}`);
                                if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                if (details.ice !== undefined) detailsParts.push(`ƒê√°: ${details.ice}%`);
                                if (details.sugar !== undefined) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}%`);
                                if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                
                                if (detailsParts.length > 0) {
                                    detailsHtml = `<p class="text-xs text-gray-600 mt-1">${detailsParts.join(' ‚Ä¢ ')}</p>`;
                                }
                            }
                            
                            return `
                                <div class="py-3 border-b border-dashed border-amber-100">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-grow pr-4">
                                            <div class="flex items-center gap-2">
                                                <p class="font-semibold text-amber-900">${entry.item.name}</p>
                                                ${hasDetails ? `<button onclick="editCartItemDetails('${entry.id}')" class="text-xs text-blue-600 hover:text-blue-800" title="Ch·ªânh s·ª≠a chi ti·∫øt">
                                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                                </button>` : ''}
                                            </div>
                                            <p class="text-sm text-orange-600">${formatCurrency(price)} x ${entry.quantity}</p>
                                            ${detailsHtml}
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <button onclick="updateCart('${entry.item.id}', -1, null, '${entry.id}')" class="p-1 text-sm bg-amber-200 rounded-full hover:bg-amber-300 transition duration-150">
                                                <i data-lucide="minus" class="w-4 h-4"></i>
                                            </button>
                                            <span class="w-6 text-center text-amber-900 font-medium">${entry.quantity}</span>
                                            <button onclick="updateCart('${entry.item.id}', 1, null, '${entry.id}')" class="p-1 text-sm bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150">
                                                <i data-lucide="plus" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p class="text-center text-gray-500 mt-10">Gi·ªè h√†ng tr·ªëng.</p>'}
                    </div>
                    
                    <div class="absolute bottom-0 w-full p-4 border-t border-amber-300 bg-white">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-lg font-bold text-amber-900">T·ªïng C·ªông:</p>
                            <p class="text-2xl font-extrabold text-red-600">${formatCurrency(total)}</p>
                        </div>
                         <button class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition duration-150 shadow-lg" onclick="handleOrder()">
                             <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order
                         </button>
                    </div>
                </div>
            `;
        }

          function disableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = true;
                  button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i> ƒêang x·ª≠ l√Ω...';
              }
          }

          function enableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = false;
                  button.innerHTML = '<i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order';
                  renderLucideIcons();
              }
          }

          async function handleOrder() {
              const total = Object.values(cart).reduce((sum, entry) => {
                  const price = entry.finalPrice || getItemPrice(entry.item);
                  return sum + (price * entry.quantity);
              }, 0);

              if (total === 0) {
                  showMessage("Gi·ªè h√†ng tr·ªëng! Vui l√≤ng ch·ªçn m√≥n.", 'warning');
                  return;
              }

              // Ki·ªÉm tra table number - n·∫øu ch∆∞a c√≥ th√¨ hi·ªán modal ch·ªçn b√†n
              if (!currentTableNumber) {
                  showTableSelectionModal();
                  return;
              }

              // Hi·ªÉn th·ªã confirm dialog
              const itemsInCart = Object.values(cart);
              const confirmMessage = `B·∫°n c√≥ mu·ªën ƒë·∫∑t h√†ng v·ªõi ${itemsInCart.length} m√≥n v√† t·ªïng ti·ªÅn ${formatCurrency(total)} kh√¥ng?`;
              if (!confirm(confirmMessage)) {
                  return; // User canceled
              }

              // Disable order button to prevent multiple clicks
              disableOrderButton();

              try {
                  // T·∫°o order object
                  const orderItems = Object.values(cart).map(entry => {
                      const orderItem = {
                          id: entry.item.id,
                          name: entry.item.name,
                          price: entry.finalPrice || getItemPrice(entry.item),
                          basePrice: entry.item.price, // Gi√° g·ªëc c·ªßa m√≥n
                          quantity: entry.quantity,
                          size: entry.item.size || null,
                          category: entry.item.category
                      };
                      
                      // Th√™m selectedDetails n·∫øu c√≥
                      if (entry.selectedDetails) {
                          orderItem.selectedDetails = entry.selectedDetails;
                      }
                      
                      return orderItem;
                  });

                  const orderData = {
                      items: orderItems,
                      total: total,
                      status: 'ordered', // ordered, confirmed, preparing, ready, completed, cancelled, updated
                      customerId: userId,
                      customerEmail: auth.currentUser?.email || 'anonymous',
                      tableNumber: currentTableNumber || null, // S·ªë b√†n (n·∫øu order t·ª´ QR code)
                      createdAt: new Date(),
                      updatedAt: new Date()
                  };

                  // L∆∞u order v√†o Firestore
                  const docRef = await addDoc(collection(db, 'orders'), orderData);

                  showMessage(`üéâ ƒê√£ ƒë·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: #${docRef.id.slice(-6).toUpperCase()}`, 'success');


                  // L∆∞u order v√†o session cho kh√°ch h√†ng (n·∫øu l√† guest)
                  if (userRole === 'guest' && currentSessionId) {
                      const guestOrderData = {
                          orderId: docRef.id,
                          shortId: docRef.id.slice(-6).toUpperCase(),
                          items: orderItems,
                          total: total,
                          status: 'ordered',
                          tableNumber: currentTableNumber,
                          createdAt: orderData.createdAt,
                          updatedAt: orderData.updatedAt
                      };
                      guestOrders.push(guestOrderData);
                      saveSessionToCookie();
                  }

                  // ƒê√≥ng cart v√† x√≥a gi·ªè h√†ng
                  document.getElementById('cart-sidebar').classList.add('translate-x-full');
                  cart = {};
                  localStorage.removeItem('cart');
                  renderApp();

              } catch (error) {
                  console.error("Error creating order:", error);
                  showMessage("L·ªói khi ƒë·∫∑t h√†ng: " + error.message, "error");
              } finally {
                  // Always re-enable button regardless of success/failure
                  enableOrderButton();
              }
          }

          // ==================== ORDER MANAGEMENT (ADMIN) ====================
          
          let currentOrderFilter = 'ordered'; // ordered, preparing, completed, cancelled, all, today
          let dateFrom = null; // Start date for filtering (Date object)
          let dateTo = null; // End date for filtering (Date object)
          let currentPage = 1;
          let itemsPerPage = 5; // Default 10 items per page
          let menuCurrentPage = 1;
          let menuItemsPerPage = 10; // Show 10 menu items per page (default)
          let menuFilterStatus = ''; // Filter by status (empty = all)
          let menuFilterCategory = ''; // Filter by category (empty = all)
          let processingOrderId = localStorage.getItem('processingOrderId'); // L·∫•y t·ª´ storage n·∫øu reload
          
          // Notification settings
          let notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false'; // Default: enabled

          // Setup realtime listener cho orders
          function setupOrdersListener() {
              if (!db) {
                  console.error("Database not initialized");
                  return;
              }

              try {
                  console.log("üì° Setting up orders realtime listener...");
                  const ordersRef = collection(db, 'orders');
                  
                  onSnapshot(ordersRef, async (snapshot) => {
                      orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      console.log("üìã Orders updated:", orders.length);
                      
                      // --- T·ª∞ ƒê·ªòNG H·ª¶Y ƒê∆†N QU√Å H·∫†N ---
                      const now = Date.now();
                      const threeHours = 3 * 60 * 60 * 1000; // 3 gi·ªù t√≠nh b·∫±ng milliseconds (cho ƒë∆°n "Ch·ªù nh·∫≠n")
                      const sixHours = 6 * 60 * 60 * 1000; // 6 gi·ªù t√≠nh b·∫±ng milliseconds (cho ƒë∆°n "ƒêang l√†m")
                      
                      for (const order of orders) {
                          // T·ª± ƒë·ªông h·ªßy ƒë∆°n "Ch·ªù nh·∫≠n" (ordered) qu√° 3 gi·ªù
                          if (order.status === 'ordered' && order.createdAt && order.createdAt.seconds) {
                              const orderTime = order.createdAt.seconds * 1000;
                              const timeDiff = now - orderTime;
                              
                              // N·∫øu ƒë∆°n h√†ng ƒë√£ qu√° 3 ti·∫øng
                              if (timeDiff >= threeHours) {
                                  console.log(`‚è∞ Auto-cancelling expired order: ${order.id.slice(-6)}`);
                                  
                                  try {
                                      await updateDoc(doc(db, 'orders', order.id), {
                                          status: 'cancelled',
                                          cancelReason: 'ƒê∆°n h√†ng qu√° h·∫°n (t·ª± ƒë·ªông h·ªßy sau 3 gi·ªù)',
                                          cancelledAt: { seconds: Math.floor(Date.now() / 1000), nanoseconds: 0 },
                                          cancelledBy: 'system',
                                          updatedAt: new Date()
                                      });
                                      
                                      showMessage(`‚è∞ ƒê∆°n #${order.id.slice(-6).toUpperCase()} ƒë√£ b·ªã h·ªßy do qu√° h·∫°n`, "warning");
                                  } catch (error) {
                                      console.error("Error auto-cancelling order:", error);
                                  }
                              }
                          }
                          
                          // T·ª± ƒë·ªông h·ªßy ƒë∆°n "ƒêang l√†m" (preparing) qu√° 6 gi·ªù
                          if (order.status === 'preparing' && order.createdAt && order.createdAt.seconds) {
                              const orderTime = order.createdAt.seconds * 1000;
                              const timeDiff = now - orderTime;
                              
                              // N·∫øu ƒë∆°n h√†ng ƒë√£ qu√° 6 ti·∫øng
                              if (timeDiff >= sixHours) {
                                  console.log(`‚è∞ Auto-cancelling expired preparing order: ${order.id.slice(-6)}`);
                                  
                                  try {
                                      await updateDoc(doc(db, 'orders', order.id), {
                                          status: 'cancelled',
                                          cancelReason: 'ƒê∆°n h√†ng qu√° h·∫°n (t·ª± ƒë·ªông h·ªßy sau 6 gi·ªù)',
                                          cancelledAt: { seconds: Math.floor(Date.now() / 1000), nanoseconds: 0 },
                                          cancelledBy: 'system',
                                          updatedAt: new Date()
                                      });
                                      
                                      showMessage(`‚è∞ ƒê∆°n #${order.id.slice(-6).toUpperCase()} ƒë√£ b·ªã h·ªßy do qu√° h·∫°n`, "warning");
                                  } catch (error) {
                                      console.error("Error auto-cancelling preparing order:", error);
                                  }
                              }
                          }
                      }
                      
                      // --- LOGIC T·ª∞ ƒê·ªòNG CHUY·ªÇN TAB V√Ä TR·∫†NG TH√ÅI ---
                      if (isAdmin) {
                           // 1. Ki·ªÉm tra ƒë∆°n h√†ng ƒëang l√†m (processingOrderId)
                           if (processingOrderId) {
                               const processingOrder = orders.find(o => o.id === processingOrderId);
                               
                               // N·∫øu ƒë∆°n v·∫´n ƒëang l√†m ('preparing') -> CH·ªà t·ª± ƒë·ªông chuy·ªÉn tab n·∫øu KH√îNG ƒëang ·ªü trang admin-orders
                               if (processingOrder && processingOrder.status === 'preparing') {
                                   if (currentView !== 'admin-orders' && currentOrderFilter !== 'preparing') {
                                       currentOrderFilter = 'preparing';
                                   }
                               } 
                               // N·∫øu ƒë∆°n ƒë√£ xong ho·∫∑c h·ªßy -> X√≥a tr·∫°ng th√°i ƒëang l√†m
                               else {
                                   processingOrderId = null;
                                   localStorage.removeItem('processingOrderId');
                                   
                                   // N·∫øu v·ª´a xong ƒë∆°n l√†m, ki·ªÉm tra xem c√≥ ƒë∆°n ch·ªù n√†o kh√¥ng ƒë·ªÉ chuy·ªÉn v·ªÅ tab ordered
                                   // CH·ªà t·ª± ƒë·ªông chuy·ªÉn tab n·∫øu KH√îNG ƒëang ·ªü trang admin-orders
                                   const hasPendingOrders = orders.some(o => o.status === 'ordered');
                                   if (hasPendingOrders && currentView !== 'admin-orders' && currentOrderFilter !== 'ordered') {
                                       currentOrderFilter = 'ordered';
                                   }
                               }
                           }
                           
                           // 2. Logic khi c√≥ ƒë∆°n m·ªõi
                           snapshot.docChanges().forEach(change => {
                               if (change.type === 'added') {
                                   const order = change.doc.data();
                                   if (order.status === 'ordered') {
                                       const orderId = change.doc.id.slice(-6).toUpperCase();
                                       showMessage(`üîî ƒê∆°n h√†ng m·ªõi: #${orderId}`, 'info');

                                       // Hi·ªÉn th·ªã th√¥ng b√°o tr√¨nh duy·ªát v·ªõi √¢m thanh cho admin
                                       showBrowserNotification(
                                           'üîî ƒê∆°n h√†ng m·ªõi!',
                                           `ƒê∆°n h√†ng #${orderId} ƒëang ch·ªù x·ª≠ l√Ω`,
                                           'logo.png'
                                       );

                                       // T·ª± ƒë·ªông c·∫≠p nh·∫≠t dateTo ƒë·ªÉ ƒë·∫£m b·∫£o ƒë∆°n m·ªõi lu√¥n hi·ªÉn th·ªã (kh√¥ng b·ªã date filter ch·∫∑n)
                                       if (dateTo) {
                                           dateTo = new Date();
                                           console.log('üìÖ Auto-updated dateTo to now:', dateTo);
                                       }

                                       // N·∫æU KH√îNG ƒêANG L√ÄM ƒê∆†N N√ÄO V√Ä KH√îNG ƒêANG ·ªû TRANG QU·∫¢N L√ù ƒê∆†N H√ÄNG -> T·ª± ƒë·ªông chuy·ªÉn sang tab ch·ªù nh·∫≠n
                                       // N·∫øu ƒëang ·ªü trong trang admin-orders th√¨ gi·ªØ nguy√™n tab hi·ªán t·∫°i (kh√¥ng thay ƒë·ªïi currentOrderFilter)
                                       if (!processingOrderId && currentView !== 'admin-orders' && currentOrderFilter !== 'ordered') {
                                           currentOrderFilter = 'ordered';
                                       }
                                   }
                               }
                           });
                      }

                      // Re-render header ƒë·ªÉ c·∫≠p nh·∫≠t badge
                      if (isAdmin) {
                          document.getElementById('header-container').innerHTML = renderHeader();
                          renderLucideIcons();
                      }
                      
                      // Render n·∫øu ƒëang ·ªü trang admin orders
                      if (currentView === 'admin-orders') {
                          console.log('üîÑ Updating orders management page, current filter:', currentOrderFilter);
                          renderOrdersManagementList();
                      }

                      // Render n·∫øu ƒëang ·ªü trang admin stats
                      if (currentView === 'admin-stats') {
                          renderApp(); // Re-render to√†n b·ªô app ƒë·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™
                      }
                      
                      // NOTE: Guest orders realtime updates now handled by individual order listeners
                      // (more efficient than listening to all orders and filtering)
                  }, (error) => {
                      console.error("Error in orders listener:", error);
                  });
                  
              } catch (error) {
                  console.error("Error setting up orders listener:", error);
              }
          }
          
          // Setup m·∫∑c ƒë·ªãnh cho trang qu·∫£n l√Ω ƒë∆°n h√†ng
          function setupOrdersPage() {
              currentOrderFilter = 'ordered'; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã ƒë∆°n ch·ªù
              // Set default to show today's orders
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time
          }

          function setOrderFilter(filter) {
              currentOrderFilter = filter;
              renderOrdersManagementList();
          }

          function toggleDateFilter() {
              const content = document.getElementById('date-filter-content');
              const arrow = document.getElementById('date-filter-arrow');

              if (content.classList.contains('hidden')) {
                  content.classList.remove('hidden');
                  arrow.textContent = '‚ñ≤';
              } else {
                  content.classList.add('hidden');
                  arrow.textContent = '‚ñº';
              }
          }

          function applyDateFilter() {
              const fromInput = document.getElementById('date-from');
              const toInput = document.getElementById('date-to');

              if (fromInput && fromInput.value) {
                  dateFrom = new Date(fromInput.value);
              } else {
                  dateFrom = null;
              }

              if (toInput && toInput.value) {
                  dateTo = new Date(toInput.value);
              } else {
                  dateTo = null;
              }

              currentPage = 1; // Reset to first page when changing filters
              renderOrdersManagementList();

              // Close the date filter after applying
              const content = document.getElementById('date-filter-content');
              const arrow = document.getElementById('date-filter-arrow');
              if (content && arrow) {
                  content.classList.add('hidden');
                  arrow.textContent = '‚ñº';
              }
          }

          function clearDateFilter() {
              // Clear date filter and show today's orders (from 00:00 to current time)
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time

              // Update input values to show today's range
              document.getElementById('date-from').value = dateFrom.toISOString().slice(0, 16);
              document.getElementById('date-to').value = dateTo.toISOString().slice(0, 16);

              currentPage = 1; // Reset to first page when clearing filters
              renderOrdersManagementList();
          }

          function resetDateFilter() {
              // Reset to default: today from 00:00 to current time
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time

              // Update input values
              document.getElementById('date-from').value = dateFrom.toISOString().slice(0, 16);
              document.getElementById('date-to').value = dateTo.toISOString().slice(0, 16);

              currentPage = 1; // Reset to first page when resetting filters
              renderOrdersManagementList();
          }

          function setItemsPerPage(count) {
              itemsPerPage = parseInt(count);
              currentPage = 1; // Reset to first page when changing items per page
              renderOrdersManagementList();
          }

          function setPage(page) {
              currentPage = page;
              renderOrdersManagementList();
          }

          function setMenuPage(page) {
              const filteredItems = getFilteredMenuItems();
              const totalPages = Math.ceil(filteredItems.length / menuItemsPerPage);
              if (page >= 1 && page <= totalPages) {
                  menuCurrentPage = page;
                  renderApp(); // Re-render entire app to update menu
              }
          }

          function setMenuItemsPerPage(itemsPerPage) {
              if (itemsPerPage && itemsPerPage > 0) {
                  menuItemsPerPage = parseInt(itemsPerPage);
                  menuCurrentPage = 1; // Reset to first page
                  renderApp(); // Re-render entire app to update menu
              }
          }

          function setMenuFilterStatus(status) {
              menuFilterStatus = status === '-- T·∫•t c·∫£ --' ? '' : (status || '');
              menuCurrentPage = 1; // Reset to first page
              renderApp(); // Re-render entire app to update menu
          }

          function setMenuFilterCategory(category) {
              menuFilterCategory = category === '-- T·∫•t c·∫£ --' ? '' : (category || '');
              menuCurrentPage = 1; // Reset to first page
              renderApp(); // Re-render entire app to update menu
          }

          function getFilteredMenuItems() {
              return menuItems
                  .filter(item => {
                      // Always exclude deleted items
                      if (item.status === 'deleted') return false;
                      
                      // Filter by status if selected (empty string means show all)
                      if (menuFilterStatus && menuFilterStatus !== '') {
                          if (item.status !== menuFilterStatus) return false;
                      }
                      
                      // Filter by category if selected (empty string means show all)
                      if (menuFilterCategory && menuFilterCategory !== '') {
                          if (item.category !== menuFilterCategory) return false;
                      }
                      
                      return true;
                  })
                  .sort((a, b) => {
                      // S·∫Øp x·∫øp theo itemId gi·∫£m d·∫ßn
                      const idA = a.itemId !== undefined && a.itemId !== null ? a.itemId : 0;
                      const idB = b.itemId !== undefined && b.itemId !== null ? b.itemId : 0;
                      
                      if (idA > 0 && idB > 0) {
                          return idB - idA;
                      }
                      
                      if (idA > 0 && idB === 0) return -1;
                      if (idA === 0 && idB > 0) return 1;
                      
                      const timeA = a.createdAt?.seconds || a.updatedAt?.seconds || 0;
                      const timeB = b.createdAt?.seconds || b.updatedAt?.seconds || 0;
                      return timeB - timeA;
                  });
          }

          function nextPage() {
              const totalPages = Math.ceil(getFilteredOrders().length / itemsPerPage);
              if (currentPage < totalPages) {
                  currentPage++;
                  renderOrdersManagementList();
              }
          }

          function prevPage() {
              if (currentPage > 1) {
                  currentPage--;
                  renderOrdersManagementList();
              }
          }

          function getFilteredOrders() {
              // Filter orders
              let filteredOrders = [...orders];

              // Filter theo date range
              if (dateFrom || dateTo) {
                  filteredOrders = filteredOrders.filter(order => {
                      if (!order.createdAt) return false;
                      const orderDate = new Date(order.createdAt.seconds * 1000);

                      if (dateFrom && orderDate < dateFrom) return false;
                      if (dateTo && orderDate > dateTo) return false;

                      return true;
                  });
              }

              // Filter theo status
              if (currentOrderFilter === 'deleted') {
                  // Ch·ªâ hi·ªÉn th·ªã ƒë∆°n ƒë√£ x√≥a
                  filteredOrders = filteredOrders.filter(order => order.status === 'deleted');
              } else if (currentOrderFilter === 'all') {
                  // Hi·ªÉn th·ªã t·∫•t c·∫£ TR·ª™ ƒë∆°n ƒë√£ x√≥a
                  filteredOrders = filteredOrders.filter(order => order.status !== 'deleted');
              } else {
                  // L·ªçc theo status c·ª• th·ªÉ (v√† lo·∫°i tr·ª´ deleted)
                  filteredOrders = filteredOrders.filter(order => order.status === currentOrderFilter);
              }

              // Sort: ∆∞u ti√™n ƒë∆°n ch·ªù (ordered) l√™n ƒë·∫ßu, sau ƒë√≥ theo th·ªùi gian
              // V·ªõi tab "ordered" v√† "preparing": s·∫Øp x·∫øp h√≥a ƒë∆°n c≈© ·ªü tr∆∞·ªõc (tƒÉng d·∫ßn)
              // V·ªõi c√°c tab kh√°c: s·∫Øp x·∫øp h√≥a ƒë∆°n m·ªõi nh·∫•t ·ªü tr∆∞·ªõc (gi·∫£m d·∫ßn)
              filteredOrders.sort((a, b) => {
                  // ∆Øu ti√™n ordered
                  if (a.status === 'ordered' && b.status !== 'ordered') return -1;
                  if (a.status !== 'ordered' && b.status === 'ordered') return 1;

                  // Sau ƒë√≥ preparing
                  if (a.status === 'preparing' && b.status !== 'preparing' && b.status !== 'ordered') return -1;
                  if (a.status !== 'preparing' && b.status === 'preparing') return 1;

                  // Cu·ªëi c√πng theo th·ªùi gian
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  
                  // N·∫øu l√† tab "ordered" ho·∫∑c "preparing": s·∫Øp x·∫øp c≈© tr∆∞·ªõc (tƒÉng d·∫ßn)
                  if (currentOrderFilter === 'ordered' || currentOrderFilter === 'preparing') {
                      return timeA - timeB;
                  }
                  
                  // C√°c tab kh√°c: s·∫Øp x·∫øp m·ªõi nh·∫•t tr∆∞·ªõc (gi·∫£m d·∫ßn)
                  return timeB - timeA;
              });

              return filteredOrders;
          }

          function renderOrdersManagementList() {
              const container = document.getElementById('orders-management-content');
              if (!container) {
                  console.log('‚ùå Container #orders-management-content not found, skipping render');
                  return;
              }

              console.log('‚úÖ Rendering orders management list, filter:', currentOrderFilter, 'total orders:', orders.length);
              const filteredOrders = getFilteredOrders();
              console.log('üìä Filtered orders:', filteredOrders.length, 'Current page:', currentPage);

              // Count theo status (theo k·∫øt qu·∫£ l·ªçc th·ªùi gian, kh√¥ng ph·ª• thu·ªôc v√†o currentOrderFilter)
              let dateFilteredOrders = orders;
              if (dateFrom || dateTo) {
                  dateFilteredOrders = orders.filter(order => {
                      if (!order.createdAt) return false;
                      const orderDate = new Date(order.createdAt.seconds * 1000);

                      if (dateFrom && orderDate < dateFrom) return false;
                      if (dateTo && orderDate > dateTo) return false;

                      return true;
                  });
              }
              
              // Lo·∫°i b·ªè ƒë∆°n ƒë√£ x√≥a kh·ªèi dateFilteredOrders cho hi·ªÉn th·ªã t·ªïng s·ªë
              const nonDeletedOrders = dateFilteredOrders.filter(o => o.status !== 'deleted');

              const counts = {
                  ordered: dateFilteredOrders.filter(o => o.status === 'ordered').length,
                  preparing: dateFilteredOrders.filter(o => o.status === 'preparing').length,
                  completed: dateFilteredOrders.filter(o => o.status === 'completed').length,
                  cancelled: dateFilteredOrders.filter(o => o.status === 'cancelled').length,
                  deleted: dateFilteredOrders.filter(o => o.status === 'deleted').length
              };
              
              // C·∫≠p nh·∫≠t l·∫°i dateFilteredOrders ƒë·ªÉ kh√¥ng bao g·ªìm deleted (ƒë·ªÉ hi·ªÉn th·ªã "T·∫•t c·∫£")
              dateFilteredOrders = nonDeletedOrders;

              // Pagination calculations
              const totalItems = filteredOrders.length;
              const totalPages = Math.ceil(totalItems / itemsPerPage);
              const startIndex = (currentPage - 1) * itemsPerPage;
              const endIndex = startIndex + itemsPerPage;
              const paginatedOrders = filteredOrders.slice(startIndex, endIndex);
              
              container.innerHTML = `
                  <!-- Filter Bar -->
                  <div class="bg-gray-50 p-3 sm:p-4 rounded-lg mb-3 sm:mb-4 space-y-2 sm:space-y-3">
                      <!-- Date Range Filter -->
                      <div>
                          <button onclick="toggleDateFilter()" class="w-full text-left flex items-center justify-between text-xs font-medium text-gray-700 hover:text-gray-900 transition">
                              <span>üóìÔ∏è L·ªçc theo kho·∫£ng th·ªùi gian</span>
                              <span id="date-filter-arrow" class="text-gray-400">‚ñº</span>
                          </button>
                          <div id="date-filter-content" class="hidden mt-2 space-y-2">
                              <div class="flex gap-2">
                                  <div class="flex-1">
                                      <label class="text-[9px] text-gray-600 block mb-0.5">T·ª´:</label>
                                  <input type="datetime-local" id="date-from" class="w-full px-1.5 py-1 border border-gray-300 rounded text-[11px] focus:ring-blue-500 focus:border-blue-500">
                              </div>
                              <div class="flex-1">
                                  <label class="text-[9px] text-gray-600 block mb-0.5">ƒê·∫øn:</label>
                                  <input type="datetime-local" id="date-to" class="w-full px-1.5 py-1 border border-gray-300 rounded text-[11px] focus:ring-blue-500 focus:border-blue-500">
                                  </div>
                              </div>
                              <div class="flex gap-2">
                                  <button onclick="applyDateFilter()" class="flex-1 px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 active:scale-95 transition">
                                      L·ªçc
                                  </button>
                                  <button onclick="clearDateFilter()" class="px-2 py-1.5 bg-gray-500 text-white rounded text-[10px] hover:bg-gray-600 active:scale-95 transition whitespace-nowrap">
                                      X√≥a b·ªô l·ªçc
                                  </button>
                                  <button onclick="resetDateFilter()" class="px-2 py-1.5 bg-orange-500 text-white rounded text-[10px] hover:bg-orange-600 active:scale-95 transition whitespace-nowrap">
                                      ƒê·∫∑t l·∫°i
                                  </button>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Status Filter -->
                      <div>
                          <label class="text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2 block">üìä L·ªçc theo tr·∫°ng th√°i:</label>
                          <div class="flex flex-wrap gap-1.5 sm:gap-2">
                              <button onclick="setOrderFilter('ordered')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'ordered' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üìã Ch·ªù nh·∫≠n (${counts.ordered})
                              </button>
                              <button onclick="setOrderFilter('preparing')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'preparing' ? 'bg-yellow-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üë®‚Äçüç≥ ƒêang l√†m (${counts.preparing})
                              </button>
                              <button onclick="setOrderFilter('completed')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'completed' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  ‚úÖ Ho√†n th√†nh (${counts.completed})
                              </button>
                              <button onclick="setOrderFilter('cancelled')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'cancelled' ? 'bg-red-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  ‚ùå ƒê√£ h·ªßy (${counts.cancelled})
                              </button>
                              <button onclick="setOrderFilter('all')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üìÇ T·∫•t c·∫£ (${dateFilteredOrders.length})
                              </button>
                              <button onclick="setOrderFilter('deleted')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'deleted' ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üóëÔ∏è Th√πng r√°c (${counts.deleted || 0})
                              </button>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Orders List -->
                  <div class="space-y-3 sm:space-y-4">
                      ${paginatedOrders.length === 0 ? `
                          <p class="text-center text-gray-500 py-8 sm:py-12">
                              <i data-lucide="inbox" class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 opacity-50"></i>
                              <br><span class="text-sm sm:text-base">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</span>
                          </p>
                      ` : paginatedOrders.map(order => `
                          <div class="bg-white p-3 sm:p-4 rounded-lg border-2 ${
                              order.status === 'deleted' ? 'border-gray-300 bg-gray-100' :
                              order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                              order.status === 'completed' ? 'border-green-200 bg-green-50' :
                              order.status === 'preparing' ? 'border-yellow-200 bg-yellow-50' :
                              'border-blue-200 bg-blue-50'
                          }">
                              <div class="flex justify-between items-start gap-2 sm:gap-3 mb-2 sm:mb-3">
                                  <div class="flex-1 min-w-0">
                                      <h4 class="font-semibold text-purple-800 flex flex-wrap items-center gap-1.5 sm:gap-2 mb-1">
                                          <span class="text-xs sm:text-sm md:text-base">Order #${order.id.slice(-6).toUpperCase()}</span>
                                          ${order.tableNumber ? `<span class="px-1.5 py-0.5 sm:px-2 bg-teal-100 text-teal-700 text-[10px] sm:text-xs rounded-full whitespace-nowrap">üçΩÔ∏è B√†n ${order.tableNumber}</span>` : ''}
                                      </h4>
                                      <p class="text-[11px] sm:text-xs md:text-sm text-gray-600 mb-0.5 sm:mb-1">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                      <p class="text-[10px] sm:text-xs text-gray-500 truncate">Kh√°ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                                  </div>
                                  <div class="flex flex-col items-end gap-1.5 sm:gap-2 flex-shrink-0">
                                      <span class="px-2 sm:px-3 py-1 rounded-full text-[11px] sm:text-xs md:text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                          ${getStatusText(order.status)}
                                      </span>
                                      <div class="flex flex-wrap items-center gap-1.5 sm:gap-2 justify-end">
                                        ${order.status === 'ordered' ? `
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-red-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚ùå H·ªßy
                                          </button>
                                          <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-green-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚úÖ Nh·∫≠n ƒë∆°n
                                          </button>
                                        ` : order.status === 'preparing' ? `
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-red-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚ùå H·ªßy
                                          </button>
                                          <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-blue-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚úÖ Ho√†n th√†nh
                                          </button>
                                        ` : order.status === 'deleted' ? `
                                          <button onclick="restoreOrder('${order.id}')" class="bg-green-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-green-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚ôªÔ∏è Kh√¥i ph·ª•c
                                          </button>
                                          <button onclick="permanentDeleteOrder('${order.id}')" class="bg-red-600 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-red-700 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              ‚ö†Ô∏è X√≥a vƒ©nh vi·ªÖn
                                          </button>
                                        ` : (order.status === 'completed' || order.status === 'cancelled') ? `
                                          <button onclick="deleteOrder('${order.id}')" class="bg-gray-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-gray-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition">
                                              üóëÔ∏è X√≥a
                                          </button>
                                        ` : ''}
                                      </div>
                                  </div>
                              </div>

                              ${order.status === 'cancelled' && order.cancelReason && order.cancelReason.trim() ? `
                                  <div class="mb-2 sm:mb-3 p-2 sm:p-3 bg-red-50 border border-red-200 rounded-lg">
                                      <div class="flex items-start gap-1.5 sm:gap-2">
                                          <i data-lucide="info" class="w-3 h-3 sm:w-4 sm:h-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                                          <div class="flex-1 min-w-0">
                                              <p class="text-[11px] sm:text-xs font-medium text-red-800 mb-0.5 sm:mb-1">L√Ω do h·ªßy:</p>
                                              <p class="text-[10px] sm:text-xs text-red-700">${order.cancelReason}</p>
                                              ${order.cancelledAt ? `<p class="text-[9px] sm:text-[10px] text-red-600 mt-0.5 sm:mt-1">H·ªßy l√∫c: ${new Date(order.cancelledAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                                          </div>
                                      </div>
                                  </div>
                              ` : ''}
                              
                              ${order.status === 'deleted' ? `
                                  <div class="mb-2 sm:mb-3 p-2 sm:p-3 bg-gray-100 border border-gray-300 rounded-lg">
                                      <div class="flex items-start gap-1.5 sm:gap-2">
                                          <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4 text-gray-600 mt-0.5 flex-shrink-0"></i>
                                          <div class="flex-1 min-w-0">
                                              <p class="text-[11px] sm:text-xs font-medium text-gray-800 mb-0.5 sm:mb-1">üóëÔ∏è ƒê∆°n h√†ng ƒë√£ x√≥a</p>
                                              ${order.previousStatus ? `<p class="text-[10px] sm:text-xs text-gray-700">Tr·∫°ng th√°i tr∆∞·ªõc: ${getStatusText(order.previousStatus)}</p>` : ''}
                                              ${order.deletedAt ? `<p class="text-[9px] sm:text-[10px] text-gray-600 mt-0.5 sm:mt-1">X√≥a l√∫c: ${new Date(order.deletedAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                                          </div>
                                      </div>
                                  </div>
                              ` : ''}

                              <div class="space-y-1.5 sm:space-y-2 mb-2 sm:mb-3">
                                  ${order.items.map((item, itemIndex) => {
                                      const hasDetails = item.selectedDetails && Object.keys(item.selectedDetails).length > 0;
                                      let detailsHtml = '';
                                      
                                      if (hasDetails) {
                                          const details = item.selectedDetails;
                                          const detailsParts = [];
                                          
                                          if (details.size) detailsParts.push(`Size: ${details.size}`);
                                          if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                          if (details.ice !== undefined) detailsParts.push(`ƒê√°: ${details.ice}%`);
                                          if (details.sugar !== undefined) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}%`);
                                          if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                          if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                          if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                          
                                          if (detailsParts.length > 0) {
                                              detailsHtml = `<div class="text-[9px] sm:text-[10px] text-gray-600 mt-0.5">${detailsParts.join(' ‚Ä¢ ')}</div>`;
                                          }
                                      }
                                      
                                      return `
                                          <div class="bg-white p-1.5 sm:p-2 rounded">
                                              <div class="flex justify-between items-start">
                                                  <div class="flex-1 min-w-0">
                                                      <div class="flex items-center gap-1">
                                                          <span class="font-medium text-xs sm:text-sm md:text-base">${item.name}</span>
                                                          ${item.size ? `<span class="text-[10px] sm:text-xs text-blue-600">(${item.size})</span>` : ''}
                                                          <span class="text-[10px] sm:text-xs text-gray-600">x${item.quantity}</span>
                                                          ${hasDetails && order.status === 'preparing' ? `
                                                              <button onclick="editOrderItemDetails('${order.id}', ${itemIndex})" class="text-xs text-blue-600 hover:text-blue-800 ml-1" title="Ch·ªânh s·ª≠a chi ti·∫øt">
                                                                  <i data-lucide="edit-2" class="w-2.5 h-2.5 sm:w-3 sm:h-3"></i>
                                                              </button>
                                                          ` : ''}
                                                      </div>
                                                      ${detailsHtml}
                                                  </div>
                                                  <div class="flex items-center gap-1 sm:gap-2 ml-2">
                                                      <span class="text-[11px] sm:text-xs md:text-sm font-semibold text-orange-600 whitespace-nowrap">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                                      ${order.status === 'preparing' ? `
                                                          <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-0.5 sm:p-1 active:scale-95 transition" title="X√≥a m√≥n">
                                                              <i data-lucide="x" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                          </button>
                                                      ` : ''}
                                                  </div>
                                              </div>
                                          </div>
                                      `;
                                  }).join('')}
                              </div>

                              ${order.status === 'preparing' ? `
                                  <div class="border-t pt-2 sm:pt-3 mb-2 sm:mb-3">
                                      <p class="text-[10px] sm:text-xs text-gray-600 mb-1.5 sm:mb-2 font-medium">üõ† Ch·ªânh s·ª≠a ƒë∆°n h√†ng:</p>
                                      <div class="flex gap-1.5 sm:gap-2">
                                          <select id="add-item-${order.id}" class="flex-1 text-[11px] sm:text-xs md:text-sm border rounded px-2 py-1.5 sm:py-2">
                                              <option value="">Ch·ªçn m√≥n th√™m...</option>
                                              ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                                  <option value="${item.id}">${item.name} - ${formatCurrency(getItemPrice(item))}</option>
                                              `).join('')}
                                          </select>
                                          <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-2 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-green-600 text-[11px] sm:text-xs md:text-sm active:scale-95 transition">
                                              <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                          </button>
                                      </div>
                                      <div class="flex gap-1.5 sm:gap-2 mt-2">
                                          <button onclick="updateOrder('${order.id}')" class="flex-1 bg-blue-600 text-white px-3 py-1.5 sm:py-2 rounded hover:bg-blue-700 text-[11px] sm:text-xs md:text-sm font-medium active:scale-95 transition">
                                              <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1"></i>
                                              C·∫≠p Nh·∫≠t ƒê∆°n H√†ng
                                          </button>
                                      </div>
                                  </div>
                              ` : ''}

                              <div class="pt-1.5 sm:pt-2 border-t">
                                  <span class="font-bold text-sm sm:text-base md:text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                              </div>
                          </div>
                      `).join('')}

                      <!-- Pagination Controls -->
                      ${totalPages > 1 ? `
                          <div class="bg-white p-3 sm:p-4 rounded-lg border border-gray-200 mt-4 sm:mt-6">
                              <div class="flex flex-col gap-3 sm:gap-4">
                                  <!-- Items per page selector -->
                                  <div class="flex items-center justify-center sm:justify-start gap-1.5 sm:gap-2">
                                      <label class="text-xs sm:text-sm text-gray-600">Hi·ªÉn th·ªã:</label>
                                      <select onchange="setItemsPerPage(this.value)" class="px-2 sm:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm">
                                          <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5</option>
                                          <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                          <option value="20" ${itemsPerPage === 20 ? 'selected' : ''}>20</option>
                                          <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                      </select>
                                      <span class="text-xs sm:text-sm text-gray-600">ƒë∆°n/trang</span>
                                  </div>

                                  <!-- Pagination info -->
                                  <div class="text-xs sm:text-sm text-gray-600 text-center">
                                      Hi·ªÉn th·ªã ${totalItems > 0 ? startIndex + 1 : 0}-${Math.min(endIndex, totalItems)} c·ªßa ${totalItems} ƒë∆°n
                                  </div>

                                  <!-- Page navigation -->
                                  <div class="flex items-center justify-center gap-1 sm:gap-2">
                                      <button onclick="setPage(1)" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                      <button onclick="prevPage()" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevron-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>

                                      <span class="px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-blue-50 border border-blue-200 rounded whitespace-nowrap">
                                          ${currentPage} / ${totalPages}
                                      </span>

                                      <button onclick="nextPage()" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevron-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                      <button onclick="setPage(${totalPages})" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                  </div>
                              </div>
                          </div>
                      ` : ''}
                  </div>
              `;

              console.log('üé® HTML updated in container');

              // Set default values for date inputs based on current filter
              setTimeout(() => {
                  const fromInput = document.getElementById('date-from');
                  const toInput = document.getElementById('date-to');

                  if (fromInput && dateFrom) {
                      fromInput.value = dateFrom.toISOString().slice(0, 16);
                  }

                  if (toInput && dateTo) {
                      toInput.value = dateTo.toISOString().slice(0, 16);
                  }
              }, 100);

              renderLucideIcons();
              console.log('‚ú® Render complete!');
          }

          async function loadOrders() {
              try {
                  console.log("Loading orders...");
                  const querySnapshot = await getDocs(collection(db, 'orders'));
                  orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log("Loaded orders:", orders.length);
                  // Debug: check if cancelled orders have cancelReason
                  orders.filter(o => o.status === 'cancelled').forEach(order => {
                      console.log(`Order ${order.id.slice(-6)} cancelled reason:`, order.cancelReason);
                  });
                  renderOrdersList();

              } catch (error) {
                  console.error("Error loading orders:", error);
                  showMessage("L·ªói t·∫£i ƒë∆°n h√†ng: " + error.message, "error");
              }
          }

          function renderOrdersList() {
              const ordersList = document.getElementById('orders-list');
              const orderCount = document.getElementById('order-count');

              if (!ordersList || !orderCount) return;

              orderCount.textContent = orders.length;

              if (orders.length === 0) {
                  ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                  return;
              }

              // Sort orders by createdAt (newest first)
              const sortedOrders = [...orders].sort((a, b) => {
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  return timeB - timeA;
              });

              ordersList.innerHTML = sortedOrders.map(order => `
                  <div class="bg-white p-4 rounded-lg border-2 ${
                      order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                      order.status === 'completed' ? 'border-green-200 bg-green-50' :
                      order.status === 'updated' ? 'border-yellow-200 bg-yellow-50' :
                      'border-purple-200'
                  }">
                      <div class="flex justify-between items-start mb-3">
                          <div>
                              <h4 class="font-semibold text-purple-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                              <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                              <p class="text-xs text-gray-500">Kh√°ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                          </div>
                          <div class="flex items-center gap-2">
                              ${order.status === 'ordered' ? `
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium">
                                      ‚ùå H·ªßy
                                  </button>
                                  <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600 text-sm font-medium ml-2">
                                      ‚úÖ Nh·∫≠n ƒë∆°n
                                  </button>
                              ` : order.status === 'preparing' ? `
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium">
                                      ‚ùå H·ªßy
                                  </button>
                                  <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600 text-sm font-medium ml-2">
                                      ‚úÖ Ho√†n th√†nh
                                  </button>
                              ` : order.status === 'completed' || order.status === 'cancelled' ? `
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              ` : ''}
                          </div>
                      </div>

                      ${order.status === 'cancelled' && order.cancelReason && order.cancelReason.trim() ? `
                          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                              <div class="flex items-start gap-2">
                                  <i data-lucide="info" class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                                  <div>
                                      <p class="text-sm font-medium text-red-800 mb-1">L√Ω do h·ªßy ƒë∆°n h√†ng:</p>
                                      <p class="text-sm text-red-700">${order.cancelReason}</p>
                                      ${order.cancelledAt ? `<p class="text-xs text-red-600 mt-1">Th·ªùi gian h·ªßy: ${new Date(order.cancelledAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                                  </div>
                              </div>
                          </div>
                      ` : ''}

                      <div class="space-y-2 mb-3">
                          ${order.items.map(item => {
                              const hasDetails = item.selectedDetails && Object.keys(item.selectedDetails).length > 0;
                              let detailsHtml = '';
                              
                              if (hasDetails) {
                                  const details = item.selectedDetails;
                                  const detailsParts = [];
                                  
                                  if (details.size) detailsParts.push(`Size: ${details.size}`);
                                  if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                  if (details.ice !== undefined) detailsParts.push(`ƒê√°: ${details.ice}%`);
                                  if (details.sugar !== undefined) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}%`);
                                  if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                  if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                  if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                  
                                  if (detailsParts.length > 0) {
                                      detailsHtml = `<div class="text-xs text-gray-600 mt-1">${detailsParts.join(' ‚Ä¢ ')}</div>`;
                                  }
                              }
                              
                              return `
                                  <div class="bg-gray-50 p-2 rounded">
                                      <div class="flex justify-between items-center">
                                          <div class="flex-1">
                                              <span class="font-medium">${item.name}</span>
                                              ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                              <span class="text-sm text-gray-600">x${item.quantity}</span>
                                          </div>
                                          <div class="flex items-center gap-2">
                                              <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                              ${order.status === 'preparing' ? `
                                                  <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-1" title="X√≥a m√≥n">
                                                      <i data-lucide="x" class="w-4 h-4"></i>
                                                  </button>
                                              ` : ''}
                                          </div>
                                      </div>
                                      ${detailsHtml}
                                  </div>
                              `;
                          }).join('')}
                      </div>

                      ${order.status === 'preparing' ? `
                          <div class="border-t pt-3 mb-3">
                              <p class="text-xs text-gray-600 mb-2 font-medium">üõ† Ch·ªânh s·ª≠a ƒë∆°n h√†ng:</p>
                              <div class="flex gap-2">
                                  <select id="add-item-${order.id}" class="flex-1 text-sm border rounded px-2 py-1">
                                      <option value="">Ch·ªçn m√≥n th√™m...</option>
                                      ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                          <option value="${item.id}">${item.name} - ${formatCurrency(item.price)}</option>
                                      `).join('')}
                                  </select>
                                  <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                      <i data-lucide="plus" class="w-4 h-4"></i>
                                  </button>
                              </div>
                          </div>
                      ` : ''}

                      <div class="flex justify-between items-center pt-2 border-t">
                          <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                          <span class="text-sm px-3 py-1 rounded-full ${getStatusBadgeClass(order.status)}">
                              ${getStatusText(order.status)}
                          </span>
                      </div>
                  </div>
              `).join('');

              renderLucideIcons();
          }

          function getStatusText(status) {
              const statusMap = {
                  'ordered': 'üìã Ch·ªù nh·∫≠n',
                  'preparing': 'üë®‚Äçüç≥ ƒêang l√†m',
                  'completed': '‚úÖ Ho√†n th√†nh',
                  'cancelled': '‚ùå ƒê√£ h·ªßy',
                  'deleted': 'üóëÔ∏è ƒê√£ x√≥a',
                  'updated': 'üîÑ ƒê√£ c·∫≠p nh·∫≠t'
              };
              return statusMap[status] || status;
          }

          function getStatusBadgeClass(status) {
              const classMap = {
                  'ordered': 'bg-blue-100 text-blue-800',
                  'preparing': 'bg-yellow-100 text-yellow-800',
                  'completed': 'bg-green-200 text-green-900',
                  'cancelled': 'bg-red-100 text-red-800',
                  'deleted': 'bg-gray-200 text-gray-700',
                  'updated': 'bg-orange-100 text-orange-800'
              };
              return classMap[status] || 'bg-gray-100 text-gray-800';
          }

          // Nh·∫≠n ƒë∆°n h√†ng
          async function acceptOrder(orderId) {
              if (!confirm("X√°c nh·∫≠n nh·∫≠n ƒë∆°n h√†ng n√†y?")) return; // Add confirm check

              try {
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'preparing',
                      acceptedAt: new Date(),
                      updatedAt: new Date()
                  });

                  // Set as currently processing order
                  processingOrderId = orderId;
                  localStorage.setItem('processingOrderId', orderId);
                  currentOrderFilter = 'preparing'; // Chuy·ªÉn sang tab ƒëang l√†m
                  renderOrdersManagementList(); // Update UI immediately

                  showMessage(`‚úÖ ƒê√£ nh·∫≠n ƒë∆°n #${orderId.slice(-6).toUpperCase()}`, "success");

              } catch (error) {
                  console.error("Error accepting order:", error);
                  showMessage("L·ªói nh·∫≠n ƒë∆°n: " + error.message, "error");
              }
          }

          // H·ªßy ƒë∆°n h√†ng
          async function cancelOrder(orderId) {
              openCancelModal(orderId);
          }

          // Ho√†n th√†nh ƒë∆°n h√†ng v√† l∆∞u th·ªëng k√™
          async function completeOrder(orderId) {
              if (!confirm("X√°c nh·∫≠n HO√ÄN TH√ÄNH ƒë∆°n h√†ng n√†y?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const completedAt = new Date();
                  
                  // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i order
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'completed',
                      completedAt: completedAt,
                      updatedAt: completedAt
                  });

                  // Clear processing state
                  if (processingOrderId === orderId) {
                      processingOrderId = null;
                      localStorage.removeItem('processingOrderId');
                      
                      // Check for pending orders to switch back
                      const hasPendingOrders = orders.some(o => o.status === 'ordered');
                      if (hasPendingOrders && currentOrderFilter !== 'ordered') {
                          currentOrderFilter = 'ordered';
                      }
                      renderOrdersManagementList();
                  }

                  // 2. L∆∞u th·ªëng k√™ doanh thu
                  const year = completedAt.getFullYear();
                  const month = completedAt.getMonth() + 1; // 1-12
                  const statsId = `${year}-${month.toString().padStart(2, '0')}`;

                  const statsRef = doc(db, 'statistics', statsId);
                  
                  try {
                      // Ki·ªÉm tra xem th√°ng n√†y ƒë√£ c√≥ ch∆∞a
                      const statsDoc = await getDoc(statsRef);
                      
                      if (statsDoc.exists()) {
                          // C·ªông d·ªìn v√†o th√°ng hi·ªán t·∫°i
                          const currentData = statsDoc.data();
                          await updateDoc(statsRef, {
                              totalRevenue: (currentData.totalRevenue || 0) + order.total,
                              orderCount: (currentData.orderCount || 0) + 1,
                              updatedAt: completedAt
                          });
                      } else {
                          // T·∫°o m·ªõi cho th√°ng n√†y
                          await setDoc(statsRef, {
                              year: year,
                              month: month,
                              totalRevenue: order.total,
                              orderCount: 1,
                              createdAt: completedAt,
                              updatedAt: completedAt
                          });
                      }
                  } catch (statsError) {
                      console.error("Error updating statistics:", statsError);
                      // V·∫´n ti·∫øp t·ª•c ho√†n th√†nh ƒë∆°n d√π l∆∞u th·ªëng k√™ l·ªói
                  }

                  showMessage(`‚úÖ Ho√†n th√†nh ƒë∆°n #${orderId.slice(-6).toUpperCase()} - ${formatCurrency(order.total)}`, "success");

              } catch (error) {
                  console.error("Error completing order:", error);
                  showMessage("L·ªói ho√†n th√†nh ƒë∆°n: " + error.message, "error");
              }
          }

          // X√≥a ƒë∆°n h√†ng (chuy·ªÉn v√†o th√πng r√°c)
          window.deleteOrder = async function(orderId) {
              if (!confirm("X√≥a ƒë∆°n h√†ng n√†y v√†o th√πng r√°c?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ kh√¥i ph·ª•c
                  await updateDoc(doc(db, 'orders', orderId), {
                      previousStatus: order.status,
                      status: 'deleted',
                      deletedAt: new Date(),
                      updatedAt: new Date()
                  });

                  showMessage(`üóëÔ∏è ƒê√£ chuy·ªÉn ƒë∆°n #${orderId.slice(-6).toUpperCase()} v√†o th√πng r√°c`, "success");
                  
                  // Re-render based on current view
                  if (currentView === 'admin-orders') {
                      renderOrdersManagementList();
                  } else if (currentView === 'admin-trash') {
                      renderApp();
                  }

              } catch (error) {
                  console.error("Error deleting order:", error);
                  showMessage("L·ªói x√≥a ƒë∆°n: " + error.message, "error");
              }
          }

          // Kh√¥i ph·ª•c ƒë∆°n h√†ng t·ª´ th√πng r√°c
          window.restoreOrder = async function(orderId) {
              if (!confirm("Kh√¥i ph·ª•c ƒë∆°n h√†ng n√†y?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  // Kh√¥i ph·ª•c v·ªÅ tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ (m·∫∑c ƒë·ªãnh l√† completed)
                  const previousStatus = order.previousStatus || 'completed';
                  
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: previousStatus,
                      restoredAt: new Date(),
                      updatedAt: new Date()
                  });

                  showMessage(`‚ôªÔ∏è ƒê√£ kh√¥i ph·ª•c ƒë∆°n #${orderId.slice(-6).toUpperCase()}`, "success");
                  
                  // Re-render based on current view
                  if (currentView === 'admin-orders') {
                      renderOrdersManagementList();
                  } else if (currentView === 'admin-trash') {
                      renderApp();
                  }

              } catch (error) {
                  console.error("Error restoring order:", error);
                  showMessage("L·ªói kh√¥i ph·ª•c ƒë∆°n: " + error.message, "error");
              }
          }

          // X√≥a vƒ©nh vi·ªÖn ƒë∆°n h√†ng
          window.permanentDeleteOrder = async function(orderId) {
              if (!confirm("‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN ƒë∆°n h√†ng n√†y? H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!")) return;
              if (!confirm("B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën x√≥a vƒ©nh vi·ªÖn?")) return;

              try {
                  await deleteDoc(doc(db, 'orders', orderId));

                  showMessage(`üóëÔ∏è ƒê√£ x√≥a vƒ©nh vi·ªÖn ƒë∆°n #${orderId.slice(-6).toUpperCase()}`, "success");
                  
                  // Re-render based on current view
                  if (currentView === 'admin-orders') {
                      renderOrdersManagementList();
                  } else if (currentView === 'admin-trash') {
                      renderApp();
                  }

              } catch (error) {
                  console.error("Error permanently deleting order:", error);
                  showMessage("L·ªói x√≥a vƒ©nh vi·ªÖn: " + error.message, "error");
              }
          }

          // Bi·∫øn ƒë·ªÉ l∆∞u orderId khi admin ƒëang th√™m m√≥n v√†o order
          let currentAdminAddingOrderId = null;

          async function addItemToOrder(orderId) {
              const selectElement = document.getElementById(`add-item-${orderId}`);
              const itemId = selectElement.value;

              if (!itemId) {
                  showMessage("Vui l√≤ng ch·ªçn m√≥n!", "warning");
                  return;
              }

              try {
                  const order = orders.find(o => o.id === orderId);
                  const menuItem = menuItems.find(item => item.id === itemId);

                  if (!order || !menuItem) return;

                  // N·∫øu m√≥n c√≥ details, m·ªü modal ch·ªçn details
                  if (menuItem.itemType !== 'simple' && menuItem.details) {
                      currentAdminAddingOrderId = orderId;
                      // L∆∞u itemId ƒë·ªÉ sau khi ch·ªçn details s·∫Ω th√™m v√†o order
                      window.adminAddingItemId = itemId;
                      // Reset select
                      selectElement.value = '';
                      // M·ªü modal ch·ªçn details
                      openCustomerItemDetailsModal(menuItem);
                      return;
                  }

                  // N·∫øu m√≥n kh√¥ng c√≥ details, th√™m tr·ª±c ti·∫øp
                  addItemToOrderDirectly(orderId, menuItem, null);

              } catch (error) {
                  console.error("Error adding item to order:", error);
                  showMessage("L·ªói th√™m m√≥n: " + error.message, "error");
              }
          }

          // Th√™m m√≥n v√†o order tr·ª±c ti·∫øp (kh√¥ng qua modal)
          function addItemToOrderDirectly(orderId, menuItem, selectedDetails) {
              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const itemPrice = selectedDetails ? calculateItemPrice(menuItem, selectedDetails) : getItemPrice(menuItem);

                  // Check if item already exists in order with same details
                  const existingItem = order.items.find(item => {
                      if (item.id !== menuItem.id) return false;
                      return areDetailsEqual(item.selectedDetails, selectedDetails);
                  });

                  if (existingItem) {
                      existingItem.quantity += 1;
                  } else {
                      const newItem = {
                          id: menuItem.id,
                          name: menuItem.name,
                          price: itemPrice,
                          basePrice: menuItem.price,
                          quantity: 1,
                          size: menuItem.size || null,
                          category: menuItem.category
                      };
                      
                      // Th√™m selectedDetails n·∫øu c√≥
                      if (selectedDetails) {
                          newItem.selectedDetails = selectedDetails;
                      }
                      
                      order.items.push(newItem);
                  }

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                  // Mark order as having pending changes
                  order.hasPendingChanges = true;

                  showMessage(`üìù ƒê√£ th√™m ${menuItem.name} (ch∆∞a l∆∞u)`, "info");

                  // Re-render to show updated order
                  renderOrdersManagementList();

              } catch (error) {
                  console.error("Error adding item to order directly:", error);
                  showMessage("L·ªói th√™m m√≥n: " + error.message, "error");
              }
          }

          async function removeItemFromOrder(orderId, itemId) {
              if (!confirm("X√≥a m√≥n n√†y kh·ªèi ƒë∆°n h√†ng?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const removedItem = order.items.find(item => item.id === itemId);

                  // Remove item
                  order.items = order.items.filter(item => item.id !== itemId);

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                  // Mark order as having pending changes
                  order.hasPendingChanges = true;

                  // If no items left, this will be handled when updating
                  if (order.items.length === 0) {
                      showMessage(`üóëÔ∏è ƒê√£ x√≥a ${removedItem?.name || 'm√≥n'} (ƒë∆°n s·∫Ω b·ªã h·ªßy khi c·∫≠p nh·∫≠t)`, "warning");
                  } else {
                      showMessage(`üóëÔ∏è ƒê√£ x√≥a ${removedItem?.name || 'm√≥n'} (ch∆∞a l∆∞u)`, "info");
                  }

                  // Re-render to show updated order
                  renderOrdersManagementList();

              } catch (error) {
                  console.error("Error removing item from order:", error);
                  showMessage("L·ªói x√≥a m√≥n: " + error.message, "error");
              }
          }

          // Edit details c·ªßa item trong order
          let currentEditingOrderId = null;
          let currentEditingItemIndex = null;
          
          function editOrderItemDetails(orderId, itemIndex) {
              const order = orders.find(o => o.id === orderId);
              if (!order || !order.items[itemIndex]) return;
              
              currentEditingOrderId = orderId;
              currentEditingItemIndex = itemIndex;
              
              const orderItem = order.items[itemIndex];
              
              // T√¨m menu item ƒë·ªÉ l·∫•y details configuration
              const menuItem = menuItems.find(m => m.id === orderItem.id);
              if (!menuItem || !menuItem.details) {
                  showMessage("M√≥n n√†y kh√¥ng c√≥ chi ti·∫øt ƒë·ªÉ ch·ªânh s·ª≠a", 'info');
                  return;
              }
              
              // M·ªü modal v·ªõi details hi·ªán t·∫°i
              openOrderItemDetailsModalForEdit(orderItem, menuItem);
          }
          
          // Expose to global scope
          window.editOrderItemDetails = editOrderItemDetails;

          function openOrderItemDetailsModalForEdit(orderItem, menuItem) {
              currentSelectingItem = menuItem;
              const currentDetails = orderItem.selectedDetails || {};
              
              const modal = document.getElementById('customer-item-details-modal');
              if (!modal) return;
              
              // Render n·ªôi dung modal (gi·ªëng nh∆∞ openCustomerItemDetailsModal nh∆∞ng v·ªõi gi√° tr·ªã hi·ªán t·∫°i)
              const detailsContent = document.getElementById('customer-item-details-content');
              const details = menuItem.details || {};
              
              const itemBasePrice = getItemPrice(menuItem); // L·∫•y gi√° m·ªõi nh·∫•t (newPrice n·∫øu c√≥, kh√¥ng th√¨ price)
              
              let html = `
                  <div class="mb-3 sm:mb-4">
                      <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-1.5 sm:mb-2">${menuItem.name}</h4>
                      <p class="text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-2">${menuItem.description || ''}</p>
                      <p class="text-sm sm:text-base font-semibold text-teal-600">Gi√° g·ªëc: ${itemBasePrice.toLocaleString()}ƒë</p>
                  </div>
              `;
              
              // Sizes - ch·ªâ hi·ªÉn th·ªã size c√≥ enabled = true
              if (details.sizes && details.sizes.length > 0) {
                  const enabledSizes = details.sizes.filter(s => s.enabled);
                  if (enabledSizes.length > 0) {
                      html += `
                          <div class="mb-3 sm:mb-4">
                              <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Size</label>
                              <div class="space-y-1.5 sm:space-y-2">
                                  ${enabledSizes.map((size) => {
                                      const priceAdd = size.priceAdd || size.price || 0;
                                      // N·∫øu priceAdd = 0 th√¨ d√πng gi√° m√≥n m·ªõi nh·∫•t, n·∫øu kh√¥ng th√¨ d√πng priceAdd
                                      const displayPrice = priceAdd > 0 ? priceAdd : itemBasePrice;
                                      return `
                                          <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                              <div class="flex items-center">
                                                  <input type="radio" name="customer-size" value="${size.name}" ${currentDetails.size === size.name ? 'checked' : ''} 
                                                      onchange="updateCustomerItemPrice()" 
                                                      class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                                  <span>${size.name}</span>
                                              </div>
                                              <span class="text-teal-600 text-xs sm:text-sm font-medium">${displayPrice.toLocaleString()}ƒë</span>
                                          </label>
                                      `;
                                  }).join('')}
                              </div>
                          </div>
                      `;
                  }
              }
              
              // Toppings
              if (details.toppings && details.toppings.length > 0) {
                  html += `
                      <div class="mb-3 sm:mb-4">
                          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Topping (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                          <div class="space-y-1.5 sm:space-y-2">
                              ${details.toppings.map(topping => {
                                  const isChecked = currentDetails.toppings && currentDetails.toppings.includes(topping.name);
                                  return `
                                      <label class="flex items-center justify-between p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm sm:text-base">
                                          <div class="flex items-center">
                                              <input type="checkbox" name="customer-topping" value="${topping.name}" ${isChecked ? 'checked' : ''}
                                                  onchange="updateCustomerItemPrice()" 
                                                  class="mr-1.5 sm:mr-2 w-4 h-4 sm:w-5 sm:h-5">
                                              <span>${topping.name}</span>
                                          </div>
                                          <span class="text-teal-600 text-xs sm:text-sm font-medium">+${topping.price?.toLocaleString() || 0}ƒë</span>
                                      </label>
                                  `;
                              }).join('')}
                          </div>
                      </div>
                  `;
              }
              
              // Ice/Sugar level - radio buttons vu√¥ng
              if (details.iceOptions && details.iceOptions.length > 0) {
                  // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                  const sortedIceOptions = [...details.iceOptions].sort((a, b) => b - a);
                  const defaultIce = sortedIceOptions.includes(100) ? 100 : sortedIceOptions[0];
                  const currentIce = currentDetails.ice !== undefined ? currentDetails.ice : defaultIce;
                  
                  html += `
                      <div class="mb-3 sm:mb-4">
                          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üßä ƒê√° (%)</label>
                          <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                              ${sortedIceOptions.map((opt) => `
                                  <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                      <input type="radio" name="customer-ice" value="${opt}" ${currentIce === opt ? 'checked' : ''} 
                                          onchange="updateCustomerItemPrice()" 
                                          class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                      <span class="text-xs sm:text-sm">${opt}%</span>
                                  </label>
                              `).join('')}
                          </div>
                      </div>
                  `;
              }
              
              if (details.sugarOptions && details.sugarOptions.length > 0) {
                  // S·∫Øp x·∫øp gi·∫£m d·∫ßn v√† ∆∞u ti√™n 100%
                  const sortedSugarOptions = [...details.sugarOptions].sort((a, b) => b - a);
                  const defaultSugar = sortedSugarOptions.includes(100) ? 100 : sortedSugarOptions[0];
                  const currentSugar = currentDetails.sugar !== undefined ? currentDetails.sugar : defaultSugar;
                  
                  html += `
                      <div class="mb-3 sm:mb-4">
                          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">üçØ ƒê∆∞·ªùng (%)</label>
                          <div class="grid grid-cols-3 sm:grid-cols-5 gap-1.5 sm:gap-2">
                              ${sortedSugarOptions.map((opt) => `
                                  <label class="flex items-center justify-center p-1.5 sm:p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                      <input type="radio" name="customer-sugar" value="${opt}" ${currentSugar === opt ? 'checked' : ''} 
                                          onchange="updateCustomerItemPrice()" 
                                          class="mr-1 sm:mr-2 w-3 h-3 sm:w-4 sm:h-4">
                                      <span class="text-xs sm:text-sm">${opt}%</span>
                                  </label>
                              `).join('')}
                          </div>
                      </div>
                  `;
              }
              
              // Spice level
              if (details.spiceLevels && details.spiceLevels.length > 0) {
                  html += `
                      <div class="mb-3 sm:mb-4">
                          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">ƒê·ªô cay</label>
                          <select name="customer-spice" onchange="updateCustomerItemPrice()" 
                              class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                              ${details.spiceLevels.map((opt) => `
                                  <option value="${opt}" ${currentDetails.spice === opt ? 'selected' : ''}>${opt}</option>
                              `).join('')}
                          </select>
                      </div>
                  `;
              }
              
              // Noodle type
              if (details.noodleTypes && details.noodleTypes.length > 0) {
                  html += `
                      <div class="mb-3 sm:mb-4">
                          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Lo·∫°i s·ª£i</label>
                          <select name="customer-noodle" onchange="updateCustomerItemPrice()" 
                              class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base">
                              ${details.noodleTypes.map((opt) => `
                                  <option value="${opt}" ${currentDetails.noodle === opt ? 'selected' : ''}>${opt}</option>
                              `).join('')}
                          </select>
                      </div>
                  `;
              }
              
              // Special requests
              html += `
                  <div class="mb-3 sm:mb-4">
                      <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Ghi ch√∫ ƒë·∫∑c bi·ªát</label>
                      <textarea name="customer-notes" rows="2" 
                          class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border rounded text-sm sm:text-base" 
                          placeholder="V√≠ d·ª•: √çt ƒë√°, kh√¥ng h√†nh...">${currentDetails.notes || ''}</textarea>
                  </div>
              `;
              
              // Final price display
              html += `
                  <div class="mb-3 sm:mb-4 p-2 sm:p-3 bg-teal-50 rounded">
                      <div class="flex justify-between items-center">
                          <span class="text-sm sm:text-base font-medium text-gray-700">T·ªïng c·ªông:</span>
                          <span id="customer-item-final-price" class="text-lg sm:text-xl font-bold text-teal-600">${(orderItem.price || menuItem.price)?.toLocaleString() || 0}ƒë</span>
                      </div>
                  </div>
              `;
              
              detailsContent.innerHTML = html;
              
              // Set mode = 'edit' (c·∫≠p nh·∫≠t trong order)
              modalMode = 'edit';
              updateModalButtonText();
              
              // Hi·ªÉn th·ªã modal
              modal.classList.remove('hidden');
              
              // T√≠nh gi√° ban ƒë·∫ßu
              updateCustomerItemPrice();
          }

          async function updateOrder(orderId) {
              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  // If no items left, cancel the order
                  if (order.items.length === 0) {
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: 0,
                          status: 'cancelled',
                          cancelReason: 'ƒê∆°n h√†ng tr·ªëng sau khi ch·ªânh s·ª≠a',
                          cancelledBy: 'admin',
                          cancelledAt: new Date(),
                          updatedAt: new Date(),
                          updatedBy: 'admin'
                      });

                      // Remove pending changes flag
                      order.hasPendingChanges = false;

                      showMessage("‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy (kh√¥ng c√≤n m√≥n)", "warning");
                  } else {
                      // Update in Firestore with all changes
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: order.total,
                          updatedAt: new Date(),
                          updatedBy: 'admin'
                      });

                      // Remove pending changes flag
                      order.hasPendingChanges = false;

                      showMessage("‚úÖ C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!", "success");
                  }

                  // Re-render to reflect changes
                  renderOrdersManagementList();

                  // Trigger real-time updates for customer view
                  if (typeof setupOrderRealtimeListener === 'function') {
                      setupOrderRealtimeListener(orderId);
                  }

              } catch (error) {
                  console.error("Error updating order:", error);
                  showMessage("L·ªói c·∫≠p nh·∫≠t ƒë∆°n h√†ng: " + error.message, "error");
              }
        }

        // ==================== BROWSER NOTIFICATIONS ====================

        // ƒêƒÉng k√Ω Service Worker cho PWA v√† notifications
        let serviceWorkerRegistration = null;
        
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ƒë·ªÉ ho·∫°t ƒë·ªông tr√™n m·ªçi server
                    const swPath = './service-worker.js';
                    const registration = await navigator.serviceWorker.register(swPath, {
                        scope: './'
                    });
                    serviceWorkerRegistration = registration;
                    // console.log('‚úÖ Service Worker registered:', registration); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    
                    // Ki·ªÉm tra n·∫øu c√≥ update
                    registration.addEventListener('updatefound', () => {
                        // console.log('üîÑ Service Worker update found'); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    });
                    
                    return registration;
                } catch (error) {
                    // console.error('‚ùå Service Worker registration failed:', error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    // Th·ª≠ v·ªõi ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi
                    try {
                        const registration = await navigator.serviceWorker.register('/service-worker.js');
                        serviceWorkerRegistration = registration;
                        console.log('‚úÖ Service Worker registered with absolute path');
                        return registration;
                    } catch (error2) {
                        console.error('‚ùå Service Worker registration failed with absolute path:', error2);
                        return null;
                    }
                }
            } else {
                // console.log('‚ö†Ô∏è Service Worker not supported'); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                return null;
            }
        }

        // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát
        async function requestNotificationPermission() {
            // ƒêƒÉng k√Ω service worker tr∆∞·ªõc (c·∫ßn thi·∫øt cho mobile)
            if (!serviceWorkerRegistration && 'serviceWorker' in navigator) {
                serviceWorkerRegistration = await registerServiceWorker();
            }
            
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showMessage("‚úÖ ƒê√£ c·∫•p quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát!", "success");
                            // console.log("üîî Notification permission granted"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        } else {
                            showMessage("‚ùå Kh√¥ng th·ªÉ c·∫•p quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát", "warning");
                            // console.log("üîî Notification permission denied"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    showMessage("‚úÖ Quy·ªÅn th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c c·∫•p!", "success");
                    // console.log("üîî Notification permission already granted"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                } else {
                    showMessage("‚ö†Ô∏è Th√¥ng b√°o tr√¨nh duy·ªát b·ªã ch·∫∑n. Vui l√≤ng cho ph√©p trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.", "warning");
                }
            } else {
                showMessage("‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o", "warning");
                // console.log("üîî Browser doesn't support notifications"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            }
        }

        // H√†m rung thi·∫øt b·ªã (Vibration API)
        function vibrateDevice(pattern = [200, 100, 200, 100, 200]) {
            if ('vibrate' in navigator) {
                try {
                    navigator.vibrate(pattern);
                    // console.log('üì≥ Device vibrated:', pattern); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                } catch (error) {
                    console.error('‚ùå Vibration failed:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Vibration API not supported');
            }
        }

        // Toggle notifications on/off
        function toggleNotifications() {
            notificationsEnabled = !notificationsEnabled;
            localStorage.setItem('notificationsEnabled', notificationsEnabled.toString());
            showMessage(notificationsEnabled ? '‚úÖ ƒê√£ b·∫≠t th√¥ng b√°o' : '‚ùå ƒê√£ t·∫Øt th√¥ng b√°o', notificationsEnabled ? 'success' : 'info');
            renderApp(); // Re-render to update UI
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o tr√¨nh duy·ªát v·ªõi √¢m thanh v√† rung
        async function showBrowserNotification(title, body, icon = null) {
            // Ki·ªÉm tra xem th√¥ng b√°o c√≥ ƒë∆∞·ª£c b·∫≠t kh√¥ng
            if (!notificationsEnabled) {
                // console.log('üîï Notifications are disabled, skipping notification'); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                return false;
            }
            
            // ƒê·∫£m b·∫£o service worker ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω (c·∫ßn thi·∫øt cho mobile)
            if (!serviceWorkerRegistration && 'serviceWorker' in navigator) {
                serviceWorkerRegistration = await registerServiceWorker();
            }
            
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    // Rung thi·∫øt b·ªã ngay khi c√≥ th√¥ng b√°o (pattern: rung 200ms, ngh·ªâ 100ms, rung 200ms, ngh·ªâ 100ms, rung 200ms)
                    vibrateDevice([200, 100, 200, 100, 200]);
                    
                    // S·ª≠ d·ª•ng Service Worker API n·∫øu c√≥ (cho mobile v√† PWA)
                    if (serviceWorkerRegistration && 'showNotification' in serviceWorkerRegistration) {
                        await serviceWorkerRegistration.showNotification(title, {
                            body: body,
                            icon: icon || '/logo.png',
                            badge: '/logo.png',
                            tag: 'order-notification',
                            requireInteraction: false,
                            silent: false,
                            vibrate: [200, 100, 200, 100, 200], // Rung tr√™n mobile qua notification
                            data: {
                                url: window.location.href
                            }
                        });
                        // console.log('‚úÖ Notification shown via Service Worker with vibration'); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    } else {
                        // Fallback: S·ª≠ d·ª•ng Notification API tr·ª±c ti·∫øp (cho desktop)
                        const notification = new Notification(title, {
                            body: body,
                            icon: icon || 'logo.png',
                            badge: 'logo.png',
                            tag: 'order-notification',
                            requireInteraction: false,
                            silent: false,
                            vibrate: [200, 100, 200, 100, 200] // Rung tr√™n desktop n·∫øu h·ªó tr·ª£
                        });

                        // T·ª± ƒë·ªông ƒë√≥ng sau 5 gi√¢y
                        setTimeout(() => {
                            notification.close();
                        }, 5000);

                        // X·ª≠ l√Ω click v√†o th√¥ng b√°o
                        notification.onclick = function() {
                            window.focus();
                            if (isAdmin && currentView !== 'admin-orders') {
                                setView('admin-orders');
                            }
                            notification.close();
                        };
                    }

                    // Ph√°t √¢m thanh dong_xu.mp3
                    playNotificationSound();

                    return true;
                } catch (error) {
                    // console.error("‚ùå Error showing browser notification:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    // Th·ª≠ fallback v·ªõi Notification API tr·ª±c ti·∫øp
                    try {
                        // V·∫´n rung ngay c·∫£ khi fallback
                        vibrateDevice([200, 100, 200]);
                        
                        const notification = new Notification(title, {
                            body: body,
                            icon: icon || 'logo.png',
                            tag: 'order-notification',
                            vibrate: [200, 100, 200]
                        });
                        playNotificationSound();
                        setTimeout(() => notification.close(), 5000);
                        return true;
                    } catch (fallbackError) {
                        // console.error("‚ùå Fallback notification also failed:", fallbackError); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                    }
                }
            } else {
                // console.warn("‚ö†Ô∏è Notification permission not granted"); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            }
            return false;
        }

        // Ph√°t √¢m thanh th√¥ng b√°o
        function playNotificationSound() {
            try {
                const audio = new Audio('dong_xu.mp3');
                audio.volume = 0.7; // Gi·∫£m √¢m l∆∞·ª£ng m·ªôt ch√∫t
                audio.play().catch(error => {
                    // console.error("‚ùå Error playing notification sound:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
                });
            } catch (error) {
                    // console.error("‚ùå Error creating audio object:", error); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t
            }
        }

        // ==================== CUSTOMER ORDER HISTORY ====================

          // Bi·∫øn l∆∞u unsubscribe functions cho c√°c order listeners
          let customerOrdersUnsubscribe = null;
          let orderRealtimeListeners = {}; // { orderId: unsubscribeFunction }

          // Setup realtime listener cho m·ªôt order c·ª• th·ªÉ (hi·ªáu qu·∫£ h∆°n listen t·∫•t c·∫£ orders)
          function setupOrderRealtimeListener(orderId) {
              if (!db || !orderId) return;

              // H·ªßy listener c≈© n·∫øu c√≥
              if (orderRealtimeListeners[orderId]) {
                  orderRealtimeListeners[orderId]();
                  console.log(`üîå Unsubscribed old listener for order: ${orderId.slice(-6)}`);
              }

              try {
                  console.log(`üì° Setting up realtime listener for order: ${orderId.slice(-6)} (full ID: ${orderId})`);

                  // Listen ch·ªâ order n√†y thay v√¨ t·∫•t c·∫£ orders
                  const orderRef = doc(db, 'orders', orderId);
                  const unsubscribe = onSnapshot(orderRef, (doc) => {
                      if (!doc.exists()) {
                          console.log(`‚ö†Ô∏è Order ${orderId.slice(-6)} no longer exists`);
                          return;
                      }

                      const orderData = doc.data();
                      console.log(`üîÑ Order ${orderId.slice(-6)} updated:`, orderData.status);

                      // T√¨m v√† c·∫≠p nh·∫≠t trong guestOrders
                      const guestOrder = guestOrders.find(o => o.orderId === orderId);
                      if (guestOrder) {
                          const oldStatus = guestOrder.status;

                          // C·∫≠p nh·∫≠t th√¥ng tin order
                          guestOrder.status = orderData.status;
                          guestOrder.updatedAt = orderData.updatedAt;

                          // C·∫≠p nh·∫≠t items v√† total n·∫øu c√≥ thay ƒë·ªïi (admin ch·ªânh s·ª≠a)
                          if (orderData.items) {
                              guestOrder.items = orderData.items;
                          }
                          if (orderData.total !== undefined) {
                              guestOrder.total = orderData.total;
                          }

                          // C·∫≠p nh·∫≠t cancelReason n·∫øu c√≥
                          if (orderData.status === 'cancelled' && orderData.cancelReason) {
                              guestOrder.cancelReason = orderData.cancelReason;
                              guestOrder.cancelledAt = orderData.cancelledAt;
                          }

                          // L∆∞u v√†o cookie
                          saveSessionToCookie();

                          console.log(`üìù Guest order updated: ${guestOrder.shortId} (${oldStatus} ‚Üí ${orderData.status})`);

                          // Hi·ªÉn th·ªã th√¥ng b√°o cho kh√°ch h√†ng
                          if (oldStatus !== orderData.status) {
                              const statusMessages = {
                                  'preparing': `üç≥ ƒê∆°n h√†ng #${guestOrder.shortId} ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã!`,
                                  'completed': `‚úÖ ƒê∆°n h√†ng #${guestOrder.shortId} ƒë√£ ho√†n th√†nh!`,
                                  'cancelled': `‚ùå ƒê∆°n h√†ng #${guestOrder.shortId} ƒë√£ b·ªã h·ªßy`
                              };

                              if (statusMessages[orderData.status]) {
                                  showMessage(statusMessages[orderData.status],
                                      orderData.status === 'completed' ? 'success' :
                                      orderData.status === 'cancelled' ? 'error' : 'info');
                              }
                          }

                          // Th√¥ng b√°o khi admin c·∫≠p nh·∫≠t items (kh√¥ng ph·∫£i do status change)
                          if (oldStatus === orderData.status && orderData.updatedBy === 'admin' && orderData.updatedAt) {
                              // Ki·ªÉm tra xem c√≥ thay ƒë·ªïi items/total kh√¥ng
                              const hasItemsChanged = JSON.stringify(guestOrder.items) !== JSON.stringify(orderData.items);
                              const hasTotalChanged = guestOrder.total !== orderData.total;

                              if (hasItemsChanged || hasTotalChanged) {
                                  showMessage(`üîÑ ƒê∆°n h√†ng #${guestOrder.shortId} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi nh√¢n vi√™n!`, 'info');
                              }
                          }

                          // T·ª± ƒë·ªông c·∫≠p nh·∫≠t modal "ƒê∆°n h√†ng c·ªßa t√¥i" n·∫øu ƒëang m·ªü
                          const myOrdersModal = document.getElementById('my-orders-modal');
                          if (myOrdersModal && !myOrdersModal.classList.contains('hidden')) {
                              console.log('üîÑ Refreshing My Orders modal (specific order update)');
                              showGuestOrders(false); // false = don't setup listeners again
                          }
                      }
                  }, (error) => {
                      console.error(`‚ùå Error in order listener for ${orderId.slice(-6)}:`, error);
                  });

                  // L∆∞u unsubscribe function
                  orderRealtimeListeners[orderId] = unsubscribe;

              } catch (error) {
                  console.error(`‚ùå Error setting up listener for order ${orderId.slice(-6)}:`, error);
              }
          }

          // H·ªßy t·∫•t c·∫£ order realtime listeners
          function cleanupOrderRealtimeListeners() {
              console.log('üßπ Cleaning up order realtime listeners...');
              Object.values(orderRealtimeListeners).forEach(unsubscribe => {
                  if (typeof unsubscribe === 'function') {
                      unsubscribe();
                  }
              });
              orderRealtimeListeners = {};
              console.log('‚úÖ All order realtime listeners cleaned up');
          }

          async function showMyOrders() {
              // Guest: xem t·ª´ cookie session
              if (userRole === 'guest') {
                  console.log("Loading guest orders from session...");
                  showGuestOrders();
                  return;
              }

              // Customer: query Firebase v·ªõi REALTIME LISTENER
              if (!auth.currentUser) {
                  showMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë∆°n h√†ng!", "warning");
                  return;
              }

              try {
                  console.log("Setting up customer orders realtime listener...");
                  const q = query(collection(db, 'orders'), where('customerId', '==', userId));
                  
                  // H·ªßy listener c≈© n·∫øu c√≥
                  if (customerOrdersUnsubscribe) {
                      customerOrdersUnsubscribe();
                  }
                  
                  // Setup realtime listener
                  customerOrdersUnsubscribe = onSnapshot(q, (snapshot) => {
                      const myOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      
                      console.log("Customer orders updated:", myOrders.length);
                      
                      // Ki·ªÉm tra xem c√≥ order n√†o b·ªã thay ƒë·ªïi kh√¥ng
                      snapshot.docChanges().forEach(change => {
                          if (change.type === 'modified') {
                              const orderData = change.doc.data();
                              console.log('üìù Customer order updated realtime:', {
                                  orderId: change.doc.id.slice(-6),
                                  status: orderData.status
                              });
                              
                              // Hi·ªÉn th·ªã th√¥ng b√°o
                              const statusMessages = {
                                  'preparing': `üç≥ ƒê∆°n h√†ng #${change.doc.id.slice(-6).toUpperCase()} ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã!`,
                                  'completed': `‚úÖ ƒê∆°n h√†ng #${change.doc.id.slice(-6).toUpperCase()} ƒë√£ ho√†n th√†nh!`,
                                  'cancelled': `‚ùå ƒê∆°n h√†ng #${change.doc.id.slice(-6).toUpperCase()} ƒë√£ b·ªã h·ªßy`
                              };
                              
                              if (statusMessages[orderData.status]) {
                                  showMessage(statusMessages[orderData.status], 
                                      orderData.status === 'completed' ? 'success' : 
                                      orderData.status === 'cancelled' ? 'error' : 'info');
                              }
                          }
                      });

                      // Render n·ªôi dung modal
                      renderCustomerOrdersModal(myOrders);
                  });

                  // Hi·ªÉn th·ªã modal
                  document.getElementById('my-orders-modal').classList.remove('hidden');

              } catch (error) {
                  console.error("Error setting up customer orders listener:", error);
                  showMessage("L·ªói t·∫£i ƒë∆°n h√†ng: " + error.message, "error");
              }
          }
          
          // Render n·ªôi dung modal ƒë∆°n h√†ng cho customer
          function renderCustomerOrdersModal(myOrders) {
              const modalContent = document.getElementById('my-orders-content');
              
              // Ki·ªÉm tra xem modal c√≥ ƒëang m·ªü kh√¥ng
              const modal = document.getElementById('my-orders-modal');
              if (!modal || modal.classList.contains('hidden')) {
                  // Modal kh√¥ng m·ªü, kh√¥ng c·∫ßn render
                  return;
              }

              if (myOrders.length === 0) {
                  modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
              } else {
                  // Sort by newest first
                  const sortedOrders = [...myOrders].sort((a, b) => {
                      const timeA = a.createdAt?.seconds || 0;
                      const timeB = b.createdAt?.seconds || 0;
                      return timeB - timeA;
                  });

                      modalContent.innerHTML = sortedOrders.map(order => `
                          <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                              order.status === 'cancelled' ? 'border-red-200' :
                              order.status === 'completed' ? 'border-green-200' :
                              'border-blue-200'
                          } mb-4">
                              <div class="flex justify-between items-start mb-3">
                                  <div>
                                      <h4 class="font-semibold text-blue-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                                      <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                  </div>
                                  <div class="text-right">
                                      <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                          ${getStatusText(order.status)}
                                      </span>
                                  </div>
                              </div>

                              ${order.status === 'cancelled' && order.cancelReason && order.cancelReason.trim() ? `
                                  <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                      <div class="flex items-start gap-2">
                                          <i data-lucide="info" class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                                          <div>
                                              <p class="text-sm font-medium text-red-800 mb-1">L√Ω do h·ªßy ƒë∆°n h√†ng:</p>
                                              <p class="text-sm text-red-700">${order.cancelReason}</p>
                                              ${order.cancelledAt ? `<p class="text-xs text-red-600 mt-1">Th·ªùi gian h·ªßy: ${new Date(order.cancelledAt.seconds * 1000).toLocaleString('vi-VN')}</p>` : ''}
                                          </div>
                                      </div>
                                  </div>
                              ` : ''}

                              <div class="space-y-2 mb-3">
                                  ${order.items.map(item => {
                                      const hasDetails = item.selectedDetails && Object.keys(item.selectedDetails).length > 0;
                                      let detailsHtml = '';
                                      
                                      if (hasDetails) {
                                          const details = item.selectedDetails;
                                          const detailsParts = [];
                                          
                                          if (details.size) detailsParts.push(`Size: ${details.size}`);
                                          if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                          if (details.ice !== undefined) detailsParts.push(`ƒê√°: ${details.ice}%`);
                                          if (details.sugar !== undefined) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}%`);
                                          if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                          if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                          if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                          
                                          if (detailsParts.length > 0) {
                                              detailsHtml = `<div class="text-xs text-gray-600 mt-1">${detailsParts.join(' ‚Ä¢ ')}</div>`;
                                          }
                                      }
                                      
                                      return `
                                          <div class="bg-white p-2 rounded">
                                              <div class="flex justify-between items-start">
                                                  <div class="flex-1">
                                                      <div class="flex items-center gap-1">
                                                          <span class="font-medium">${item.name}</span>
                                                          <span class="text-sm text-gray-600">x${item.quantity}</span>
                                                      </div>
                                                      ${detailsHtml}
                                                  </div>
                                                  <div class="text-right ml-2">
                                                      <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                                  </div>
                                              </div>
                                          </div>
                                      `;
                                  }).join('')}
                              </div>

                              <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                  <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                                  <span class="text-xs font-medium ${
                                      order.status === 'ordered' ? 'text-blue-600' :
                                      order.status === 'preparing' ? 'text-yellow-600' :
                                      order.status === 'cancelled' ? 'text-red-600' :
                                      order.status === 'completed' ? 'text-green-600' :
                                      'text-gray-600'
                                  }">
                                      ${order.status === 'ordered' ? 'üìã Ch·ªù nh·∫≠n ƒë∆°n' :
                                        order.status === 'preparing' ? 'üë®‚Äçüç≥ ƒêang l√†m' :
                                        order.status === 'cancelled' ? '‚ùå ƒê√£ h·ªßy' :
                                        order.status === 'completed' ? '‚úÖ Ho√†n th√†nh' :
                                        'üîÑ ƒêang x·ª≠ l√Ω'}
                                  </span>
                              </div>

                              ${order.updatedBy === 'admin' && order.status === 'preparing' ? `
                                  <div class="mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800 border border-yellow-200">
                                      <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                      Admin ƒë√£ ch·ªânh s·ª≠a ƒë∆°n h√†ng (th√™m/x√≥a m√≥n)
                                  </div>
                              ` : ''}
                          </div>
                      `).join('');
              }
              
              renderLucideIcons();
          }

          function closeMyOrdersModal() {
              document.getElementById('my-orders-modal').classList.add('hidden');

              // H·ªßy listener khi ƒë√≥ng modal ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
              if (customerOrdersUnsubscribe) {
                  customerOrdersUnsubscribe();
                  customerOrdersUnsubscribe = null;
                  console.log('üîå Customer orders listener unsubscribed');
              }

              // Cleanup t·∫•t c·∫£ order realtime listeners
              cleanupOrderRealtimeListeners();
          }

          // Hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa guest t·ª´ session
          function showGuestOrders(setupRealtimeListeners = true) {
              const modalContent = document.getElementById('my-orders-content');

              if (guestOrders.length === 0) {
                  modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong phi√™n n√†y</p>';
              } else {
                  // Sort by newest first
                  const sortedOrders = [...guestOrders].sort((a, b) => {
                      const timeA = new Date(a.createdAt).getTime();
                      const timeB = new Date(b.createdAt).getTime();
                      return timeB - timeA;
                  });

                  modalContent.innerHTML = sortedOrders.map(order => `
                      <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                          order.status === 'cancelled' ? 'border-red-200' :
                          order.status === 'completed' ? 'border-green-200' :
                          'border-blue-200'
                      } mb-4">
                          <div class="flex justify-between items-start mb-3">
                              <div>
                                  <h4 class="font-semibold text-blue-800">Order #${order.shortId}</h4>
                                  <p class="text-sm text-gray-600">${new Date(order.createdAt).toLocaleString('vi-VN')}</p>
                                  <p class="text-xs text-gray-500">B√†n: ${order.tableNumber || 'N/A'}</p>
                              </div>
                              <div class="text-right">
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              </div>
                          </div>

                          <div class="space-y-2 mb-3">
                              ${order.items.map(item => {
                                  const hasDetails = item.selectedDetails && Object.keys(item.selectedDetails).length > 0;
                                  let detailsHtml = '';
                                  
                                  if (hasDetails) {
                                      const details = item.selectedDetails;
                                      const detailsParts = [];
                                      
                                      if (details.size) detailsParts.push(`Size: ${details.size}`);
                                      if (details.toppings && details.toppings.length > 0) detailsParts.push(`Topping: ${details.toppings.join(', ')}`);
                                      if (details.ice) detailsParts.push(`ƒê√°: ${details.ice}`);
                                      if (details.sugar) detailsParts.push(`ƒê∆∞·ªùng: ${details.sugar}`);
                                      if (details.spice) detailsParts.push(`Cay: ${details.spice}`);
                                      if (details.noodle) detailsParts.push(`S·ª£i: ${details.noodle}`);
                                      if (details.notes) detailsParts.push(`Ghi ch√∫: ${details.notes}`);
                                      
                                      if (detailsParts.length > 0) {
                                          detailsHtml = `<div class="text-xs text-gray-600 mt-1">${detailsParts.join(' ‚Ä¢ ')}</div>`;
                                      }
                                  }
                                  
                                  return `
                                      <div class="bg-white p-2 rounded">
                                          <div class="flex justify-between items-start">
                                              <div class="flex-1">
                                                  <div class="flex items-center gap-1">
                                                      <span class="font-medium">${item.name}</span>
                                                      <span class="text-sm text-gray-600">x${item.quantity}</span>
                                                  </div>
                                                  ${detailsHtml}
                                              </div>
                                              <div class="text-right ml-2">
                                                  <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                              </div>
                                          </div>
                                      </div>
                                  `;
                              }).join('')}
                          </div>

                          ${order.status === 'cancelled' && order.cancelReason && order.cancelReason.trim() ? `
                              <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                  <div class="flex items-start gap-2">
                                      <i data-lucide="info" class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                                      <div>
                                          <p class="text-sm font-medium text-red-800 mb-1">L√Ω do h·ªßy ƒë∆°n h√†ng:</p>
                                          <p class="text-sm text-red-700">${order.cancelReason}</p>
                                          ${order.cancelledAt ? `<p class="text-xs text-red-600 mt-1">Th·ªùi gian h·ªßy: ${order.cancelledAt.seconds ? new Date(order.cancelledAt.seconds * 1000).toLocaleString('vi-VN') : new Date(order.cancelledAt).toLocaleString('vi-VN')}</p>` : ''}
                                      </div>
                                  </div>
                              </div>
                          ` : ''}

                          <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                              <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                              <span class="text-xs text-gray-500">
                                  ${order.status === 'ordered' ? '‚è≥ Ch·ªù nh·∫≠n ƒë∆°n' :
                                    order.status === 'cancelled' ? '‚ùå ƒê√£ h·ªßy' :
                                    order.status === 'completed' ? '‚úÖ Ho√†n th√†nh' :
                                    'üîÑ ƒêang x·ª≠ l√Ω'}
                              </span>
                          </div>
                      </div>
                  `).join('');

                  // Setup realtime listeners cho t·ª´ng order (hi·ªáu qu·∫£ h∆°n listen t·∫•t c·∫£)
                  if (setupRealtimeListeners) {
                      console.log(`üì° Setting up ${sortedOrders.length} realtime listeners for guest orders`);
                      sortedOrders.forEach(order => {
                          console.log(`üì° Setting up listener for order: ${order.shortId} (${order.orderId})`);
                          setupOrderRealtimeListener(order.orderId);
                      });
                  }
              }

              document.getElementById('my-orders-modal').classList.remove('hidden');
              renderLucideIcons();
          }
        
        // --- Custom Alert/Message ---
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;

            let classes = '';
            if (type === 'success') {
                classes = 'bg-green-100 text-green-800 border-green-400';
            } else if (type === 'warning') {
                classes = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            } else if (type === 'error') {
                classes = 'bg-red-100 text-red-800 border-red-400';
            } else { // info
                classes = 'bg-blue-100 text-blue-800 border-blue-400';
            }

            // Responsive classes cho mobile v√† desktop
            messageBox.className = `p-2 sm:p-3 text-sm sm:text-base rounded-lg border fixed top-3 sm:top-4 left-1/2 -translate-x-1/2 z-[9999] shadow-xl transition-opacity duration-300 max-w-[90vw] sm:max-w-md text-center ${classes}`;
            messageBox.style.opacity = '1';

            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        function renderApp() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // Hide loading screen
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }

            // Render Header
            document.getElementById('header-container').innerHTML = renderHeader();

            // Render Main Content (Menu/Login/Admin)
            document.getElementById('main-content-container').innerHTML = renderMainContent();

            // Render Cart Sidebar
            document.getElementById('cart-container').innerHTML = renderCartSidebar();

            // X·ª≠ l√Ω gi·ªè h√†ng ban ƒë·∫ßu (khi user m·ªü app)
            const storedCart = localStorage.getItem('cart');
            if (storedCart) {
                try {
                    cart = JSON.parse(storedCart);
                } catch(e) {
                    console.error("L·ªói parse gi·ªè h√†ng:", e);
                    cart = {};
                }
            }

            // Setup admin price preview listeners
            setTimeout(() => {
                setupAdminPricePreviewListeners();
                updateFeaturedScrollButtons();
            }, 100);

            renderLucideIcons();
        }


        // ==================== MOBILE MENU ====================

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            
            // Ki·ªÉm tra n·∫øu c√°c element kh√¥ng t·ªìn t·∫°i
            if (!menu || !btn) {
                console.warn('Mobile menu elements not found');
                return;
            }
            
            const icon = btn.querySelector('i');
            
            // Ki·ªÉm tra n·∫øu icon kh√¥ng t·ªìn t·∫°i
            if (!icon) {
                console.warn('Mobile menu icon not found');
                // V·∫´n toggle menu nh∆∞ng kh√¥ng ƒë·ªïi icon
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                } else {
                    menu.classList.add('hidden');
                }
                return;
            }

            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'x');
            } else {
                menu.classList.add('hidden');
                icon.setAttribute('data-lucide', 'menu');
            }
            renderLucideIcons();
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');

            // Ki·ªÉm tra n·∫øu c√°c element kh√¥ng t·ªìn t·∫°i
            if (!menu || !btn) {
                return;
            }

            if (!btn.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.add('hidden');
                const icon = btn.querySelector('i');
                if (icon) icon.setAttribute('data-lucide', 'menu');
                renderLucideIcons();
            }
        });

        // ==================== TABLE SELECTION MODAL ====================

        // Hi·ªÉn th·ªã modal ch·ªçn b√†n
        async function showTableSelectionModal() {
            const modal = document.getElementById('table-selection-modal');
            const content = document.getElementById('table-selection-content');

            console.log('üìã Current tables:', tables);
            console.log('üìä Tables length:', tables.length);

            // N·∫øu ch∆∞a load ƒë∆∞·ª£c tables, th·ª≠ load m·ªôt l·∫ßn
            if (tables.length === 0) {
                console.log('üîÑ Tables empty, trying to load once...');
                await loadTablesOnce();

                console.log('üìã After loading tables:', tables);
                console.log('üìä Tables length after load:', tables.length);
            }

            // N·∫øu v·∫´n ch∆∞a c√≥ tables, hi·ªÉn th·ªã loading
            if (tables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†n</p>
                        <p class="text-sm text-gray-500 mt-2">Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ho·∫∑c th·ª≠ l·∫°i sau.</p>
                        <button onclick="showTableSelectionModal()" class="mt-4 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            üîÑ Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
                modal.classList.remove('hidden');
                renderLucideIcons();
                return;
            }

            // Load danh s√°ch b√†n - ch·∫•p nh·∫≠n c·∫£ 'available' v√† undefined status (m·∫∑c ƒë·ªãnh l√† tr·ªëng)
            const availableTables = tables.filter(table => !table.status || table.status === 'available');

            console.log('‚úÖ Available tables:', availableTables);

            if (availableTables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">Kh√¥ng c√≥ b√†n tr·ªëng l√∫c n√†y.</p>
                        <p class="text-sm text-gray-500 mt-2">Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>
                        <p class="text-xs text-gray-400 mt-4">Debug: ${tables.length} b√†n trong h·ªá th·ªëng</p>
                    </div>
                `;
            } else {
                content.innerHTML = availableTables.map(table => `
                    <button onclick="selectTable('${table.tableNumber}')" class="p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-2">
                        <i data-lucide="table-2" class="w-8 h-8 text-teal-600"></i>
                        <span class="font-semibold text-gray-800">B√†n ${table.tableNumber}</span>
                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">${table.status || 'Tr·ªëng'}</span>
                    </button>
                `).join('');
            }

            modal.classList.remove('hidden');
            renderLucideIcons();
        }

        // ƒê√≥ng modal ch·ªçn b√†n
        function closeTableSelectionModal() {
            document.getElementById('table-selection-modal').classList.add('hidden');
        }

        // Ch·ªçn b√†n v√† ti·∫øp t·ª•c ƒë·∫∑t h√†ng
        function selectTable(tableNumber) {
            // ƒê·∫∑t table number
            currentTableNumber = tableNumber;
            userRole = 'guest';

            // T·∫°o session m·ªõi n·∫øu ch∆∞a c√≥
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            // L∆∞u session
            saveSessionToCookie();

            // ƒê√≥ng modal
            closeTableSelectionModal();

            // Hi·ªÉn th·ªã th√¥ng b√°o
            showMessage(`ƒê√£ ch·ªçn B√†n ${tableNumber}!`, 'success');

            // Ti·∫øp t·ª•c ƒë·∫∑t h√†ng
            handleOrder();

            // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t header
            renderApp();
        }

        // --- Kh·ªüi t·∫°o ·ª®ng d·ª•ng ---
        window.onload = function() {
            // console.log("üåü ·ª®ng d·ª•ng Chill Coffee kh·ªüi ƒë·ªông..."); // ·∫®n ƒë·ªÉ b·∫£o m·∫≠t

            // ƒêƒÉng k√Ω Service Worker cho PWA v√† notifications
            registerServiceWorker().then(() => {
                // L·∫Øng nghe message t·ª´ service worker ƒë·ªÉ rung thi·∫øt b·ªã
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'vibrate') {
                            vibrateDevice(event.data.pattern || [50]);
                        }
                    });
                }
            });

            initFirebase();
            window.updateCart = updateCart;
            window.openCart = openCart;
            window.closeCart = closeCart;
            window.setView = setView;
            window.setCategory = setCategory;
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            window.requestNotificationPermission = requestNotificationPermission;
            window.showBrowserNotification = showBrowserNotification;
            window.playNotificationSound = playNotificationSound;
            window.vibrateDevice = vibrateDevice;
            window.toggleNotifications = toggleNotifications;
            window.toggleAdminMode = toggleAdminMode;
            window.saveItem = saveItem;
            window.deleteItem = deleteItem;
            window.handleSaveItem = handleSaveItem;
            window.handleChangePassword = handleChangePassword;
            window.loadItemForEdit = loadItemForEdit;
            window.clearAdminForm = clearAdminForm;
            window.loadMenuItemsOnce = loadMenuItemsOnce;
            window.openPriceModal = openPriceModal;
            window.closePriceModal = closePriceModal;
            window.openCancelModal = openCancelModal;
            window.closeCancelModal = closeCancelModal;
            window.confirmCancelOrder = confirmCancelOrder;
            window.selectCancelReason = selectCancelReason;
            window.savePriceUpdate = savePriceUpdate;
            window.openCategoryModal = openCategoryModal;
            window.closeCategoryModalAdmin = closeCategoryModalAdmin;
            window.addNewCategoryAdmin = addNewCategoryAdmin;
            window.openEditCategoryModalAdmin = openEditCategoryModalAdmin;
            window.closeEditCategoryModalAdmin = closeEditCategoryModalAdmin;
            window.updateCategoryAdmin = updateCategoryAdmin;
            window.openAddTableModalAdmin = openAddTableModalAdmin;
            window.closeAddTableModalAdmin = closeAddTableModalAdmin;
            window.addTableAdmin = addTableAdmin;
            window.openEditTableModalAdmin = openEditTableModalAdmin;
            window.closeEditTableModalAdmin = closeEditTableModalAdmin;
            window.updateTableAdmin = updateTableAdmin;
            window.showTableQRAdmin = showTableQRAdmin;
            window.closeQRTableModalAdmin = closeQRTableModalAdmin;
            window.downloadTableQRAdmin = downloadTableQRAdmin;
            window.restoreItem = restoreItem;
            window.permanentDeleteItem = permanentDeleteItem;
            window.cleanupExpiredItems = cleanupExpiredItems;
            window.loadCategories = loadCategories;
            window.saveCategories = saveCategories;
            window.updateAdminPricePreview = updateAdminPricePreview;
            window.setupAdminPricePreviewListeners = setupAdminPricePreviewListeners;
            window.closeCategoryModal = closeCategoryModal;
            window.addNewCategory = addNewCategory;
            window.editCategory = editCategory;
            window.deleteCategory = deleteCategory;
            window.loadOrders = loadOrders;
            window.acceptOrder = acceptOrder;
            window.cancelOrder = cancelOrder;
            window.completeOrder = completeOrder;
            window.addItemToOrder = addItemToOrder;
            window.removeItemFromOrder = removeItemFromOrder;
            window.updateOrder = updateOrder;
            window.handleOrder = handleOrder;
            window.showMyOrders = showMyOrders;
            window.closeMyOrdersModal = closeMyOrdersModal;
            window.cleanupOrderRealtimeListeners = cleanupOrderRealtimeListeners;
            window.setOrderFilter = setOrderFilter;
            window.setStatsTimeFilter = setStatsTimeFilter;
            window.toggleDateFilter = toggleDateFilter;
            window.applyDateFilter = applyDateFilter;
            window.clearDateFilter = clearDateFilter;
            window.resetDateFilter = resetDateFilter;
            window.previewAsCustomer = previewAsCustomer;
            window.handleLogoClick = handleLogoClick;
            window.showItemContextMenu = showItemContextMenu;
            window.handleTableRowTouch = handleTableRowTouch;
            window.hideContextMenu = hideContextMenu;
            window.openAddItemModal = openAddItemModal;
            window.openEditItemModal = openEditItemModal;
            window.closeItemModal = closeItemModal;
            window.openItemDetailModal = openItemDetailModal;
            window.closeItemDetailModal = closeItemDetailModal;
            window.openItemDetailsConfig = openItemDetailsConfig;
            window.closeItemDetailsConfig = closeItemDetailsConfig;
            window.saveItemDetailsConfig = saveItemDetailsConfig;
            window.addDrinkSize = addDrinkSize;
            window.updateDrinkSize = updateDrinkSize;
            window.toggleDrinkSize = toggleDrinkSize;
            window.removeDrinkSize = removeDrinkSize;
            window.addDrinkTopping = addDrinkTopping;
            window.updateDrinkTopping = updateDrinkTopping;
            window.removeDrinkTopping = removeDrinkTopping;
            window.toggleIceOption = toggleIceOption;
            window.toggleSugarOption = toggleSugarOption;
            window.toggleSpiceLevel = toggleSpiceLevel;
            window.addCustomSpiceLevel = addCustomSpiceLevel;
            window.removeCustomSpiceLevel = removeCustomSpiceLevel;
            window.addNoodleTopping = addNoodleTopping;
            window.updateNoodleTopping = updateNoodleTopping;
            window.removeNoodleTopping = removeNoodleTopping;
            window.addFoodSize = addFoodSize;
            window.updateFoodSize = updateFoodSize;
            window.toggleFoodSize = toggleFoodSize;
            window.removeFoodSize = removeFoodSize;
            window.addAlcoholSize = addAlcoholSize;
            window.updateAlcoholSize = updateAlcoholSize;
            window.toggleAlcoholSize = toggleAlcoholSize;
            window.removeAlcoholSize = removeAlcoholSize;
            window.setItemsPerPage = setItemsPerPage;
            window.setPage = setPage;
            window.setMenuPage = setMenuPage;
            window.setMenuItemsPerPage = setMenuItemsPerPage;
            window.setMenuFilterStatus = setMenuFilterStatus;
            window.setMenuFilterCategory = setMenuFilterCategory;
            window.getFilteredMenuItems = getFilteredMenuItems;
            window.nextPage = nextPage;
            window.prevPage = prevPage;
            window.addTable = addTable;
            window.deleteTable = deleteTable;
            window.showTableQR = showTableQR;
            window.closeQRModal = closeQRModal;
            window.openAddTableModal = openAddTableModal;
            window.closeAddTableModal = closeAddTableModal;
            window.downloadQR = downloadQR;
            window.showTableSelectionModal = showTableSelectionModal;
            window.closeTableSelectionModal = closeTableSelectionModal;
            window.selectTable = selectTable;
            window.toggleMobileMenu = toggleMobileMenu;

              // Fallback: Hide loading after 10 seconds if Firebase fails
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen && loadingScreen.style.display !== 'none') {
                    console.warn("‚ö†Ô∏è Firebase load timeout - showing app anyway");
                    loadingScreen.style.display = 'none';
                }
            }, 10000);

            renderApp(); // Render l·∫ßn ƒë·∫ßu
            
            // Add resize listener for featured items scroll buttons
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateFeaturedScrollButtons();
                }, 150);
            });
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5e6d3;
        }
        ::-webkit-scrollbar-thumb {
            background: #d97706; /* Orange-700 */
            border-radius: 10px;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app-container" class="relative">
        <div id="header-container">
            <!-- Header s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-amber-50 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold text-amber-900 mb-2">Chill Coffee</h2>
                <p class="text-amber-700">ƒêang t·∫£i menu...</p>
                <p class="text-sm text-amber-600 mt-2">üí° N·∫øu load l√¢u, th·ª≠ enable Authentication trong Firebase Console</p>
            </div>
        </div>

        <div id="main-content-container">
            <!-- N·ªôi dung ch√≠nh (Menu, Login, Admin) s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>

        <div id="cart-container">
            <!-- Gi·ªè h√†ng Sidebar s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>
        
        <!-- H·ªôp th√¥ng b√°o t√πy ch·ªânh (thay th·∫ø alert) -->
        <div id="message-box" style="opacity: 0; pointer-events: none;" class="p-2 sm:p-3 text-sm sm:text-base rounded-lg border fixed top-3 sm:top-4 left-1/2 -translate-x-1/2 z-[9999] shadow-xl transition-opacity duration-300 max-w-[90vw] sm:max-w-md text-center"></div>

        <!-- Price Update Modal -->
        <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">üí∞ C·∫≠p Nh·∫≠t Gi√°</h3>

                <div id="price-modal-content">
                    <!-- Content s·∫Ω ƒë∆∞·ª£c render b·ªüi JavaScript -->
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closePriceModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="savePriceUpdate()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">L∆∞u</button>
                </div>
              </div>
          </div>

          <!-- My Orders Modal (Customer) -->
          <div id="my-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
              <div class="bg-white p-6 rounded-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-2xl font-bold text-blue-600">üìã ƒê∆°n H√†ng C·ªßa T√¥i</h3>
                      <button onclick="closeMyOrdersModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div id="my-orders-content">
                      <!-- Orders will be loaded here -->
                  </div>
              </div>
          </div>
          

          <!-- Table Selection Modal (Guest) -->
          <div id="table-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden p-4">
              <div class="bg-white rounded-xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-teal-600">üçΩÔ∏è Ch·ªçn B√†n C·ªßa B·∫°n</h3>
                      <button onclick="closeTableSelectionModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div class="p-4 sm:p-6">
                      <div class="mb-4">
                          <p class="text-gray-600 text-sm sm:text-base mb-4">Vui l√≤ng ch·ªçn b√†n m√† b·∫°n ƒëang ng·ªìi ƒë·ªÉ ch√∫ng t√¥i ph·ª•c v·ª• t·ªët nh·∫•t:</p>
                      </div>

                      <div class="flex justify-between items-center mb-4">
                          <p class="text-sm text-gray-600">Danh s√°ch b√†n tr·ªëng:</p>
                          <div class="flex gap-1 sm:gap-2">
                              <button onclick="loadTablesOnce().then(() => showTableSelectionModal())" class="px-2 py-1 sm:px-3 sm:py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition duration-150">
                                  üîÑ T·∫£i l·∫°i
                              </button>
                              <span class="text-xs text-gray-500 self-center hidden sm:inline">${tables.length} b√†n</span>
                          </div>
                      </div>

                      <div id="table-selection-content" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 sm:gap-3">
                      <!-- Tables will be loaded here -->
                  </div>

                  <div class="flex gap-3 mt-4 sm:mt-6 px-4 sm:px-6 pb-4 sm:pb-6">
                      <button onclick="closeTableSelectionModal()" class="flex-1 px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm sm:text-base transition duration-150">
                          H·ªßy
                      </button>
                      <div class="text-xs sm:text-sm text-gray-500 self-center px-2">
                          Ch·ªçn b√†n ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t h√†ng
                      </div>
                  </div>
              </div>
          </div>

          <!-- Add Category Modal -->
        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">‚ûï Th√™m Danh M·ª•c M·ªõi</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                    <input type="text" id="new-category-name" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div class="flex gap-3">
                    <button onclick="closeCategoryModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="addNewCategory()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Th√™m</button>
                </div>
            </div>
        </div>
        
        <!-- Add Table Modal -->
        <div id="add-table-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-teal-600 mb-4">üçΩÔ∏è Th√™m B√†n M·ªõi</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                    <input type="text" id="new-table-number" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeAddTableModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="addTable()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Th√™m B√†n</button>
                </div>
            </div>
        </div>
        
        <!-- QR Code Modal -->
        <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-teal-600">üì± QR Code</h3>
                    <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="qr-table-info" class="mb-4 text-center">
                    <!-- Table info will be inserted here -->
                </div>
                
                <div id="qr-code-container" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                    <!-- QR Code will be generated here -->
                </div>
                
                <div class="flex gap-3">
                    <button onclick="downloadQR()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        T·∫£i Xu·ªëng
                    </button>
                    <button onclick="closeQRModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancel-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-red-600 mb-4">‚ùå H·ªßy ƒê∆°n H√†ng</h3>

            <div id="cancel-modal-content">
                <!-- Content s·∫Ω ƒë∆∞·ª£c render b·ªüi JavaScript -->
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeCancelModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                <button onclick="confirmCancelOrder()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">X√°c Nh·∫≠n H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Footer ƒë∆°n gi·∫£n -->
    <footer class="bg-amber-700 text-white p-2 mt-6 text-center text-xs fixed bottom-0 left-0 right-0 z-50">
        &copy; 2025 by GTD Fry. Chill Coffee
    </footer>

    <!-- Auto Clear Script - T·ª± ƒë·ªông x√≥a sau 2 gi·ªù -->
    <script>
        // H√†m x√≥a t·∫•t c·∫£ d·ªØ li·ªáu kh√°ch h√†ng
        function autoCleanupCustomerData() {
            console.log('üßπ ƒêang th·ª±c hi·ªán d·ªçn d·∫πp t·ª± ƒë·ªông...');
            
            // 1. X√≥a gi·ªè h√†ng t·ª´ localStorage
            localStorage.removeItem('cart');
            
            // 2. X√≥a ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω t·ª´ localStorage
            localStorage.removeItem('processingOrderId');
            
            // 3. X√≥a session cookie (bao g·ªìm table number v√† orders)
            if (typeof clearSessionCookie === 'function') {
                clearSessionCookie();
            } else {
                // Fallback n·∫øu function ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
                document.cookie = 'guest_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            }
            
            // 4. Reset gi·ªè h√†ng trong memory
            if (typeof cart !== 'undefined') {
                cart = {};
            }
            
            console.log('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£: Cookie, Gi·ªè h√†ng, ƒê∆°n h√†ng, B√†n');
            
            // 5. Hi·ªÉn th·ªã th√¥ng b√°o cho ng∆∞·ªùi d√πng
            if (typeof showMessage === 'function') {
                showMessage('‚è∞ Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n. D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a!', 'info');
            }
            
            // 6. Reload trang ƒë·ªÉ l√†m m·ªõi giao di·ªán sau 2 gi√¢y
            setTimeout(() => {
                window.location.href = window.location.pathname; // Reload v·ªÅ trang ch·ªß, x√≥a query params
            }, 2000);
        }
        
        // Thi·∫øt l·∫≠p timer 2 gi·ªù (7,200,000 milliseconds)
        const TWO_HOURS = 2 * 60  * 60 * 1000; // 2 gi·ªù = 7,200,000 ms
        
        
        // Optional: Th√™m event listener ƒë·ªÉ clear timer khi ƒë√≥ng tab/window
        window.addEventListener('beforeunload', function() {
            console.log('üö™ Trang ƒëang ƒë√≥ng, timer s·∫Ω b·ªã h·ªßy');
            // Cleanup order realtime listeners
            if (typeof cleanupOrderRealtimeListeners === 'function') {
                cleanupOrderRealtimeListeners();
            }
        });
    </script>

    <!-- Modal ch·ªçn details cho kh√°ch h√†ng -->
    <div id="customer-item-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden p-2 sm:p-4">
        <div class="bg-white rounded-lg sm:rounded-xl w-full max-w-lg max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
            <!-- Header -->
            <div class="flex justify-between items-center p-3 sm:p-4 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg sm:text-xl font-bold text-teal-600">üç¥ T√πy ch·ªânh m√≥n</h3>
                <button onclick="closeCustomerItemDetailsModal()" class="text-gray-500 hover:text-gray-700 p-1 sm:p-2">
                    <i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                </button>
            </div>
            
            <!-- Content (scrollable) -->
            <div id="customer-item-details-content" class="p-3 sm:p-4 overflow-y-auto flex-1 min-h-0">
                <!-- Content will be inserted here by JavaScript -->
            </div>
            
            <!-- Footer -->
            <div class="p-3 sm:p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                <div class="flex gap-2 sm:gap-3">
                    <button onclick="closeCustomerItemDetailsModal()" 
                        class="flex-1 px-3 py-2.5 sm:px-4 sm:py-3 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium text-sm sm:text-base">
                        H·ªßy
                    </button>
                    <button onclick="addItemWithDetailsToCart()" 
                        class="flex-1 px-3 py-2.5 sm:px-4 sm:py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-bold text-sm sm:text-base">
                        Th√™m v√†o gi·ªè
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>