<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="logo.ico">
    <title>Chill Coffee</title>
    <!-- Tailwind CSS via CDN (for development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* Custom Tailwind config for production */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        position: relative;
        overflow-x: hidden;
    }

    /* Tr√¢n ch√¢u (boba pearls) effect */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background-image: 
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 11px, transparent 11px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 7px, transparent 7px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 9px, transparent 9px),
            radial-gradient(circle, rgba(139, 99, 66, 0.35) 6px, transparent 6px),
            radial-gradient(circle, rgba(139, 99, 66, 0.5) 10px, transparent 10px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 8px, transparent 8px),
            radial-gradient(circle, rgba(139, 99, 66, 0.3) 5px, transparent 5px),
            radial-gradient(circle, rgba(139, 99, 66, 0.45) 12px, transparent 12px),
            radial-gradient(circle, rgba(139, 99, 66, 0.4) 9px, transparent 9px);
        background-size: 
            80px 80px, 60px 60px, 100px 100px, 70px 70px, 90px 90px,
            75px 75px, 110px 110px, 65px 65px, 85px 85px, 55px 55px,
            95px 95px, 78px 78px, 50px 50px, 115px 115px, 88px 88px;
        background-position: 
            10% 85%, 25% 90%, 40% 88%, 60% 92%, 75% 87%,
            15% 78%, 88% 95%, 50% 80%, 30% 93%, 70% 82%,
            5% 75%, 95% 90%, 45% 96%, 82% 85%, 20% 70%;
        background-repeat: no-repeat;
        opacity: 0.8;
        /* Gradient mask ƒë·ªÉ l√†m m·ªèng d·∫ßn ·ªü tr√™n */
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
        mask-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,1) 100%);
    }

    /* ƒê·∫£m b·∫£o n·ªôi dung n·∫±m tr√™n background */
    body > * {
        position: relative;
        z-index: 1;
    }

    /* Hide scrollbar for webkit browsers */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f5e6d3; }
    ::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }

    /* Custom utilities */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    </style>
    <!-- Lucide Icons for nice, clean icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // C·∫•u h√¨nh Firebase v√† Kh·ªüi t·∫°o
        setLogLevel('Debug');
        const appId = 'order-app'; // App ID cho qu√°n tr√† s·ªØa

        // Firebase config cho project order-d8a0c
        const firebaseConfig = {
            apiKey: "AIzaSyCGs3xD2uC153yGlV7IpRftllAKx-NHt88",
            authDomain: "order-d8a0c.firebaseapp.com",
            projectId: "order-d8a0c",
            storageBucket: "order-d8a0c.firebasestorage.app",
            messagingSenderId: "559568129038",
            appId: "1:559568129038:web:dd1ebcefb23f7cf03dc05f"
        };
        const __initial_auth_token = null; // For Canvas environment - set to null for direct usage

        let app, db, auth, storage, userId;
          let menuItems = [];
          let cart = {}; // { itemId: { item, quantity } }
          let orders = []; // Danh s√°ch orders cho admin
          let tables = []; // Danh s√°ch b√†n ƒÉn
          let currentView = 'customer'; // 'customer', 'login', 'admin', 'admin-orders', 'admin-stats', 'admin-tables', 'admin-menu', 'admin-trash', 'preview'
          let currentCategory = 'ƒê·ªì U·ªëng'; // 'ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'
          let currentTableNumber = null; // S·ªë b√†n hi·ªán t·∫°i (t·ª´ QR code)
          let userRole = 'guest'; // 'guest', 'customer', 'admin'
        let isAdmin = false;
        let isPreviewMode = false; // Admin ƒëang xem nh∆∞ kh√°ch h√†ng
        let categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u']; // Danh s√°ch categories m·∫∑c ƒë·ªãnh
        let drinkSizes = ['S', 'M', 'L', 'Big Size']; // Size cho ƒë·ªì u·ªëng

        // --- H√†m h·ªó tr·ª£ chung ---
        function renderLucideIcons() {
            lucide.createIcons();
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 16000) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = numSamples * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;

            // RIFF chunk
            view.setUint32(offset, 0x52494646, false); offset += 4; // "RIFF"
            view.setUint32(offset, 36 + dataSize, true); offset += 4; // file size - 8
            view.setUint32(offset, 0x57415645, false); offset += 4; // "WAVE"

            // fmt chunk
            view.setUint32(offset, 0x666d7420, false); offset += 4; // "fmt "
            view.setUint32(offset, 16, true); offset += 4; // chunk size
            view.setUint16(offset, 1, true); offset += 2; // format (1 = PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // channels
            view.setUint32(offset, sampleRate, true); offset += 4; // sample rate
            view.setUint32(offset, byteRate, true); offset += 4; // byte rate
            view.setUint16(offset, blockAlign, true); offset += 2; // block align
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; // bits per sample

            // data chunk
            view.setUint32(offset, 0x64617461, false); offset += 4; // "data"
            view.setUint32(offset, dataSize, true); offset += 4; // data size

            // write PCM data
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function speak(text) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        // Assuming a default sample rate of 16000 Hz for PCM16 audio
                        const sampleRate = 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                        return;
                    }
                } catch (error) {
                    console.error(`TTS API failed (attempt ${i + 1}):`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    } else {
                        console.error('TTS failed after multiple retries.');
                    }
                }
            }
        }

        // --- Qu·∫£n l√Ω Gi·ªè h√†ng ---
        function updateCart(itemId, change) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const wasEmpty = Object.keys(cart).length === 0;
            const previousQty = cart[itemId]?.quantity || 0;
            
            // L∆∞u tr·∫°ng th√°i gi·ªè h√†ng tr∆∞·ªõc khi render l·∫°i
            const cartWasOpen = !document.getElementById('cart-sidebar')?.classList.contains('translate-x-full');

            if (cart[itemId]) {
                cart[itemId].quantity += change;
            } else if (change > 0) {
                cart[itemId] = { item: item, quantity: 1 };
            }

            if (cart[itemId] && cart[itemId].quantity <= 0) {
                delete cart[itemId];
            }

            // T·ª± ƒë·ªông ƒë√≥ng gi·ªè h√†ng CH·ªà KHI x√≥a h·∫øt m√≥n
            if (Object.keys(cart).length === 0 && !wasEmpty) {
                closeCart();
                showMessage("Gi·ªè h√†ng tr·ªëng", 'info');
            }

            // Hi·ªán th√¥ng b√°o khi th√™m m√≥n t·ª´ menu (kh√¥ng t·ª´ gi·ªè h√†ng)
            if (change > 0 && cart[itemId] && !cartWasOpen) {
                showMessage(`‚úÖ ƒê√£ th√™m "${item.name}" v√†o gi·ªè h√†ng!`, 'success');
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            renderApp();
            
            // Gi·ªØ nguy√™n tr·∫°ng th√°i gi·ªè h√†ng sau khi render
            if (cartWasOpen && Object.keys(cart).length > 0) {
                openCart();
            }
        }
        
        // ƒê√≥ng gi·ªè h√†ng
        function closeCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.add('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.add('hidden');
            }
        }
        
        // M·ªü gi·ªè h√†ng
        function openCart() {
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            
            if (cartSidebar) {
                cartSidebar.classList.remove('translate-x-full');
            }
            if (cartOverlay) {
                cartOverlay.classList.remove('hidden');
            }
        }

        // --- Qu·∫£n l√Ω State View ---
        function setView(viewName) {
            currentView = viewName;

            // Setup specific page data
            if (viewName === 'admin-orders') {
                setupOrdersPage();
            }

            renderApp();
            if (viewName !== 'login') {
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.reset();
                }
            }
        }

        function setCategory(categoryName) {
            currentCategory = categoryName;
            renderApp();
        }

        function toggleAdminMode() {
            if (isAdmin) {
                if (currentView.startsWith('admin')) {
                    // Chuy·ªÉn sang preview mode (xem nh∆∞ kh√°ch)
                    isPreviewMode = true;
                    currentView = 'customer';
                } else {
                    // Quay v·ªÅ admin dashboard
                    isPreviewMode = false;
                    currentView = 'admin-stats'; // Default admin view
                }
                renderApp();
            }
        }

        function previewAsCustomer() {
            if (isAdmin) {
                isPreviewMode = true;
                setView('customer');
                showMessage("ƒêang xem d∆∞·ªõi d·∫°ng kh√°ch h√†ng", "info");
            }
        }

        function handleLogoClick() {
            if (isAdmin) {
                if (isPreviewMode) {
                    // Admin ƒëang ·ªü ch·∫ø ƒë·ªô preview ‚Üí tho√°t preview v√† v·ªÅ admin
                    isPreviewMode = false;
                    setView('admin-stats');
                    showMessage("ƒê√£ tho√°t ch·∫ø ƒë·ªô xem kh√°ch h√†ng", "info");
                } else {
                    // Admin ƒëang ·ªü trang admin ‚Üí v·ªÅ trang th·ªëng k√™
                    setView('admin-stats');
                }
            } else {
                // Kh√°ch h√†ng ‚Üí v·ªÅ trang kh√°ch
                setView('customer');
            }
            return false; // Prevent default link behavior
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' ‚Ç´';
        }

        // Helper function to get the appropriate price (prefer newPrice, fallback to price)
        function getItemPrice(item) {
            return item.newPrice ? parseFloat(item.newPrice) : parseFloat(item.price);
        }

        // --- Qu·∫£n l√Ω D·ªØ li·ªáu Firebase ---
        const PUBLIC_DATA_PATH = `menuItems`; // ƒê∆°n gi·∫£n h√≥a path cho development
        const PRIVATE_SALES_PATH = `sales/${userId}`;

        // ==================== CATEGORIES MANAGEMENT ====================

        const CATEGORIES_DOC_ID = 'categories_config';

        async function loadCategories() {
            try {
                console.log("üîÑ Loading categories from Firebase...");
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    categories = data.categories || ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'];
                    console.log("‚úÖ Loaded categories:", categories);
                } else {
                    // N·∫øu ch∆∞a c√≥, t·∫°o document m·∫∑c ƒë·ªãnh
                    categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u'];
                    await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                    console.log("‚úÖ Created default categories in Firebase");
                }
            } catch (error) {
                console.error("‚ùå Error loading categories:", error);
                categories = ['ƒê·ªì U·ªëng', 'ƒê·ªì ƒÇn', 'ƒê·ªì Nh·∫≠u']; // Fallback
            }
        }

        async function saveCategories() {
            try {
                console.log("üíæ Saving categories to Firebase...");
                const docRef = doc(db, 'config', CATEGORIES_DOC_ID);
                await setDoc(docRef, { categories: categories, updatedAt: new Date() });
                console.log("‚úÖ Categories saved successfully");
            } catch (error) {
                console.error("‚ùå Error saving categories:", error);
                showMessage("L·ªói khi l∆∞u danh m·ª•c: " + error.message, "error");
            }
        }

        function setupMenuListener() {
            if (!db) {
                console.warn("‚ùå DB ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o");
                return;
            }
            const q = query(collection(db, PUBLIC_DATA_PATH));
            console.log("üîÑ Setting up menu listener for path:", PUBLIC_DATA_PATH);

            onSnapshot(q, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("‚úÖ Loaded menu items:", menuItems.length, "items");
                console.log("üìã Menu items:", menuItems.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    priceType: typeof item.price,
                    newPrice: item.newPrice,
                    newPriceType: typeof item.newPrice
                })));
                console.log("üîç Raw snapshot:", snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));

                // Ki·ªÉm tra currentCategory c√≥ c√≤n active kh√¥ng (c√≥ m√≥n kh√¥ng)
                const activeCategories = categories.filter(cat =>
                    menuItems.some(item => item.category === cat && item.status !== 'deleted')
                );
                if (!activeCategories.includes(currentCategory) && activeCategories.length > 0) {
                    // N·∫øu currentCategory kh√¥ng c√≤n active, chuy·ªÉn v·ªÅ category ƒë·∫ßu ti√™n
                    currentCategory = activeCategories[0];
                    console.log("üîÑ Current category changed to:", currentCategory);
                }

                // Auto-cleanup expired items
                cleanupExpiredItems();

                renderApp();
            }, (error) => {
                console.error("‚ùå L·ªói khi nghe thay ƒë·ªïi menu:", error);
                console.error("‚ùå Error details:", error.code, error.message);
                // Fallback: th·ª≠ load m·ªôt l·∫ßn
                loadMenuItemsOnce();
            });
        }

        async function loadMenuItemsOnce() {
            try {
                console.log("üîÑ Loading menu items once...");
                const querySnapshot = await getDocs(collection(db, PUBLIC_DATA_PATH));
                menuItems = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("‚úÖ Loaded menu items (once):", menuItems.length, "items");
                renderApp();
            } catch (error) {
                console.error("‚ùå Failed to load menu items:", error);
            }
        }
        
        async function saveItem(item) {
            const isNew = !item.id;

            try {
                let imageUrl = item.imageUrl;

                // Handle file upload - Convert to Data URL
                const fileInput = document.getElementById('admin-form-image-file');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    console.log("üì∏ Processing image...");
                    showMessage("ƒêang x·ª≠ l√Ω ·∫£nh...", "info");
                    
                    try {
                        imageUrl = await uploadImage(fileInput.files[0]);
                        showMessage("‚úÖ ·∫¢nh ƒë√£ s·∫µn s√†ng!", "success");
                        console.log("‚úÖ Image ready for save");
                    } catch (error) {
                        showMessage("‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: " + error.message, "error");
                        throw error;
                    }
                }

                // Fallback to placeholder if no image provided
                if (!imageUrl || imageUrl.trim() === '') {
                    imageUrl = `https://via.placeholder.com/400x300/f0d48f/8b542f?text=${encodeURIComponent(item.name.substring(0, 10))}`;
                    console.log("üìù Using placeholder image");
                }

                const itemToSave = {
                    name: item.name,
                    description: item.description,
                    price: parseFloat(item.price),
                    category: item.category,
                    status: item.status || 'active',
                    imageUrl: imageUrl,
                    updatedAt: new Date(),
                };

                // Add size if provided (for drinks)
                if (item.size && item.size.trim() !== '') {
                    itemToSave.size = item.size;
                }

                // Add newPrice if provided, remove if empty/0
                if (item.newPrice && parseFloat(item.newPrice) > 0) {
                    itemToSave.newPrice = parseFloat(item.newPrice);
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(itemToSave).forEach(key => {
                    if (itemToSave[key] === undefined || itemToSave[key] === null) {
                        delete itemToSave[key];
                    }
                });
                // Note: If newPrice is not included, Firestore will remove the field

                if (isNew) {
                    await addDoc(collection(db, PUBLIC_DATA_PATH), itemToSave);
                    console.log("Th√™m m√≥n th√†nh c√¥ng");
                    showMessage("Th√™m m√≥n th√†nh c√¥ng!", "success");
                } else {
                    const itemRef = doc(db, PUBLIC_DATA_PATH, item.id);
                    await updateDoc(itemRef, itemToSave);
                    console.log("C·∫≠p nh·∫≠t m√≥n th√†nh c√¥ng");
                    showMessage("C·∫≠p nh·∫≠t m√≥n th√†nh c√¥ng!", "success");
                }

                // Clear file input
                if (fileInput) fileInput.value = '';

                setView('admin'); // Tr·ªü v·ªÅ trang qu·∫£n l√Ω
            } catch (e) {
                console.error("L·ªói khi l∆∞u m√≥n:", e);
                showMessage("L·ªói khi l∆∞u m√≥n: " + e.message, "error");
            }
        }
        
        async function deleteItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y? M√≥n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v√†o th√πng r√°c.")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'deleted',
                    deletedAt: new Date(),
                    updatedAt: new Date()
                });
                console.log("‚úÖ Chuy·ªÉn m√≥n v√†o th√πng r√°c th√†nh c√¥ng");

                // Reload menu items to reflect changes
                await loadMenuItemsOnce();

                showMessage("ƒê√£ chuy·ªÉn m√≥n v√†o th√πng r√°c!", "success");
            } catch (e) {
                console.error("‚ùå L·ªói khi x√≥a m√≥n:", e);
                showMessage("L·ªói khi x√≥a m√≥n: " + e.message, "error");
            }
        }

        // Convert image to Base64 Data URL (l∆∞u tr·ª±c ti·∫øp trong database)
        async function uploadImage(file) {
            if (!file) return null;

            try {
                console.log("üì∏ Converting image to Data URL...");
                console.log("üìÅ File:", file.name, "Size:", (file.size / 1024).toFixed(2), "KB");

                // Check file size (max 1MB recommended for Data URL)
                if (file.size > 1024 * 1024) {
                    throw new Error("·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 1MB");
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const dataURL = e.target.result;
                        console.log("‚úÖ Image converted successfully!");
                        console.log("üìä Data URL length:", dataURL.length);
                        resolve(dataURL);
                    };
                    
                    reader.onerror = function(error) {
                        console.error("‚ùå Error reading file:", error);
                        reject(error);
                    };
                    
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error("‚ùå Error processing image:", error);
                throw error;
            }
        }

        // Thay ƒë·ªïi m·∫≠t kh·∫©u
        async function changePassword(currentPassword, newPassword) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("Kh√¥ng c√≥ user ƒëƒÉng nh·∫≠p");

                // Re-authenticate v·ªõi password hi·ªán t·∫°i
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);

                // Update password m·ªõi
                await updatePassword(user, newPassword);
                console.log("Password changed successfully");

                showMessage("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
                return true;
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = "L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u";

                if (error.code === 'auth/wrong-password') {
                    errorMessage = "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "M·∫≠t kh·∫©u m·ªõi qu√° y·∫øu";
                }

                showMessage(errorMessage, "error");
                return false;
            }
        }

        // --- Qu·∫£n l√Ω ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            console.log("üîê Attempting login with email:", email);

            try {
                showMessage("ƒêang ƒëƒÉng nh·∫≠p...", "info");
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                console.log("‚úÖ Login successful!");
                console.log("üë§ User:", userCredential.user.email);
                console.log("üÜî UID:", userCredential.user.uid);
                
                // Check if admin
                const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                const isAdminUser = adminEmails.includes(userCredential.user.email);
                
                console.log("üëë Is Admin:", isAdminUser);
                
                if (isAdminUser) {
                    showMessage("‚úÖ ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng! Chuy·ªÉn ƒë·∫øn Dashboard...", "success");
                    console.log("üöÄ Redirecting to Admin Dashboard");
                } else {
                    showMessage("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Nh∆∞ng t√†i kho·∫£n kh√¥ng c√≥ quy·ªÅn Admin.", "info");
                    console.log("‚ö†Ô∏è User is not admin, staying in customer view");
                }
                
                // AuthStateChanged s·∫Ω lo vi·ªác chuy·ªÉn view
            } catch (error) {
                console.error("‚ùå Login failed:", error.code, error.message);
                let errorMessage = "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.";

                if (error.code === 'auth/user-not-found') {
                    errorMessage = "‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "‚ùå Email kh√¥ng h·ª£p l·ªá.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "‚ùå Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                }

                document.getElementById('login-message').textContent = errorMessage;
                showMessage(errorMessage, "error");
                console.log("‚ùå Error details:", error);
            }
        }
        
        async function handleLogout() {
            try {
                console.log("üîì Logging out...");
                await signOut(auth);
                console.log("‚úÖ Logout successful");
                showMessage("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!", "success");
                isPreviewMode = false;
                // AuthStateChanged s·∫Ω lo vi·ªác chuy·ªÉn view
            } catch (error) {
                console.error("‚ùå Logout error:", error);
                showMessage("L·ªói khi ƒëƒÉng xu·∫•t", "error");
            }
        }

        // --- Kh·ªüi t·∫°o v√† Qu·∫£n l√Ω Auth ---
        // ==================== SESSION MANAGEMENT (COOKIE) ====================

        let currentSessionId = null; // ID session c·ªßa kh√°ch
        let guestOrders = []; // L·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa kh√°ch trong session

        // T·∫°o session ID duy nh·∫•t
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // L∆∞u session v√†o cookie (expire sau 2 gi·ªù)
        function saveSessionToCookie() {
            const sessionData = {
                sessionId: currentSessionId,
                tableNumber: currentTableNumber,
                orders: guestOrders,
                createdAt: new Date().toISOString()
            };

            const expirationTime = new Date();
            expirationTime.setTime(expirationTime.getTime() + (30 * 60 * 1000)); // 30 ph√∫t
            // expirationTime.setTime(expirationTime.getTime() + (1 * 60 * 1000)); // 1 ph√∫t (ƒë·ªÉ test)
            // expirationTime.setTime(expirationTime.getTime() + (2 * 60 * 60 * 1000)); // 2 gi·ªù (production)

            document.cookie = `guest_session=${JSON.stringify(sessionData)}; expires=${expirationTime.toUTCString()}; path=/`;

            console.log('üíæ Session saved to cookie:', sessionData);
        }

        // ƒê·ªçc session t·ª´ cookie
        function loadSessionFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'guest_session') {
                    try {
                        const sessionData = JSON.parse(decodeURIComponent(value));

                        // Ki·ªÉm tra xem session c√≥ c√≤n h·ª£p l·ªá kh√¥ng (1 ph√∫t)
                        const sessionAge = Date.now() - new Date(sessionData.createdAt).getTime();
                        const maxAge = 1 * 60 * 1000; // 1 ph√∫t (ƒë·ªÉ test)

                        console.log('üç™ Cookie check:', {
                            sessionAge: Math.round(sessionAge / 1000) + 's',
                            maxAge: Math.round(maxAge / 1000) + 's',
                            isExpired: sessionAge >= maxAge,
                            createdAt: new Date(sessionData.createdAt).toLocaleTimeString(),
                            now: new Date().toLocaleTimeString()
                        });

                        if (sessionAge < maxAge) {
                            currentSessionId = sessionData.sessionId;
                            currentTableNumber = sessionData.tableNumber;
                            guestOrders = sessionData.orders || [];
                            userRole = 'guest';

                            console.log('üìñ Session loaded from cookie:', sessionData);
                            return true;
                        } else {
                            // Session h·∫øt h·∫°n, x√≥a cookie
                            clearSessionCookie();
                            console.log('‚è∞ Session expired, cleared cookie');
                        }
                    } catch (error) {
                        console.error('Error parsing session cookie:', error);
                        clearSessionCookie();
                    }
                    break;
                }
            }
            return false;
        }

        // X√≥a session cookie
        function clearSessionCookie() {
            document.cookie = 'guest_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            currentSessionId = null;
            currentTableNumber = null;
            guestOrders = [];
            userRole = 'guest';
        }

        // ==================== TABLE MANAGEMENT ====================

        // ƒê·ªçc table number t·ª´ URL (QR code scan)
        function checkTableFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const tableNumber = urlParams.get('table');

            if (tableNumber) {
                // Ki·ªÉm tra xem b√†n c√≥ t·ªìn t·∫°i kh√¥ng (ch·ªâ check n·∫øu ƒë√£ load tables)
                if (tables.length > 0) {
                    const tableExists = tables.some(t => t.tableNumber === tableNumber);
                    if (!tableExists) {
                        console.warn(`Table ${tableNumber} does not exist`);
                        showMessage(`B√†n ${tableNumber} kh√¥ng t·ªìn t·∫°i!`, 'error');
                        return;
                    }
                }

                // Ki·ªÉm tra xem c√≥ session c≈© v·ªõi b√†n kh√°c kh√¥ng
                if (currentTableNumber && currentTableNumber !== tableNumber) {
                    // ƒê·ªïi b√†n m·ªõi, t·∫°o session m·ªõi
                    console.log(`üîÑ Changing table from ${currentTableNumber} to ${tableNumber}`);
                    guestOrders = []; // Reset orders khi ƒë·ªïi b√†n
                }

                currentTableNumber = tableNumber;
                userRole = 'guest';

                // T·∫°o session ID m·ªõi n·∫øu ch∆∞a c√≥
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                }

                console.log(`üçΩÔ∏è Guest accessing from Table ${tableNumber} (Session: ${currentSessionId})`);
                showMessage(`Ch√†o m·ª´ng ƒë·∫øn B√†n ${tableNumber}!`, 'success');

                // L∆∞u session v√†o cookie
                saveSessionToCookie();

                // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t header
                renderApp();
            }
        }
        
        // Setup realtime listener cho tables
        function setupTablesListener() {
            if (!db) return;
            
            try {
                console.log("üì° Setting up tables realtime listener...");
                const tablesRef = collection(db, 'tables');
                
                onSnapshot(tablesRef, (snapshot) => {
                    tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("üçΩÔ∏è Tables updated:", tables.length);
                    
                    // Re-render n·∫øu ƒëang ·ªü admin tables view
                    if (isAdmin && currentView === 'admin-tables') {
                        renderApp();
                    }

                    // Re-render n·∫øu ƒëang ·ªü admin view (for backward compatibility)
                    if (isAdmin && currentView === 'admin') {
                        renderApp();
                    }

                    // C·∫≠p nh·∫≠t modal ch·ªçn b√†n n·∫øu ƒëang m·ªü
                    const tableModal = document.getElementById('table-selection-modal');
                    if (tableModal && !tableModal.classList.contains('hidden')) {
                        console.log("üîÑ Updating table selection modal");
                        // Re-load danh s√°ch b√†n trong modal
                        const content = document.getElementById('table-selection-content');
                        if (content) {
                            const availableTables = tables.filter(table => !table.status || table.status === 'available');
                            console.log("‚úÖ Available tables for modal:", availableTables);
                            content.innerHTML = availableTables.map(table => `
                                <button onclick="selectTable('${table.tableNumber}')" class="p-2 sm:p-3 lg:p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-1 sm:space-y-2 active:scale-95">
                                    <i data-lucide="table-2" class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-teal-600"></i>
                                    <span class="font-semibold text-gray-800 text-sm sm:text-base">B√†n ${table.tableNumber}</span>
                                    <span class="text-xs text-green-600 bg-green-100 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full">${table.status || 'Tr·ªëng'}</span>
                                </button>
                            `).join('');
                            renderLucideIcons();
                        }
                    }
                });
                
            } catch (error) {
                console.error("Error setting up tables listener:", error);
            }
        }

        // Load tables m·ªôt l·∫ßn (fallback n·∫øu realtime ch∆∞a load)
        async function loadTablesOnce() {
            if (!db || tables.length > 0) return; // ƒê√£ c√≥ data r·ªìi

            try {
                console.log("üîÑ Loading tables once...");
                const tablesRef = collection(db, 'tables');
                const snapshot = await getDocs(tablesRef);
                tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("‚úÖ Tables loaded once:", tables.length);
                console.log("üìã Tables data:", tables);
            } catch (error) {
                console.error("Error loading tables once:", error);
            }
        }
        
        // Th√™m b√†n m·ªõi
        async function addTable() {
            const tableNumber = document.getElementById('new-table-number').value.trim();
            
            if (!tableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "warning");
                return;
            }
            
            // Ki·ªÉm tra tr√πng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`B√†n ${tableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }
            
            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                await addDoc(collection(db, 'tables'), tableData);
                
                showMessage(`‚úÖ ƒê√£ th√™m B√†n ${tableNumber}`, "success");
                closeAddTableModal();
                
            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("L·ªói th√™m b√†n: " + error.message, "error");
            }
        }
        
        // X√≥a b√†n
        async function deleteTable(tableId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†n n√†y?")) return;
            
            try {
                await deleteDoc(doc(db, 'tables', tableId));
                showMessage("‚úÖ ƒê√£ x√≥a b√†n", "success");
                
            } catch (error) {
                console.error("Error deleting table:", error);
                showMessage("L·ªói x√≥a b√†n: " + error.message, "error");
            }
        }
        
        // Hi·ªÉn th·ªã QR Code c·ªßa b√†n
        function showTableQR(tableId, tableNumber) {
            const modal = document.getElementById('qr-modal');
            const qrContainer = document.getElementById('qr-code-container');
            const tableInfo = document.getElementById('qr-table-info');
            
            // Clear previous QR
            qrContainer.innerHTML = '';
            
            // T·∫°o URL v·ªõi table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;
            
            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">B√†n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">Qu√©t QR code n√†y ƒë·ªÉ v√†o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function closeQRModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }
        
        function openAddTableModal() {
            document.getElementById('add-table-modal').classList.remove('hidden');
        }
        
        function closeAddTableModal() {
            document.getElementById('add-table-modal').classList.add('hidden');
            document.getElementById('new-table-number').value = '';
        }
        
        // Download QR Code as image
        function downloadQR() {
            const qrCanvas = document.querySelector('#qr-code-container canvas');
            if (!qrCanvas) return;
            
            const tableNumber = document.querySelector('#qr-table-info .text-teal-600').textContent;
            
            const link = document.createElement('a');
            link.download = `QR-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }
        
        function initFirebase() {
            try {
                // Debug: Check current cookies
                console.log('üç™ Current cookies:', document.cookie);

                // Load session t·ª´ cookie tr∆∞·ªõc
                loadSessionFromCookie();

                // Ki·ªÉm tra table t·ª´ URL (c√≥ th·ªÉ override session c≈©)
                checkTableFromURL();

                console.log("üöÄ Initializing Firebase with config:", firebaseConfig);
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    storage = getStorage(app);
                    console.log("‚úÖ Firebase initialized successfully");
                } else {
                    console.warn("‚ùå Firebase Config kh√¥ng t·ªìn t·∫°i. D√πng ch·∫ø ƒë·ªô Demo.");
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Check if user is admin (multiple admin emails supported)
                        const adminEmails = ['binhbiinshop@admin.com', 'duong3112@gmail.com'];
                        isAdmin = adminEmails.includes(user.email);
                        
                        console.log("üë§ User authenticated:", user.email);
                        console.log("üëë Is Admin:", isAdmin);
                        
                        if (__initial_auth_token && user.isAnonymous) {
                            // ƒê√¢y l√† logic ƒë·∫∑c bi·ªát cho m√¥i tr∆∞·ªùng Canvas, d√πng token ban ƒë·∫ßu
                            await signInWithCustomToken(auth, __initial_auth_token);
                            // Sau khi ƒëƒÉng nh·∫≠p b·∫±ng custom token, user v·∫´n l√† ·∫©n danh.
                            userId = auth.currentUser.uid;
                            isAdmin = false;
                        }
                        
                        if (db) {
                            setupMenuListener();
                            setupTablesListener(); // Always setup for table selection modal

                            // Load categories from Firebase
                            loadCategories();

                            // Setup listeners for admin
                            if (isAdmin) {
                                setupOrdersListener();
                                setupTablesListener(); // Always setup for admin tables view
                            }
                        }
                        
                        // Chuy·ªÉn v·ªÅ tr·∫°ng th√°i Kh√°ch h√†ng n·∫øu kh√¥ng ph·∫£i Admin
                        if (isAdmin && currentView === 'login') {
                           console.log("üöÄ Switching to Admin Dashboard");
                           setView('admin-stats');
                           showMessage("Ch√†o m·ª´ng Admin! üëë", "success");
                        } else if (!isAdmin && currentView === 'login') {
                           console.log("üë§ Switching to Customer view");
                           setView('customer');
                        } else if (isAdmin && currentView === 'customer' && !isPreviewMode) {
                           // Admin ƒëƒÉng nh·∫≠p nh∆∞ng ƒëang ·ªü trang customer ‚Üí chuy·ªÉn v·ªÅ admin
                           console.log("üöÄ Admin logged in, redirecting to admin dashboard");
                           setView('admin-stats');
                        }
                    } else {
                        // User ƒë√£ ƒëƒÉng xu·∫•t
                        isAdmin = false;
                        userId = crypto.randomUUID(); // D√πng ID ng·∫´u nhi√™n cho kh√°ch ·∫©n danh
                        if (db) {
                            // T·∫°m th·ªùi b·ªè anonymous auth ƒë·ªÉ tr√°nh l·ªói config
                            // if (!__initial_auth_token) await signInAnonymously(auth);
                            console.log("üîÑ Setting up menu listener without auth...");
                            setupMenuListener();

                            // Load categories from Firebase
                            loadCategories();
                        }
                        setView('customer');
                    }
                    renderApp();
                });
            } catch (e) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
            }
        }


        // --- Render UI ---
        function renderHeader() {
            const loginButton = isAdmin
                ? `<button onclick="handleLogout()" class="px-4 py-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition duration-150 flex items-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>ƒêƒÉng Xu·∫•t</span>
                </button>`
                : `<button onclick="setView('login')" class="px-4 py-2 rounded-full bg-orange-600 text-white hover:bg-orange-700 transition duration-150">ƒêƒÉng Nh·∫≠p Admin</button>`;

            // ƒê·∫øm ƒë∆°n h√†ng ch·ªù nh·∫≠n (ch·ªâ admin th·∫•y)
            const pendingOrdersCount = isAdmin ? orders.filter(o => o.status === 'ordered').length : 0;
            
            const adminToggle = isAdmin
                ? `<button onclick="toggleAdminMode()" class="flex items-center justify-center w-10 h-10 rounded-full ${currentView === 'admin' ? 'bg-blue-500 hover:bg-blue-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white font-semibold transition duration-150" title="${currentView === 'admin' ? 'Xem Trang Kh√°ch' : 'Qu·∫£n L√Ω Admin'}">
                    <i data-lucide="${currentView === 'admin' ? 'eye' : 'settings'}" class="w-5 h-5"></i>
                </button>` : '';
            
            const adminBadge = isAdmin && !isPreviewMode
                ? `<span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">üëë ADMIN</span>`
                : isPreviewMode
                ? `<span class="px-3 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">üëÅÔ∏è PREVIEW</span>`
                : '';

            // Admin page title
            const adminPageTitle = isAdmin && currentView.startsWith('admin') ? (() => {
                const titles = {
                    'admin-stats': 'üìä Th·ªëng K√™',
                    'admin-orders': 'üìã ƒê∆°n H√†ng',
                    'admin-tables': 'üçΩÔ∏è B√†n ƒÇn',
                    'admin-menu': 'üçΩÔ∏è Menu'
                };
                return titles[currentView] || 'üëë Admin';
            })() : '';
            
            // Admin navigation buttons
            const adminNavButtons = isAdmin ? `
                <div class="flex items-center space-x-2">
                    <button onclick="setView('admin-stats')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-stats' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Th·ªëng K√™</span>
                    </button>
                    <button onclick="setView('admin-orders')" class="relative flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-orders' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">ƒê∆°n H√†ng</span>
                        ${pendingOrdersCount > 0 ? `
                            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform bg-red-600 rounded-full animate-pulse">
                                ${pendingOrdersCount}
                            </span>
                        ` : ''}
                    </button>
                    <button onclick="setView('admin-tables')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-tables' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-teal-500 hover:bg-teal-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="table-2" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">B√†n ƒÇn</span>
                    </button>
                    <button onclick="setView('admin-menu')" class="flex items-center space-x-2 px-4 py-2 rounded-full ${currentView === 'admin-menu' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-orange-500 hover:bg-orange-600'} text-white font-semibold transition duration-150 shadow-lg">
                        <i data-lucide="coffee" class="w-5 h-5"></i>
                        <span class="hidden lg:inline">Menu</span>
                    </button>
                </div>
            ` : '';
            
             // T√≠nh t·ªïng s·ªë m√≥n trong gi·ªè h√†ng
             const totalItemsInCart = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);

            return `
                <header class="sticky top-0 z-20 bg-amber-100/90 backdrop-blur-sm shadow-md border-b border-yellow-700/50">
                    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-3 sm:py-4">
                        <!-- Logo Qu√°n + S·ªë B√†n -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                                <a href="#" onclick="handleLogoClick()" class="block"><img src="logo.png" alt="Logo" class="w-10 h-10 border-2 border-amber-200 rounded-full sm:w-6 sm:h-6 lg:w-8 lg:h-8 flex-shrink-0 object-contain"></a>
                                <div class="min-w-0 flex-1">
                                    
                                        <h1 class="text-sm sm:text-lg lg:text-xl font-bold text-amber-900 font-serif truncate"><a href="#" onclick="handleLogoClick()" class="block">Chill Coffee</a></h1>
                                    
                                    ${adminPageTitle ? `
                                        <div class="mt-0.5">
                                            <p class="text-xs sm:text-sm text-red-600 font-semibold truncate">${adminPageTitle}</p>
                                        </div>
                                    ` : currentTableNumber ? `
                                        <div class="flex items-center gap-1 sm:gap-2 mt-0.5">
                                            <p class="text-xs sm:text-sm text-teal-600 font-semibold flex items-center gap-1 truncate">
                                                <i data-lucide="table-2" class="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0"></i>
                                                <span class="truncate">B√†n ${currentTableNumber}</span>
                                            </p>
                                            ${guestOrders.length > 0 ? `
                                                <span class="text-xs bg-teal-100 text-teal-700 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full flex-shrink-0">
                                                    ${guestOrders.length} ƒë∆°n
                                                </span>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Always Visible Actions (Contact & Table Selection & Orders & Cart) -->
                            <div class="flex items-center space-x-2 sm:space-x-3 y-2">
                                ${!isAdmin ? `
                                    <a href="#" class="hidden sm:flex items-center text-amber-800 hover:text-orange-600 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="phone" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">Li√™n H·ªá</span>
                                    </a>
                                    <a href="#" class="sm:hidden p-1 rounded-full text-amber-800 hover:text-orange-600 transition duration-150">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                    </a>
                                ` : ''}
                                ${!currentTableNumber && !isAdmin ? `
                                    <button onclick="showTableSelectionModal()" class="hidden md:flex items-center text-teal-600 hover:text-teal-800 transition duration-150 text-xs whitespace-nowrap">
                                        <i data-lucide="table-2" class="w-4 h-4 sm:w-5 sm:h-5 inline mr-0.5"></i>
                                        <span class="hidden lg:inline">Ch·ªçn B√†n</span>
                                        <span class="lg:hidden">B√†n</span>
                                    </button>
                                ` : ''}
                                ${!isAdmin ? `
                                <button onclick="showMyOrders()" class="p-1 sm:p-1.5 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-150 shadow-sm active:scale-95" title="ƒê∆°n h√†ng c·ªßa t√¥i">
                                    <i data-lucide="clipboard" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                </button>
                                ` : ''}
                                ${isAdmin ? `
                                <button onclick="setView('admin-orders')" class="md:hidden relative p-1 sm:p-1.5 rounded-full bg-purple-500 text-white hover:bg-purple-600 transition duration-150 shadow-sm active:scale-95" title="ƒê∆°n h√†ng">
                                    <i data-lucide="clipboard-list" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    ${pendingOrdersCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full animate-pulse">${pendingOrdersCount}</span>` : ''}
                                </button>
                                ` : ''}
                                ${!isAdmin || isPreviewMode ? `
                                    <button onclick="openCart()" class="relative p-1 sm:p-1.5 rounded-full bg-orange-500 text-white hover:bg-orange-600 transition duration-150 shadow-sm">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                        ${totalItemsInCart > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full animate-pulse">${totalItemsInCart}</span>` : ''}
                                    </button>
                                ` : ''}
                            </div>

                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-amber-200 transition duration-150" id="mobile-menu-btn">
                            <i data-lucide="menu" class="w-5 h-5 text-amber-800"></i>
                        </button>

                        <!-- Desktop Navigation -->
                        <div class="hidden md:flex items-center space-x-2 lg:space-x-3 ml-6">
                              ${adminBadge}
                              ${isAdmin ? adminNavButtons : ''}
                              ${adminToggle}
                            ${loginButton}
                        </div>

                        <!-- Mobile Menu Dropdown -->
                        <div id="mobile-menu" class="absolute top-full left-0 right-0 bg-amber-50 shadow-lg border-t border-amber-200 hidden md:hidden z-30">
                            <div class="px-4 py-3 space-y-2">
                                ${isAdmin ? `
                                    <!-- Admin Mobile Menu -->
                                    <button onclick="setView('admin-stats'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-stats' ? 'bg-blue-100' : ''}">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">üìä Th·ªëng K√™</span>
                                    </button>
                                    <button onclick="setView('admin-orders'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-orders' ? 'bg-purple-100' : ''}">
                                        <i data-lucide="clipboard-list" class="w-5 h-5 text-purple-600"></i>
                                        <span class="text-purple-600 font-medium">üìã ƒê∆°n H√†ng</span>
                                        ${pendingOrdersCount > 0 ? `<span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingOrdersCount}</span>` : ''}
                                    </button>
                                    <button onclick="setView('admin-tables'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-tables' ? 'bg-teal-100' : ''}">
                                        <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                        <span class="text-teal-600 font-medium">üçΩÔ∏è B√†n ƒÇn</span>
                                    </button>
                                    <button onclick="setView('admin-menu'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-menu' ? 'bg-orange-100' : ''}">
                                        <i data-lucide="coffee" class="w-5 h-5 text-orange-600"></i>
                                        <span class="text-orange-600 font-medium">üçΩÔ∏è Menu</span>
                                    </button>
                                    <button onclick="setView('admin-trash'); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150 ${currentView === 'admin-trash' ? 'bg-gray-100' : ''}">
                                        <i data-lucide="trash-2" class="w-5 h-5 text-gray-600"></i>
                                        <span class="text-gray-600 font-medium">üóëÔ∏è Th√πng R√°c</span>
                                    </button>
                                    <button onclick="previewAsCustomer(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                        <i data-lucide="eye" class="w-5 h-5 text-green-600"></i>
                                        <span class="text-green-600 font-medium">üëÅÔ∏è Xem Ph√≠a Kh√°ch</span>
                                    </button>
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        <button onclick="handleChangePassword(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="lock" class="w-5 h-5 text-purple-600"></i>
                                            <span class="text-purple-600 font-medium">üîê ƒê·ªïi M·∫≠t Kh·∫©u</span>
                                        </button>
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg mt-2').replace('ƒêƒÉng Nh·∫≠p Admin', 'üë®‚Äçüíº ƒêƒÉng Nh·∫≠p Admin').replace('ƒêƒÉng Xu·∫•t', 'üö™ ƒêƒÉng Xu·∫•t')}
                                    </div>
                                ` : `
                                    <!-- Guest Mobile Menu -->
                                    <button onclick="showMyOrders(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                        <i data-lucide="clipboard" class="w-5 h-5 text-blue-600"></i>
                                        <span class="text-blue-600 font-medium">ƒê∆°n H√†ng C·ªßa T√¥i</span>
                                    </button>
                                    ${!currentTableNumber ? `
                                        <button onclick="showTableSelectionModal(); toggleMobileMenu()" class="w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-amber-100 transition duration-150">
                                            <i data-lucide="table-2" class="w-5 h-5 text-teal-600"></i>
                                            <span class="text-teal-600 font-medium">Ch·ªçn B√†n</span>
                                        </button>
                                    ` : ''}
                                    <div class="border-t border-amber-200 pt-2 mt-3">
                                        ${loginButton.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg').replace('ƒêƒÉng Nh·∫≠p Admin', 'üë®‚Äçüíº ƒêƒÉng Nh·∫≠p Admin').replace('ƒêƒÉng Xu·∫•t', 'üö™ ƒêƒÉng Xu·∫•t')}
                                    </div>
                                `}
                                ${adminToggle && !isAdmin ? `<div class="border-t border-amber-200 pt-2 mt-2">${adminToggle.replace('px-4 py-2 rounded-full', 'w-full px-3 py-2 rounded-lg')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderMenuSelection() {
            // Ch·ªâ hi·ªÉn th·ªã categories c√≥ √≠t nh·∫•t 1 m√≥n active (kh√¥ng ph·∫£i deleted)
            const activeCategories = categories.filter(cat =>
                menuItems.some(item => item.category === cat && item.status !== 'deleted')
            );

            return `
                <div class="flex justify-center p-2 sm:p-3 bg-amber-50 shadow-inner sticky top-[64px] sm:top-[68px] z-10 overflow-x-auto">
                    <div class="flex space-x-1 sm:space-x-2 min-w-max">
                        ${activeCategories.map(cat => `
                            <button onclick="setCategory('${cat}')" class="${currentCategory === cat ? 'bg-orange-600 text-white shadow-lg' : 'bg-white text-amber-900 hover:bg-amber-200'} font-medium py-1.5 px-3 sm:px-4 rounded-full transition duration-150 text-xs sm:text-sm whitespace-nowrap active:scale-95">
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // ·∫®n m√≥n ƒë√£ x√≥a cho kh√°ch h√†ng v√† admin preview mode
        function renderCustomerMenu() {
            const filteredItems = menuItems.filter(item => {
                // ·∫®n m√≥n ƒë√£ x√≥a cho kh√°ch h√†ng
                if (!isAdmin && item.status === 'deleted') return false;
                if (isAdmin && item.status === 'deleted') return false;
                return item.category === currentCategory;
            });
            
            // Ki·ªÉm tra xem c√≥ ph·∫£i admin ƒëang ·ªü mode admin kh√¥ng (·∫©n n√∫t +)
            const showAddButton = !isAdmin || isPreviewMode;
            
            if (currentCategory === 'ƒê·ªì U·ªëng') {
                // Layout ƒê·ªì U·ªëng: 1 m√≥n/h√†ng, ·∫£nh tr√°i
                return filteredItems.map(item => {
                    const statusBadge = getStatusBadge(item.status);
                    const isOutOfStock = item.status === 'out_of_stock';
                    
                    return `
                    <div class="flex items-center bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 p-2 sm:p-3 border border-amber-200 ${isOutOfStock ? 'opacity-60' : ''}">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 sm:w-16 sm:h-16 lg:w-20 lg:h-20 object-cover rounded-md mr-2 sm:mr-3 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/96x96/f0d48f/8b542f?text=N∆∞·ªõc'">
                        <div class="flex-grow min-w-0">
                            <div class="flex items-start justify-between gap-1 sm:gap-2 mb-1">
                                <h3 class="text-sm sm:text-base font-medium text-amber-900 truncate">${item.name}</h3>
                                ${showAddButton && !isOutOfStock ? `
                                    <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 flex-shrink-0 shadow-sm active:scale-95">
                                        <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-1 sm:gap-2 mb-1">
                                ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded whitespace-nowrap">${item.size}</span>` : ''}
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-500 mb-1 line-clamp-2">${item.description}</p>
                            <div class="flex items-center justify-between gap-1 sm:gap-2">
                                <div class="flex items-center gap-1 sm:gap-2">
                                    ${item.newPrice ?
                                        (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                            // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                                            `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                            // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                                            `<div class="flex items-center gap-1">
                                                <span class="text-xs sm:text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>
                                             </div>`
                                        ) :
                                        // Kh√¥ng c√≥ gi√° m·ªõi: ch·ªâ hi·ªán gi√° c≈©
                                        `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                    }
                                </div>
                                ${isAdmin && !isPreviewMode ? `<button onclick="openPriceModal('${item.id}')" class="px-1.5 py-0.5 sm:px-2 sm:py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-150">üí∞</button>` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('');
            } else {
                // Layout ƒê·ªì ƒÇn/ƒê·ªì Nh·∫≠u: 2 m√≥n/h√†ng, khung vu√¥ng
                return `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 p-3 sm:p-4">
                        ${filteredItems.map(item => {
                            const statusBadge = getStatusBadge(item.status);
                            const isOutOfStock = item.status === 'out_of_stock';
                            
                            return `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-amber-300 flex flex-col hover:shadow-lg transition duration-300 ${isOutOfStock ? 'opacity-60' : ''}">
                                <div class="relative">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-24 sm:h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x160/f0d48f/8b542f?text=M√≥n+ƒÇn'">
                                    <div class="absolute top-1 right-1 sm:top-2 sm:right-2">
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="p-3 flex flex-col flex-grow">
                                    <h3 class="text-sm sm:text-base font-semibold text-amber-900 mb-1">${item.name} ${item.size ? `<span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded ml-1">${item.size}</span>` : ''}</h3>
                                    <p class="text-xs text-gray-500 line-clamp-2 mb-2">${item.description}</p>
                                    <div class="mt-auto flex justify-between items-center">
                                        <div class="flex items-center gap-1 sm:gap-2">
                                            ${item.newPrice ?
                                                (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                    // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                                                    `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>` :
                                                    // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                                                    `<span class="text-sm text-gray-500 line-through">${formatCurrency(item.price)}</span>
                                                     <span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.newPrice)}</span>`
                                                ) :
                                                // Kh√¥ng c√≥ gi√° m·ªõi: ch·ªâ hi·ªán gi√° c≈©
                                                `<span class="text-base sm:text-lg font-semibold text-orange-600">${formatCurrency(item.price)}</span>`
                                            }
                                            ${isAdmin && !isPreviewMode ? `<button onclick="openPriceModal('${item.id}')" class="ml-1 px-1 py-0.5 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">üí∞</button>` : ''}
                                        </div>
                                        ${showAddButton && !isOutOfStock ? `
                                            <button onclick="updateCart('${item.id}', 1)" class="p-1.5 sm:p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150 shadow-sm">
                                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            }
        }

        function getStatusBadge(status) {
            if (!status || status === 'active') return '';

            const badges = {
                'hot': '<span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">üî• B√ÅN CH·∫†Y</span>',
                'new': '<span class="px-2 py-1 bg-green-500 text-white text-xs font-bold rounded-full">üÜï M·ªöI</span>',
                'sale': '<span class="px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded-full">üí∞ SALE</span>',
                'best_seller': '<span class="px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded-full">‚≠ê BEST SELLER</span>',
                'out_of_stock': '<span class="px-2 py-1 bg-gray-500 text-white text-xs font-bold rounded-full">‚ùå H·∫æT H√ÄNG</span>',
                'coming_soon': '<span class="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded-full">‚è≥ S·∫ÆP C√ì</span>',
                'deleted': '<span class="px-2 py-1 bg-black text-white text-xs font-bold rounded-full">üóëÔ∏è ƒê√É X√ìA</span>'
            };

            return badges[status] || '';
        }

        function getCategoryIcon(category) {
            const icons = {
                'ƒê·ªì U·ªëng': '‚òï',
                'ƒê·ªì ƒÇn': 'üçΩÔ∏è',
                'ƒê·ªì Nh·∫≠u': 'üç∫'
            };
            return icons[category] || 'üìÇ';
        }

        // Category Management Functions
        let editingCategory = null;

        function editCategory(categoryName) {
            editingCategory = categoryName;
            document.getElementById('new-category-name').value = categoryName;
            document.getElementById('category-modal').classList.remove('hidden');
            document.getElementById('category-modal').querySelector('h3').textContent = '‚úèÔ∏è S·ª≠a Danh M·ª•c';
            document.querySelector('button[onclick="addNewCategory()"]').textContent = 'C·∫≠p Nh·∫≠t';
            document.querySelector('button[onclick="addNewCategory()"]').onclick = () => updateCategory();
        }

        async function updateCategory() {
            const newName = document.getElementById('new-category-name').value.trim();
            if (!newName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (newName !== editingCategory && categories.includes(newName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategory);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategory) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ƒê√£ c·∫≠p nh·∫≠t danh m·ª•c: ${editingCategory} ‚Üí ${newName}`, "success");
                closeCategoryModal();
                renderApp();
            }
        }

        async function deleteCategory(categoryName) {
            const index = categories.indexOf(categoryName);
            if (index < 3) {
                showMessage("Kh√¥ng th·ªÉ x√≥a 3 danh m·ª•c m·∫∑c ƒë·ªãnh!", "error");
                return;
            }

            const itemsInCategory = menuItems.filter(item => item.category === categoryName);
            if (itemsInCategory.length > 0) {
                const confirmDelete = confirm(`Danh m·ª•c "${categoryName}" c√≥ ${itemsInCategory.length} m√≥n. B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?\n\nT·∫•t c·∫£ m√≥n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang "ƒê·ªì ƒÇn".`);
                if (!confirmDelete) return;

                // Move items to default category
                itemsInCategory.forEach(item => {
                    updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                        category: 'ƒê·ªì ƒÇn',
                        updatedAt: new Date()
                    });
                });
            }

            categories.splice(index, 1);
            await saveCategories();
            showMessage(`ƒê√£ x√≥a danh m·ª•c: ${categoryName}`, "success");
            renderApp();
        }

        // Price Update Modal
        let currentPriceUpdateItem = null;

        function openPriceModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            currentPriceUpdateItem = item;

            const modalContent = document.getElementById('price-modal-content');
            const oldPrice = item.price;
            const newPrice = item.newPrice || '';

            modalContent.innerHTML = `
                        <div class="mb-4">
                    <h4 class="font-semibold text-amber-900 mb-2">${item.name}</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° Hi·ªán T·∫°i</label>
                            <div class="text-lg font-bold text-orange-600">
                                ${formatCurrency(oldPrice)}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° M·ªõi (C√≥ Th·ªÉ B·ªè Tr·ªëng)</label>
                            <input type="number" id="new-price-input" value="${newPrice}" placeholder="Nh·∫≠p gi√° m·ªõi..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën x√≥a gi√° m·ªõi</p>
                        </div>

                        ${newPrice ? `
                            <div class="p-3 rounded-lg bg-amber-50 border border-amber-200">
                                <div class="text-sm text-amber-800">
                                    <strong>Preview hi·ªÉn th·ªã:</strong><br>
                                    ${parseFloat(newPrice) >= oldPrice ?
                                        `Ch·ªâ hi·ªán: ${formatCurrency(parseFloat(newPrice))}` :
                                        `G·∫°ch ${formatCurrency(oldPrice)} ‚Üí ${formatCurrency(parseFloat(newPrice))}`
                                    }
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('price-modal').classList.remove('hidden');
        }

        function closePriceModal() {
            document.getElementById('price-modal').classList.add('hidden');
            currentPriceUpdateItem = null;
        }

        async function savePriceUpdate() {
            if (!currentPriceUpdateItem) return;

            const newPriceInput = document.getElementById('new-price-input');
            const newPriceValue = newPriceInput.value.trim();

            try {
                const updateData = {
                    name: currentPriceUpdateItem.name,
                    description: currentPriceUpdateItem.description,
                    price: currentPriceUpdateItem.price,
                    category: currentPriceUpdateItem.category,
                    status: currentPriceUpdateItem.status,
                    imageUrl: currentPriceUpdateItem.imageUrl,
                    updatedAt: new Date()
                };

                // Only add size if it exists and is not null/undefined
                if (currentPriceUpdateItem.size && currentPriceUpdateItem.size.trim() !== '') {
                    updateData.size = currentPriceUpdateItem.size;
                }

                if (newPriceValue === '') {
                    // X√≥a gi√° m·ªõi, ch·ªâ gi·ªØ gi√° c≈©
                    // Firestore s·∫Ω x√≥a field newPrice n·∫øu kh√¥ng include
                } else {
                    // C·∫≠p nh·∫≠t gi√° m·ªõi
                    const newPriceNum = parseFloat(newPriceValue);
                    if (newPriceNum <= 0) {
                        showMessage("Gi√° ph·∫£i l·ªõn h∆°n 0!", "error");
                        return;
                    }

                    // Lu√¥n lu√¥n c·∫≠p nh·∫≠t newPrice
                    updateData.newPrice = newPriceNum;
                    showMessage("C·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!", "success");
                }

                // Filter out undefined values to prevent Firestore errors
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === undefined) {
                        delete updateData[key];
                    }
                });

                await updateDoc(doc(db, PUBLIC_DATA_PATH, currentPriceUpdateItem.id), updateData);
                showMessage("C·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!", "success");

                closePriceModal();
                // Refresh data
                loadMenuItemsOnce();

            } catch (error) {
                console.error("Error updating price:", error);
                showMessage("L·ªói khi c·∫≠p nh·∫≠t gi√°: " + error.message, "error");
            }
        }

        // Category Management
        function openCategoryModal() {
            console.log('Opening category modal...');
            const modal = document.getElementById('category-modal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.classList.remove('hidden');
                const input = document.getElementById('new-category-name');
                if (input) {
                    input.focus();
                }
                console.log('Category modal opened successfully');
            } else {
                console.error('Category modal not found!');
            }
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('new-category-name').value = '';
            resetCategoryModal();
        }

        async function addNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            if (!categoryName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ƒê√£ th√™m danh m·ª•c: ${categoryName}`, "success");
            closeCategoryModal();
            renderApp(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t menu selection
        }

        function resetCategoryModal() {
            editingCategory = null;
            document.getElementById('category-modal').querySelector('h3').textContent = '‚ûï Th√™m Danh M·ª•c M·ªõi';
            document.querySelector('button[onclick*="addNewCategory"]').textContent = 'Th√™m';
            document.querySelector('button[onclick*="addNewCategory"]').onclick = () => addNewCategory();
        }
        
        function renderLoginView() {
            return `
                <div class="flex justify-center items-center py-20 bg-amber-50 min-h-screen pb-16 sm:pb-20">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-yellow-700/50">
                        <h2 class="text-3xl font-bold text-center text-amber-900 mb-6">üëë ƒêƒÉng Nh·∫≠p Admin</h2>
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <label for="email" class="block text-amber-800 font-semibold mb-2">Email Admin</label>
                                <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="binhbiinshop@admin.com">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-amber-800 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <p id="login-message" class="text-red-500 text-sm mb-4"></p>
                            <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition duration-150 shadow-lg">ƒêƒÉng Nh·∫≠p</button>
                        </form>
                        <p class="mt-4 text-center text-sm text-gray-500">
                            (Ch·ªâ d√†nh cho Qu·∫£n tr·ªã vi√™n)
                        </p>
                        <button onclick="setView('customer')" class="w-full mt-4 text-orange-600 hover:text-orange-800 transition duration-150 text-sm">
                            Tr·ªü v·ªÅ trang kh√°ch h√†ng
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== ADMIN DASHBOARD COMPONENTS ====================

        function renderAdminStats() {
            const totalRevenue = 15000000; // Mock data - will be replaced with real stats
            const totalOrders = orders.length;
            const activeItems = menuItems.filter(item => item.status !== 'deleted').length;
            const pendingOrders = orders.filter(o => o.status === 'ordered').length;

            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-amber-900">üìä Th·ªëng K√™ T·ªïng Quan</h2>
                        <div class="flex gap-2">
                            <button onclick="setView('admin-orders')" class="bg-purple-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-purple-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="clipboard-list" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">ƒê∆°n H√†ng (${pendingOrders})</span>
                                <span class="sm:hidden">ƒê∆°n (${pendingOrders})</span>
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ ch√≠nh -->
                    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 md:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">Doanh Thu Th√°ng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${formatCurrency(totalRevenue)}</p>
                                </div>
                                <i data-lucide="dollar-sign" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-orange-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">T·ªïng ƒê∆°n H√†ng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${totalOrders}</p>
                                </div>
                                <i data-lucide="shopping-bag" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-blue-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">S·ªë M√≥n ƒêang B√°n</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${activeItems}</p>
                                </div>
                                <i data-lucide="coffee" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-green-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">ƒê∆°n Ch·ªù X·ª≠ L√Ω</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-amber-900 mt-0.5 sm:mt-1 truncate">${pendingOrders}</p>
                                </div>
                                <i data-lucide="clock" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-purple-500 flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ theo tr·∫°ng th√°i ƒë∆°n h√†ng -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900 mb-3 sm:mb-4">üìà Tr·∫°ng Th√°i ƒê∆°n H√†ng</h3>
                            <div class="space-y-2 sm:space-y-3">
                                ${[
                                    { status: 'ordered', label: 'Ch·ªù nh·∫≠n', color: 'blue', count: orders.filter(o => o.status === 'ordered').length },
                                    { status: 'preparing', label: 'ƒêang l√†m', color: 'yellow', count: orders.filter(o => o.status === 'preparing').length },
                                    { status: 'completed', label: 'Ho√†n th√†nh', color: 'green', count: orders.filter(o => o.status === 'completed').length },
                                    { status: 'cancelled', label: 'ƒê√£ h·ªßy', color: 'red', count: orders.filter(o => o.status === 'cancelled').length }
                                ].map(stat => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs sm:text-sm text-gray-700">${stat.label}</span>
                                        <div class="flex items-center gap-1.5 sm:gap-2">
                                            <div class="w-16 sm:w-20 md:w-24 bg-gray-200 rounded-full h-1.5 sm:h-2">
                                                <div class="bg-${stat.color}-500 h-1.5 sm:h-2 rounded-full transition-all duration-300" style="width: ${orders.length > 0 ? (stat.count / orders.length * 100) : 0}%"></div>
                                            </div>
                                            <span class="text-[10px] sm:text-xs md:text-sm font-semibold text-${stat.color}-600 min-w-[1.5rem] sm:min-w-[2rem]">${stat.count}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900 mb-3 sm:mb-4">üìä Th·ªëng K√™ M√≥n ƒÇn</h3>
                            <div class="space-y-2 sm:space-y-3">
                                ${categories.map(cat => {
                                    const count = menuItems.filter(item => item.category === cat && item.status !== 'deleted').length;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs sm:text-sm text-gray-700">${getCategoryIcon(cat)} ${cat}</span>
                                            <span class="text-[10px] sm:text-xs md:text-sm font-semibold text-orange-600">${count} m√≥n</span>
                                        </div>
                                    `;
                                }).join('')}
                                <hr class="my-2 sm:my-3">
                                <div class="flex justify-between items-center font-bold">
                                    <span class="text-xs sm:text-sm text-gray-900">T·ªïng c·ªông</span>
                                    <span class="text-[10px] sm:text-xs md:text-sm text-orange-600">${activeItems} m√≥n</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ƒê∆°n h√†ng g·∫ßn ƒë√¢y -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900">üïí ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h3>
                            <button onclick="setView('admin-orders')" class="text-blue-600 hover:text-blue-800 text-xs sm:text-sm">Xem t·∫•t c·∫£ ‚Üí</button>
                        </div>
                        <div class="space-y-2 sm:space-y-3">
                            ${orders.slice(0, 5).map(order => `
                                <div class="flex justify-between items-center p-2 sm:p-3 border rounded-lg hover:bg-gray-50 active:scale-[0.98] transition">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-gray-900 text-xs sm:text-sm md:text-base truncate">Order #${order.id.slice(-6).toUpperCase()}</p>
                                        <p class="text-[10px] sm:text-xs md:text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                    </div>
                                    <div class="text-right ml-2">
                                        <p class="font-semibold text-orange-600 text-xs sm:text-sm md:text-base">${formatCurrency(order.total)}</p>
                                        <span class="px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-[9px] sm:text-xs font-medium ${getStatusBadgeClass(order.status)}">
                                            ${getStatusText(order.status)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}

                            ${orders.length === 0 ? '<p class="text-center text-gray-500 py-6 sm:py-8 text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminOrders() {
            // Load orders management content after a short delay to ensure DOM is ready
            setTimeout(() => {
                renderOrdersManagementList();
            }, 100);

            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-purple-900">üìã Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                        <div class="flex gap-2">
                            <button onclick="loadOrders()" class="bg-purple-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-purple-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">T·∫£i L·∫°i</span>
                            </button>
                        </div>
                    </div>

                    <div id="orders-management-content">
                        <!-- Orders management will be loaded here -->
                        <div class="text-center py-12">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 text-purple-500 animate-spin"></i>
                            <p class="text-gray-600">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTables() {
            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-teal-900">üçΩÔ∏è Qu·∫£n L√Ω B√†n ƒÇn</h2>
                        <div class="flex gap-2">
                            <button onclick="openAddTableModalAdmin()" class="bg-teal-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-teal-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">Th√™m B√†n M·ªõi</span>
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ b√†n -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-4 md:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">B√†n Tr·ªëng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-green-600 mt-0.5 sm:mt-1 truncate">${tables.filter(t => !t.status || t.status === 'available').length}</p>
                                </div>
                                <i data-lucide="check-circle" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-green-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">ƒêang D√πng</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-red-600 mt-0.5 sm:mt-1 truncate">${tables.filter(t => t.status === 'occupied').length}</p>
                                </div>
                                <i data-lucide="users" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-red-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] sm:text-xs md:text-sm text-gray-500">T·ªïng S·ªë</p>
                                    <p class="text-lg sm:text-xl md:text-3xl font-extrabold text-blue-600 mt-0.5 sm:mt-1 truncate">${tables.length}</p>
                                </div>
                                <i data-lucide="table-2" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-blue-500 flex-shrink-0 ml-1 sm:ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Danh s√°ch b√†n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <h3 class="text-sm sm:text-base md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">Danh S√°ch B√†n ƒÇn</h3>

                        ${tables.length === 0 ? `
                            <div class="text-center py-8 sm:py-12">
                                <i data-lucide="table-2" class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 text-gray-300"></i>
                                <p class="text-gray-500 text-sm sm:text-base md:text-lg">Ch∆∞a c√≥ b√†n n√†o</p>
                                <p class="text-gray-400 text-xs sm:text-sm mt-1 sm:mt-2">Click "Th√™m B√†n M·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-6">
                                ${tables.map(table => `
                                    <div class="bg-white p-3 sm:p-4 rounded-lg border-2 ${table.status === 'occupied' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'} shadow-sm hover:shadow-md transition duration-150 active:scale-[0.98]">
                                        <div class="flex justify-between items-start mb-2 sm:mb-3">
                                            <div class="flex-1 min-w-0">
                                                <h4 class="text-sm sm:text-base md:text-lg font-bold text-gray-800 truncate">B√†n ${table.tableNumber}</h4>
                                                <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full inline-block mt-1 ${table.status === 'occupied' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${table.status === 'occupied' ? 'üî¥ ƒêang d√πng' : 'üü¢ Tr·ªëng'}
                                                </span>
                                            </div>
                                            <div class="flex gap-0.5 sm:gap-1 ml-2">
                                                <button onclick="showTableQRAdmin('${table.tableNumber}')" class="p-1.5 sm:p-2 bg-blue-500 text-white rounded hover:bg-blue-600 active:scale-95 transition" title="Xem QR Code">
                                                    <i data-lucide="qr-code" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                                <button onclick="openEditTableModalAdmin('${table.id}', '${table.tableNumber}', '${table.status || 'available'}')" class="p-1.5 sm:p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 active:scale-95 transition" title="Ch·ªânh s·ª≠a">
                                                    <i data-lucide="edit" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                                <button onclick="deleteTable('${table.id}')" class="p-1.5 sm:p-2 bg-red-500 text-white rounded hover:bg-red-600 active:scale-95 transition" title="X√≥a b√†n">
                                                    <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-[10px] sm:text-xs text-gray-600">
                                            <p class="truncate">T·∫°o: ${table.createdAt ? new Date(table.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Add Table Modal for Admin Tables -->
                    <div id="add-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">üçΩÔ∏è Th√™m B√†n M·ªõi</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                                <input type="text" id="new-table-number-admin" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeAddTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="addTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Th√™m B√†n</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Table Modal for Admin Tables -->
                    <div id="edit-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-teal-600 mb-4">‚úèÔ∏è Ch·ªânh S·ª≠a B√†n</h3>

                            <input type="hidden" id="edit-table-id-admin">

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                                <input type="text" id="edit-table-number-admin" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng Th√°i</label>
                                <select id="edit-table-status-admin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                    <option value="available">üü¢ Tr·ªëng</option>
                                    <option value="occupied">üî¥ ƒêang d√πng</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="updateTableAdmin()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">C·∫≠p Nh·∫≠t</button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Modal for Admin Tables -->
                    <div id="qr-table-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-teal-600">üì± QR Code B√†n</h3>
                                <button onclick="closeQRTableModalAdmin()" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>

                            <div id="qr-table-info-admin" class="mb-4 text-center">
                                <!-- Table info will be inserted here -->
                            </div>

                            <div id="qr-table-code-container-admin" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                                <!-- QR Code will be generated here -->
                            </div>

                            <div class="flex gap-3">
                                <button onclick="downloadTableQRAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    T·∫£i Xu·ªëng
                                </button>
                                <button onclick="closeQRTableModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTrash() {
            // L·ªçc items ƒë√£ x√≥a v√† s·∫Øp x·∫øp theo th·ªùi gian x√≥a (m·ªõi nh·∫•t tr∆∞·ªõc)
            const deletedItems = menuItems
                .filter(item => item.status === 'deleted')
                .sort((a, b) => {
                    const timeA = a.deletedAt?.seconds || 0;
                    const timeB = b.deletedAt?.seconds || 0;
                    return timeB - timeA;
                });

            return `
                <div class="p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">üóëÔ∏è Th√πng R√°c</h2>
                        <div class="text-sm text-gray-600">
                            ${deletedItems.length} m√≥n ƒë√£ x√≥a
                        </div>
                    </div>

                    <!-- Th√¥ng b√°o -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0"></i>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-800">Th√¥ng tin v·ªÅ th√πng r√°c</h4>
                                <div class="mt-1 text-sm text-yellow-700">
                                    <p>‚Ä¢ C√°c m√≥n ƒë√£ x√≥a s·∫Ω ƒë∆∞·ª£c l∆∞u trong th√πng r√°c 30 ng√†y</p>
                                    <p>‚Ä¢ Sau 30 ng√†y, m√≥n s·∫Ω ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn t·ª± ƒë·ªông</p>
                                    <p>‚Ä¢ B·∫°n c√≥ th·ªÉ kh√¥i ph·ª•c ho·∫∑c x√≥a vƒ©nh vi·ªÖn m√≥n b·∫•t k·ª≥ l√∫c n√†o</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Danh s√°ch items ƒë√£ x√≥a -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">M√≥n ƒë√£ x√≥a</h3>

                            ${deletedItems.length === 0 ? `
                                <div class="text-center py-12">
                                    <i data-lucide="trash-2" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                    <p class="text-gray-500 text-lg">Th√πng r√°c tr·ªëng</p>
                                    <p class="text-gray-400 text-sm mt-2">Kh√¥ng c√≥ m√≥n n√†o ƒë√£ x√≥a</p>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${deletedItems.map(item => {
                                        const deletedDate = item.deletedAt ? new Date(item.deletedAt.seconds * 1000) : new Date();
                                        const daysSinceDeleted = Math.floor((Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24));
                                        const daysUntilAutoDelete = 30 - daysSinceDeleted;

                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-3 mb-2">
                                                            <h4 class="font-semibold text-gray-900">${item.name}</h4>
                                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">${item.category}</span>
                                                            ${daysUntilAutoDelete <= 7 ? `<span class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full">X√≥a sau ${daysUntilAutoDelete} ng√†y</span>` : ''}
                                                        </div>
                                                        <p class="text-sm text-gray-600 mb-2">${item.description}</p>
                                                        <div class="text-sm text-gray-500">
                                                            <p>Gi√°: ${formatCurrency(item.price)} ${item.newPrice ? `(M·ªõi: ${formatCurrency(item.newPrice)})` : ''}</p>
                                                            <p>X√≥a: ${deletedDate.toLocaleString('vi-VN')} (${daysSinceDeleted} ng√†y tr∆∞·ªõc)</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2 ml-4">
                                                        <button onclick="restoreItem('${item.id}')" class="px-3 py-1.5 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition duration-150" title="Kh√¥i ph·ª•c">
                                                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="permanentDeleteItem('${item.id}')" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition duration-150" title="X√≥a vƒ©nh vi·ªÖn">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminMenu() {
            const itemToEdit = menuItems.find(i => i.id === (document.getElementById('admin-form-id')?.value || null));


            return `
                <div class="p-3 sm:p-6 md:p-10 bg-gray-50 min-h-screen pb-16 sm:pb-20">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-orange-900">üçΩÔ∏è Qu·∫£n L√Ω Menu</h2>
                    </div>

                    <!-- Danh m·ª•c -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg mb-6 sm:mb-8">
                        <div class="flex justify-between items-center mb-3 sm:mb-4">
                            <h3 class="text-sm sm:text-base md:text-xl font-bold text-indigo-900">üìÇ Danh M·ª•c M√≥n ƒÇn</h3>
                            <button onclick="document.getElementById('category-modal-admin').classList.remove('hidden'); document.getElementById('new-category-name-admin').focus()" class="bg-indigo-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                <i data-lucide="folder-plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span class="hidden sm:inline">Th√™m Danh M·ª•c</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-3 sm:mb-4">
                            ${categories.map((cat, index) => `
                                <div class="bg-indigo-50 p-3 sm:p-4 rounded-lg border border-indigo-200 flex justify-between items-center active:scale-[0.98] transition">
                                    <div class="flex items-center gap-1.5 sm:gap-2 flex-1 min-w-0">
                                        <span class="text-base sm:text-lg flex-shrink-0">${getCategoryIcon(cat)}</span>
                                        <span class="font-medium text-gray-800 text-xs sm:text-sm truncate">${cat}</span>
                                        <span class="text-[10px] sm:text-xs bg-indigo-100 text-indigo-800 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full flex-shrink-0">
                                            ${menuItems.filter(item => item.category === cat && item.status !== 'deleted').length} m√≥n
                                        </span>
                                    </div>
                                    <div class="flex gap-0.5 sm:gap-1 ml-1">
                                        <button onclick="openEditCategoryModalAdmin('${cat}')" class="text-blue-600 hover:text-blue-800 p-1 active:scale-95 transition" title="S·ª≠a">
                                            <i data-lucide="edit" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                        </button>
                                        ${index >= 3 ? `
                                            <button onclick="deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 p-1 active:scale-95 transition" title="X√≥a">
                                                <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-[10px] sm:text-xs md:text-sm text-gray-600">
                            <strong>L∆∞u √Ω:</strong> T·∫•t c·∫£ danh m·ª•c ƒë·ªÅu c√≥ th·ªÉ s·ª≠a t√™n. 3 danh m·ª•c ƒë·∫ßu ti√™n (ƒê·ªì U·ªëng, ƒê·ªì ƒÇn, ƒê·ªì Nh·∫≠u) kh√¥ng th·ªÉ x√≥a.
                        </div>
                    </div>

                    <!-- Form th√™m/s·ª≠a m√≥n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg mb-6 sm:mb-8">
                        <h3 class="text-sm sm:text-base md:text-xl font-bold text-orange-900 mb-3 sm:mb-4">${itemToEdit ? '‚úèÔ∏è Ch·ªânh S·ª≠a M√≥n' : '‚ûï Th√™m M√≥n M·ªõi'}</h3>
                        <form id="admin-item-form" onsubmit="event.preventDefault(); handleSaveItem()">
                            <input type="hidden" id="admin-form-id" value="${itemToEdit ? itemToEdit.id : ''}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">T√™n M√≥n</label>
                                    <input type="text" id="admin-form-name" required value="${itemToEdit ? itemToEdit.name : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Gi√° C≈© (VNƒê)</label>
                                    <input type="number" id="admin-form-price" required value="${itemToEdit ? itemToEdit.price : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Gi√° M·ªõi (VNƒê) <span class="text-xs text-gray-500">(Kh√¥ng b·∫Øt bu·ªôc)</span></label>
                                    <input type="number" id="admin-form-new-price" value="${itemToEdit ? itemToEdit.newPrice || '' : ''}" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Danh M·ª•c</label>
                                    <select id="admin-form-category" required class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        ${categories.map(cat => `<option value="${cat}" ${itemToEdit && itemToEdit.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tr·∫°ng Th√°i</label>
                                    <select id="admin-form-status" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        <option value="active" ${!itemToEdit || itemToEdit.status === 'active' ? 'selected' : ''}>‚úÖ ƒêang b√°n</option>
                                        <option value="hot" ${itemToEdit && itemToEdit.status === 'hot' ? 'selected' : ''}>üî• B√°n ch·∫°y</option>
                                        <option value="new" ${itemToEdit && itemToEdit.status === 'new' ? 'selected' : ''}>üÜï M√≥n m·ªõi</option>
                                        <option value="sale" ${itemToEdit && itemToEdit.status === 'sale' ? 'selected' : ''}>üí∞ Sale</option>
                                        <option value="best_seller" ${itemToEdit && itemToEdit.status === 'best_seller' ? 'selected' : ''}>‚≠ê Best Seller</option>
                                        <option value="out_of_stock" ${itemToEdit && itemToEdit.status === 'out_of_stock' ? 'selected' : ''}>‚ùå H·∫øt h√†ng</option>
                                        <option value="coming_soon" ${itemToEdit && itemToEdit.status === 'coming_soon' ? 'selected' : ''}>‚è≥ S·∫Øp c√≥</option>
                                        <option value="deleted" ${itemToEdit && itemToEdit.status === 'deleted' ? 'selected' : ''}>üóëÔ∏è ƒê√£ x√≥a</option>
                                    </select>
                                </div>

                                <div id="size-field" style="display: ${itemToEdit && itemToEdit.category === 'ƒê·ªì U·ªëng' ? 'block' : 'none'};">
                                    <label class="block text-sm font-medium text-gray-700">Size (ƒê·ªì U·ªëng)</label>
                                    <select id="admin-form-size" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                        <option value="" ${!itemToEdit || !itemToEdit.size ? 'selected' : ''}>Kh√¥ng ch·ªçn size</option>
                                        ${drinkSizes.map(size => `<option value="${size}" ${itemToEdit && itemToEdit.size === size ? 'selected' : ''}>${size}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">·∫¢nh</label>
                                    <input type="file" id="admin-form-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                    <p class="mt-1 text-xs text-gray-500">Ho·∫∑c nh·∫≠p URL tr·ª±c ti·∫øp:</p>
                                    <input type="url" id="admin-form-image" value="${itemToEdit ? itemToEdit.imageUrl : ''}" placeholder="https://..." class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                            </div>

                            <!-- Price Preview -->
                            <div id="admin-price-preview" class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200" style="display: none;">
                                <div class="text-sm text-amber-800">
                                    <strong>Preview hi·ªÉn th·ªã:</strong><br>
                                    <span id="admin-price-preview-text"></span>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">M√¥ T·∫£</label>
                                <textarea id="admin-form-description" rows="2" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">${itemToEdit ? itemToEdit.description : ''}</textarea>
                            </div>
                            <div class="mt-4 sm:mt-6 flex justify-end space-x-2 sm:space-x-3">
                                <button type="button" onclick="clearAdminForm()" class="px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 rounded-md shadow-sm text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 active:scale-95 transition">H·ªßy/Th√™m M·ªõi</button>
                                <button type="submit" class="px-3 py-1.5 sm:px-4 sm:py-2 bg-orange-600 text-white rounded-md shadow-lg text-xs sm:text-sm font-medium hover:bg-orange-700 active:scale-95 transition">
                                    ${itemToEdit ? 'C·∫≠p Nh·∫≠t M√≥n' : 'Th√™m M√≥n'}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Danh s√°ch m√≥n -->
                    <div class="bg-white p-3 sm:p-4 md:p-6 rounded-lg sm:rounded-xl shadow-lg">
                        <h3 class="text-sm sm:text-base md:text-xl font-bold text-amber-900 mb-3 sm:mb-4">üìã Danh S√°ch M√≥n ƒÇn/ƒê·ªì U·ªëng (${menuItems.filter(item => item.status !== 'deleted').length})</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-amber-50">
                                    <tr>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">T√™n M√≥n</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Danh M·ª•c</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Tr·∫°ng Th√°i</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Gi√°</th>
                                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-right text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Thao T√°c</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                        <tr class="${item.status === 'deleted' ? 'bg-gray-100' : ''} hover:bg-gray-50 active:scale-[0.99] transition">
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-amber-900">${item.name}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.category}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm text-blue-600">${item.size || '-'}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm">${getStatusBadge(item.status) || '<span class="text-green-600">‚úÖ ƒêang b√°n</span>'}</td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-xs sm:text-sm text-orange-600 font-semibold">
                                                ${item.newPrice ?
                                                    (parseFloat(item.newPrice) >= parseFloat(item.price) ?
                                                        formatCurrency(item.newPrice) :
                                                        `${formatCurrency(item.price)} ‚Üí ${formatCurrency(item.newPrice)}`
                                                    ) :
                                                    formatCurrency(item.price)
                                                }
                                            </td>
                                            <td class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap text-right text-xs sm:text-sm font-medium">
                                                <div class="flex justify-end gap-1 sm:gap-2">
                                                    <button onclick="openPriceModal('${item.id}')" class="text-blue-600 hover:text-blue-800 p-1 active:scale-95 transition" title="Ch·ªânh gi√°">üí∞</button>
                                                    <button onclick="loadItemForEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-900 text-xs sm:text-sm active:scale-95 transition">S·ª≠a</button>
                                                    <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-900 text-xs sm:text-sm active:scale-95 transition ml-1">X√≥a</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Category Modal for Admin Menu -->
                    <div id="category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">‚ûï Th√™m Danh M·ª•c M·ªõi</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                                <input type="text" id="new-category-name-admin" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="addNewCategoryAdmin()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Th√™m</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Category Modal for Admin Menu -->
                    <div id="edit-category-modal-admin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-amber-900 mb-4">‚úèÔ∏è S·ª≠a Danh M·ª•c</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                                <input type="text" id="edit-category-name-admin" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            </div>

                            <div class="flex gap-3">
                                <button onclick="closeEditCategoryModalAdmin()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                                <button onclick="updateCategoryAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">C·∫≠p Nh·∫≠t</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeCategoryModalAdmin() {
            document.getElementById('category-modal-admin').classList.add('hidden');
            document.getElementById('new-category-name-admin').value = '';
        }

        async function addNewCategoryAdmin() {
            const categoryName = document.getElementById('new-category-name-admin').value.trim();
            if (!categoryName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (categories.includes(categoryName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            categories.push(categoryName);
            await saveCategories();
            showMessage(`ƒê√£ th√™m danh m·ª•c: ${categoryName}`, "success");
            closeCategoryModalAdmin();
            renderApp(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t menu selection
        }

        // ==================== TRASH MANAGEMENT ====================

        async function restoreItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c m√≥n n√†y?")) return;
            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, id), {
                    status: 'active',
                    deletedAt: null,
                    updatedAt: new Date()
                });
                console.log("‚úÖ Kh√¥i ph·ª•c m√≥n th√†nh c√¥ng");
                showMessage("ƒê√£ kh√¥i ph·ª•c m√≥n!", "success");
            } catch (e) {
                console.error("‚ùå L·ªói khi kh√¥i ph·ª•c m√≥n:", e);
                showMessage("L·ªói khi kh√¥i ph·ª•c m√≥n: " + e.message, "error");
            }
        }

        async function permanentDeleteItem(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN m√≥n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) return;
            try {
                await deleteDoc(doc(db, PUBLIC_DATA_PATH, id));
                console.log("‚úÖ X√≥a vƒ©nh vi·ªÖn m√≥n th√†nh c√¥ng");
                showMessage("ƒê√£ x√≥a vƒ©nh vi·ªÖn m√≥n!", "success");
            } catch (e) {
                console.error("‚ùå L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n:", e);
                showMessage("L·ªói khi x√≥a vƒ©nh vi·ªÖn m√≥n: " + e.message, "error");
            }
        }

        // Auto-cleanup deleted items after 30 days
        async function cleanupExpiredItems() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            try {
                const expiredItems = menuItems.filter(item =>
                    item.status === 'deleted' &&
                    item.deletedAt &&
                    new Date(item.deletedAt.seconds * 1000) < thirtyDaysAgo
                );

                if (expiredItems.length > 0) {
                    console.log(`üóëÔ∏è Auto-deleting ${expiredItems.length} expired items`);
                    for (const item of expiredItems) {
                        await deleteDoc(doc(db, PUBLIC_DATA_PATH, item.id));
                    }
                    console.log("‚úÖ Auto-cleanup completed");
                }
            } catch (error) {
                console.error("‚ùå Error during auto-cleanup:", error);
            }
        }

        let editingCategoryAdmin = null;

        function openEditCategoryModalAdmin(categoryName) {
            editingCategoryAdmin = categoryName;
            document.getElementById('edit-category-name-admin').value = categoryName;
            document.getElementById('edit-category-modal-admin').classList.remove('hidden');
        }

        function closeEditCategoryModalAdmin() {
            document.getElementById('edit-category-modal-admin').classList.add('hidden');
            document.getElementById('edit-category-name-admin').value = '';
            editingCategoryAdmin = null;
        }

        async function updateCategoryAdmin() {
            const newName = document.getElementById('edit-category-name-admin').value.trim();
            if (!newName) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!", "error");
                return;
            }

            if (newName !== editingCategoryAdmin && categories.includes(newName)) {
                showMessage("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                return;
            }

            const index = categories.indexOf(editingCategoryAdmin);
            if (index > -1) {
                categories[index] = newName;

                // Update all items in this category
                menuItems.forEach(item => {
                    if (item.category === editingCategoryAdmin) {
                        // Update in Firestore
                        updateDoc(doc(db, PUBLIC_DATA_PATH, item.id), {
                            category: newName,
                            updatedAt: new Date()
                        });
                    }
                });

                await saveCategories();
                showMessage(`ƒê√£ c·∫≠p nh·∫≠t danh m·ª•c: ${editingCategoryAdmin} ‚Üí ${newName}`, "success");
                closeEditCategoryModalAdmin();
                renderApp();
            }
        }

        function openAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.remove('hidden');
            document.getElementById('new-table-number-admin').focus();
        }

        function closeAddTableModalAdmin() {
            document.getElementById('add-table-modal-admin').classList.add('hidden');
            document.getElementById('new-table-number-admin').value = '';
        }

        async function addTableAdmin() {
            const tableNumber = document.getElementById('new-table-number-admin').value.trim();

            if (!tableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "error");
                return;
            }

            // Ki·ªÉm tra tr√πng
            if (tables.some(t => t.tableNumber === tableNumber)) {
                showMessage(`B√†n ${tableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }

            try {
                const tableData = {
                    tableNumber: tableNumber,
                    status: 'available', // available, occupied
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await addDoc(collection(db, 'tables'), tableData);

                showMessage(`‚úÖ ƒê√£ th√™m B√†n ${tableNumber}`, "success");
                closeAddTableModalAdmin();

            } catch (error) {
                console.error("Error adding table:", error);
                showMessage("L·ªói th√™m b√†n: " + error.message, "error");
            }
        }

        function openEditTableModalAdmin(tableId, tableNumber, status) {
            document.getElementById('edit-table-id-admin').value = tableId;
            document.getElementById('edit-table-number-admin').value = tableNumber;
            document.getElementById('edit-table-status-admin').value = status;
            document.getElementById('edit-table-modal-admin').classList.remove('hidden');
        }

        function closeEditTableModalAdmin() {
            document.getElementById('edit-table-modal-admin').classList.add('hidden');
            document.getElementById('edit-table-id-admin').value = '';
            document.getElementById('edit-table-number-admin').value = '';
            document.getElementById('edit-table-status-admin').value = 'available';
        }

        async function updateTableAdmin() {
            const tableId = document.getElementById('edit-table-id-admin').value;
            const newTableNumber = document.getElementById('edit-table-number-admin').value.trim();
            const newStatus = document.getElementById('edit-table-status-admin').value;

            if (!newTableNumber) {
                showMessage("Vui l√≤ng nh·∫≠p s·ªë b√†n!", "error");
                return;
            }

            // Ki·ªÉm tra tr√πng (tr·ª´ b√†n hi·ªán t·∫°i)
            const currentTable = tables.find(t => t.id === tableId);
            if (tables.some(t => t.tableNumber === newTableNumber && t.id !== tableId)) {
                showMessage(`B√†n ${newTableNumber} ƒë√£ t·ªìn t·∫°i!`, "error");
                return;
            }

            try {
                await updateDoc(doc(db, 'tables', tableId), {
                    tableNumber: newTableNumber,
                    status: newStatus,
                    updatedAt: new Date()
                });

                showMessage(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t B√†n ${newTableNumber}`, "success");
                closeEditTableModalAdmin();

            } catch (error) {
                console.error("Error updating table:", error);
                showMessage("L·ªói c·∫≠p nh·∫≠t b√†n: " + error.message, "error");
            }
        }

        function showTableQRAdmin(tableNumber) {
            const modal = document.getElementById('qr-table-modal-admin');
            const qrContainer = document.getElementById('qr-table-code-container-admin');
            const tableInfo = document.getElementById('qr-table-info-admin');

            // Clear previous QR
            qrContainer.innerHTML = '';

            // T·∫°o URL v·ªõi table parameter
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}?table=${tableNumber}`;

            // Generate QR Code
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Update table info
            tableInfo.innerHTML = `
                <p class="text-lg font-bold text-teal-600 mb-2">B√†n ${tableNumber}</p>
                <p class="text-sm text-gray-600 mb-3">Qu√©t QR code n√†y ƒë·ªÉ v√†o menu</p>
                <div class="bg-gray-100 p-2 rounded text-xs break-all">
                    ${qrUrl}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeQRTableModalAdmin() {
            document.getElementById('qr-table-modal-admin').classList.add('hidden');
        }

        function downloadTableQRAdmin() {
            const qrCanvas = document.querySelector('#qr-table-code-container-admin canvas');
            if (!qrCanvas) return;

            const tableNumber = document.querySelector('#qr-table-info-admin .text-teal-600').textContent;

            const link = document.createElement('a');
            link.download = `QR-Ban-${tableNumber}.png`;
            link.href = qrCanvas.toDataURL();
            link.click();
        }

        function clearAdminForm() {
            document.getElementById('admin-item-form').reset();
            document.getElementById('admin-form-id').value = '';
            // Hide price preview
            const previewDiv = document.getElementById('admin-price-preview');
            if (previewDiv) {
                previewDiv.style.display = 'none';
            }
            renderApp(); // Force re-render ƒë·ªÉ c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ form
        }
        
        function loadItemForEdit(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                document.getElementById('admin-form-id').value = item.id;
                document.getElementById('admin-form-name').value = item.name;
                document.getElementById('admin-form-price').value = item.price;
                document.getElementById('admin-form-new-price').value = item.newPrice || '';
                document.getElementById('admin-form-category').value = item.category;
                document.getElementById('admin-form-status').value = item.status || 'active';
                document.getElementById('admin-form-size').value = item.size || '';
                document.getElementById('admin-form-image').value = item.imageUrl || '';
                document.getElementById('admin-form-description').value = item.description || '';

                // Update price preview
                updateAdminPricePreview();

                // Show/hide size field based on category
                toggleSizeField(item.category);

                renderApp(); // Force re-render ƒë·ªÉ c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ form
            }
        }

        function toggleSizeField(category) {
            const sizeField = document.getElementById('size-field');
            if (sizeField) {
                sizeField.style.display = category === 'ƒê·ªì U·ªëng' ? 'block' : 'none';
            }
        }

        function updateAdminPricePreview() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');
            const previewDiv = document.getElementById('admin-price-preview');
            const previewText = document.getElementById('admin-price-preview-text');

            if (!oldPriceInput || !newPriceInput || !previewDiv || !previewText) return;

            const oldPrice = parseFloat(oldPriceInput.value);
            const newPrice = parseFloat(newPriceInput.value);

            if (newPriceInput.value && !isNaN(newPrice) && newPrice > 0) {
                previewDiv.style.display = 'block';
                if (newPrice >= oldPrice) {
                    // Gi√° m·ªõi >= gi√° c≈©: ch·ªâ hi·ªán gi√° m·ªõi
                    previewText.innerHTML = `Ch·ªâ hi·ªán: ${formatCurrency(newPrice)}`;
                } else {
                    // Gi√° m·ªõi < gi√° c≈©: g·∫°ch gi√° c≈©, hi·ªán gi√° m·ªõi
                    previewText.innerHTML = `G·∫°ch ${formatCurrency(oldPrice)} ‚Üí ${formatCurrency(newPrice)}`;
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function setupAdminPricePreviewListeners() {
            const oldPriceInput = document.getElementById('admin-form-price');
            const newPriceInput = document.getElementById('admin-form-new-price');

            if (oldPriceInput && newPriceInput) {
                oldPriceInput.addEventListener('input', updateAdminPricePreview);
                newPriceInput.addEventListener('input', updateAdminPricePreview);
            }
        }

        // Add event listener for category change
        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('admin-form-category');
            if (categorySelect) {
                categorySelect.addEventListener('change', function(e) {
                    toggleSizeField(e.target.value);
                });
            }
        });
        
        function handleSaveItem() {
            const newPriceValue = document.getElementById('admin-form-new-price').value.trim();
            const item = {
                id: document.getElementById('admin-form-id').value,
                name: document.getElementById('admin-form-name').value,
                price: parseFloat(document.getElementById('admin-form-price').value),
                category: document.getElementById('admin-form-category').value,
                status: document.getElementById('admin-form-status').value,
                size: document.getElementById('admin-form-size').value || null,
                imageUrl: document.getElementById('admin-form-image').value,
                description: document.getElementById('admin-form-description').value,
            };

            // Add newPrice if provided
            if (newPriceValue && parseFloat(newPriceValue) > 0) {
                item.newPrice = parseFloat(newPriceValue);
            }

            saveItem(item);
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showMessage("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!", "error");
                return;
            }

            if (newPassword.length < 6) {
                showMessage("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", "error");
                return;
            }

            const success = await changePassword(currentPassword, newPassword);
            if (success) {
                document.getElementById('change-password-form').reset();
            }
        }


        function renderMainContent() {
            switch (currentView) {
                case 'login':
                    return renderLoginView();
                case 'admin-stats':
                    return isAdmin ? renderAdminStats() : renderLoginView();
                case 'admin-orders':
                    return isAdmin ? renderAdminOrders() : renderLoginView();
                case 'admin-tables':
                    return isAdmin ? renderAdminTables() : renderLoginView();
                case 'admin-menu':
                    return isAdmin ? renderAdminMenu() : renderLoginView();
                case 'admin-trash':
                    return isAdmin ? renderAdminTrash() : renderLoginView();
                case 'customer':
                default:
                    const menuHtml = currentCategory === 'ƒê·ªì U·ªëng'
                        ? `<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4 pb-16 sm:pb-20">${renderCustomerMenu()}</div>`
                        : `<div class="max-w-7xl mx-auto pb-16 sm:pb-20">${renderCustomerMenu()}</div>`;

                    return `
                        ${renderMenuSelection()}
                        <main class="bg-amber-50">
                            ${menuHtml}
                        </main>
                    `;
            }
        }
        
        function renderCartSidebar() {
            const itemsInCart = Object.values(cart);
            const total = itemsInCart.reduce((sum, entry) => sum + (getItemPrice(entry.item) * entry.quantity), 0);
            const cartClasses = Object.keys(cart).length === 0 
                ? 'translate-x-full' // ·∫®n khi kh√¥ng c√≥ m√≥n
                : ''; // Gi·ªØ tr·∫°ng th√°i ·∫©n/hi·ªán d·ª±a tr√™n click

            return `
                <!-- N·ªÅn ƒëen m·ªù (overlay) - click ƒë·ªÉ ƒë√≥ng gi·ªè h√†ng -->
                <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity duration-300 hidden" onclick="closeCart()"></div>
            
                <div id="cart-sidebar" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white shadow-2xl z-[60] transform transition-transform duration-300 translate-x-full">
                    <div class="flex justify-between items-center p-4 border-b border-amber-200 bg-amber-50">
                        <h3 class="text-xl font-bold text-amber-900 flex items-center">
                            <i data-lucide="shopping-basket" class="w-6 h-6 mr-2"></i> Gi·ªè H√†ng
                            ${Object.keys(cart).length > 0 ? `<span class="ml-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full">${Object.values(cart).reduce((sum, item) => sum + item.quantity, 0)}</span>` : ''}
                        </h3>
                        <button onclick="closeCart()" class="p-2 rounded-full hover:bg-gray-100 text-amber-800">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="p-4 overflow-y-auto h-[calc(100%-140px)]">
                        ${itemsInCart.length > 0 ? itemsInCart.map(entry => `
                            <div class="flex items-center justify-between py-3 border-b border-dashed border-amber-100">
                                <div class="flex-grow pr-4">
                                    <p class="font-semibold text-amber-900">${entry.item.name}</p>
                                    <p class="text-sm text-orange-600">${formatCurrency(getItemPrice(entry.item))} x ${entry.quantity}</p>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <button onclick="updateCart('${entry.item.id}', -1)" class="p-1 text-sm bg-amber-200 rounded-full hover:bg-amber-300 transition duration-150">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span class="w-6 text-center text-amber-900 font-medium">${entry.quantity}</span>
                                    <button onclick="updateCart('${entry.item.id}', 1)" class="p-1 text-sm bg-orange-500 text-white rounded-full hover:bg-orange-600 transition duration-150">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 mt-10">Gi·ªè h√†ng tr·ªëng.</p>'}
                    </div>
                    
                    <div class="absolute bottom-0 w-full p-4 border-t border-amber-300 bg-white">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-lg font-bold text-amber-900">T·ªïng C·ªông:</p>
                            <p class="text-2xl font-extrabold text-red-600">${formatCurrency(total)}</p>
                        </div>
                         <button class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition duration-150 shadow-lg" onclick="handleOrder()">
                             <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order
                         </button>
                    </div>
                </div>
            `;
        }

          function disableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = true;
                  button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i> ƒêang x·ª≠ l√Ω...';
              }
          }

          function enableOrderButton() {
              const button = document.getElementById('order-button');
              if (button) {
                  button.disabled = false;
                  button.innerHTML = '<i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Order';
                  renderLucideIcons();
              }
          }

          async function handleOrder() {
              const total = Object.values(cart).reduce((sum, entry) => sum + (getItemPrice(entry.item) * entry.quantity), 0);

              if (total === 0) {
                  showMessage("Gi·ªè h√†ng tr·ªëng! Vui l√≤ng ch·ªçn m√≥n.", 'warning');
                  return;
              }

              // Ki·ªÉm tra table number - n·∫øu ch∆∞a c√≥ th√¨ hi·ªán modal ch·ªçn b√†n
              if (!currentTableNumber) {
                  showTableSelectionModal();
                  return;
              }

              // Hi·ªÉn th·ªã confirm dialog
              const itemsInCart = Object.values(cart);
              const confirmMessage = `B·∫°n c√≥ mu·ªën ƒë·∫∑t h√†ng v·ªõi ${itemsInCart.length} m√≥n v√† t·ªïng ti·ªÅn ${formatCurrency(total)} kh√¥ng?`;
              if (!confirm(confirmMessage)) {
                  return; // User canceled
              }

              // Disable order button to prevent multiple clicks
              disableOrderButton();

              try {
                  // T·∫°o order object
                  const orderItems = Object.values(cart).map(entry => ({
                      id: entry.item.id,
                      name: entry.item.name,
                      price: getItemPrice(entry.item),
                      quantity: entry.quantity,
                      size: entry.item.size || null,
                      category: entry.item.category
                  }));

                  const orderData = {
                      items: orderItems,
                      total: total,
                      status: 'ordered', // ordered, confirmed, preparing, ready, completed, cancelled, updated
                      customerId: userId,
                      customerEmail: auth.currentUser?.email || 'anonymous',
                      tableNumber: currentTableNumber || null, // S·ªë b√†n (n·∫øu order t·ª´ QR code)
                      createdAt: new Date(),
                      updatedAt: new Date()
                  };

                  // L∆∞u order v√†o Firestore
                  const docRef = await addDoc(collection(db, 'orders'), orderData);

                  showMessage(`üéâ ƒê√£ ƒë·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: #${docRef.id.slice(-6).toUpperCase()}`, 'success');

                  // TTS
                  speak(`C·∫£m ∆°n b·∫°n. ƒê∆°n h√†ng tr·ªã gi√° ${total.toLocaleString('vi-VN')} ƒë·ªìng ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t th√†nh c√¥ng. M√£ ƒë∆°n h√†ng l√† ${docRef.id.slice(-6).toUpperCase()}.`);

                  // L∆∞u order v√†o session cho kh√°ch h√†ng (n·∫øu l√† guest)
                  if (userRole === 'guest' && currentSessionId) {
                      const guestOrderData = {
                          orderId: docRef.id,
                          shortId: docRef.id.slice(-6).toUpperCase(),
                          items: orderItems,
                          total: total,
                          status: 'ordered',
                          tableNumber: currentTableNumber,
                          createdAt: orderData.createdAt,
                          updatedAt: orderData.updatedAt
                      };
                      guestOrders.push(guestOrderData);
                      saveSessionToCookie();
                  }

                  // ƒê√≥ng cart v√† x√≥a gi·ªè h√†ng
                  document.getElementById('cart-sidebar').classList.add('translate-x-full');
                  cart = {};
                  localStorage.removeItem('cart');
                  renderApp();

              } catch (error) {
                  console.error("Error creating order:", error);
                  showMessage("L·ªói khi ƒë·∫∑t h√†ng: " + error.message, "error");
              } finally {
                  // Always re-enable button regardless of success/failure
                  enableOrderButton();
              }
          }

          // ==================== ORDER MANAGEMENT (ADMIN) ====================
          
          let currentOrderFilter = 'ordered'; // ordered, preparing, completed, cancelled, all, today
          let dateFrom = null; // Start date for filtering (Date object)
          let dateTo = null; // End date for filtering (Date object)
          let currentPage = 1;
          let itemsPerPage = 5; // Default 10 items per page
          let processingOrderId = localStorage.getItem('processingOrderId'); // L·∫•y t·ª´ storage n·∫øu reload

          // Setup realtime listener cho orders
          function setupOrdersListener() {
              if (!db) {
                  console.error("Database not initialized");
                  return;
              }

              try {
                  console.log("üì° Setting up orders realtime listener...");
                  const ordersRef = collection(db, 'orders');
                  
                  onSnapshot(ordersRef, (snapshot) => {
                      orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      console.log("üìã Orders updated:", orders.length);
                      
                      // --- LOGIC T·ª∞ ƒê·ªòNG CHUY·ªÇN TAB V√Ä TR·∫†NG TH√ÅI ---
                      if (isAdmin) {
                           // 1. Ki·ªÉm tra ƒë∆°n h√†ng ƒëang l√†m (processingOrderId)
                           if (processingOrderId) {
                               const processingOrder = orders.find(o => o.id === processingOrderId);
                               
                               // N·∫øu ƒë∆°n v·∫´n ƒëang l√†m ('preparing') -> Gi·ªØ m√†n h√¨nh ·ªü tab 'preparing'
                               if (processingOrder && processingOrder.status === 'preparing') {
                                   if (currentOrderFilter !== 'preparing') {
                                       currentOrderFilter = 'preparing';
                                   }
                               } 
                               // N·∫øu ƒë∆°n ƒë√£ xong ho·∫∑c h·ªßy -> X√≥a tr·∫°ng th√°i ƒëang l√†m
                               else {
                                   processingOrderId = null;
                                   localStorage.removeItem('processingOrderId');
                                   
                                   // N·∫øu v·ª´a xong ƒë∆°n l√†m, ki·ªÉm tra xem c√≥ ƒë∆°n ch·ªù n√†o kh√¥ng ƒë·ªÉ chuy·ªÉn v·ªÅ tab ordered
                                   const hasPendingOrders = orders.some(o => o.status === 'ordered');
                                   if (hasPendingOrders && currentOrderFilter !== 'ordered') {
                                       currentOrderFilter = 'ordered';
                                   }
                               }
                           }
                           
                           // 2. Logic khi c√≥ ƒë∆°n m·ªõi
                           snapshot.docChanges().forEach(change => {
                               if (change.type === 'added') {
                                   const order = change.doc.data();
                                   if (order.status === 'ordered') {
                                       showMessage(`üîî ƒê∆°n h√†ng m·ªõi: #${change.doc.id.slice(-6).toUpperCase()}`, 'info');
                                       speak(`C√≥ ƒë∆°n h√†ng m·ªõi`);
                                       
                                       // N·∫æU KH√îNG ƒêANG L√ÄM ƒê∆†N N√ÄO -> T·ª± ƒë·ªông chuy·ªÉn sang tab ch·ªù nh·∫≠n
                                       if (!processingOrderId && currentOrderFilter !== 'ordered') {
                                           currentOrderFilter = 'ordered';
                                       }
                                   }
                               }
                           });
                      }

                      // Re-render header ƒë·ªÉ c·∫≠p nh·∫≠t badge
                      if (isAdmin) {
                          document.getElementById('header-container').innerHTML = renderHeader();
                          renderLucideIcons();
                      }
                      
                      // Render n·∫øu ƒëang ·ªü trang admin orders
                      if (currentView === 'admin-orders') {
                          renderOrdersManagementList();
                      }
                      
                      // C·∫≠p nh·∫≠t guest orders n·∫øu c√≥ thay ƒë·ªïi
                      snapshot.docChanges().forEach(change => {
                          if (userRole === 'guest' && change.type === 'modified') {
                              const orderData = change.doc.data();
                              const guestOrder = guestOrders.find(o => o.orderId === change.doc.id);
                              if (guestOrder) {
                                  guestOrder.status = orderData.status;
                                  guestOrder.updatedAt = orderData.updatedAt;
                                  saveSessionToCookie();
                                  console.log('üìù Guest order updated:', guestOrder);
                              }
                          }
                      });
                  }, (error) => {
                      console.error("Error in orders listener:", error);
                  });
                  
              } catch (error) {
                  console.error("Error setting up orders listener:", error);
              }
          }
          
          // Setup m·∫∑c ƒë·ªãnh cho trang qu·∫£n l√Ω ƒë∆°n h√†ng
          function setupOrdersPage() {
              currentOrderFilter = 'ordered'; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã ƒë∆°n ch·ªù
              // Set default to show today's orders
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time
          }

          function setOrderFilter(filter) {
              currentOrderFilter = filter;
              renderOrdersManagementList();
          }

          function toggleDateFilter() {
              const content = document.getElementById('date-filter-content');
              const arrow = document.getElementById('date-filter-arrow');

              if (content.classList.contains('hidden')) {
                  content.classList.remove('hidden');
                  arrow.textContent = '‚ñ≤';
              } else {
                  content.classList.add('hidden');
                  arrow.textContent = '‚ñº';
              }
          }

          function applyDateFilter() {
              const fromInput = document.getElementById('date-from');
              const toInput = document.getElementById('date-to');

              if (fromInput && fromInput.value) {
                  dateFrom = new Date(fromInput.value);
              } else {
                  dateFrom = null;
              }

              if (toInput && toInput.value) {
                  dateTo = new Date(toInput.value);
              } else {
                  dateTo = null;
              }

              currentPage = 1; // Reset to first page when changing filters
              renderOrdersManagementList();

              // Close the date filter after applying
              const content = document.getElementById('date-filter-content');
              const arrow = document.getElementById('date-filter-arrow');
              if (content && arrow) {
                  content.classList.add('hidden');
                  arrow.textContent = '‚ñº';
              }
          }

          function clearDateFilter() {
              // Clear date filter and show today's orders (from 00:00 to current time)
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time

              // Update input values to show today's range
              document.getElementById('date-from').value = dateFrom.toISOString().slice(0, 16);
              document.getElementById('date-to').value = dateTo.toISOString().slice(0, 16);

              currentPage = 1; // Reset to first page when clearing filters
              renderOrdersManagementList();
          }

          function resetDateFilter() {
              // Reset to default: today from 00:00 to current time
              const now = new Date();
              const today = new Date(now);
              today.setHours(0, 0, 0, 0); // Start of today
              dateFrom = today;
              dateTo = now; // Current time

              // Update input values
              document.getElementById('date-from').value = dateFrom.toISOString().slice(0, 16);
              document.getElementById('date-to').value = dateTo.toISOString().slice(0, 16);

              currentPage = 1; // Reset to first page when resetting filters
              renderOrdersManagementList();
          }

          function setItemsPerPage(count) {
              itemsPerPage = parseInt(count);
              currentPage = 1; // Reset to first page when changing items per page
              renderOrdersManagementList();
          }

          function setPage(page) {
              currentPage = page;
              renderOrdersManagementList();
          }

          function nextPage() {
              const totalPages = Math.ceil(getFilteredOrders().length / itemsPerPage);
              if (currentPage < totalPages) {
                  currentPage++;
                  renderOrdersManagementList();
              }
          }

          function prevPage() {
              if (currentPage > 1) {
                  currentPage--;
                  renderOrdersManagementList();
              }
          }

          function getFilteredOrders() {
              // Filter orders
              let filteredOrders = [...orders];

              // Filter theo date range
              if (dateFrom || dateTo) {
                  filteredOrders = filteredOrders.filter(order => {
                      if (!order.createdAt) return false;
                      const orderDate = new Date(order.createdAt.seconds * 1000);

                      if (dateFrom && orderDate < dateFrom) return false;
                      if (dateTo && orderDate > dateTo) return false;

                      return true;
                  });
              }

              // Filter theo status
              if (currentOrderFilter !== 'all') {
                  filteredOrders = filteredOrders.filter(order => order.status === currentOrderFilter);
              }

              // Sort: ∆∞u ti√™n ƒë∆°n ch·ªù (ordered) l√™n ƒë·∫ßu, sau ƒë√≥ theo th·ªùi gian m·ªõi nh·∫•t
              filteredOrders.sort((a, b) => {
                  // ∆Øu ti√™n ordered
                  if (a.status === 'ordered' && b.status !== 'ordered') return -1;
                  if (a.status !== 'ordered' && b.status === 'ordered') return 1;

                  // Sau ƒë√≥ preparing
                  if (a.status === 'preparing' && b.status !== 'preparing' && b.status !== 'ordered') return -1;
                  if (a.status !== 'preparing' && b.status === 'preparing') return 1;

                  // Cu·ªëi c√πng theo th·ªùi gian
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  return timeB - timeA;
              });

              return filteredOrders;
          }

          function renderOrdersManagementList() {
              const container = document.getElementById('orders-management-content');
              if (!container) {
                  console.log('Container not found, skipping render');
                  return;
              }

              const filteredOrders = getFilteredOrders();

              // Count theo status (theo k·∫øt qu·∫£ l·ªçc th·ªùi gian, kh√¥ng ph·ª• thu·ªôc v√†o currentOrderFilter)
              let dateFilteredOrders = orders;
              if (dateFrom || dateTo) {
                  dateFilteredOrders = orders.filter(order => {
                      if (!order.createdAt) return false;
                      const orderDate = new Date(order.createdAt.seconds * 1000);

                      if (dateFrom && orderDate < dateFrom) return false;
                      if (dateTo && orderDate > dateTo) return false;

                      return true;
                  });
              }

              const counts = {
                  ordered: dateFilteredOrders.filter(o => o.status === 'ordered').length,
                  preparing: dateFilteredOrders.filter(o => o.status === 'preparing').length,
                  completed: dateFilteredOrders.filter(o => o.status === 'completed').length,
                  cancelled: dateFilteredOrders.filter(o => o.status === 'cancelled').length
              };

              // Pagination calculations
              const totalItems = filteredOrders.length;
              const totalPages = Math.ceil(totalItems / itemsPerPage);
              const startIndex = (currentPage - 1) * itemsPerPage;
              const endIndex = startIndex + itemsPerPage;
              const paginatedOrders = filteredOrders.slice(startIndex, endIndex);
              
              container.innerHTML = `
                  <!-- Filter Bar -->
                  <div class="bg-gray-50 p-3 sm:p-4 rounded-lg mb-3 sm:mb-4 space-y-2 sm:space-y-3">
                      <!-- Date Range Filter -->
                      <div>
                          <button onclick="toggleDateFilter()" class="w-full text-left flex items-center justify-between text-xs font-medium text-gray-700 hover:text-gray-900 transition">
                              <span>üóìÔ∏è L·ªçc theo kho·∫£ng th·ªùi gian</span>
                              <span id="date-filter-arrow" class="text-gray-400">‚ñº</span>
                          </button>
                          <div id="date-filter-content" class="hidden mt-2 space-y-2">
                              <div class="flex gap-2">
                                  <div class="flex-1">
                                      <label class="text-[9px] text-gray-600 block mb-0.5">T·ª´:</label>
                                  <input type="datetime-local" id="date-from" class="w-full px-1.5 py-1 border border-gray-300 rounded text-[11px] focus:ring-blue-500 focus:border-blue-500">
                              </div>
                              <div class="flex-1">
                                  <label class="text-[9px] text-gray-600 block mb-0.5">ƒê·∫øn:</label>
                                  <input type="datetime-local" id="date-to" class="w-full px-1.5 py-1 border border-gray-300 rounded text-[11px] focus:ring-blue-500 focus:border-blue-500">
                                  </div>
                              </div>
                              <div class="flex gap-2">
                                  <button onclick="applyDateFilter()" class="flex-1 px-3 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 active:scale-95 transition">
                                      L·ªçc
                                  </button>
                                  <button onclick="clearDateFilter()" class="px-2 py-1.5 bg-gray-500 text-white rounded text-[10px] hover:bg-gray-600 active:scale-95 transition whitespace-nowrap">
                                      X√≥a b·ªô l·ªçc
                                  </button>
                                  <button onclick="resetDateFilter()" class="px-2 py-1.5 bg-orange-500 text-white rounded text-[10px] hover:bg-orange-600 active:scale-95 transition whitespace-nowrap">
                                      ƒê·∫∑t l·∫°i
                                  </button>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Status Filter -->
                      <div>
                          <label class="text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2 block">üìä L·ªçc theo tr·∫°ng th√°i:</label>
                          <div class="flex flex-wrap gap-1.5 sm:gap-2">
                              <button onclick="setOrderFilter('ordered')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'ordered' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üìã Ch·ªù nh·∫≠n (${counts.ordered})
                              </button>
                              <button onclick="setOrderFilter('preparing')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'preparing' ? 'bg-yellow-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üë®‚Äçüç≥ ƒêang l√†m (${counts.preparing})
                              </button>
                              <button onclick="setOrderFilter('completed')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'completed' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  ‚úÖ Ho√†n th√†nh (${counts.completed})
                              </button>
                              <button onclick="setOrderFilter('cancelled')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'cancelled' ? 'bg-red-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  ‚ùå ƒê√£ h·ªßy (${counts.cancelled})
                              </button>
                              <button onclick="setOrderFilter('all')" class="px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium ${currentOrderFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} active:scale-95 transition whitespace-nowrap">
                                  üìÇ T·∫•t c·∫£ (${dateFilteredOrders.length})
                              </button>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Orders List -->
                  <div class="space-y-3 sm:space-y-4">
                      ${paginatedOrders.length === 0 ? `
                          <p class="text-center text-gray-500 py-8 sm:py-12">
                              <i data-lucide="inbox" class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 opacity-50"></i>
                              <br><span class="text-sm sm:text-base">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</span>
                          </p>
                      ` : paginatedOrders.map(order => `
                          <div class="bg-white p-3 sm:p-4 rounded-lg border-2 ${
                              order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                              order.status === 'completed' ? 'border-green-200 bg-green-50' :
                              order.status === 'preparing' ? 'border-yellow-200 bg-yellow-50' :
                              'border-blue-200 bg-blue-50'
                          }">
                              <div class="flex flex-col gap-2 sm:gap-3 mb-2 sm:mb-3">
                                  <div class="flex-1 min-w-0">
                                      <h4 class="font-semibold text-purple-800 flex flex-wrap items-center gap-1.5 sm:gap-2 mb-1">
                                          <span class="text-xs sm:text-sm md:text-base">Order #${order.id.slice(-6).toUpperCase()}</span>
                                          ${order.tableNumber ? `<span class="px-1.5 py-0.5 sm:px-2 bg-teal-100 text-teal-700 text-[10px] sm:text-xs rounded-full whitespace-nowrap">üçΩÔ∏è B√†n ${order.tableNumber}</span>` : ''}
                                      </h4>
                                      <p class="text-[11px] sm:text-xs md:text-sm text-gray-600 mb-0.5 sm:mb-1">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                      <p class="text-[10px] sm:text-xs text-gray-500 truncate">Kh√°ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                                  </div>
                                  <div class="flex flex-wrap items-center gap-1.5 sm:gap-2">
                                        ${order.status === 'ordered' ? `
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-red-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition flex-1 sm:flex-none">
                                              ‚ùå H·ªßy
                                          </button>
                                          <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-green-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition flex-1 sm:flex-none">
                                              ‚úÖ Nh·∫≠n ƒë∆°n
                                          </button>
                                        ` : order.status === 'preparing' ? `
                                          <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-red-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition flex-1 sm:flex-none">
                                              ‚ùå H·ªßy
                                          </button>
                                          <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-blue-600 text-[11px] sm:text-xs md:text-sm font-medium whitespace-nowrap active:scale-95 transition flex-1 sm:flex-none">
                                              ‚úÖ Ho√†n th√†nh
                                          </button>
                                        ` : `
                                          <span class="px-2 sm:px-3 py-1 rounded-full text-[11px] sm:text-xs md:text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                              ${getStatusText(order.status)}
                                          </span>
                                      `}
                                  </div>
                              </div>

                              <div class="space-y-1.5 sm:space-y-2 mb-2 sm:mb-3">
                                  ${order.items.map(item => `
                                      <div class="flex justify-between items-center bg-white p-1.5 sm:p-2 rounded">
                                          <div class="flex-1 min-w-0">
                                              <span class="font-medium text-xs sm:text-sm md:text-base">${item.name}</span>
                                              ${item.size ? `<span class="text-[10px] sm:text-xs text-blue-600 ml-1">(${item.size})</span>` : ''}
                                              <span class="text-[10px] sm:text-xs text-gray-600 ml-1">x${item.quantity}</span>
                                          </div>
                                          <div class="flex items-center gap-1 sm:gap-2">
                                              <span class="text-[11px] sm:text-xs md:text-sm font-semibold text-orange-600 whitespace-nowrap">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                              ${order.status === 'preparing' ? `
                                                  <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-0.5 sm:p-1 active:scale-95 transition" title="X√≥a m√≥n">
                                                      <i data-lucide="x" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                                  </button>
                                              ` : ''}
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>

                              ${order.status === 'preparing' ? `
                                  <div class="border-t pt-2 sm:pt-3 mb-2 sm:mb-3">
                                      <p class="text-[10px] sm:text-xs text-gray-600 mb-1.5 sm:mb-2 font-medium">üõ† Ch·ªânh s·ª≠a ƒë∆°n h√†ng:</p>
                                      <div class="flex gap-1.5 sm:gap-2">
                                          <select id="add-item-${order.id}" class="flex-1 text-[11px] sm:text-xs md:text-sm border rounded px-2 py-1.5 sm:py-2">
                                              <option value="">Ch·ªçn m√≥n th√™m...</option>
                                              ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                                  <option value="${item.id}">${item.name} - ${formatCurrency(getItemPrice(item))}</option>
                                              `).join('')}
                                          </select>
                                          <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-2 sm:px-3 py-1.5 sm:py-2 rounded hover:bg-green-600 text-[11px] sm:text-xs md:text-sm active:scale-95 transition">
                                              <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                          </button>
                                      </div>
                                  </div>
                              ` : ''}

                              <div class="flex justify-between items-center pt-1.5 sm:pt-2 border-t">
                                  <span class="font-bold text-sm sm:text-base md:text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                                  <span class="text-[10px] sm:text-xs md:text-sm px-2 sm:px-3 py-0.5 sm:py-1 rounded-full ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              </div>
                          </div>
                      `).join('')}

                      <!-- Pagination Controls -->
                      ${totalPages > 1 ? `
                          <div class="bg-white p-3 sm:p-4 rounded-lg border border-gray-200 mt-4 sm:mt-6">
                              <div class="flex flex-col gap-3 sm:gap-4">
                                  <!-- Items per page selector -->
                                  <div class="flex items-center justify-center sm:justify-start gap-1.5 sm:gap-2">
                                      <label class="text-xs sm:text-sm text-gray-600">Hi·ªÉn th·ªã:</label>
                                      <select onchange="setItemsPerPage(this.value)" class="px-2 sm:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm">
                                          <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5</option>
                                          <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                          <option value="20" ${itemsPerPage === 20 ? 'selected' : ''}>20</option>
                                          <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                      </select>
                                      <span class="text-xs sm:text-sm text-gray-600">ƒë∆°n/trang</span>
                                  </div>

                                  <!-- Pagination info -->
                                  <div class="text-xs sm:text-sm text-gray-600 text-center">
                                      Hi·ªÉn th·ªã ${totalItems > 0 ? startIndex + 1 : 0}-${Math.min(endIndex, totalItems)} c·ªßa ${totalItems} ƒë∆°n
                                  </div>

                                  <!-- Page navigation -->
                                  <div class="flex items-center justify-center gap-1 sm:gap-2">
                                      <button onclick="setPage(1)" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                      <button onclick="prevPage()" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                                          <i data-lucide="chevron-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>

                                      <span class="px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-blue-50 border border-blue-200 rounded whitespace-nowrap">
                                          ${currentPage} / ${totalPages}
                                      </span>

                                      <button onclick="nextPage()" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevron-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                      <button onclick="setPage(${totalPages})" class="px-1.5 sm:px-2 md:px-3 py-1 sm:py-1.5 border border-gray-300 rounded text-xs sm:text-sm hover:bg-gray-50 active:scale-95 transition ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage >= totalPages ? 'disabled' : ''}>
                                          <i data-lucide="chevrons-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                      </button>
                                  </div>
                              </div>
                          </div>
                      ` : ''}
                  </div>
              `;

              // Set default values for date inputs based on current filter
              setTimeout(() => {
                  const fromInput = document.getElementById('date-from');
                  const toInput = document.getElementById('date-to');

                  if (fromInput && dateFrom) {
                      fromInput.value = dateFrom.toISOString().slice(0, 16);
                  }

                  if (toInput && dateTo) {
                      toInput.value = dateTo.toISOString().slice(0, 16);
                  }
              }, 100);

              renderLucideIcons();
          }

          async function loadOrders() {
              try {
                  console.log("Loading orders...");
                  const querySnapshot = await getDocs(collection(db, 'orders'));
                  orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log("Loaded orders:", orders.length);
                  renderOrdersList();

              } catch (error) {
                  console.error("Error loading orders:", error);
                  showMessage("L·ªói t·∫£i ƒë∆°n h√†ng: " + error.message, "error");
              }
          }

          function renderOrdersList() {
              const ordersList = document.getElementById('orders-list');
              const orderCount = document.getElementById('order-count');

              if (!ordersList || !orderCount) return;

              orderCount.textContent = orders.length;

              if (orders.length === 0) {
                  ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                  return;
              }

              // Sort orders by createdAt (newest first)
              const sortedOrders = [...orders].sort((a, b) => {
                  const timeA = a.createdAt?.seconds || 0;
                  const timeB = b.createdAt?.seconds || 0;
                  return timeB - timeA;
              });

              ordersList.innerHTML = sortedOrders.map(order => `
                  <div class="bg-white p-4 rounded-lg border-2 ${
                      order.status === 'cancelled' ? 'border-red-200 bg-red-50' :
                      order.status === 'completed' ? 'border-green-200 bg-green-50' :
                      order.status === 'updated' ? 'border-yellow-200 bg-yellow-50' :
                      'border-purple-200'
                  }">
                      <div class="flex justify-between items-start mb-3">
                          <div>
                              <h4 class="font-semibold text-purple-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                              <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                              <p class="text-xs text-gray-500">Kh√°ch: ${order.customerEmail || order.customerId.slice(-6)}</p>
                          </div>
                          <div class="flex items-center gap-2">
                              ${order.status === 'ordered' ? `
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium">
                                      ‚ùå H·ªßy
                                  </button>
                                  <button onclick="acceptOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600 text-sm font-medium ml-2">
                                      ‚úÖ Nh·∫≠n ƒë∆°n
                                  </button>
                              ` : order.status === 'preparing' ? `
                                  <button onclick="cancelOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1.5 rounded hover:bg-red-600 text-sm font-medium">
                                      ‚ùå H·ªßy
                                  </button>
                                  <button onclick="completeOrder('${order.id}')" class="bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600 text-sm font-medium ml-2">
                                      ‚úÖ Ho√†n th√†nh
                                  </button>
                              ` : order.status === 'completed' || order.status === 'cancelled' ? `
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              ` : ''}
                          </div>
                      </div>

                      <div class="space-y-2 mb-3">
                          ${order.items.map(item => `
                              <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                  <div class="flex-1">
                                      <span class="font-medium">${item.name}</span>
                                      ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                      <span class="text-sm text-gray-600">x${item.quantity}</span>
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                      ${order.status === 'preparing' ? `
                                          <button onclick="removeItemFromOrder('${order.id}', '${item.id}')" class="text-red-500 hover:text-red-700 p-1" title="X√≥a m√≥n">
                                              <i data-lucide="x" class="w-4 h-4"></i>
                                          </button>
                                      ` : ''}
                                  </div>
                              </div>
                          `).join('')}
                      </div>

                      ${order.status === 'preparing' ? `
                          <div class="border-t pt-3 mb-3">
                              <p class="text-xs text-gray-600 mb-2 font-medium">üõ† Ch·ªânh s·ª≠a ƒë∆°n h√†ng:</p>
                              <div class="flex gap-2">
                                  <select id="add-item-${order.id}" class="flex-1 text-sm border rounded px-2 py-1">
                                      <option value="">Ch·ªçn m√≥n th√™m...</option>
                                      ${menuItems.filter(item => item.status !== 'deleted').map(item => `
                                          <option value="${item.id}">${item.name} - ${formatCurrency(item.price)}</option>
                                      `).join('')}
                                  </select>
                                  <button onclick="addItemToOrder('${order.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                      <i data-lucide="plus" class="w-4 h-4"></i>
                                  </button>
                              </div>
                          </div>
                      ` : ''}

                      <div class="flex justify-between items-center pt-2 border-t">
                          <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                          <span class="text-sm px-3 py-1 rounded-full ${getStatusBadgeClass(order.status)}">
                              ${getStatusText(order.status)}
                          </span>
                      </div>
                  </div>
              `).join('');

              renderLucideIcons();
          }

          function getStatusText(status) {
              const statusMap = {
                  'ordered': 'üìã Ch·ªù nh·∫≠n',
                  'preparing': 'üë®‚Äçüç≥ ƒêang l√†m',
                  'completed': '‚úÖ Ho√†n th√†nh',
                  'cancelled': '‚ùå ƒê√£ h·ªßy',
                  'updated': 'üîÑ ƒê√£ c·∫≠p nh·∫≠t'
              };
              return statusMap[status] || status;
          }

          function getStatusBadgeClass(status) {
              const classMap = {
                  'ordered': 'bg-blue-100 text-blue-800',
                  'preparing': 'bg-yellow-100 text-yellow-800',
                  'completed': 'bg-green-200 text-green-900',
                  'cancelled': 'bg-red-100 text-red-800',
                  'updated': 'bg-orange-100 text-orange-800'
              };
              return classMap[status] || 'bg-gray-100 text-gray-800';
          }

          // Nh·∫≠n ƒë∆°n h√†ng
          async function acceptOrder(orderId) {
              if (!confirm("X√°c nh·∫≠n nh·∫≠n ƒë∆°n h√†ng n√†y?")) return; // Add confirm check

              try {
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'preparing',
                      acceptedAt: new Date(),
                      updatedAt: new Date()
                  });

                  // Set as currently processing order
                  processingOrderId = orderId;
                  localStorage.setItem('processingOrderId', orderId);
                  currentOrderFilter = 'preparing'; // Chuy·ªÉn sang tab ƒëang l√†m
                  renderOrdersManagementList(); // Update UI immediately

                  showMessage(`‚úÖ ƒê√£ nh·∫≠n ƒë∆°n #${orderId.slice(-6).toUpperCase()}`, "success");
                  speak("ƒê√£ nh·∫≠n ƒë∆°n");

              } catch (error) {
                  console.error("Error accepting order:", error);
                  showMessage("L·ªói nh·∫≠n ƒë∆°n: " + error.message, "error");
              }
          }

          // H·ªßy ƒë∆°n h√†ng
          async function cancelOrder(orderId) {
              if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën H·ª¶Y ƒë∆°n h√†ng n√†y?")) return;

              try {
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'cancelled',
                      cancelledAt: new Date(),
                      cancelledBy: 'admin',
                      updatedAt: new Date()
                  });

                  showMessage(`‚ùå ƒê√£ h·ªßy ƒë∆°n #${orderId.slice(-6).toUpperCase()}`, "warning");

              } catch (error) {
                  console.error("Error cancelling order:", error);
                  showMessage("L·ªói h·ªßy ƒë∆°n: " + error.message, "error");
              }
          }

          // Ho√†n th√†nh ƒë∆°n h√†ng v√† l∆∞u th·ªëng k√™
          async function completeOrder(orderId) {
              if (!confirm("X√°c nh·∫≠n HO√ÄN TH√ÄNH ƒë∆°n h√†ng n√†y?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const completedAt = new Date();
                  
                  // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i order
                  await updateDoc(doc(db, 'orders', orderId), {
                      status: 'completed',
                      completedAt: completedAt,
                      updatedAt: completedAt
                  });

                  // Clear processing state
                  if (processingOrderId === orderId) {
                      processingOrderId = null;
                      localStorage.removeItem('processingOrderId');
                      
                      // Check for pending orders to switch back
                      const hasPendingOrders = orders.some(o => o.status === 'ordered');
                      if (hasPendingOrders && currentOrderFilter !== 'ordered') {
                          currentOrderFilter = 'ordered';
                      }
                      renderOrdersManagementList();
                  }

                  // 2. L∆∞u th·ªëng k√™ doanh thu
                  const year = completedAt.getFullYear();
                  const month = completedAt.getMonth() + 1; // 1-12
                  const statsId = `${year}-${month.toString().padStart(2, '0')}`;

                  const statsRef = doc(db, 'statistics', statsId);
                  
                  try {
                      // Ki·ªÉm tra xem th√°ng n√†y ƒë√£ c√≥ ch∆∞a
                      const statsDoc = await getDoc(statsRef);
                      
                      if (statsDoc.exists()) {
                          // C·ªông d·ªìn v√†o th√°ng hi·ªán t·∫°i
                          const currentData = statsDoc.data();
                          await updateDoc(statsRef, {
                              totalRevenue: (currentData.totalRevenue || 0) + order.total,
                              orderCount: (currentData.orderCount || 0) + 1,
                              updatedAt: completedAt
                          });
                      } else {
                          // T·∫°o m·ªõi cho th√°ng n√†y
                          await setDoc(statsRef, {
                              year: year,
                              month: month,
                              totalRevenue: order.total,
                              orderCount: 1,
                              createdAt: completedAt,
                              updatedAt: completedAt
                          });
                      }
                  } catch (statsError) {
                      console.error("Error updating statistics:", statsError);
                      // V·∫´n ti·∫øp t·ª•c ho√†n th√†nh ƒë∆°n d√π l∆∞u th·ªëng k√™ l·ªói
                  }

                  showMessage(`‚úÖ Ho√†n th√†nh ƒë∆°n #${orderId.slice(-6).toUpperCase()} - ${formatCurrency(order.total)}`, "success");
                  speak("ƒê∆°n h√†ng ho√†n th√†nh");

              } catch (error) {
                  console.error("Error completing order:", error);
                  showMessage("L·ªói ho√†n th√†nh ƒë∆°n: " + error.message, "error");
              }
          }

          async function addItemToOrder(orderId) {
              const selectElement = document.getElementById(`add-item-${orderId}`);
              const itemId = selectElement.value;

              if (!itemId) {
                  showMessage("Vui l√≤ng ch·ªçn m√≥n!", "warning");
                  return;
              }

              try {
                  const order = orders.find(o => o.id === orderId);
                  const menuItem = menuItems.find(item => item.id === itemId);

                  if (!order || !menuItem) return;

                  // Check if item already exists in order
                  const existingItem = order.items.find(item => item.id === itemId);
                  if (existingItem) {
                      existingItem.quantity += 1;
                  } else {
                      order.items.push({
                          id: menuItem.id,
                          name: menuItem.name,
                          price: menuItem.price,
                          quantity: 1,
                          size: menuItem.size || null,
                          category: menuItem.category
                      });
                  }

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + ((item.newPrice || item.price) * item.quantity), 0);

                  // Update in Firestore - v·∫´n gi·ªØ status preparing, kh√¥ng ƒë·ªïi th√†nh updated
                  await updateDoc(doc(db, 'orders', orderId), {
                      items: order.items,
                      total: order.total,
                      updatedAt: new Date(),
                      updatedBy: 'admin'
                  });

                  selectElement.value = '';
                  showMessage(`‚úÖ ƒê√£ th√™m ${menuItem.name}`, "success");

              } catch (error) {
                  console.error("Error adding item to order:", error);
                  showMessage("L·ªói th√™m m√≥n: " + error.message, "error");
              }
          }

          async function removeItemFromOrder(orderId, itemId) {
              if (!confirm("X√≥a m√≥n n√†y kh·ªèi ƒë∆°n h√†ng?")) return;

              try {
                  const order = orders.find(o => o.id === orderId);
                  if (!order) return;

                  const removedItem = order.items.find(item => item.id === itemId);
                  
                  // Remove item
                  order.items = order.items.filter(item => item.id !== itemId);

                  // Recalculate total
                  order.total = order.items.reduce((sum, item) => sum + ((item.newPrice || item.price) * item.quantity), 0);

                  // If no items left, cancel the order
                  if (order.items.length === 0) {
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: 0,
                          status: 'cancelled',
                          cancelledBy: 'admin-no-items',
                          updatedAt: new Date()
                      });
                      showMessage("‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy (kh√¥ng c√≤n m√≥n)", "warning");
                  } else {
                      // Update in Firestore
                      await updateDoc(doc(db, 'orders', orderId), {
                          items: order.items,
                          total: order.total,
                          updatedAt: new Date(),
                          updatedBy: 'admin'
                      });
                      showMessage(`üóëÔ∏è ƒê√£ x√≥a ${removedItem?.name || 'm√≥n'}`, "success");
                  }

              } catch (error) {
                  console.error("Error removing item from order:", error);
                  showMessage("L·ªói x√≥a m√≥n: " + error.message, "error");
              }
          }

          // ==================== CUSTOMER ORDER HISTORY ====================
          async function showMyOrders() {
              // Guest: xem t·ª´ cookie session
              if (userRole === 'guest') {
                  console.log("Loading guest orders from session...");
                  showGuestOrders();
                  return;
              }

              // Customer: query Firebase
              if (!auth.currentUser) {
                  showMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë∆°n h√†ng!", "warning");
                  return;
              }

              try {
                  console.log("Loading customer orders from Firebase...");
                  const q = query(collection(db, 'orders'), where('customerId', '==', userId));
                  const querySnapshot = await getDocs(q);
                  const myOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  console.log("Loaded customer orders:", myOrders.length);

                  const modalContent = document.getElementById('my-orders-content');

                  if (myOrders.length === 0) {
                      modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                  } else {
                      // Sort by newest first
                      const sortedOrders = myOrders.sort((a, b) => {
                          const timeA = a.createdAt?.seconds || 0;
                          const timeB = b.createdAt?.seconds || 0;
                          return timeB - timeA;
                      });

                      modalContent.innerHTML = sortedOrders.map(order => `
                          <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                              order.status === 'cancelled' ? 'border-red-200' :
                              order.status === 'completed' ? 'border-green-200' :
                              'border-blue-200'
                          } mb-4">
                              <div class="flex justify-between items-start mb-3">
                                  <div>
                                      <h4 class="font-semibold text-blue-800">Order #${order.id.slice(-6).toUpperCase()}</h4>
                                      <p class="text-sm text-gray-600">${new Date(order.createdAt.seconds * 1000).toLocaleString('vi-VN')}</p>
                                  </div>
                                  <div class="text-right">
                                      <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                          ${getStatusText(order.status)}
                                      </span>
                                  </div>
                              </div>

                              <div class="space-y-2 mb-3">
                                  ${order.items.map(item => `
                                      <div class="flex justify-between items-center bg-white p-2 rounded">
                                          <div class="flex-1">
                                              <span class="font-medium">${item.name}</span>
                                              ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                              <span class="text-sm text-gray-600">x${item.quantity}</span>
                                          </div>
                                          <div class="text-right">
                                              <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>

                              <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                  <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                                  <span class="text-xs font-medium ${
                                      order.status === 'ordered' ? 'text-blue-600' :
                                      order.status === 'preparing' ? 'text-yellow-600' :
                                      order.status === 'cancelled' ? 'text-red-600' :
                                      order.status === 'completed' ? 'text-green-600' :
                                      'text-gray-600'
                                  }">
                                      ${order.status === 'ordered' ? 'üìã Ch·ªù nh·∫≠n ƒë∆°n' :
                                        order.status === 'preparing' ? 'üë®‚Äçüç≥ ƒêang l√†m' :
                                        order.status === 'cancelled' ? '‚ùå ƒê√£ h·ªßy' :
                                        order.status === 'completed' ? '‚úÖ Ho√†n th√†nh' :
                                        'üîÑ ƒêang x·ª≠ l√Ω'}
                                  </span>
                              </div>

                              ${order.updatedBy === 'admin' && order.status === 'preparing' ? `
                                  <div class="mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800 border border-yellow-200">
                                      <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                      Admin ƒë√£ ch·ªânh s·ª≠a ƒë∆°n h√†ng (th√™m/x√≥a m√≥n)
                                  </div>
                              ` : ''}
                          </div>
                      `).join('');
                  }

                  document.getElementById('my-orders-modal').classList.remove('hidden');
                  renderLucideIcons();

              } catch (error) {
                  console.error("Error loading my orders:", error);
                  showMessage("L·ªói t·∫£i ƒë∆°n h√†ng: " + error.message, "error");
              }
          }

          function closeMyOrdersModal() {
              document.getElementById('my-orders-modal').classList.add('hidden');
          }

          // Hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa guest t·ª´ session
          function showGuestOrders() {
              const modalContent = document.getElementById('my-orders-content');

              if (guestOrders.length === 0) {
                  modalContent.innerHTML = '<p class="text-gray-500 text-center py-8">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong phi√™n n√†y</p>';
              } else {
                  // Sort by newest first
                  const sortedOrders = [...guestOrders].sort((a, b) => {
                      const timeA = new Date(a.createdAt).getTime();
                      const timeB = new Date(b.createdAt).getTime();
                      return timeB - timeA;
                  });

                  modalContent.innerHTML = sortedOrders.map(order => `
                      <div class="bg-gray-50 p-4 rounded-lg border-2 ${
                          order.status === 'cancelled' ? 'border-red-200' :
                          order.status === 'completed' ? 'border-green-200' :
                          'border-blue-200'
                      } mb-4">
                          <div class="flex justify-between items-start mb-3">
                              <div>
                                  <h4 class="font-semibold text-blue-800">Order #${order.shortId}</h4>
                                  <p class="text-sm text-gray-600">${new Date(order.createdAt).toLocaleString('vi-VN')}</p>
                                  <p class="text-xs text-gray-500">B√†n: ${order.tableNumber || 'N/A'}</p>
                              </div>
                              <div class="text-right">
                                  <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(order.status)}">
                                      ${getStatusText(order.status)}
                                  </span>
                              </div>
                          </div>

                          <div class="space-y-2 mb-3">
                              ${order.items.map(item => `
                                  <div class="flex justify-between items-center bg-white p-2 rounded">
                                      <div class="flex-1">
                                          <span class="font-medium">${item.name}</span>
                                          ${item.size ? `<span class="text-sm text-blue-600 ml-1">(${item.size})</span>` : ''}
                                          <span class="text-sm text-gray-600">x${item.quantity}</span>
                                      </div>
                                      <div class="text-right">
                                          <span class="text-sm font-semibold text-orange-600">${formatCurrency((item.newPrice || item.price) * item.quantity)}</span>
                                      </div>
                                  </div>
                              `).join('')}
                          </div>

                          <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                              <span class="font-bold text-lg text-orange-600">T·ªïng: ${formatCurrency(order.total)}</span>
                              <span class="text-xs text-gray-500">
                                  ${order.status === 'ordered' ? '‚è≥ Ch·ªù nh·∫≠n ƒë∆°n' :
                                    order.status === 'cancelled' ? '‚ùå ƒê√£ h·ªßy' :
                                    order.status === 'completed' ? '‚úÖ Ho√†n th√†nh' :
                                    'üîÑ ƒêang x·ª≠ l√Ω'}
                              </span>
                          </div>
                      </div>
                  `).join('');
              }

              document.getElementById('my-orders-modal').classList.remove('hidden');
              renderLucideIcons();
          }
        
        // --- Custom Alert/Message ---
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            
            let classes = '';
            if (type === 'success') {
                classes = 'bg-green-100 text-green-800 border-green-400';
            } else if (type === 'warning') {
                classes = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            } else { // info/error
                classes = 'bg-red-100 text-red-800 border-red-400';
            }
            
            messageBox.className = `p-3 rounded-lg border fixed top-4 left-1/2 -translate-x-1/2 z-50 shadow-lg transition-opacity duration-300 ${classes}`;
            messageBox.style.opacity = '1';
            
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        function renderApp() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // Hide loading screen
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }

            // Render Header
            document.getElementById('header-container').innerHTML = renderHeader();

            // Render Main Content (Menu/Login/Admin)
            document.getElementById('main-content-container').innerHTML = renderMainContent();

            // Render Cart Sidebar
            document.getElementById('cart-container').innerHTML = renderCartSidebar();

            // X·ª≠ l√Ω gi·ªè h√†ng ban ƒë·∫ßu (khi user m·ªü app)
            const storedCart = localStorage.getItem('cart');
            if (storedCart) {
                try {
                    cart = JSON.parse(storedCart);
                } catch(e) {
                    console.error("L·ªói parse gi·ªè h√†ng:", e);
                    cart = {};
                }
            }

            // Setup admin price preview listeners
            setTimeout(() => {
                setupAdminPricePreviewListeners();
            }, 100);

            renderLucideIcons();
        }


        // ==================== MOBILE MENU ====================

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            const icon = btn.querySelector('i');

            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'x');
            } else {
                menu.classList.add('hidden');
                icon.setAttribute('data-lucide', 'menu');
            }
            renderLucideIcons();
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');

            if (!btn.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.add('hidden');
                const icon = btn.querySelector('i');
                if (icon) icon.setAttribute('data-lucide', 'menu');
                renderLucideIcons();
            }
        });

        // ==================== TABLE SELECTION MODAL ====================

        // Hi·ªÉn th·ªã modal ch·ªçn b√†n
        async function showTableSelectionModal() {
            const modal = document.getElementById('table-selection-modal');
            const content = document.getElementById('table-selection-content');

            console.log('üìã Current tables:', tables);
            console.log('üìä Tables length:', tables.length);

            // N·∫øu ch∆∞a load ƒë∆∞·ª£c tables, th·ª≠ load m·ªôt l·∫ßn
            if (tables.length === 0) {
                console.log('üîÑ Tables empty, trying to load once...');
                await loadTablesOnce();

                console.log('üìã After loading tables:', tables);
                console.log('üìä Tables length after load:', tables.length);
            }

            // N·∫øu v·∫´n ch∆∞a c√≥ tables, hi·ªÉn th·ªã loading
            if (tables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†n</p>
                        <p class="text-sm text-gray-500 mt-2">Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ho·∫∑c th·ª≠ l·∫°i sau.</p>
                        <button onclick="showTableSelectionModal()" class="mt-4 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            üîÑ Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
                modal.classList.remove('hidden');
                renderLucideIcons();
                return;
            }

            // Load danh s√°ch b√†n - ch·∫•p nh·∫≠n c·∫£ 'available' v√† undefined status (m·∫∑c ƒë·ªãnh l√† tr·ªëng)
            const availableTables = tables.filter(table => !table.status || table.status === 'available');

            console.log('‚úÖ Available tables:', availableTables);

            if (availableTables.length === 0) {
                content.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2 text-yellow-500"></i>
                        <p class="text-gray-600">Kh√¥ng c√≥ b√†n tr·ªëng l√∫c n√†y.</p>
                        <p class="text-sm text-gray-500 mt-2">Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>
                        <p class="text-xs text-gray-400 mt-4">Debug: ${tables.length} b√†n trong h·ªá th·ªëng</p>
                    </div>
                `;
            } else {
                content.innerHTML = availableTables.map(table => `
                    <button onclick="selectTable('${table.tableNumber}')" class="p-4 border-2 border-teal-200 rounded-lg hover:border-teal-400 hover:bg-teal-50 transition duration-150 flex flex-col items-center space-y-2">
                        <i data-lucide="table-2" class="w-8 h-8 text-teal-600"></i>
                        <span class="font-semibold text-gray-800">B√†n ${table.tableNumber}</span>
                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">${table.status || 'Tr·ªëng'}</span>
                    </button>
                `).join('');
            }

            modal.classList.remove('hidden');
            renderLucideIcons();
        }

        // ƒê√≥ng modal ch·ªçn b√†n
        function closeTableSelectionModal() {
            document.getElementById('table-selection-modal').classList.add('hidden');
        }

        // Ch·ªçn b√†n v√† ti·∫øp t·ª•c ƒë·∫∑t h√†ng
        function selectTable(tableNumber) {
            // ƒê·∫∑t table number
            currentTableNumber = tableNumber;
            userRole = 'guest';

            // T·∫°o session m·ªõi n·∫øu ch∆∞a c√≥
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            // L∆∞u session
            saveSessionToCookie();

            // ƒê√≥ng modal
            closeTableSelectionModal();

            // Hi·ªÉn th·ªã th√¥ng b√°o
            showMessage(`ƒê√£ ch·ªçn B√†n ${tableNumber}!`, 'success');

            // Ti·∫øp t·ª•c ƒë·∫∑t h√†ng
            handleOrder();

            // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t header
            renderApp();
        }

        // --- Kh·ªüi t·∫°o ·ª®ng d·ª•ng ---
        window.onload = function() {
            console.log("üåü ·ª®ng d·ª•ng Qu√°n Tr√† ƒê·ªì kh·ªüi ƒë·ªông...");

            initFirebase();
            window.updateCart = updateCart;
            window.openCart = openCart;
            window.closeCart = closeCart;
            window.setView = setView;
            window.setCategory = setCategory;
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            window.toggleAdminMode = toggleAdminMode;
            window.saveItem = saveItem;
            window.deleteItem = deleteItem;
            window.handleSaveItem = handleSaveItem;
            window.handleChangePassword = handleChangePassword;
            window.loadItemForEdit = loadItemForEdit;
            window.clearAdminForm = clearAdminForm;
            window.speak = speak;
            window.loadMenuItemsOnce = loadMenuItemsOnce;
            window.openPriceModal = openPriceModal;
            window.closePriceModal = closePriceModal;
            window.savePriceUpdate = savePriceUpdate;
            window.openCategoryModal = openCategoryModal;
            window.closeCategoryModalAdmin = closeCategoryModalAdmin;
            window.addNewCategoryAdmin = addNewCategoryAdmin;
            window.openEditCategoryModalAdmin = openEditCategoryModalAdmin;
            window.closeEditCategoryModalAdmin = closeEditCategoryModalAdmin;
            window.updateCategoryAdmin = updateCategoryAdmin;
            window.openAddTableModalAdmin = openAddTableModalAdmin;
            window.closeAddTableModalAdmin = closeAddTableModalAdmin;
            window.addTableAdmin = addTableAdmin;
            window.openEditTableModalAdmin = openEditTableModalAdmin;
            window.closeEditTableModalAdmin = closeEditTableModalAdmin;
            window.updateTableAdmin = updateTableAdmin;
            window.showTableQRAdmin = showTableQRAdmin;
            window.closeQRTableModalAdmin = closeQRTableModalAdmin;
            window.downloadTableQRAdmin = downloadTableQRAdmin;
            window.restoreItem = restoreItem;
            window.permanentDeleteItem = permanentDeleteItem;
            window.cleanupExpiredItems = cleanupExpiredItems;
            window.loadCategories = loadCategories;
            window.saveCategories = saveCategories;
            window.updateAdminPricePreview = updateAdminPricePreview;
            window.setupAdminPricePreviewListeners = setupAdminPricePreviewListeners;
            window.closeCategoryModal = closeCategoryModal;
            window.addNewCategory = addNewCategory;
            window.editCategory = editCategory;
            window.deleteCategory = deleteCategory;
            window.loadOrders = loadOrders;
            window.acceptOrder = acceptOrder;
            window.cancelOrder = cancelOrder;
            window.completeOrder = completeOrder;
            window.addItemToOrder = addItemToOrder;
            window.removeItemFromOrder = removeItemFromOrder;
            window.handleOrder = handleOrder;
            window.showMyOrders = showMyOrders;
            window.closeMyOrdersModal = closeMyOrdersModal;
            window.setOrderFilter = setOrderFilter;
            window.toggleDateFilter = toggleDateFilter;
            window.applyDateFilter = applyDateFilter;
            window.clearDateFilter = clearDateFilter;
            window.resetDateFilter = resetDateFilter;
            window.previewAsCustomer = previewAsCustomer;
            window.handleLogoClick = handleLogoClick;
            window.setItemsPerPage = setItemsPerPage;
            window.setPage = setPage;
            window.nextPage = nextPage;
            window.prevPage = prevPage;
            window.addTable = addTable;
            window.deleteTable = deleteTable;
            window.showTableQR = showTableQR;
            window.closeQRModal = closeQRModal;
            window.openAddTableModal = openAddTableModal;
            window.closeAddTableModal = closeAddTableModal;
            window.downloadQR = downloadQR;
            window.showTableSelectionModal = showTableSelectionModal;
            window.closeTableSelectionModal = closeTableSelectionModal;
            window.selectTable = selectTable;
            window.toggleMobileMenu = toggleMobileMenu;

              // Fallback: Hide loading after 10 seconds if Firebase fails
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen && loadingScreen.style.display !== 'none') {
                    console.warn("‚ö†Ô∏è Firebase load timeout - showing app anyway");
                    loadingScreen.style.display = 'none';
                }
            }, 10000);

            renderApp(); // Render l·∫ßn ƒë·∫ßu
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f5e6d3 0%, #d4a574 100%);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5e6d3;
        }
        ::-webkit-scrollbar-thumb {
            background: #d97706; /* Orange-700 */
            border-radius: 10px;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app-container" class="relative">
        <div id="header-container">
            <!-- Header s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-amber-50 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold text-amber-900 mb-2">Chill Coffee</h2>
                <p class="text-amber-700">ƒêang t·∫£i menu...</p>
                <p class="text-sm text-amber-600 mt-2">üí° N·∫øu load l√¢u, th·ª≠ enable Authentication trong Firebase Console</p>
            </div>
        </div>

        <div id="main-content-container">
            <!-- N·ªôi dung ch√≠nh (Menu, Login, Admin) s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>

        <div id="cart-container">
            <!-- Gi·ªè h√†ng Sidebar s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </div>
        
        <!-- H·ªôp th√¥ng b√°o t√πy ch·ªânh (thay th·∫ø alert) -->
        <div id="message-box" style="opacity: 0; pointer-events: none;" class="p-3 rounded-lg border fixed top-4 left-1/2 -translate-x-1/2 z-50 shadow-lg transition-opacity duration-300"></div>

        <!-- Price Update Modal -->
        <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">üí∞ C·∫≠p Nh·∫≠t Gi√°</h3>

                <div id="price-modal-content">
                    <!-- Content s·∫Ω ƒë∆∞·ª£c render b·ªüi JavaScript -->
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closePriceModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="savePriceUpdate()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">L∆∞u</button>
                </div>
              </div>
          </div>

          <!-- My Orders Modal (Customer) -->
          <div id="my-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
              <div class="bg-white p-6 rounded-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-2xl font-bold text-blue-600">üìã ƒê∆°n H√†ng C·ªßa T√¥i</h3>
                      <button onclick="closeMyOrdersModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div id="my-orders-content">
                      <!-- Orders will be loaded here -->
                  </div>
              </div>
          </div>
          

          <!-- Table Selection Modal (Guest) -->
          <div id="table-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden p-4">
              <div class="bg-white rounded-xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-teal-600">üçΩÔ∏è Ch·ªçn B√†n C·ªßa B·∫°n</h3>
                      <button onclick="closeTableSelectionModal()" class="text-gray-500 hover:text-gray-700">
                          <i data-lucide="x" class="w-6 h-6"></i>
                      </button>
                  </div>

                  <div class="p-4 sm:p-6">
                      <div class="mb-4">
                          <p class="text-gray-600 text-sm sm:text-base mb-4">Vui l√≤ng ch·ªçn b√†n m√† b·∫°n ƒëang ng·ªìi ƒë·ªÉ ch√∫ng t√¥i ph·ª•c v·ª• t·ªët nh·∫•t:</p>
                      </div>

                      <div class="flex justify-between items-center mb-4">
                          <p class="text-sm text-gray-600">Danh s√°ch b√†n tr·ªëng:</p>
                          <div class="flex gap-1 sm:gap-2">
                              <button onclick="loadTablesOnce().then(() => showTableSelectionModal())" class="px-2 py-1 sm:px-3 sm:py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition duration-150">
                                  üîÑ T·∫£i l·∫°i
                              </button>
                              <span class="text-xs text-gray-500 self-center hidden sm:inline">${tables.length} b√†n</span>
                          </div>
                      </div>

                      <div id="table-selection-content" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 sm:gap-3">
                      <!-- Tables will be loaded here -->
                  </div>

                  <div class="flex gap-3 mt-4 sm:mt-6 px-4 sm:px-6 pb-4 sm:pb-6">
                      <button onclick="closeTableSelectionModal()" class="flex-1 px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm sm:text-base transition duration-150">
                          H·ªßy
                      </button>
                      <div class="text-xs sm:text-sm text-gray-500 self-center px-2">
                          Ch·ªçn b√†n ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t h√†ng
                      </div>
                  </div>
              </div>
          </div>

          <!-- Add Category Modal -->
        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-amber-900 mb-4">‚ûï Th√™m Danh M·ª•c M·ªõi</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Danh M·ª•c</label>
                    <input type="text" id="new-category-name" placeholder="V√≠ d·ª•: ƒê·ªì Chay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div class="flex gap-3">
                    <button onclick="closeCategoryModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="addNewCategory()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Th√™m</button>
                </div>
            </div>
        </div>
        
        <!-- Add Table Modal -->
        <div id="add-table-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-teal-600 mb-4">üçΩÔ∏è Th√™m B√†n M·ªõi</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë B√†n</label>
                    <input type="text" id="new-table-number" placeholder="V√≠ d·ª•: 1, A1, VIP-01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    <p class="text-xs text-gray-500 mt-1">C√≥ th·ªÉ d√πng s·ªë ho·∫∑c ch·ªØ c√°i</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeAddTableModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button onclick="addTable()" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Th√™m B√†n</button>
                </div>
            </div>
        </div>
        
        <!-- QR Code Modal -->
        <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-teal-600">üì± QR Code</h3>
                    <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="qr-table-info" class="mb-4 text-center">
                    <!-- Table info will be inserted here -->
                </div>
                
                <div id="qr-code-container" class="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-teal-200">
                    <!-- QR Code will be generated here -->
                </div>
                
                <div class="flex gap-3">
                    <button onclick="downloadQR()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        T·∫£i Xu·ªëng
                    </button>
                    <button onclick="closeQRModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer ƒë∆°n gi·∫£n -->
    <footer class="bg-amber-700 text-white p-2 mt-6 text-center text-xs fixed bottom-0 left-0 right-0 z-50">
        &copy; 2025 by GTD Fry. Chill Coffee
    </footer>
</body>
</html>